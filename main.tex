\documentclass[12pt,twoside,openright,a4paper]{book}
\usepackage{graphicx}
\usepackage{asymptote}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{makeidx}
\usepackage{hyperref}
\usepackage{framed}
\usepackage{slashbox}
\makeindex

\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{conjecture}{Conjecture}[chapter]
\newcommand{\col}{\text{col}}
\newcommand{\initch}{\text{ch}_0}
\newcommand{\finch}{\text{ch}}
\newcommand{\crs}{\text{cr}}
\newcommand{\sgn}{\text{sgn}}
\newcommand{\exc}{\text{exc}}
\newcommand{\GG}{\mathcal{G}}
\newcommand{\CC}{\mathcal{C}}
\newcommand{\FF}{\mathcal{F}}

\makeatletter
\newcommand{\ovlr}{\mathpalette{\overarrowsmall@\leftrightarrowfill@}}
\newcommand{\ovr}{\mathpalette{\overarrowsmall@\rightarrowfill@}}
\newcommand{\ovl}{\mathpalette{\overarrowsmall@\leftarrowfill@}}
\newcommand{\overarrowsmall@}[3]{%
  \vbox{%
    \ialign{%
      ##\crcr
      #1{\smaller@style{#2}}\crcr
      \noalign{\nointerlineskip}%
      $\m@th\hfil#2#3\hfil$\crcr
    }%
  }%
}
\def\smaller@style#1{%
  \ifx#1\displaystyle\scriptstyle\else
    \ifx#1\textstyle\scriptstyle\else
      \scriptscriptstyle
    \fi
  \fi
}
\makeatother


\begin{asydef}
unitsize(10mm);

void vertex(pair a, pen barva=white, real pol = 0.1)
{
  filldraw(circle (a, pol), fillpen=barva);
}

void outnbrs(pair a, real d, int n)
{
  if (n == 0)
    return;

  if (n == 1)
    {
      draw(a--(a+0.3dir(d)));
      return;
    }

  int i;
  for (i = 0; i < n; ++i)
    draw(a -- (a + 0.3dir((d-25)+50i/(n-1))));
}

void crosscap (pair a)
{
  int i;
  for (i = 0; i < 9; ++i)
    {
      pair d = dir(360i/9+17);
      draw ((a + 0.1d) -- (a + 0.3d));
    }
}

pair v[];
int i,j;
\end{asydef}

\begin{document}
\pagestyle{empty}
\begin{titlepage}

\begin{center}

\vspace{10cm}

{\large\bf A Coloring Book}

\end{center}
\end{titlepage}

\newpage

\pagestyle{plain}
\pagenumbering{roman}
\tableofcontents

\newpage

\pagestyle{headings}
\pagenumbering{arabic}
\setcounter{page}{1}

\chapter{Introduction}

\section{Scope of the book}

(sparse graphs, vertex coloring), target audience (PhD level,
familiarity with graph theory and basic coloring results expected, otherwise self-contained).

\section{Basic definitions and notation}

% claims: A, B, C, ... local
% labels: "lemma:zzz", "thm:zzz"
% numbered definitions only for important concepts

Notation for number of vertices/edges/faces of a graph $G$:
$|V(G)|$, $|E(G)|$, $|F(G)|$.
Use $n$ and $m$ for vertices and edges when repeated.
Graphs have no loops or parallel edges, multigraphs may have parallel edges and loops, unless specified otherwise.

"coloring" means proper coloring, unless specified otherwise; nevertheless, we sometimes use the adjective proper
for emphasis.

Colorings: $\varphi$, $\psi$, \ldots

List coloring.

$[k]=\{1,\ldots,k\}$.

$P_k$ denotes a path on $k$ vertices, its length is $k-1$.

$C_k$ denotes a cycle on $k$ vertices, its length is $k$.  Length of a cycle $C$ is denoted by $|C|$.

Girth (no special notation)? Odd girth.

Graphs on surfaces: genus (Euler by default), representativity and edge-width, contractible and
non-contractible curves (separating vs non-separating, one-sided vs two-sided).

Planar vs plane graphs.

Face of an embedded graph $G$ is a maximal connected subset of the surface minus $G$.
A face is \emph{$2$-cell} if it is homeomorphic to an open disk, \emph{closed $2$-cell}
if additionally bounded by a cycle.  Embedding is $2$-cell if all faces are $2$-cell.
\emph{Facial walk} of $f$ is a closed walk in $G$ tracing
a component of the boundary of $f$, the length $|f|$ of $f$ is the sum of lengths of its facial
walks.

Surfaces: $\Sigma$, $\Pi$; Euler genus $g(\Sigma)$.

Other notation (to be moved to where it becomes relevant).

critical for $k$-coloring/$k$-list-coloring

list chromatic number, $k$-list-colorable

If $G$ is $H$-critical,then $G\neq H$.

$\initch$ for initial charge, $\finch$ for final charge.  Discharging to non-negative.

\section{Basic results on graph coloring}

We assume throughout the book that the reader has a previous knowledge of some basic facts
about graph coloring, which we summarize here.  Hence, we state them with not much exposition;
more information can generally be found in any basic graph theory textbook.
Where possible, we will also give pointers to sections of this book where the results are
studied in more depth.

\subsection{Greedy coloring, degeneracy, and maximum degree}

\emph{Greedy coloring} is a very basic technique how to color a graph: fix some ordering $v_1$, \ldots, $v_n$ of
vertices of the graph.  Then assign colors to vertices in order. When coloring the vertex $v_i$ for some $i\in[n]$,
choose a color not appearing on any preceding neighbors of $v_i$ and use it to color $v_i$.  If all possible colors
appeared on these neighbors, the procedure would fail; this is usually guaranteed not to happen in the situations where
we use greedy coloring for a carefully specified ordering of vertices.  Note that this technique can also be used for list coloring.
Furthermore, it can be used to extend a precoloring of a part of the graph---if an induced subgraph $H$ of a graph $G$ was given
a coloring, we can fix some ordering of $V(G)\setminus V(H)$ and assign colors in order, so that the colors are different
from the colors of the adjacent vertices of $V(H)$ as well as preceding adjacent vertices of $V(G)\setminus V(H)$.

A graph is \emph{$d$-degenerate} if every subgraph of $G$ contains a vertex of degree at most $d$.
Equivalently, we can order vertices of $G$ so that each vertex has at most $d$ neighbors that precede it in the
ordering---indeed, we can form such an ordering by repeatedly removing vertices of degree at most $d$ and
arranging them in the opposite order of their removal.
Greedy coloring can naturally be applied to this ordering, giving the following result.
\begin{lemma}\label{lemma:degen}
Every $d$-degenerate graph has choosability (as well as chromatic number) at most $d+1$; i.e., $\chi(G)\le\chi_l(G)\le \col(G)$.
\end{lemma}

Clearly, this also implies that a graph of maximum degree at most $\Delta$ has chromatic number
at most $\Delta+1$.  Brooks~\cite{brooks1941colouring} proved that this bound can be improved, the only exceptions
being odd cycles and complete graphs.  We will frequently use the following strengthening of Brooks' theorem
in the list coloring setting~\cite{galfor}.
\begin{lemma}\label{lemma:gallai1}
Let $G$ be a $2$-connected graph and let $L$ be a list assignment for $G$ such that $|L(v)|\ge \deg(v)$ for all $v\in V(G)$.
If $G$ is neither an odd cycle nor a complete graph, then $G$ is $L$-colorable.
\end{lemma}
For even more general version of this claim, see Subsection~\ref{ssec-gallai}.

Lemma~\ref{lemma:gallai1} is most often used to extend a precoloring of a part of a graph.
Let $G$ be a graph with a list assignment $L$ and let $H$ be an induced subgraph of $G$ with an $L$-coloring $\psi$.
Let $L'$ be an assignment of lists to vertices of $V(G)\setminus V(H)$ such that $L'(v)=L(v)\setminus \{\psi(u):u\in V(H),uv\in E(G)\}$,
i.e., $L'(v)$ is obtained from $L(v)$ by removing the colors of its neighbors in $H$.  Clearly, $\psi$ extends to an $L$-coloring of $G$
if and only if the subgraph $J$ of $G$ induced by $V(G)\setminus V(H)$ is $L'$-colorable.  Note that if $|L(v)|\ge \deg_G(v)$, then
$|L'(v)|\ge \deg_J(v)$.  Hence, Lemma~\ref{lemma:gallai1} gives the following.
\begin{corollary}\label{cor:gallai1}
Let $G$ be a graph and let $J$ be its $2$-connected induced subgraph.  Let $L$ be a list assignment for $G$ such that $|L(v)|\ge \deg_G(v)$ for all $v\in V(J)$.
If $J$ is neither an odd cycle nor a complete graph, then every precoloring of $G-V(J)$ extends to an $L$-coloring of $G$.
\end{corollary}
Of course, this corollary can be applied even for ordinary coloring, by giving all vertices the same list.

\subsection{Planar graphs, graphs on surfaces, and forbidden minors}

A large body of work in graph coloring theory is devoted to the chromatic properties of planar graphs.
Since planar graphs are $5$-degenerate, they have chromatic number at most $6$ by Lemma~\ref{lemma:degen}.
The bound can be fairly easily improved to $5$, but of course the most important result in this context is
the Four Color Theorem.

\begin{theorem}[The Four Color Theorem]
Every planar graph is $4$-colorable.
\end{theorem}

A result of Gr\"{o}tzsch concerning triangle-free planar graphs has been also similarly influential.
\begin{theorem}[Gr\"{o}tzsch' Theorem]
Every planar triangle-free graph is $3$-colorable.
\end{theorem}
Unlike the Four Color Theorem, Gr\"{o}tzsch' Theorem has many proofs based on diverse ideas, all of them non-trivial but also
relatively simple and educational; we will use several of them to demonstrate various coloring methods.

The wealth of results regarding planar graphs motivated the study of graphs drawn on other surfaces.
Heawood's formula giving an upper bound for their chromatic number is probably the best known result in this area.
\begin{theorem}[Heawood's formula]\label{thm:heawood}
Every graph drawn in a surface of genus $g$ has chromatic number at most
$$\Bigl\lfloor\frac{7+\sqrt{24g+1}}{2}\Bigr\rfloor.$$
\end{theorem}
This bound is tight for all surfaces except for the Klein bottle, for which the tight upper bound is $6$.

Heawood's formula is an easy consequence of the sparsity of embedded graphs (see Section~\ref{sec:heawood}
for more details), which follows from the well-known relationship amnong the numbers of their vertices, edges and faces.

\begin{theorem}[Euler's formula]\label{thm:eulerfla}
If $G$ is a graph embedded in a surface of genus $g$, then
$$|E(G)|\le |V(G)|+|F(G)|+g-2,$$
with equality if and only if the embedding of $G$ is $2$-cell.
\end{theorem}

In particular, this has the following corollary.
\begin{lemma}\label{lemma:numedges}
Let $\ell\ge 3$ be an integer.
Suppose that $G$ is a graph embedded in a surface of genus $g$ and $G$ contains no cycles of length less than $\ell$.
If $g=0$, furthermore assume that $G$ is not a forest. Then
$$|E(G)|\le \frac{\ell}{\ell-2}(|V(G)|+g-2).$$
\end{lemma}
\begin{proof}
Without loss of generality, we can assume that $G$ is connected.  If $G$ is a tree, then by assumptions
$g\ge 1$, and since $|E(G)|=|V(G)|-1$, the inequality holds.
Hence, assume that $G$ is not a tree.  It follows that the boundary
of every face of $G$ contains a cycle, and by the assumptions it has length at least $\ell$.
Consequently,
$$2|E(G)|=\sum_{f\in F(G)} |f|\ge \ell|F(G)|.$$
Substituting $2|E(G)|/\ell$ for $|F(G)|$ in Euler's formula, we obtain the required inequality.
\end{proof}

This can be interpreted in the terms of average degree as follows.
\begin{corollary}\label{cor:mad}
Let $\ell\ge 3$ be an integer.
If $G$ is a graph embedded in a surface of genus $g$ with no cycles of length less than $\ell$,
then the average degree of $G$ is at most
$$\frac{2\ell}{\ell-2}\Bigl(1+\frac{g-2}{|V(G)|}\Bigr),$$
unless $g=0$ and $G$ is a forest.
\end{corollary}

Graphs that can be drawn in a fixed surfaces give a natural example of a class of graphs closed under taking minors.
Heawood's formula shows that for any fixed surface $\Sigma$, the maximum chromatic number of a graph that can be drawn in
$\Sigma$ is at most the size of the largest clique that can be drawn in $\Sigma$.  Hadwiger conjectured the following
substantial strengthening of this claim.

\begin{conjecture}[Hadwiger's conjecture]
For any integer $k\ge 1$, if a graph $G$ does not contain a clique $K_{k+1}$ as a minor, then $\chi(G)\le k$.
\end{conjecture}

For $k\le 3$, Hadwiger's conjecture is easy to prove.  For $k=4$, it implies (and can be seen to be equivalent to)
the Four Color Theorem.  It is also known that Hadwiger's conjecture holds for $k=5$, via a rather complex argument~\cite{robertsonseymourthomas}.

\part{Standard Methods}

Overview of Standard Methods (with examples and comments on common tricks and pitfalls).

\chapter{Reducible Configurations and Discharging}\label{chap:redu}

Suppose we want to show that graphs from some hereditary class $\GG$ are $k$-colorable.  Clearly, we can
restrict our attention to graphs from $\GG$ of minimum degree at least $k$: if a graph $G\in \GG$
contains a vertex $v$ of degree less than $k$, it suffices to find a $k$-coloring of the graph $G-v$
which also belongs to $\GG$, and then give $v$ a color different from the colors of its neighbors,
which is always available since $v$ has less than $k$ neighbors.

More formally, we are constructing a proof by contradiction.  Suppose that $G$ is a graph belonging to $\GG$
with the smallest number of vertices that is not $k$-coloriable.  Hence, $G$ is a hypothetical smallest counterexample
to the claim that all graphs from $\GG$ are $k$-colorable.
By the previous paragraph, we see that $G$ does not contain a vertex of degree at most $k-1$.
Substructures with the property that they cannot appear in any smallest counterexample
are called \emph{reducible configurations}, and they form a basis of many arguments in graph coloring.

In the most direct application, we can be able to identify a set of reducible configurations such that
at least one of them must necessarily appear in any graph from $\GG$, thus excluding the existence of
a (smallest) counterexample and showing that indeed, all graphs from $\GG$ are $k$-colorable.
In more advanced applications, reducible configurations can be used to restrict the properties
of the smallest counterexample, and a contradiction is obtained by different means afterwards, typically
by showing through another method that all graphs satisfying these restrictions are $k$-colorable.

There are many tricks used in showing that a configuration is reducible, which we will discuss some
of them throughout this chapter and elsewhere in the book. However, the basic idea almost always resembles
our starting example: the configuration is removed (and possibly some further local changes are
performed in the graph), and then a coloring of the modified graph is transformed in a coloring of the
original graph.  Reducible configurations usually involve vertices whose degree is
smaller than or close to the number of colors $k$ we are using, since a coloring of the rest of the graph
can be extended to such vertices (nearly) greedily.

Consequently, reducible configurations are easiest to find in graph classes $\GG$ that are sparse, in the
sense that the graphs in $\GG$ have average degree close to $k$. To prove that each graph in such a class $\GG$
contains one of the reducible configurations, one needs to argue that their absence would force the graph to be
too dense.  The \emph{discharging method} is a systematic way to organize such an argument.  In the most straightforward
form, a real number called \emph{charge} is assigned to vertices (and in the case of embedded graphs, possibly faces)
of the graph, so that the sum of the charges is negative; for example, if graphs in $\GG$ have average degree less than $d$,
a possible assignment of charge to a vertex $v$ is $\deg(v)-d$.  The charge is then redistributed according to some local
rules, without changing its total amount.  As a result, there exists a vertex (or face) whose final charge is negative,
and based on the discharging rules, we argue that this is only possible if a reducible configuration appears in its neighborhood.
Of course, this description omits the most important aspect: how to choose the discharging rules?
While this seems a daunting task at first, with a bit of experience this becomes a fairly mechanical process of trial and error
(which can in fact be automatized to some extent), as we will discuss later in this chapter.

Although reducible configurations and discharging method are independent tools that have many applications on their
own, in the coloring context they are most commonly applied together, and so we devote this chapter to both of them.

\section{Overview of the Method}

Let us now flesh out the ideas from the introduction a bit.  While discharging and reducible configurations
are applicable in many contexts, they are at their best in the realm of graphs drawn on a fixed surface, and
especially for planar graphs.  This is primarily due to the well-known relationship between the numbers
of their vertices, edges, and faces, the Euler's formula~\ref{thm:eulerfla}.
Let us start with a mandatory toy example: 5-colorability of planar graphs.

\begin{theorem}\label{thm:planar5col}
Every planar graph is $5$-colorable.
\end{theorem}
\begin{proof}
Suppose for a contradiction that this is not the case, and let $G$ be a non-$5$-colorable plane graph
with the smallest number of vertices.

Clearly, $G$ is connected and it has minimum degree at least $5$.  We can strengthen this claim: $G$ does not
contain any vertex of degree $5$.  Indeed, suppose that $v\in V(G)$ has degree $5$.  Since $G$ is planar, it does
not contain $K_6$ as a subgraph, and thus $v$ has two non-adjacent neighbors $x$ and $y$.  Let $G'$ be the graph obtained
from $G$ by removing $v$ and identifying vertices $x$ and $y$ to a single vertex $z$.  Note that $G'$ is a plane graph,
and by the minimality of $G$, we conclude that $G'$ has a $5$-coloring $\varphi$.  We can extend this $5$-coloring to $G$,
by giving $x$ and $y$ the color $\varphi(z)$, and by coloring $v$ greedily (there are $5$ available colors, but only
$4$ of them are used at the neihbors of $v$, since $x$ and $y$ have the same color).  This contradicts the assumption
that $G$ is not $5$-colorable, and thus we conclude that $G$ cannot contain a vertex of degree $5$.

Let us now give each vertex $v\in V(G)$ charge $\initch(v)=\deg(v)-6$ and each face $f\in F(G)$ charge $\initch(f)=2|f|-6$.
Since all vertices of $G$ have degree at least $6$, their charge is non-negative.  Furthermore, $G$ clearly has at least $6$
vertices, and since it is connected, all its faces have length at least $3$ and their charge is non-negative.
However,
$$\sum_{v\in V(G)} \initch(v)=\left(\sum_{v\in V(G)} \deg(v)\right)-6|V(G)|=2|E(G)|-6|V(G)|$$
and
$$\sum_{f\in F(G)} \initch(f)=\left(2\sum_{f\in F(G)} |f|\right)-6|F(G)|=4|E(G)|-6|F(G)|,$$
and thus the sum of charges of vertices and faces is
$$6(|E(G)|-|V(G)|-|F(G)|)=-12$$
by Euler's formula.  This is a contradiction, showing that no non-$5$-colorable plane graph exists.
\end{proof}

For the demonstration purposes, the preceding example has a disadvantage of
having only a trivial discharging phase, with no discharging rules.  Let us
turn this to our advantage and discuss two aspects seen in the proof: its
overall structure and the choice of the assignment of charges.

We see that the proof is cleanly split to two parts: first we identify the reducible configurations, then we show
that they need to appear in each planar graph.  This makes for a clear presentation, but it hides the process of
how we devised the two parts, which usually is not in isolation; more on that in Section~\ref{sec:rules}.

Both parts are presented as proofs by contradiction: we consider a smallest counterexample in the first part,
and we argue that since we have no reducible configuration the sum of charges would have to be non-negative.
This is not the only possiblity, and both parts can be presented in a more ``positive'' manner.

\begin{proof}[Proof of Theorem~\ref{thm:planar5col}, alternative formulation]
We prove the claim by induction on the number of vertices.  So, consider some plane graph $G$, and assume
that every planar graph with fewer than $|V(G)|$ vertices is $5$-colorable.

If $G$ is disconnected, we can $5$-color its components separately by the induction hypothesis, and thus $G$
is $5$-colorable.  Hence, we can assume that $G$ is connected.  Also, if $|V(G)|\le 5$, then we can give all
vertices distinct colors.  Hence, assume that $|V(G)|\ge 6$.

Let us assign charges to vertices and faces in the same way as in the first proof of the theorem.
Since their sum is negative and all faces have non-negative charge, there exists a vertex $v\in V(G)$
such that $\initch(v)<0$, and thus $\deg(v)\le 5$.

If $v$ has degree at most $4$, then a $5$-coloring of $G-v$ which exists by the induction hypothesis can be extended to $G$ by giving $v$ a color
different from the colors of its neighbors.  And, if $v$ has degree $5$, then we can $5$-color by
the induction hypothesis the graph $G'$ constructed in the same way as in the first proof of the theorem, and extend its
$5$-coloring to $G$.
\end{proof}

Of course, both proofs are equivalent, and it is a matter of taste which style of presentation one chooses.
In our experience, the latter style is more convenient when one wants to discuss the algorithmic aspects of the proof.
The former style has the advantage that we can speak about the properties of one fixed object (a hypothetical minimal
counterexample $G$), and say things like ``$G$ has minimum degree at least $k$ and does not contain this-and-that'';
the respective formulations in the latter style tend to be more cumbersome.

\subsection{Initial assignment of charge}\label{ssec:initch}

How do we decide what initial charge we assign to vertices and faces?  Since we want to take advantage of Euler's formula,
there is actually not much freedom, and when the discharging method is used for embedded graphs, the assignment
of charges almost exclusively follows one of the options from the following lemma.

\begin{lemma}\label{lemma:initch}
Let $a\ge 0$ and $b>0$ be real numbers, and let $G$ be a graph with $2$-cell embedding in a surface of genus $g$.
Let $\initch(v)=a\deg(v)-2b$ for $v\in V(G)$ and $\initch(f)=(b-a)|f|-2b$ for $f\in F(G)$.
Then
$$\sum_{v\in V(G)}\initch(v)+\sum_{f\in F(G)}\initch(f)=2b(g-2).$$
\end{lemma}
\begin{proof}
By Euler's formula, we have
\begin{align*}
\sum_{v\in V(G)}\initch(v)+\sum_{f\in F(G)}\initch(f)&=\left(-2b|V(G)|+a\sum_{v\in V(G)}\deg(v)\right)+\left(-2b|F(G)|+(b-a)\sum_{f\in F(G)}|f|\right)\\
&(-2b|V(G)|+2a|E(G)|)+(-2b|F(G)|+2(b-a)|E(G)|)\\
&=2b(|E(G)|-|V(G)|-|F(G)|)=2b(g-2).
\end{align*}
\end{proof}

The most common choices of charge for vertices $v$ and faces $f$ are the following:
\begin{itemize}
\item $\initch(v)=\deg(v)-6$ and $\initch(f)=2|f|-6$, obtained by setting $a=1$ and $b=3$: This is the charge we used in the proof of Theorem~\ref{thm:planar5col},
and for connected plane graphs, it sums to $-12$.  The charge of all faces is nonnegative, putting the focus on vertices.  This tends to be a good
choice when proving results for unrestricted plane graphs.
\item $\initch(v)=\deg(v)-4$ and $\initch(f)=|f|-4$, obtained by setting $a=1$ and $b=2$: For connected plane graphs, the charge sums to $-8$.
Only $3$-faces have negative charge, which makes this a good choice for triangle-free graphs or graphs with restrictions on triangles.
\item $\initch(v)=2\deg(v)-6$ and $\initch(f)=|f|-6$, obtained by setting $a=2$ and $b=3$: For connected plane graphs, the charge sums to $-12$.
and this choice is convenient when dealing with $3$-regular graphs (so that vertices have no charge), or sometimes when dealing with graphs of large girth.
\end{itemize}
Of course, other choices may be useful in other special situations. The proper
choice of charge can greatly simplify the discharging rules.  However, let us
remark that at least in principle, all the charge choices are equivalent.
Indeed, suppose that we have assigned charge $\initch(v)=a\deg(v)-2b$ for $v\in V(G)$ and $\initch(f)=(b-a)|f|-2b$ for $f\in F(G)$.
Consider any other real numbers $a'\ge 0$ and $b'>0$.
Now, let each vertex send $\gamma=\frac{ab'-a'b}{b'}$ units of charge to each incident face, and let $\finch$ denote the resulting assigment of charges.
We have $\finch(v)=(a-\gamma)\deg(v)-2b=\frac{b}{b'}(a'\deg(v)-2b')$ and $\finch(f)=(b-a+\gamma)|f|-2b=\frac{b}{b'}((b'-a')|f|-2b')$,
which up to scaling is the same charge we would obtain if we instead of $a$ and $b$ chose $a'$ and $b'$.
Hence, if a discharging argument is possible with the latter choice, it is also possible with the former one, by adding the discharging rule of
moving $\gamma$ units of charge from each vertex to each incident face.
In other words, choosing a ``wrong'' charge may make the discharging rules more complicated, but not impossible to find.

Let us remark that some authors prefer to negate the charge assignments we suggest, so that the sum of charges is positive and
after redistribution using the discharging rules, a reducible configuration
is then found near the vertices or faces of positive charge.  This convention can be mostly found
in older works, most notably in the proofs of the Four Color Theorem~\cite{AppHak1,rsst}.  As this is purely a matter of taste
and nowadays the choice of charge summing to negative is more popular, this will be the convention used in this book.

\section{A more substantial example}

We now give a further example demonstrating more of the aspects of the method.  Specifically, we will show that all
projective-planar graphs without $4$-cycles are $4$-colorable.  Let us start with the reducible configurations (see Figure~\ref{fig:no4cproj-redu}).

\begin{figure}
\begin{center}
\begin{asy}
v[0]=(0,0);

for (i = 0; i < 5; ++i)
  v[i+1]=(3.2,1) + 1.2dir(-90-72i);
v[6] = 0.5(v[3]+v[4])+(0,0.9);

v[7] = (8,0);
for (i = 0; i < 9; ++i)
  v[8+i] = v[7]+2.5dir(160-140i/8);

draw(v[3]--v[6]--v[4]--v[5]--v[1]--v[2]--v[3]--v[4]);
draw(v[7]--v[8]--v[9]--v[10]--v[11]--v[12]--v[13]--v[14]--v[15]--v[16]--v[7]--v[9]);
draw(v[12]--v[7]--v[13]);

outnbrs (v[0],90,3);
outnbrs (v[1],-90,2);
outnbrs (v[2],-90-72,2);
outnbrs (v[3],135,2);
outnbrs (v[4],45,1);
outnbrs (v[5],-18,2);
outnbrs (v[6],90,2);
outnbrs (v[7],-90,1);
outnbrs (v[8],180,2);
for (i = 1; i < 8; ++i)
  outnbrs(v[8+i], 160-140i/8, i==1 || i==4 || i == 5 ? 1 : 2);
outnbrs (v[16],0,2);

for (i = 0; i <=16; ++i)
  vertex(v[i]);

label("$v_1$", v[3],SE);
label("$v_2$", v[4],E);
label("$v_3$", v[5],NE);
label("$v_4$", v[1],E);
label("$v_5$", v[2],NW);
label("$v_6$", v[6],E);

label("$v$", v[7],SE);
label("$v_1$", v[8],E);
label("$v_2$", v[9],E);
label("$v_3$", v[10],SE);
label("$v_4$", v[11],SE);
label("$v_5$", v[12],SE);
label("$v_6$", v[13],SE);
label("$v_7$", v[14],S);
label("$v_8$", v[15],SW);
label("$v_9$", v[16],S);

label("(b)", v[0]+(0,-1));
label("(c)", v[1]+(0,-1));
label("(d)", v[7]+(0,-1));
\end{asy}
\end{center}
\caption{Reducible configurations from Lemma~\ref{lemma:no4cproj-redu}.}\label{fig:no4cproj-redu}
\end{figure}

\begin{lemma}\label{lemma:no4cproj-redu}
Let $G$ be a graph with no $4$-cycles drawn in the projective plane, such that every projective-planar graph
with no $4$-cycles and with fewer than $|V(G)|$ vertices is $4$-colorable.  If $G$ is not $4$-colorable, then
\begin{itemize}
\item[\textrm{(a)}] $G$ is connected;
\item[\textrm{(b)}] the minimum degree of $G$ is at least $4$;
\item[\textrm{(c)}] if $f$ is a $5$-face of $G$ sharing an edge $v_1v_2$ with a $3$-face $g$ and all vertices
incident with $f$ and $g$ except for $v_1$ have degree $4$, then $v_1$ has degree at least $6$; and,
\item[\textrm{(d)}] if $v\in V(G)$ has degree $6$ and is incident with a $3$-face $g_1$, a $5$-face $f_1$,
a $3$-face $g_2$, and a $5$-face $f_2$ in order, then at least one vertex incident with these faces other than $v$ has
degree at least $5$.
\end{itemize}
\end{lemma}
\begin{proof}
For (a), if $G$ were a disjoint union of non-empty graphs $G_1$ and $G_2$, then both $G_1$ and $G_2$ would be
$4$-colorable by the assumption, and thus $G$ would also be $4$-colorable.  Similarly, for (b), if $G$ contained a vertex $v$ of
degree at most $3$, then $G-v$ is $4$-colorable by the assumption and the coloring can be extended to $G$ by giving $v$ a color
different from the colors of its neighbors.

For (c), let $K=v_1v_2\ldots v_5$ be the boundary walk of $f$.  Let us first consider the case that the face $f$ is not bounded by a $5$-cycle.
Since $G$ has no loops or parallel
edges, an edge $e$ appears twice in the boundary of $f$, and the remaining three edges form a triangle.  Note that $e\neq v_1v_2$,
since the edge $v_1v_2$ is incident with a face $g$ distinct from $f$.  Also, the only triangle containing the edge $v_1v_2$
is the one bounding $g$, since $G$ does not contain a $4$-cycle.  It follows that either the path $v_1v_2v_3$ or the path $v_5v_1v_2$
is contained in the boundaries of both $f$ and $g$, and thus either $v_1$ or $v_2$ has degree two, which is a contradiction.

Hence, $K$ is a cycle, and since $G$ has no $4$-cycles, $K$ is induced.  Let $T=v_1v_2v_6$ be the triangle bounding the face $g$.
Since $K$ is an induced cycle, we have $v_6\not\in V(K)$, and since $G$ contains no $4$-cycles, $v_6$ has no neighbor in $K$ other
than $v_1$ and $v_2$.  Suppose for a contradiction that $\deg(v_1)\le 5$.  By the assumptions, there exists a $4$-coloring $\varphi$
of $G-\{v_1,\ldots, v_6\}$.  For $i\in[6]$, let $L(v_i)$ denote the subset of $[4]$ consisting of the colors not
appearing on the neighbors of $v_i$ in the coloring $\varphi$; we have $|L(v_i)|\ge 2$ for $i\in\{1,3,4,5,6\}$ and $|L(v_2)|=3$.
To extend the coloring $\varphi$ to a $4$-coloring of $G$, it suffices to color $K\cup T$ from the lists given by $L$.

First, let us choose a color $c_1\in L(v_2)$ such that $|L(v_3)\setminus\{c\}|\ge 2$.  If we can color $v_1$ and $v_6$ by colors
different from $c_1$, we can then color $v_2$ by $c_1$ and greedily color $v_5$, $v_4$, and $v_3$ in order by colors from their lists different from
the colors of their neighbors.  Otherwise, we have $L(v_1)=L(v_6)=\{c_1,c_2\}$ for some color $c_2$.
Let $c_3\in L(v_2)$ be a color different from $c_1$ and $c_2$.  We color $v_2$ by $c_3$ and greedily color $v_3$, $v_4$, $v_5$, $v_1$, and $v_6$
in order.  It follows that $G$ is $4$-colorable, which is a contradiction; hence, (c) holds.

Finally, let us consider (d).  Let $vv_1v_2$, $vv_2v_3v_4v_5$, $vv_5v_6$, and $vv_6v_7v_8v_9$ be the facial walks of
$g_1$, $f_1$, $g_2$, and $f_2$.  Observe that since $G$ has no parallel edges, no $4$-cycles, and minimum degree at least $4$,
the vertices $v_1$, \ldots, $v_9$ are pairwise distinct.  By the assumptions, there exists a $4$-coloring $\varphi$ of $G-\{v,v_1,\ldots,v_9\}$.
Note that $v$ has only one neighbor $y$ colored by $\varphi$, and $v_1$ has exactly two neighbors $y_1$ and $y_2$ that are
colored by $\varphi$ (since $v_1$ cannot be adjacent to $v_3$, \ldots, $v_9$ by the absence of $4$-cycles).
Hence, we can choose a color $c\in[4]\setminus\{\varphi(y)\}$ such that $|[4]\setminus\{c,\varphi(y_1),\varphi(y_2)\}|\ge 2$.
Color $v$ by the color $c$, then color vertices $v_9$, $v_8$, \ldots, $v_1$ greedily in order using colors different
from the colors of their neighbors colored earlier (note that even if there are some
edges among $v_2$, \ldots, $v_9$ not contained in the path $v_2\ldots v_9$, this does not affect the validity of the
greedy coloring procedure).
\end{proof}

Now, we can proceed with the discharging phase.

\begin{theorem}\label{thm:no4cproj}
Every projective-planar graph without $4$-cycles is $4$-colorable.
\end{theorem}
\begin{proof}
Suppose for a contradiction this is not the case, and let $G$ be a
non-$4$-colorable graph drawn in the projective plane with
the smallest number of
vertices.  By Lemma~\ref{lemma:no4cproj-redu}(a), $G$ is connected.
Let us assign initial charge $\initch(v)=\deg(v)-4$ to each vertex $v$ of $G$,
and initial charge $\initch(f)=|f|-4$ to each face $f$ of $G$.

If the embedding of $G$ is $2$-cell, then the sum of the initial charges
is $-4$ by Lemma~\ref{lemma:initch}.  If the embedding is not $2$-cell, then
since $G$ is connected, there exists a unique face of $G$ whose interior contains
the crosscap of the projective plane, and $G$ is planar and the sum of the initial charges is $-8$.
In either case, the total amount of charge is negative.

Next, we redistribute the charge according to the following rules.
For a $3$-face $g$, let $r(g)$ denote the number of incident vertices of degree
at least $5$.
\begin{itemize}
\item[(R1)] A vertex $v$ of degree at least $5$ incident with a $3$-face $g$ sends $1$ to $g$
if $\deg(v)\ge 7$, or if $\deg(v)=6$ and $v$ is incident with at most two triangles,
or if $\deg(v)=6$ and $g$ is the only triagle incident with $v$ satisfying $r(g)=1$.
The vertex $v$ sends $2/3$ to $g$ if $\deg(v)=6$ and $v$ is incident with three $3$-faces $g$, $g_1$, and $g_2$
such that $r(g)=r(g_1)=1$.  Otherwise, $v$ sends $1/2$ to $g$.
\item[(R2)] If a face $f$ shares an edge $uv$ with a $3$-face $g$ such that $\deg(u)=\deg(v)=4$,
then $f$ sends $1/3$ to $g$ if $r(g)=0$, and $f$ sends $1/6$ to $g$ if $r(g)=1$.
\item[(R3)] If a face $f$ shares an edge $uv$ with a $3$-face $g$ such that $r(g)=1$ and $\deg(u)=4$ and $\deg(v)\ge 5$,
then $f$ sends $1/6$ to $g$ if $|f|\ge 6$, or $|f|=5$ and $\deg(v)=5$, or $|f|=5$ and $\deg(v)=6$ and $f$ is incident with a vertex of degree
at least $5$ distinct from $v$.
\end{itemize}
Let $\finch$ denote the final charge after performing the redistribution.
Note that the total amount of charge is unchanged, and thus the sum of
final charges is negative.

We argue that each vertex and face has a non-negative final charge,
which gives a contradiction.  Let us start with vertices: By Lemma~\ref{lemma:no4cproj-redu}(b),
each vertex $v$ of $G$ has degree at least $4$.  If $\deg(v)=4$, then $v$ sends no charge
and $\finch(v)=\initch(v)=0$.  Suppose now that $\deg(v)\ge 5$, and let $t$ denote the number
of $3$-faces incident with $v$.  Since $G$ contains no $4$-cycles, no two $3$-faces are consecutive
in the cyclic order around $v$, and thus $t\le \lfloor\deg(v)/2\rfloor$.
If $\deg(v)=5$, then $t\le 2$ and $v$ sends $1/2$ to each incident $3$-face by (R1), and thus
$\finch(v)=\initch(v)-t/2=1-t/2\ge 0$.  If $\deg(v)\ge 7$, then $v$ sends $1$ to each incident $3$-face by (R1),
and thus
$\finch(v)=\initch(v)-t\ge \deg(v)-4-\lfloor\deg(v)/2\rfloor=\lceil\deg(v)/2\rceil-4\ge 0$.
So, suppose that $\deg(v)=6$.  If $t\le2$, then $\finch(v)=\initch(v)-t\ge 0$.  If $t=3$, then let $g_1$, $g_2$, and $g_3$
be the $3$-faces incident with $v$ such that $r(g_1)\le r(g_2)\le r(g_3)$.  If $r(g_2)\ge 2$, then $v$ sends $1/2$ to $g_2$ and to $g_3$,
and at most $1$ to $g_1$, hence $\finch(v)\ge\initch(v)-2=0$.  If $r(g_2)=1$, then $v$ sends at most $2/3$ to each incident $3$-face,
and $\finch(v)\ge\initch(v)-2=0$.

Next, consider the charge of the faces.  Let $g$ be a $3$-face; since $G$ does not contain $4$-cycles
and has minimum degree greater than $2$, all faces that share an edge with $g$ have length at least $5$,
and thus $g$ sends no charge.  If $r(g)\ge 2$, then $g$ receives at least $1/2$ from each incident vertex of degree at least $5$ by (R1)
and thus $g$ receives at least $1$ in total.
If $r(g)=0$, then $g$ receives $1/3$ from each face with that it shares an edge by (R2).
Hence, suppose that $r(g)=1$, and let $v$ be the vertex of degree at least $5$ incident with $g$.  Note that
$g$ receives $1/6$ from the face opposite to $v$ by (R2).  If $\deg(v)=5$, then $g$ receives $1/2$ from $v$ by (R1)
and $1/6$ from each of the two faces with that $g$ shares an edge incident with $v$ by (R3), and the total amount received
is $1/2+3\times 1/6=1$.  If $\deg(v)=7$, or $\deg(v)=6$ and $v$ is inicident with at most two $3$-faces,
or $\deg(v)=6$ and $g$ is the only $3$-face with $r(g)=1$ incident with $v$, then $g$ receives $1$ from $v$ by (R1).
Finally, suppose that $\deg(v)=6$, $v$ is incident with three $3$-faces, and a $3$-face $g_1\neq g$ incident with $v$ satisfies $r(g_1)=1$.
In this case, $v$ sends $2/3$ to $g$.
Let $f_1$, $g$, $f_2$, $g_1$ be faces incident with $v$ in order according to the drawing of $G$.
By Lemma~\ref{lemma:no4cproj-redu}(d), it cannot be the case that both $f_1$ and $f_2$ are $5$-faces whose only incident vertex
of degree at least $5$ is $v$, and thus either $f_1$ or $f_2$ sends $1/6$ to $g$ by (R3).  The total amount sent to $g$
is at least $2/3+2\times 1/6=1$.
In all the cases, the final charge of $g$ is at least $\initch(g)+1=0$.

Finally, let $f$ be a face of length at least $5$.  If $|f|\ge 6$, then $\finch(f)\ge \initch(f)-|f|/3=\frac{2}{3}|f|-4\ge 0$
by (R2) and (R3).  Hence, suppose that $|f|=5$.  If $f$ sends at most $1/6$ to each incident $3$-face by (R2), then
$\finch(f)\ge \initch(f)-5/6>0$.  Hence, suppose that $f$ sends $1/3$ to an incident $3$-face $g$ with $r(g)=0$ by (R2).
By Lemma~\ref{lemma:no4cproj-redu}(c), not all vertices incident with $f$ have degree $4$.  Let $v_1v_2v_3v_4v_5$ be the boundary
walk of $f$, where $\deg(v_5)\ge 5$.  If at least one of $v_1$, \ldots, $v_4$ has degree at least $5$, then
$f$ sends at most $\max(2\times 1/3+2\times 1/6, 1/3+4\times 1/6)=1$ by (R2) and (R3), and $\finch(f)\ge \initch(f)-1=0$.
Hence, suppose that $\deg(v_1)=\ldots=\deg(v_4)=4$.  Let $g_1$ and $g_2$ be the faces sharing edges $v_1v_5$ and $v_4v_5$ with $f$,
respectively.  If $f$ sends charge to neither $g_1$ nor $g_2$ by (R3), then $f$ sends at most $3\times 1/3$ by (R2) and (R3),
and $\finch(f)\ge \initch(f)-1=0$.  By symmetry, we can assume that $f$ sends positive amount of charge to $g_1$, and thus $g_1$
is a $3$-face with $r(g_1)=1$.  Since the only vertex incident with $f$ of degree at least $5$ is $v_5$, the rule (R3)
applies only if $\deg(v_5)=5$.  However, this is not possible by Lemma~\ref{lemma:no4cproj-redu}(c).
\end{proof}

In the next section, we explain how we came up with the reducible configurations and arcane-looking rules (R1)--(R3).
However, before that, let us comment on errors that often appear in proofs (even in some published ones) using the method of reducible
configurations.

\subsection{Common errors}\label{ssec:errors}

Dealing with planar graphs or graphs embedded on other surfaces has an advantage of easy visualisation.
The disadvantage is the ease of drawing missleading pictures.

\begin{figure}
\begin{center}
\begin{asy}
v[0]=(0,0);
v[1]=v[0]+3dir(120);
v[2]=v[0]+3dir(60);
v[3]=v[0]+1.5dir(105);
v[4]=v[0]+1.5dir(75);
draw(v[0]--v[1]--v[2]--v[0]--v[3]--v[4]--cycle);
for (i = 0; i < 5; ++i)
  vertex(v[i]);
label ("$v_1=v_4$", v[0], S);
label ("$v_2$", v[1], NW);
label ("$v_3$", v[2], NE);
label ("$v_5$", v[4], NE);
label ("$v_6$", v[3], NW);

label ("$f$", v[0] + 2dir(90));
\end{asy}
\end{center}
\caption{A face not bounded by a cycle.}\label{fig:noncycface}
\end{figure}

A common source of errors is the assumption that faces must be bounded by cycles.  Even excluding faces with disconnected boundary,
this is not necessarily the case; e.g., a $6$-face $f$ may be bounded by walk $v_1\ldots v_6$ with $v_1=v_4$, see Figure~\ref{fig:noncycface}.
When coloring graphs without $6$-cycles, it would therefore be wrong to argue that such graphs do not have $6$-faces and skip their
discussion in the discharging\footnote{We skipped the discussion of $4$-faces in our proof of Theorem~\ref{thm:no4cproj}, which
we suspect did not bother the reader till now.  In our case, this is actually safe---if $v_1v_2v_3v_4$ is a boundary walk of a $4$-face
and say $v_1=v_3$, then since the graphs we consider do not have parallel edges, it must actually be that $v_1v_2$ and $v_2v_3$
is the same edge incident twice and consecutively with the face, and thus $v_2$ would have degree $1$, which is excluded by Lemma~\ref{lemma:no4cproj-redu}(b).}.

The usual way to deal with this issue is to argue that the considered hypothetical minimal counterexample must be $2$-connected
(which is often easy, as we will see in later examples).  In plane graphs, this is equivalent with the statement that all faces
are bounded by cycles.  However, in graphs embedded in other surfaces, this is not true---there exist $2$-connected graphs
drawn with representativity $1$---and thus one needs to be more careful and consider the existence of faces not bounded by cycles
both in the discharging and the discussion of reducible configurations.

On a related note, one often sees formulations like ``if a vertex $v$ is incident with a face $f$ satisfying some conditions,
then $v$ sends $x$ units of charge to $f$'' in the discharging rules.  Unless $f$ is bounded by a cycle, this is ambiguous;
if $v$ appears $k$ times in the boundary walk of $f$, does $v$ send $x$ or $kx$ units of charge to $f$?  Almost always the latter
is the correct interpretation, and this is actually rarely a source of substantial problems with the proof, but still it is better to
be careful.

There is a similar source of (at least formal) problems in the proofs of reducibility of configurations.
It is easiest to illustrate it by an example.
Let us demonstate another reducible configuration we could have used in the proof of Theorem~\ref{thm:no4cproj}
(if it turned out those obtained in Lemma~\ref{lemma:no4cproj-redu} are not up to the task).

\begin{figure}
\begin{center}
\begin{asy}
v[1]=(0,0);
v[2]=v[1]+2dir(0);
v[3]=v[1]+2dir(60);
for (i = 0; i < 3; ++i)
  v[4+i]=v[1]+1.5dir(114) + 1.5dir(-66+(2+i)*72);
for (i = 0; i < 4; ++i)
  v[7+i]=v[2]+1.5dir(60) + 1.5dir(-120-(2+i)*60);

draw(v[1]--v[6]--v[5]--v[4]--v[3]--v[7]--v[8]--v[9]--v[10]--v[2]--v[1]--v[3]--v[2]);
outnbrs(v[1],-90,2);
outnbrs(v[2],-90,2);
outnbrs(v[4],90,2);
outnbrs(v[5],120,2);
outnbrs(v[6],180,2);
outnbrs(v[7],90,2);
outnbrs(v[8],60,2);
outnbrs(v[9],0,2);
outnbrs(v[10],-30,2);
for (i = 1; i < 11; ++i)
  vertex(v[i]);

label("$v_1$", v[1], NW);
label("$v_2$", v[2], NE);
label("$v_3$", v[3], N);
label("$x_1$", v[4], S);
label("$x_2$", v[5], SW);
label("$x_3$", v[6], S);
label("$y_1$", v[7], S);
label("$y_2$", v[8], SW);
label("$y_3$", v[9], W);
label("$y_4$", v[10], NW);

label("$f_1$", v[1]+1.5dir(114));
label("$f_2$", v[2]+1.5dir(60));
\end{asy}
\end{center}
\caption{A configuration from Lemma~\ref{lemma:false-redu}.}\label{fig:false-redu-nf}
\end{figure}

\begin{lemma}\label{lemma:false-redu}
Let $G$ be a graph with no $4$-cycles drawn in the projective plane, such that every projective-planar graph
with no $4$-cycles and with fewer than $|V(G)|$ vertices is $4$-colorable, but $G$ itself is not $4$-colorable.
Let $g$ be a $3$-face of $G$ bounded by a cycle $v_1v_2v_3$, where $\deg(v_1)=\deg(v_2)=5$ and $\deg(v_3)=4$.
If the edge $v_1v_3$ is incident with a $5$-face $f_1$ and the edge $v_2v_3$ is incident with a $6$-face $f_2$,
then at least one vertex incident with $f_1$ or $f_2$ distinct from $v_1$ and $v_2$ has degree at least $5$.
\end{lemma}
\begin{proof}[A flawed proof]
Similarly to the proof of Lemma~\ref{lemma:no4cproj-redu}(c), we argue that $f_1$ and $f_2$ are bounded by cycles,
say $v_1v_3x_1x_2x_3$ and $v_2v_3y_1y_2y_3y_4$, respectively; see Figure~\ref{fig:false-redu-nf}.  By the assumptions, there exists a $4$-coloring $\varphi$
of the subgraph of $G$ obtained by removing vertices incident with $f_1$ and $f_2$.
For each vertex $x$ incident with $f_1$ or $f_2$, let $L(x)$ denote the subset of $[4]$ consisting of the colors not
appearing on the neighbors of $x$ in the coloring $\varphi$; we have $|L(x)|\ge 2$ for all such vertices except for $v_3$,
which has $L(v_3)=[4]$.  We now need to extend $\varphi$ by coloring the vertices from the lists given by $L$.

If there exists a color $c\in L(v_1)$ such that $|L(v_2)\setminus \{c\}|\ge 2$, then color $v_1$ by $c$, color
$x_3$, $x_2$, and $x_1$ greedily in order, and remove $c$ and the color of $x_1$ from the list of $v_3$.  It is
easy to see that the $6$-cycle bounding $f_2$ can be colored from the resulting lists of size at least two.

Hence, we can assume that there exists no such color, and thus $v_1$ and $v_2$ have the same list of size two, say $L(v_1)=L(v_2)=\{1,2\}$.
Remove the colors $1$ and $2$ from the list of $v_3$ and note that we can color the $10$-cycle $v_1x_3x_2x_1v_3y_1y_2y_3y_4v_2$ (ignoring the now
irrelevant edges $v_1v_3$ and $v_2v_3$) from the resulting lists of size at least two.
\end{proof}
Did you spot the error?  The problem is that it might be the case that $x_2=y_3$ and the lists $L$ obtained in the first paragraph
of the ``proof'' might be the ones depicted in Figure~\ref{fig:false-redu-flaw}---it is easy to see that there is no proper coloring
from these lists.  This kind of omissions is quite common in the literature.

Let us remark that even if we assumed that $f_1$ and $f_2$ only share the vertex $v_3$, we would still need to additionally discuss
possible edges between the incident vertices (e.g, there might be an edge joining $x_2$ and $y_2$), which also changes the subgraph
to that we extend the coloring $\varphi$.

\section{How to find the rules?}\label{sec:rules}

In this section, let us give a semi-fictional story\footnote{The actual story had a bit more of a trial-and-error,
including introduction of a reducible configuration that we did not use in the end and a last-minute change
in the discharging rules to match what we ended up describing in this section; but the cleaner version
should hopefully be instructive enough.} of how we came up with the reducible configurations
and rules from the proof of Theorem~\ref{thm:no4cproj}.  At this point, we will give relatively little attention to the
issue of how to recognize a reducible configuration, as this will be discussed in more detail in Section~\ref{sec:howto-redu}.

\begin{figure}
\begin{center}
\begin{asy}
v[1]=(0,0);
v[2]=v[1]+2dir(0);
v[3]=v[1]+2dir(60);
for (i = 0; i < 3; ++i)
  v[4+i]=v[1]+1.5dir(114) + 1.5dir(-66+(2+i)*72);
v[7]=v[2]+1.5dir(60) + 1.5dir(-240)+(0,-1);
v[8]=v[2]+1.5dir(60) + 1.5dir(-120-3*60)+(-0.5,0);
for (i = 2; i < 4; ++i)
  v[7+i]=v[2]+1.5dir(60) + 1.5dir(-120-(2+i)*60);
v[11] = (1,4.5);

draw(v[1]--v[6]{dir(120)}..v[11]--v[4]--v[3]--v[7]--v[8]--v[11]{dir(20)}..v[10]--v[2]--v[1]--v[3]--v[2]);
outnbrs(v[1],-90,2);
outnbrs(v[2],-90,2);
outnbrs(v[4],0,2);
outnbrs(v[6],225,2);
outnbrs(v[7],90,2);
outnbrs(v[8],180,2);
outnbrs(v[10],-60,2);
for (i = 1; i <= 11; ++i)
  if (i != 5 && i != 9)
    vertex(v[i]);

label("$f_1$", v[1]+1.5dir(114));
label("$f_2$", v[2]+1.5dir(60));

label(scale(0.8)*Label("12"), v[1], NW);
label(scale(0.8)*Label("12"), v[2], NE);
label(scale(0.8)*Label("1234"), v[3], N);
label(scale(0.8)*Label("34"), v[4], W);
label(scale(0.8)*Label("12"), v[6], NE);
label(scale(0.8)*Label("34"), v[7], S);
label(scale(0.8)*Label("34"), v[8], E);
label(scale(0.8)*Label("12"), v[10], NW);
label(scale(0.8)*Label("1234"), v[11], N);
\end{asy}
\end{center}
\caption{The problem with the proof of Lemma~\ref{lemma:false-redu}.}\label{fig:false-redu-flaw}
\end{figure}

Let us consider a minimal counterexample $G$ to Theorem~\ref{thm:no4cproj}.
We start with the obvious observation that since we are $4$-coloring the graph, $G$ has minimum degree at least $4$.
Furthermore, since $G$ has no $4$-cycles, all its faces have length $3$ or at least $5$ (at this stage, we can just
ignore the issues raised in Subsection~\ref{ssec:errors}, as long as we remember to consider them in the final proof).
Considering the options from Lemma~\ref{lemma:initch}, it is natural to assign charge $\deg(v)-4$ to each vertex $v$
and $|f|-4$ to each face $f$, so that the negative charge appears only on $3$-faces.

Since $G$ contains no $4$-cycles, each face $f$ sharing an edge with a $3$-face $g$ must have length at least $5$, and thus it has positive charge.
As $g$ is incident with three such faces, it is natural to discharge $g$ by sending $1/3$ from each such face, giving
us the following precursor of rules (R2) and (R3):
\begin{itemize}
\item[(R2')] If a face $f$ shares an edge with a $3$-face $g$, then $f$ sends $1/3$ to $g$.
\end{itemize}
We did not do anything with the (nonnegative) charges of vertices, (R2') was designed to make charge of triangles $0$,
and if $f$ is a face of length at least $6$, then its charge decreases by at most $|f|/3$ using rule (R2'),
giving its final charge at least $|f|-4-|f|/3\ge 0$.

Hence, the only place where we now have negative charges are $5$-faces---the extreme case being a $5$-face $f$ sharing
edges with five $3$-faces $g_1$, \ldots, $g_5$, which now has charge $-2/3$.  We still have positive charge on vertices
whose degree is at least $5$; but if there is no such vertex incident with $f$ or $g_1$, \ldots, $g_5$, it would be difficult
to formulate a rule to redirect this charge to $f$.  So, let us try to find a reducible configuration in the case that
all vertices incident with $f$, $g_1$, \ldots, $g_5$ have degree $4$.  Now, using Corollary~\ref{cor:gallai1}, we see that
any $2$-connected subgraph consisting of vertices of degree $4$ different from an odd cycle or a clique is reducible.  Thus, we need even
less to find a reducible configuration: a $5$-face $f$ sharing an edge with a $3$-face $g$ such that all vertices incident with $f$
and $g$ have degree $4$.  We will refer to this configuration (a special case of the configuration from Lemma~\ref{lemma:no4cproj-redu}(c))
as (c').

So, in the discussed situation of a $5$-face $f$ sharing edge with $3$-faces $g_1$, \ldots, $g_5$, we know that either $f$
or all of $g_1$, \ldots, $g_5$ are incident with a $(\ge\!5)$-vertex, and we need to move its charge somehow to $f$.
There are multiple semi-equivalent ways how to achieve that in the rules: we could write a rule directly moving the charge from
the vertex to $f$; or, as we decided to do in our proof of Theorem~\ref{thm:no4cproj}, we can move this charge to the incident
triangle, and then decrease the amount of charge that needs to be sent to $3$-faces from incident faces. Which choice leads to
simpler analysis depends on circumstances (and the personal preference) and typically needs a bit of an experimentation.

Anyway, let us go with our choice to send the charge from vertices of degree at least $5$ to incident $3$-faces first.
How much charge can we send? Vertex of degree $5$ has charge $1$ and can be incident with up to two $3$-faces,
so sending $1/2$ is a safe option (this will leave positive charge on vertices of larger degree, which we may find
useful later).
\begin{itemize}
\item[(R1')] A vertex $v$ of degree at least $5$ incident with a $3$-face $g$ sends $1/2$ to $g$.
\end{itemize}
A $3$-face $g$ with $r(g)\ge 2$ now has non-negative charge, and thus we do not need to send it anything more.
A $3$-face $g$ with $r(g)=0$ is unaffected and thus we keep the rule (R2') for such faces unchanged.
The interesting case is a $3$-face $g$ with $r(g)=1$, bounded by a $3$-cycle $v_1v_2v_3$ with $\deg(v_3)\ge 5$.
After executing (R1'), this face has charge $-1/2$, which we need to obtain from the neighboring faces.
Unlike the case $r(g)=0$, the situation is not symmetric---it may be useful to send different amounts of charge
across the edge $v_1v_2$ and across the edges incident with $v_3$.  But since at the moment we do not have
much idea what amounts would be appropriate, let us go with the symmetric option for now, and let us
replace (R2') by the following rule.
\begin{itemize}
\item[(R2'')] If a face $f$ shares an edge with a $3$-face $g$, then $f$ sends $\max(2-r(g),0)/6$ to $g$.
\end{itemize}
Now, if a $5$-face $f$ is incident with at least two vertices of degree at least $5$, then $f$ sends
at most $\max\bigl(2\times \frac{1}{3}+2\times\frac{1}{6},\frac{1}{3}+4\times\frac{1}{6}\bigr)=1$
by (R2''), and the final charge of $f$ is non-negative.  If all vertices incident with $f$ have degree $4$,
then by (c') $f$ cannot share an edge with a face $g$ with $r(g)=0$, and thus $f$ sends at most $5/6$ by (R2'').
Hence, suppose that $f$ is bounded by the cycle $v_1\ldots v_5$ with $\deg(v_5)\ge 5$ and $\deg(v_1)=\ldots=\deg(v_4)$.
Then $f$ may send $3\times \frac{1}{3}$ over edges $v_1v_2$, $v_2v_3$, and $v_3v_4$ by (R2''), and if
say the edge $v_1v_5$ is shared with a $3$-face $g$ with $r(g)=1$, then sending $1/6$ to $g$ will make the charge
of $f$ negative; let us call this situation \emph{the light $5$-face}.

We now have two options: modify rule (R2'') to deal with this situation, or to try to find another reducible configuration.
The former turns out to be a bad idea (if $g$ did not receive any charge from $f$, it might for the same reason
not be able to receive any charge across its other edge incident with $v_5$, and thus it would have to receive charge
$1/2$ from the third face $f'$ with that it shares an edge, which would likely lead to shortage of charge in $f'$).
So, we try to work out whether the configuration we now have (a $5$-face with exactly one vertex $v_5$ of degree greater than $4$,
such that one edge of $f$ incident with $v_5$ is shared with a $3$-face $g$ satisfying $r(g)=1$) is reducible.
And we saw in Lemma~\ref{lemma:no4cproj-redu}(c), this turns out to be the case when $\deg(v_5)=5$.

Hence, suppose that $\deg(v_5)\ge 6$.  In this case we are not able to find a reducible configuration, but we have some
extra charge to use.  If $\deg(v_5)\ge 7$, then $v_5$ has at least $1$ unit of charge available
per incident $3$-face, and thus it can fully cover the charge of all such $3$-faces and $f$ does not need to send them anything.
Similarly, we can discharge the case that $\deg(v_5)=6$ and $v_5$ is incident with at most two $3$-faces,
or $\deg(v_5)=6$ and $v_5$ is incident with three $3$-faces, but only one $3$-face $g$ satisfying $r(g)=1$.

However, if $\deg(v_5)=6$ and $v_5$ is incident with three $3$-faces, such that at least two of them (say $g$ and $g_1$)
satisfy $r(g)=r(g_1)=1$, then $v_5$ does not have enough charge to cover the triangles by itself.
Let $v_1v_5v'_1$ be the triangle bounding $g$.  Worst-case, $v_5$ may be only able to send $2/3$ to $g$, and
$g$ will receive $1/6$ across the edge $v_1v'_1$, so we still lack $1/6$.  We could modify the rules to only take $1/12$
from $f$ and the face across the edge $v_5v'_1$, but this does not help in the light $5$-face case, so we need to
try to redistribute the charge in another way.

We could increase the amount of charge received from the face $f'$ that shares the edge $v_1v'_1$ with $g$ to $1/3$, but that would
be problematic at $f'$ (what if $f'$ shares edges with four such triangles incident with vertices of degree $6$?).
Or, we can try to take whole missing amount $1/6$ from the face $f''$ with that $g$ shares the edge $v_5v'_1$;
but this would again fail if $f''$ also forms the light $5$-face configuration.  As discharging does not seem possible,
it would be nice to find another reducible configuration in one of these cases.  In the former one, we did not succeed,
but fortunately the latter one gave us the reducible configuration described in Lemma~\ref{lemma:no4cproj-redu}(d), once
we recalled that $v_5$ must also be incident with another $3$-face $g_1$ with $r(g_1)=3$.

Rules (R1), (R2), and (R3) are now just a summary of what we decided to do in the last few paragraphs.
Of course, at this point one needs to again go over all the cases and check the altered rules indeed
discharge all the vertices and faces; and in more complicated proofs, further iterations of tweaking the rules
and adding reducible configurations may be needed.

\subsection{Discharging rules and linear programming}\label{ssec:dischlp}

Of course, in more complicated proofs, it may become hard to guess what the right amounts of charge to
transfer are, and time consuming to keep track of charges of all the arrangements of vertices and faces
when the discharging rules change.  In such a situation, it may be useful to use a computer-assisted approach
to find the amounts via linear programming.  Let us demonstrate this technique again using the setting
of Theorem~\ref{thm:no4cproj}.

Suppose that we are again at the point of the proof where we do not yet have any reducible configurations
(beyond noting that a minimal counterexample must have minimum degree at least $4$)
and we just decided to assign the initial charge $\initch$ to vertices and faces as described before.
We need to discharge triangles, and let us guess that the amount of charge sent from each face $f$ to a $3$-face $g$
with that $f$ shares an edge $uv$ will only depend on the degrees of $u$, $v$, and the third vertex $w$ incident with $g$,
where no disctinction will
be made between vertices of degree say $7$ and larger degrees.  Thus, for all triples $a,b,c\in\{4,5,6,{\ge\!7}\}$,
we introduce a variable $x_{abc}$, denoting the amount of charge $f$ sends to $g$ if the degree of $u$ is $a$, the degree of $v$ is $b$,
and the degree of $w$ is $c$ (to reduce the number of variables, we can of course by symmetry assume $a\le b$).
Let us also guess that it will suffice to distribute the charge of vertices of degree at least $5$ evenly
among the incident $3$-faces, so vertices of degree $5$, $6$, and $\ge\!7$ will send at least $1/2$, $2/3$, and $1$ to incident triangles,
respectively.

For each type of a $3$-face (determined by the degrees of its vertices), we now introduce linear constraints
describing that its final charge after performing the discharging should be non-negative.  For example, a $3$-face
incident with vertices of degrees $4$, $4$, and $5$ will receive charge $1/2$ from the vertex of degree $5$ and
$x_{445}+2x_{454}$ from the incident faces, and thus we need
$$x_{445}+2x_{454}-1/2=-1+x_{445}+2x_{454}+1/2\ge 0.$$

Next, we need to set up the inequalities for other faces.  A face of length at least $6$ may send up to $1/3$ per edge,
so let us add constraints
$$x_{abc}\le 1/3$$
for all $a,b,c\in\{4,5,6,{\ge\!7}\}$.
For $5$-faces, we will add inequalities for all possible types, depending on the degrees of incident vertices, whether
the edges are incident with $3$-faces, and in case they are, on the degrees of their vertices not incident with the $5$-face.
For example, for a $5$-face bounded by a cycle $v_1\ldots v_5$ of vertices of degree $4$, where each edge $v_iv_{i+1}$ is incident with
a triangle $g_i$, such that say $r(g_1)=r(g_2)=r(g_3)=0$, $g_4$ is incident with a vertex of degree $5$, and $g_5$ is incident with
a vertex of degree $6$, we get the inequality
$$1-3x_{444}-x_{445}-x_{446}\ge 0.$$

If the described linear program was feasible, a solution would give us amounts of charge for each rule.
However, this turns out not to be the case.  How far we are from being able to discharge everything?
Let us introduce another variable $\varepsilon$, and let us modify the inequalities for $5$-faces by adding $\varepsilon$ to their
left-hand sides; i.e., the last inequality becomes
$$1-3x_{444}-x_{445}-x_{446}+\varepsilon\ge 0.$$
Let us now minimize $\varepsilon$ subject to these constraints---it turns out the minimum is $2/3$.  That is, we can set up the amounts
transfered by the rules so that all vertices and faces have non-negative charge, except for $5$-faces which have charge at least $-2/3$.
Let us remark that since the sum of charges in the projective planar case is $-4$, this means the hypothetical minimal counterexample
we consider must have at least six $5$-faces.

What do we need to do to get closer to discharge everything?  Let us have a look at an optimum solution for the dual of
our linear program.  It has only two non-zero variables:
\begin{itemize}
\item[(i)] the one corresponding to the inequality $1-5x_{444}+\varepsilon\ge 0$
(which comes from a $5$-face sharing edge with five $3$-faces $g$ with $r(g)=0$) has value $1$, and
\item[(ii)] the one corresponding to the inequality $-1+3x_{444}\ge 0$ (which comes from a $3$-face incident only with vertices of degree $4$) has value $5/3$.
\end{itemize}
Indeed, the corresponding linear combination gives
$$\varepsilon-2/3=1-5x_{444}+\varepsilon+\frac{5}{3}(-1+3x_{444})\ge 0.$$
In order to decrease $\varepsilon$, we need either to alter the discharging rules (so that the inequalities corresponding to
the situations (i) or (ii) are changed) or to find a reducible configuration excluding (i) or (ii).  While there does not
seem much we can do in the case (i), the case (ii) is excluded by introducing the reducible configuration (c')---a $5$-face and a $3$-face
sharing an edge and only incident with vertices of degree $4$.

Therefore, we can remove inequalities for all $5$-face types matching (c') from the linear program.
Once we do so, the minimum value for $\varepsilon$ decreases to $1/4$, and in a solution to the dual linear program,
the non-zero variables correspond to the inequalities for the following configurations:
\begin{itemize}
\item a $3$-face $g$ with $r(g)=0$,
\item a $3$-face $g$ with $r(g)=1$ incident with a vertex of degree $5$,
\item a $5$-face $f$ with all incident vertices of degree 4, such that all edges of $f$ are shared with $3$-faces
incident with a vertex of degree $5$, and
\item a $5$-face $f$ incident with a vertex of degree $5$ and all other vertices of degree $4$,
such that all edges of $f$ are shared with $3$-faces whose vertices not incident with $f$ have degree $4$.
\end{itemize}
Among these, the last subcase can be excluded using the reducible configuration given by Lemma~\ref{lemma:no4cproj-redu}(c)\footnote{The next
to last case also forms a reducible configuration, which however turned out not to be useful in the end, and so we ignore it
for the purposes of this example.}.

After introducing the configuration from Lemma~\ref{lemma:no4cproj-redu}(c) and removing the matching inequalities,
the minimum value for $\varepsilon$ decreases to $1/9$, and the dual non-zero variables correspond to the following configurations:
\begin{itemize}
\item a $3$-face $g$ with $r(g)=0$,
\item a $3$-face $g$ with $r(g)=1$ incident with a vertex of degree $6$,
\item a $5$-face $f$ with all incident vertices of degree 4, such that all edges of $f$ are shared with $3$-faces
incident with a vertex of degree $6$, and
\item a $5$-face $f$ incident with a vertex $v$ of degree $6$ and all other vertices of degree $4$,
such that all edges of $f$ are shared with $3$-faces whose vertices not incident with $f$ have degree $4$.
\end{itemize}

In the last configuration, we might suspect the vertex $v$ of degree $6$ to have some extra charge that it could send to $f$.
Let us add a rule for this, represented by variable $x_{6l}\ge 0$.  More precisely, the rule is: let $v$ be a vertex of degree $6$
incident with a $5$-face $f$ such that all other vertices incident with $f$ have degree $4$, and let $e_1$ and $e_2$
be the edges in the boundary of $f$ incident with $v$.  For $i\in\{1,2\}$, if $f$ shares the edge $e_i$ with a $3$-face $g_i$
such that $r(g_i)=1$, then $v$ sends $x_{6l}$ to $f$.  Hence, the inequality for the last configuration becomes
$1-3x_{444}-2x_{464}+2x_{6l}+\varepsilon\ge 0$.  Of course, we also need to add inequalities ensuring that the final charge
of $6$-vertices is non-negative; e.g., a $6$-vertex incident with two $3$-faces sends $2/3$ to each of them, and may also
send four times the amount $x_{6l}$, giving the inequality $2/3-4x_{6l}\ge 0$.

For a $6$-vertex $z$ incident with three $3$-faces, we observe using Lemma~\ref{lemma:no4cproj-redu}(d) that
$z$ sends at most $2x_{6l}$ by this new rule.  However, it also sends all its charge to incident $3$-faces,
and thus we need to find the charge to cover $2x_{6l}$ somewhere else.  By Lemma~\ref{lemma:no4cproj-redu}(d),
we also see that $z$ is either incident with a $(\ge\!6)$-face, or with a $5$-face incident with more than one $(\ge\!5)$-vertex,
and it is natural for such a face to cover this charge.  Since $(\ge\!6)$-faces have at least $|f|/3$ units of charge available,
for them it suffices to add inequalities $1/3-x_{abc}-2x_{6l}\ge 0$ for all $a,b,c\in\{4,5,6,{\ge\!7}\}$.  For $5$-faces,
we just add the term $-2x_{6l}$ to relevant inequalities.  See Figure~\ref{fig:dischlp} for the final linear program.

\begin{figure}
\begin{framed}
Minimize $\varepsilon$ subject to the following constraints:
\begin{align*}
x_{6l}&\ge 0\\
2x_{6l}&\le 4/3\\
4x_{6l}&\le 2/3
\end{align*}
For all $a,b,c\in\{4,5,6,{\ge\!7}\}$:
\begin{align*}
x_{abc}&=x_{bac}\\
x_{abc}+2x_{6l}&\le 1/3\\
x_{abc}+x_{bca}+x_{cab}&\ge 1-\alpha(a)-\alpha(b)-\alpha(c),
\end{align*}
where $\alpha(4)=0$, $\alpha(5)=1/2$, $\alpha(6)=2/3$, and $\alpha({\ge\!7})=1$.

For all $a_1,\ldots,a_5\in \{4,5,6,{\ge\!7}\}$ and $c_1,\ldots, c_5\in \{0,4,5,6,{\ge\!7}\}$
with $a_5\ge a_1,\ldots, a_4$ and letting $a_6=a_1$, if $a_5=6$ and $a_1=\ldots=a_4$, then
\begin{align*}
\sum_{i: c_i\neq 0} x_{a_ia_{i+1}c_i}&\le 1+\varepsilon+|\{i\in\{4,5\}:c_i=4\}|\cdot x_{6l},
\end{align*}
else if at least two of $a_1$, \ldots, $a_5$ are greater than $4$, then
\begin{align*}
2|\{i:a_i=6\}|\cdot x_{6l}+\sum_{i: c_i\neq 0} x_{a_ia_{i+1}c_i}&\le 1+\varepsilon,
\end{align*}
else if $a_5=(\ge\!7)$, or $a_5=5$ and $c_4,c_5\neq 4$, or $a_5=4$ and none of $c_1,\ldots, c_5$ is $4$, then
\begin{align*}
\sum_{i: c_i\neq 0} x_{a_ia_{i+1}c_i}&\le 1+\varepsilon.
\end{align*}
\end{framed}

\caption{Linear program discussed in Subsection~\ref{ssec:dischlp}.}\label{fig:dischlp}
\end{figure}

With these changes, the minimum value of $\varepsilon$ becomes $0$, indicating that we managed to make the final charge
of vertices and faces non-negative.  We can now read off the amounts sent by the rules from the solution to the linear program.
Let us remark that linear programming solvers usually do not work in precise arithmetics, and thus one might be concerned
about the correctness of the proof obtained this way.  It is therefore necessary to verify that the discharging rules with
the amounts obtained from the linear program (after rounding to rational numbers) work either by hand, or by writing another program
to test that all vertices and faces are discharged to a non-negative value in exact arithmetics.

Let us remark that at the end of the preceding argument, we deviated slighty from the way we organized the discharging rules
in the proof of Theorem~\ref{thm:no4cproj}, adding a rule to send charge from or through a vertex of degree 6 instead of altering
the rules for sending charge to $3$-faces.  The reader is invited to find a more faithful formulation of the linear program
as an exercise.

\section{Coloring with forbidden cycle lengths}

Given Gr\"otzsch' Theorem, it is natural to ask whether forbidding other cycle lengths is sufficient to
ensure that a planar graph is $3$-colorable.  It is easy to see that forbidding either $4$-cycles or $5$-cycles
by themselves is not sufficient.  Steinberg~\cite{conj-stein} conjectured that forbidding both $4$- and $5$-cycles
ensures that a planar graph is $3$-colorable, however this was recently disproved~\cite{steinfalse}.
On the other hand, Borodin et al.~\cite{bor47} proved that excluding cycles of lengths $4$ to $7$ is sufficient,
leaving only the case of excluded cycles of lengths $4$ to $6$ open.

Here, we consider the case of planar graphs with no cycles of lengths $4$ to $9$,
giving another example of a discharging argument.
This argument will also be used as a starting point in a presentation of an important trick in the following section.

\begin{theorem}\label{thm:no4to9}
Every planar graph with no cycles of lengths $4$ to $9$ is $3$-colorable.
\end{theorem}
\begin{proof}
For a contradiction, suppose that $G$ is a plane graph with no cycles of lengths $4$ to $9$ that is not $3$-colorable,
such that the number of vertices of $G$ is minimum.  Clearly, $G$ is connected and has minimum degree at least three.

Furthermore, $G$ is $2$-connected: otherwise, $G=G_1\cup G_2$ for proper induced subgraphs $G_1$ and $G_2$ intersecting
in a vertex $v\in V(G)$.  By the minimality of $G$, there exists a $3$-coloring $\varphi_i$ of $G_i$ for $i\in\{1,2\}$.
By permuting the colors in the coloring of $G_2$, we can assume that $\varphi_1(v)=\varphi_2(v)$.  However, then $\varphi_1$ together
with $\varphi_2$ give a $3$-coloring of $G$, which is a contradiction.

Hence, every face of $G$ is bounded by a cycle, and thus its length is either $3$ or at least $10$.
By Lemma~\ref{lemma:gallai1}, we conclude that every $10$-face of $G$ is
incident with a vertex of degree at least $4$.

Let us now assign charge $\initch(v)=\deg(v)-6$ to each vertex $v\in V(G)$ and $\initch(f)=2|f|-6$ to each face $f\in F(G)$.
By Lemma~\ref{lemma:initch}, the sum of these charges is negative, specifically $-12$.
Let us redistribute the charge according to the following rule.
\begin{itemize}
\item[(R1)] Let $v_1v_2v_3$ be a part of the boundary walk of a face $f$ of length at least $10$,
where $\deg(v_2)=3$.  If neither of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1$ to $v_2$, otherwise $f$ sends $3/2$ to $v_2$.
\item[(R2)] Let $v_1v_2v_3$ be a part of the boundary walk of a face $f$ of length at least $10$,
where $\deg(v_2)\in\{4,5\}$.  If neither of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1$ to $v_2$.  If exactly one of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1/2$ to $v_2$.  If both $v_1v_2$ and $v_2v_3$ are incident with $3$-faces, then
$f$ sends $1$ to $v_2$.
\end{itemize}
Let $\finch$ denote the final charge after these rules are performed.
Let us argue that all vertices and faces have non-negative charges, which is a contradiction since the total amount of
charge is unchanged.

Let us first consider a vertex $v\in V(G)$.  If $\deg(v)\ge 6$, then $\finch(v)=\initch(v)\ge 0$.
If $\deg(v)=5$, then since $G$ does not contain $4$-cycles, there are at most two $3$-faces incident with $v$, and
thus $v$ receives at least $3\times 1/2$ by (R2) from the incident faces and $\finch(v)\ge \initch(v)+3/2>0$.
If $\deg(v)=4$, then $v$ receives $4\times 1$, $1+2\times 1/2$, or $2\times 1$ from the incident faces by (R2)
depending on the number of incident triangles, and $\finch(v)=\initch(v)+2=0$.  Finally, if $\deg(v)=3$, then $v$ receives
$3\times 1$ if $v$ is not incident with a $3$-face and $2\times 3/2$ otherwise, and $\finch(v)=\initch(v)+3=0$.

Let us now consider a face $f\in F(G)$.  If $|f|=3$, then $\finch(f)=\initch(f)=0$.  Hence, suppose that $|f|\ge 10$.
Note that $f$ sends at most $3/2$ to each incident vertex by (R1) and (R2), and thus
$$\finch(f)\ge \initch(f)-\frac{3}{2}|f|=\frac{|f|}{2}-6.$$
If $|f|\ge 12$, this implies that $\finch(f)\ge 0$.  If $|f|=11$, note that $f$ cannot send $3/2$ to all incident
vertices (otherwise all would be vertices of degree three incident with a $3$-face, which is not possible by parity).
Hence, $f$ sends at most $1$ to one incident vertex, and $\finch(f)\ge \initch(f)-10\times 3/2-1=0$.

Finally, suppose that $|f|=10$.  If $f$ sends $3/2$ to at most $8$ incident vertices, then
$\finch(f)\ge\initch(f)-8\times 3/2-2\times 1=0$. Recall that $f$ is incident with at least
one vertex of degree at least $4$, and thus we can assume that $f$ sends $3/2$ to $9$ incident
vertices.  Hence, we can label the vertices of the cycle bounding $f$ as $v_1v_2\ldots v_{10}$
so that $v_2$ is the unique vertex of degree at least $4$ incident with $f$ and the edges $v_2v_3$, $v_4v_5$,
\ldots, $v_{10}v_1$ are incident with triangles.  By (R2), $f$ sends at most $1/2$ to $v_2$, and thus
$\finch(f)=\ge\initch(f)-9\times 3/2-1/2=0$.
\end{proof}

\section{Trick: A Precolored Face}\label{sec:precolface}

We would now like to improve Theorem~\ref{thm:no4to9} by allowing $9$-faces in the graph.
With no further reducible configurations, the discharging phase of course fails for $9$-faces.
The worst case is a $9$-face $f$ bounded by a cycle $v_1v_2\ldots v_9$ with all
incident vertices of degree three and edges $v_1v_2$, $v_3v_4$, $v_5v_6$, and $v_7v_8$
incident with $3$-faces (for $i\in \{1,3,5,7,9\}$, let $x_i$ denote the neighbor of $v_i$
not incident with $f$); the final charge of such a face according to the discharging rules
(R1) and (R2) is $12-8\times 3/2-1=-1$.

One could wonder whether such a $9$-face does not
form a reducible configuration; however, just removing the incident vertices does not work---letting $G'=G-\{v_1,\ldots, v_9\}$,
a $3$-coloring of $G'$ in that $x_1$, $x_3$, \ldots, and $x_9$ happen to have the same color does not extend to
a $3$-coloring of $G$.  But, this is the only bad situation, as it is easy to see that if at least two different colors
appear on these vertices, then the coloring extends to $G$.  So, perhaps instead of considering $G'$, we could
consider the graph obtained from $G'$ by adding say the edge $x_1x_5$?  Any $3$-coloring of $G'+x_1x_5$ indeed extends to
a $3$-coloring of $G$, but adding the edge $x_1x_5$ might create a cycle of length $4$ to $8$, and thus
it might be the case that $G'+x_1x_5$ is not $3$-colorable without contradicting the minimality of the counterexample $G$
(in the final proof, we will actually use a more general reducible configuration, whose reduction however faces the
same difficulty).

The presence of such a cycle in $G'+x_1x_5$ would mean that $x_1$ and $x_5$ are joined by a path of length $3$ to $7$ in $G'$,
and this path together with the path $x_1v_2v_3v_4v_5x_5$ forms a cycle $C$ of length $8$ to $12$ in $G$.  It is also
easy to see that $C$ is a separating cycle (at least one vertex of $G$ appears both inside and outside of $C$).
If we were to show that such a separating cycle cannot appear in a minimal counterexample, this difficulty would go away.

A natural way of dealing with a separating cycle $C$ is to first color the part of $G$ outside of $C$, and then
extend the corresponding precoloring of $C$ to the subgraph of $G$ drawn inside $C$.
Of course, we need to prove that the last part is possible, forcing us to prove
a stronger statement with the precolored cycle.  This idea (which we will demonstrate momentarily, as well
as again in Section~\ref{sec:disch-grotzsch}) turns out to be very useful in many arguments to extend
the set of available reducible configurations.

Let us now proceed with the example.  Let us say that a plane graph $G$ is a \emph{counterexample}
if $G$ contains no cycles of lengths $4$ to $8$, its outer face is bounded
by a cycle $C$ of length at most $12$ and some $3$-coloring of $G[V(C)]$ does not extend to a $3$-coloring of $G$.
We aim to show that no counterexample exists; this indeed suffices to establish our claim.

\begin{lemma}\label{lemma:no4to8-exce}
Let $G$ be a plane graph with no cycles of lengths $4$ to $8$.  If $G$ is not $3$-colorable,
then there exists a counterexample with at most $|V(G)|$ vertices.
\end{lemma}
\begin{proof}
By Theorem~\ref{thm:no4to9}, $G$ contains a cycle $C$ of length $9$, which is necessarily induced.
Let $G'$ and $G''$ be the subgraphs of $G$ drawn inside and outside of $C$, respectively
(more precisely, let $G'$ be the subgraph of $G$ drawn in the closed disk $\Delta$ bounded by $C$, and let $G''$ be the
subgraph of $G$ drawn in the closure of the complement of $\Delta$).
Let $\psi$ be an arbitrary precoloring of $C$.  Since $G$ is not $3$-colorable,
$\psi$ does not extend to a $3$-coloring of either $G'$ or $G''$. By symmetry, we can assume the former,
and thus $G'$ is a counterexample.
\end{proof}

Let us start by showing some properties of a hypothetical minimal counterexample.

\begin{lemma}\label{lemma:no4to8-prop}
Let $G$ be a counterexample with $|V(G)|+|E(G)|$ the smallest possible.  Then $G$ is $2$-connected,
and the cycle $C$ bounding its outer face is induced.  Furthermore, if $K$ is a cycle
of length at most $12$ in $G$ distinct from $C$, then the open disk bounded by $K$ contains no
vertices, and if $uv$ and $uw$ are two chords of $K$ incident with the same vertex $u$,
then $vw\not\in E(G)$.
\end{lemma}
\begin{proof}
Let $\psi$ be a $3$-coloring of $G[V(C)]$ that does not extend to a $3$-coloring of $G$.
If $C$ were not induced and $e$ were a chord of $C$, then $\psi$ would not extend to a $3$-coloring of $G-e$
either and $G-e$ would be a counterexample contradicting the minimality of $G$.  Hence, $C$ is an induced
cycle.

If $G$ is not $2$-connected, then let $G_1$ and $G_2$ be proper induced subgraphs of $G$
such that $G=G_1\cup G_2$ and $G_1$ and $G_2$ intersect in at most one vertex, and $C\subseteq G_1$.
By the minimality of $G$ and Lemma~\ref{lemma:no4to8-exce}, we conclude that $\psi$ extends to a $3$-coloring $\varphi_1$ of $G_1$
and that $G_2$ has a $3$-coloring $\varphi_2$.  However, we can permute the colors in $\varphi_2$ so that $\varphi_1$ and $\varphi_2$
assign the same color to the vertex in the intersection of $G_1$ and $G_2$ (if any), and thus the combination of $\varphi_1$
and $\varphi_2$ would give a $3$-coloring of $G$ extending $\psi$.  This is a contradiction, showing that $G$ is $2$-connected.

Suppose that $K$ is a cycle of length at most $12$ in $G$ distinct from $C$ and the open disk $\Lambda$ bounded by $K$ contains some
vertex.  Let $G_1$ be the subgraph obtained from $G$ by removing all vertices drawn in $\Lambda$, and let $G_2$ be the subgraph
of $G$ drawn in the closure of $\Lambda$ (hence, $G_1$ and $G_2$ intersect in $K$ and the chords of $K$ drawn in $\Lambda$).
By the minimality of $G$, we conclude that $\psi$ extends to a $3$-coloring of $G_1$, and that the resulting $3$-coloring of $K$
extends to a $3$-coloring of $G_2$, which gives a $3$-coloring of $G$ that extends $\psi$.  This is a contradiction,
showing that $\Lambda$ contains no vertices.

Finally, consider chords $uv$ and $uw$ of $K$ drawn in $\Lambda$.  Note that the shortest cycle in $K+uv$ has length
at most $\frac{|K|+2}{2}\le 7$, and since $G$ does not contain cycles of lengths $4$ to $8$, it follows that $uv$ is incident
with a triangle $T$ in $K+uv$.  If $vw\in E(G)$, then $uvw$ would be a triangle distinct from $T$ (since $uw$ is a chord of $K$),
and the union of the two triangles would contain a $4$-cycle, which is a contradiction.  Hence, $vw\not\in E(G)$.
\end{proof}

\begin{figure}
\begin{center}
\begin{asy}
v[0]=(0,0);
v[1]=(1,0.5);
v[2]=(2,0.5);
v[3]=(3,0.5);
v[4]=(4,0.5);
v[5]=(5,0);
v[6]=(1.5,1.5);
v[7]=(3.5,1.5);

draw(v[0]--v[1]--v[2]--v[3]--v[4]--v[5]);
draw(v[1]--v[6]--v[2]);
draw(v[3]--v[7]--v[4]);

for (i = 1; i <= 4; ++i)
  vertex(v[i]);
vertex(v[0],black);
vertex(v[5],black);
vertex(v[6],black);
vertex(v[7],black);

label("$v_0$", v[0],S);
label("$v_1$", v[1],S);
label("$v_2$", v[2],S);
label("$v_3$", v[3],S);
label("$v_4$", v[4],S);
label("$v_5$", v[5],S);
label("$x$", v[6],N);
label("$y$", v[7],N);
\end{asy}
\end{center}
\caption{A tetrad.}\label{fig:tetrad}
\end{figure}

Next, we establish reducible configurations.  Let \emph{tetrad} denote a path of four vertices $v_1v_2v_3v_4$ of degree three
contained in a boundary of a face, such that edges $v_1v_2$ and $v_3v_4$ are incident with $3$-faces; see Figure~\ref{fig:tetrad}.
To reduce tetrads, we use the precolored cycle trick.

\begin{lemma}\label{lemma:no4to8-redu}
Let $G$ be a counterexample with $|V(G)|+|E(G)|$ the smallest possible, and let $C$ be the cycle bounding the outer face of $G$.
Then vertices of $G$ not belonging to $C$ have degree at least three, and $G$ contains no 
tetrad vertex-disjoint from $C$.
\end{lemma}
\begin{proof}
Let $\psi$ be a $3$-coloring of $C$ that does not extend to a $3$-coloring of $G$.
The minimality of $G$ clearly implies that $G$ contains no vertices of degree at most two not belonging to $C$.
Hence, suppose for a contradiction that $v_0v_1v_2v_3v_4v_5$ is a path contained in a boundary of a face, such that $v_1v_2v_3v_4$ is a tetrad.
Let $x$ be the common neighbor of $v_1$ and $v_2$, and let $y$ be the common neighbor of $v_3$ and $v_4$.

Let $G'=G-\{v_1,v_2,v_3,v_4\}$.  If $G'$ contains a path $P$ of length at most $8$ between $v_0$ and $y$, then
$P$ together with the path $v_0v_1v_2v_3y$ is a cycle $K$ of length at most $12$ in $G$.  Let $\Lambda$ be the open disk bounded by
$K$, and note that either the edge $v_3v_4$ or the edges $v_1x$ and $v_2x$ are contained in $\Lambda$.  The former
is not possible, as otherwise $\Lambda$ would contain the vertex $v_4$, contradicting Lemma~\ref{lemma:no4to8-prop}.
The latter is not possible either, as then either $\Lambda$ would contain the vertex $x$ or $K$ would have chords
$v_1x$ and $v_2x$ with $v_1v_2\in E(G)$, again contradicting Lemma~\ref{lemma:no4to8-prop}.
Hence, $G'$ contains no such path $P$.  Let $d_0$ and $d_y$ denote the distance from $v_0$ and $y$ to $C$ in $G'$, respectively.
Since $|C|\le 12$, any two vertices of $C$ are joined by a path of length at most $6$ in $C$, and thus $d_0+d_y\ge 3$.

Let $G''$ be the graph obtained from $G'$ by identifying $v_0$ with $y$.  By the previous paragraph,
$G''$ does not contain any cycle of lengths $4$ to $8$.  Furthermore, since $d_0+d_y\ge 3$, at most one of $v_0$ and $y$ belongs
to $C$ and if one does, the other one has no neighbors in $C$, and thus $C$ is an induced cycle in $G''$.  By the minimality of $G$, there exists a $3$-coloring of $G''$ that extends $\psi$,
and thus there exists a $3$-coloring $\varphi$ of $G'$ that extends $\psi$ such that $\varphi(v_0)=\varphi(y)$.
Next, extend $\varphi$ greedily to $v_4$ and $v_3$ in order, and note that $\varphi(v_3)\neq \varphi(v_0)$.
If $\varphi(x)=\varphi(v_0)$, then we can extend $\varphi$ to $v_2$ and $v_1$ greedily in order,
and if $\varphi(x)=\varphi(v_3)$, then we can extend $\varphi$ to $v_1$ and $v_2$ greedily in order.
Finally, if $\varphi(v_0)\neq \varphi(x)\neq\varphi(v_3)$, then we can give $v_1$ the color $\varphi(v_3)$
and $v_2$ the color $\varphi(v_0)$.  In any case, we conclude that $\psi$ extends to a $3$-coloring of $G$, which is a contradiction.
\end{proof}

Note that the some configurations that are reducible in general cease to be reducible when intersecting
the precolored cycle $C$.  Consequently, the discharging phase of the argument may need to leave some negative charge on vertices of $C$.
This will be compensated by the fact that the sum of initial charges is not just negative, but actually at most $-12$.

Let $G$ be a plane graph with outer face bounded by a cycle $C$.  We say that a vertex $v$ is \emph{light} if $v\not\in V(C)$,
$v$ has degree three, and $v$ is incident with a triangle.

\begin{theorem}\label{thm:no4to8}
Every planar graph with no cycles of lengths $4$ to $8$ is $3$-colorable.
\end{theorem}
\begin{proof}
For a contradiction, suppose this is not the case, and thus by Lemma~\ref{lemma:no4to8-exce},
there exists a counterexample.  Let $G$ be a counterexample with $|V(G)|+|E(G)|$ the smallest possible.
By Lemma~\ref{lemma:no4to8-prop}, $G$ is $2$-connected (hence every face of $G$ is bounded by a cycle of length
either $3$ or at least $9$), and the outer face of $G$ is bounded by an induced cycle
$C$ of length at most $12$.  By Lemma~\ref{lemma:no4to8-redu}, vertices of $G$ not belonging to $C$ have degree at least three.

Let us now assign charge $\initch(v)=\deg(v)-6$ to each vertex $v\in V(G)$ and $\initch(f)=2|f|-6$ to each face $f\in F(G)$.
By Lemma~\ref{lemma:initch}, the sum of these charges is negative, specifically $-12$.
Let us redistribute the charge according to the following rule.
\begin{itemize}
\item[(R0)] Each non-outer face of length at least $9$ incident with a vertex $v\in V(C)$ sends $3/2$ to $v$ if $\deg(v)=2$ and $3/4$ to $v$ if $\deg(v)=3$.
\item[(R1)] Let $v_1v_2v_3$ be a part of the boundary walk of a face $f$ of length at least $9$,
where $\deg(v_2)=3$ and $v_2\not\in V(C)$.  If neither of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1$ to $v_2$, otherwise $f$ sends $3/2$ to $v_2$.
\item[(R2)] Let $v_1v_2v_3$ be a part of the boundary walk of a face $f$ of length at least $9$,
where $\deg(v_2)\in\{4,5\}$ and $v_2\not\in V(C)$.  If neither of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1$ to $v_2$.  If exactly one of the edges $v_1v_2$ and $v_2v_3$ is incident with a $3$-face,
then $f$ sends $1/2$ to $v_2$.  If both $v_1v_2$ and $v_2v_3$ are incident with $3$-faces, then
$f$ sends $1$ to $v_2$.
\end{itemize}
Let $\finch$ denote the final charge after these rules are performed.
Let us first argue that all vertices not in $C$ and all faces except for the outer one have non-negative charge.
If $v$ is a vertex not belonging to $V(C)$, then the rules (R1) and (R2) apply to it in exactly the same way as in the
proof of Theorem~\ref{thm:no4to9}, and thus $\finch(v)\ge 0$.

Let us consider a face $f\in F(G)$.  If $|f|=3$, then $\finch(f)=\initch(f)=0$.  Hence, suppose that $|f|\ge 9$.
Let $q$ denote the number of vertices of degree two
incident with $f$ and let $t$ denote the number of light vertices incident with $f$.  Suppose first that $q=0$.
Note that that $f$ is not incident with five consecutive light vertices, as otherwise four of them would form a tetrad, contradicting Lemma~\ref{lemma:no4to8-redu};
hence, $t\le \frac{4}{5}|f|$.
We have $\finch(f)\ge \initch(f)-|f|-t/2=|f|-t/2-6\ge \frac{3}{5}|f|-5$. Hence, if $|f|\ge 10$ or $|f|=9$ and $t\le 6$, then $\finch(f)\ge 0$.
If $|f|=9$ and $t=7$, we can by symmetry and absence of tetrads disjoint from $C$
label the vertices of the cycle bounding $f$ as $v_1v_2\ldots v_9$ so that $v_5$ and $v_9$ are not light and edges $v_9v_1$,
$v_2v_3$, $v_4v_5$, $v_5v_6$, and $v_7v_8$ are shared with $3$-faces.  Since $v_8$ is light, edge $v_8v_9$ is not shared with a $3$-face.
But then $f$ sends at most $1/2$ to $v_9$ by (R2), and $\finch(f)\ge\initch(f)-7\times 3/2-1-1/2=0$.

Hence, we can assume that $q>0$.  Let $Q$ be a maximal subpath contained in the intersection of $C$ and the boundary of $f$
(since $G$ is $2$-connected, $Q$ is indeed a path, i.e., the endvertices of $Q$ are distinct).  Note that $f$ sends at most $3/4$
to each endvertex of $Q$ and $q+t\le |f|-2$.  Hence,
\begin{align*}
\finch(f)&\ge\initch(f)-2\times 3/4-(q+t)\times 3/2-(|f|-q-t-2)\times 1\\
&=|f|-(q+t+11)/2\ge(|f|-9)/2\ge 0.
\end{align*}

Let us now consider the final charge of vertices of $C$.  If $v\in V(C)$ has degree two, then note that the non-outer face incident
with $v$ does not have length $3$, since $C$ does not have chords; hence, $\finch(v)\ge\initch(v)+3/2=-5/2$ by (R0).
If $v\in V(C)$ has degree three, then $v$ is incident with at least one non-outer face of length greater than three, and
$\finch(v)\ge\initch(v)+3/4=-9/4$ by (R0).  If $v\in V(C)$ has degree at least four, then $\finch(v)=\initch(v)\ge -2$.
Let $n_2$ denote the number of vertices of $C$ of degree two.  Since $G$ is $2$-connected,
we have $n_2\le |C|-2$.  If $f_0$ is the outer face of $G$, then $\finch(f_0)=\initch(f_0)=2|C|-6$, and thus the sum of the final charges
of vertices and faces of $G$ is at least
\begin{align*}
\finch(f_0)+\sum_{v\in V(C)}\finch(v)&\ge 2|C|-6-n_2\times 5/2-(|C|-n_2)\times 9/4\\
&\ge 2|C|-6-|C|\times 5/2 + 2\times 1/4\\
&=-\frac{|C|+11}{2}\ge-\frac{23}{2}>-12.
\end{align*}
This is a contradiction, since the initial and final charges have the same sum $-12$.
\end{proof}

Theorem~\ref{thm:no4to8} can be improved---it suffices to exclude cycles of lengths $4$ to $7$, as shown
by Borodin et al.~\cite{bor47}.  The reader is invited to attempt to make the necessary changes to the
argument as an exercise (it is necessary to introduce two more reducible configurations at $8$-faces,
which should naturally follow from an attempt to discharge these faces).

\subsection{The trick without precoloring}\label{ssec:shortestinter}

There is another way of dealing with the short separating cycles:
look for a reducible configuration inside the region bounded by a separating cycle $C$ whose
interior is (in some sense) minimized; the reduction of such a configuration cannot
be prevented by another separating cycle $C'$, since the interior of $C'$ (or another suitable
cycle in $C\cup C'$ in case the cycles intersect) would contradict the minimality of $C$.

Let us give an example.  We will need the following observation.

\begin{lemma}\label{lemma:no4to8-laminar9}
Let $K_1$ and $K_2$ be $9$-cycles in a plane graph with no cycles of lengths $4$ to $8$,
and let $\Lambda_1$ and $\Lambda_2$ be the open disks bounded by these cycles.  Then the
disks $\Lambda_1$ and $\Lambda_2$ are either disjoint, or one is a subset of the other one.
\end{lemma}
\begin{proof}
Otherwise, $K_1$ contains two edge-disjoint subpaths $P_1$ and $P'_1$ with endpoints in $V(K_2)$
and otherwise disjoint from $K_2$.  Since $K_2\cup P_1$ contains no cycles of lengths $4$ to $8$,
it follows that $P_1$ has length at least $5$.  But the same holds for $P'_1$, which is not possible
since $|K_1|=9$.
\end{proof}

Let $v_0v_1v_2v_3v_4$ be a subpath of a boundary of a face in a plane
graph such that $v_1v_2v_3v_4$ is a tetrad and let $y$ be the common neighbor of $v_3$ and $v_4$.
We say that the tetrad is \emph{clean} if the distance between $v_0$ and $y$ in $G-\{v_1,v_2,v_3,v_4\}$
is greater than $8$.

\begin{lemma}\label{lemma:no4to8-exred}
Every $2$-connected plane graph $G$ without cycles of lengths $4$ to $8$ and of minimum degree at least three
contains a clean tetrad.
\end{lemma}
\begin{proof}
If $G$ did not contain a triangle, then Corollary~\ref{cor:mad} would imply that the average degree of $G$ is
at most $18/7<3$, contradicting the assumptions.
Hence, we can assume that $G$ is drawn so that the outer face of $G$ is bounded by a triangle.
Also, we can assume that some vertices of $G$ are not incident with the outer face.
Let $C_9$ be a $(\le\!9)$-cycle in $G$ such that the open disk $\Lambda_9$ bounded by $C_9$ contains a vertex of $G$,
chosen so that $\Lambda_9$ is minimal.  Let $C$ be an induced $(\le\!12)$-cycle of $G$ drawn in the closure of $\Lambda_9$
such that the open disk $\Lambda$ bounded by $C$ contains a vertex of $G$, chosen so that the number of vertices of $G$
in $\Lambda$ is minimum.  Let $G_C$ be the subgraph of $G$ drawn in the closure of $\Lambda$.

Clearly, $G_C$ is a $2$-connected graph and all vertices of $G_C$ not belonging to $C$ have degree at least three.
If $G_C$ did not contain a tetrad disjoint from $C$, then we would 
assign charge to the vertices and faces of $G_C$, perform the discharging, and obtain a contradiction in the same way as in
the proof of Theorem~\ref{thm:no4to8}.

Therefore, we can assume that $G_C$ contains a tetrad $v_1v_2v_3v_4$ vertex-disjoint from $C$.
Let $x$ be the common neighbor of $v_1$ and $v_2$, let $y$ be the common neighbor of $v_3$ and $v_4$,
and let $v_0$ and $v_5$ be the neighbors of $v_1$ and $v_4$, respectively, not contained in $\{v_2,v_3,x,y\}$.
Since $v_1,\ldots, v_4\not\in V(C)$, the path $v_1v_2v_3v_4$ is also a tetrad in $G$.  Suppose that the tetrad is not
clean in $G$, i.e., there exists a path in $G$
from $v_0$ to $y$ of length at most $8$, and thus the path $v_0v_1v_2v_3y$ is contained in a cycle of length at most $12$;
let $K_1$ be shortest such cycle. As in the proof of Lemma~\ref{lemma:no4to8-prop}, we argue that $x,v_4\not\in V(K_1)$,
and thus the open disk $\Lambda_1$ bounded by $K_1$ contains either $x$ or $v_4$.
If $\Lambda_1\subseteq\Lambda$, then we obtain a contradiction to the choice
of $C$.  Hence, $K_1$ is not contained in the closure of $\Lambda$; and since $K_1$ is an induced cycle, we have $|C|\neq 3$,
and thus $|C|\ge 9$.

Let $Q_1$ be the subpath of $K_1$ containing $v_0v_1v_2v_3y$ such that endvertices of $Q_1$ belong to $C$
and the rest of $Q_1$ is contained in $\Lambda$.
Let $F_1$ be the subgraph of $K_1\cup C$ drawn in the closure of $\Lambda$,
and let $\FF_1$ denote the set of faces of $F_1$ contained in $\Lambda$.  
No face of $\FF_1$ has length three, as otherwise either $K_1$ or $C$ would have a chord.
Hence, all faces of $\FF_1$ have length at least $9$. 
Consider a face $f\in \FF_1$ whose boundary contains $Q_1$ and let $K$ be the cycle bounding $f$.
If $|f|\le 12$, then note that either $x$ or $v_4$ is contained in $f$, and thus there exists
an induced cycle $K'\subseteq G[V(K)]$ such that the open disk bounded by $K'$ contains $x$ or $v_4$.
Since $C$ is an induced cycle, it follows that $K'$ is contained in the closure of $\Lambda$ and contradicts
the choice of $C$.  This contradiction shows that both faces of $\FF_1$ whose boundary contains $Q_1$
have length at least $13$.
Hence, $\sum_{f\in \FF_1} |f|\ge 26+9(|\FF_1|-2)$.
On the other hand, since $K_1$ has at least two edges not contained in the closure
of $\Lambda$, we have $\sum_{f\in \FF_1} |f|\le |C|+2(|K_1|-2)\le 32$.
We conclude that $|\FF_1|=2$, and thus $K_1$ intersects $\Lambda$ only in $Q_1$.

Let $\ell_1$ denote the length of $Q_1$.  The argument of the previous paragraph implies $|C|+2\ell_1\ge 26$,
and thus $\ell_1\ge 7$.
Consider now the subgraph of $K_1\cup C$ drawn outside of $\Lambda$.  Since both $K_1$ and $C$ are induced cycles,
this graph contains no triangles, and thus all its faces have length at least $9$.  It has at least two
such faces, and thus $18\le |C|+2(|K_1|-\ell_1)$, and $\ell_1\le |K_1|-(9-|C|/2)\le 9$.
Furthermore, $\ell_1=9$ only if $|C|=|K_1|=12$ and $Q'_1=K_1-\Lambda$ is a path of length three disjoint
from $C$ except for its endpoints.  Since $G$ contains no cycles of lengths $4$ to $8$, in that case $Q'_1$
joins opposite vertices of $C$; let $L_1$ and $L'_1$ be the $9$-cycles of $C+Q'_1$ labelled so that $\Lambda$
is a subset of the open disk bounded by $L'_1$ (which is then equal to $\Lambda\cup\Lambda_1$).
By Lemma~\ref{lemma:no4to8-laminar9} and the choice of $C_9$,
we conclude that $C_9=L'_1$.  Note that the open disk bounded by $L_1$ is contained inside $\Lambda_9$,
and by the choice of $C_9$, we conclude that $L_1$ bounds a face.  However, then the open disk $\Lambda_1$ bounded
by $K_1$ contains fewer vertices than $\Lambda$, contradicting the choice of $C$.
We conclude that $\ell_1\le 8$.

Note that also $v_4v_3v_2v_1$ is a tetrad, and unless it is clean in $G$, we can define $K_2$, $Q_2$, and $Q'_2$
symmetrically and show that $Q_2$ has length $\ell_2\le 8$.  Let $F$ be the graph consisting of $C$, $Q_1$, $Q_2$, and the edges $v_1x$ and $v_4y$.
Let $T_1=v_1v_2x$ and $T_2=v_3v_4y$.  Let $f_1$ and $f_2$ be the faces of $F$ incident with the edge $v_2v_3$, where the path $v_1v_2v_3v_4$
is contained in the boundary of $f_1$.  Let $f_3$ and $f_4$ be the faces of $F$ incident with the edges $v_1x$ and $v_4y$, respectively,
not bounded by $T_1$ and $T_2$.  Since the faces $f_1$, \ldots, $f_4$ share an edge with a triangle, they cannot have length $3$, and thus
they must have length at least $9$.  Let $s$ denote the sum of the length of faces of $F$ other than $f_1$, \ldots, $f_4$, the faces bounded by $T_1$ and $T_2$,
and the outer face.  We have
\begin{equation}\label{eq:facesizes}
|C|+42+s\le |C|+6+\sum_{i=1}^4|f_i|+s=2|E(F)|\le 2(|C|+\ell_1+\ell_2+1)\le 2|C|+34,
\end{equation}
and thus $s\le |C|-8\le 4$.  Consequently, in addition to the outer face and the faces $f_1$, \ldots, $f_4$ and the 3-faces bounded by $T_1$
and $T_2$, $F$ has at most one other face of length at most $3$.  Since $C$ is an induced cycle and $Q_1$ and $Q_2$
are induced paths, this triangular face is incident with an edge of each of them.  We conclude that $Q_1\cap Q_2$ consists
of the edge $v_2v_3$ and possibly at most two other disjoint paths ending either in $C$ or (when $s=3$) in a vertex of the triangle
formed by an edge of each of $Q_1$, $Q_2$, and $C$.

Suppose first that $\max(|f_1|,\ldots,|f_4|)\le 12$.  Then the minimality in the choice of $C$ implies that $V(G_C)=V(F)$, i.e., $G_C$ is obtained from $F$ by
possibly adding chords to its faces.  Such a chord necessarily cuts off a triangular face.  Since $C$ is an induced cycle and $Q_1$ and $Q_2$
are induced paths, this triangular face is incident with an edge of two of them.  Suppose that $z_1z_2u$ is such a face, where $z_1u$ is the chord
and say $z_1z_2\in E(Q_1)$.  Then either $z_2\in V(C)$ or $uz_2\in E(Q_2)$, and in the latter case $z_1z_2\not\in E(Q_2)$ and by the previous paragraph
the subpath of $Q_1-z_1z_2$ containing $z_2$ is shared with $Q_2$ except possibly for its last edge.  In particular, the edge $v_2v_3$ is not containe
in the subpath of $Q_1-z_1z_2$ containing $z_2$.  We conclude that if $z_0z_1$ is a subpath of $Q_1$ with $z_0,z_1\not\in V(C\cup Q_2)$, then
at most one of $z_0$ and $z_1$ is incident with a chord.  If $Q_1\cap Q_2\neq v_2v_3$, then $F$ contains a cycle $K$ consisting of subpaths of $Q_1$ and $Q_2$
and possibly one of edges $v_1x$ and $v_4y$.  Since $|K|\ge 9$, $K$ contains at least three vertices not contained in $V(Q_1\cap Q_2)\cup\{v_1,x,v_4,y\}$,
and by symmetry we can assume that two of them are consecutive vertices of $Q_1$ not belonging to $V(C\cup Q_2)$.  But then at most one of them is incident
with a chord, and thus the other one has degree two in $G_C$, which is a contradiction. It follows that $Q_1\cap Q_2=v_2v_3$.  However, then there are
at most 4 chords (at the ends of $Q_1$ and $Q_2$ in $C$), each incident with exactly one vertex of $V(Q_1\cup Q_2)\setminus V(C)$.  Let $q$ denote the number
of such chords.  Note that $\sum_{i=1}^4|f_i|\ge 36+q$, and by (\ref{eq:facesizes}) we have $\ell_1+\ell_2\ge 14+q/2$.  However, $F$ has at least
$(\ell_1-5)+(\ell_2-5)\ge 4+q/2>q$ vertices of degree two, and consequently at least one of them has degree two in $G_C$, which is a contradiction.

\begin{figure}
\begin{center}
\begin{asy}
path c = scale(4,3) * unitcircle;
for (i = 0; i < 12; ++i)
  v[i] = point (c, i/3);

v[12] = (-2,0);
v[13] = (-2,-1);
v[14] = (2,0);
v[15] = (2,-1);
v[16] = (-0.67,-0.5);
v[17] = (0.67,-0.5);

draw(c);
draw(v[4]--v[12]--v[13]--v[7]);
draw(v[2]--v[14]--v[15]--v[11]);
draw(v[12]--v[16]--v[13]);
draw(v[14]--v[17]--v[15]);
draw(v[16]--v[17]);
for (i = 0; i < 12; ++i)
  vertex (v[i], black);
for (i = 12; i < 18; ++i)
  vertex (v[i], white);
for (i = 0; i < 3; ++i)
  {
    vertex(interp(v[12],v[4],(i+1)/4), white);
    vertex(interp(v[14],v[2],(i+1)/4), white);
  }

\end{asy}
\end{center}
\caption{The last case in the proof of Lemma~\ref{lemma:no4to8-redu}.}\label{fig:no4to8-lastcase}
\end{figure}

Hence, one of the faces $f_1$, \ldots, $f_4$ has length at least $13$.  By (\ref{eq:facesizes}), we conclude that exactly one of the faces has length $13$,
the remaining three have length $9$, $|C|=12$, $\ell_1=\ell_2=8$, $s=0$, and $Q_1$ and $Q_2$ are edge-disjoint except for the edge $v_2v_3$.
By the minimality of $C$ and the fact that $9$-faces cannot have chords and that vertices of $G_C$ not in $C$ have degree at least three,
we conclude that all vertices of $F$ of degree two are incident with the face of length $13$.  Also, by the minimality of $C$, observe that $F$ does
not contain a path of length at most $4$ intersecting $C$ exactly in its endpoints.  It follows that $F$ is the graph depicted in Figure~\ref{fig:no4to8-lastcase}.
However, then $|Q'_1|=|Q'_2|=4$ and these paths together with subpaths of $C$ form $9$-cycles contradicting Lemma~\ref{lemma:no4to8-laminar9}.
\end{proof}

Theorem~\ref{thm:no4to8} now follows easily, observing that a hypothetical minimal counterexample is $2$-connected,
has minimum degree at least three, and does not contain clean tetrads by the argument of Lemma~\ref{lemma:no4to8-redu}.
For another application of the method, see Lemma~\ref{lemma:exredu}.

Of course, the proof of Lemma~\ref{lemma:no4to8-exred} is rather more complicated than the argument using a precolored cycle.
Furthermore, note that we used the symmetry of tetrad in the proof, which we did not need before, and we do not know how
to avoid this.
Although many results can be proved using both variants of the method, it may be that in some particular cases,
only one of them applies; the precolored cycle one is often easier.  Why might the ``minimum cycle'' argument be
sometimes preferable?

Firstly, note that Lemma~\ref{lemma:no4to8-exred} is independent on the chromatic properties of the graph.  Indeed, in Chapter~\ref{chap:corresp},
we use this lemma to generalize Theorem~\ref{thm:no4to8} to list coloring; while we could also easily modify the proof of Theorem~\ref{thm:no4to8},
using Lemma~\ref{lemma:no4to8-exred} is more convenient.  This lemma might also be of interest in non-coloring contexts.

Secondly, sometimes a precoloring extension result could be cumbersome to state or argue about.  For instance, suppose we consider
the problem of finding an \emph{acyclic coloring} of a planar graph, where in addition to adjacent vertices having different colors,
we forbid cycles colored by only two colors.  Then the precoloring would have to take into account not only the colors of the vertices
of the cycle, but also whether pairs of vertices of the cycle are joined by a bichromatic path in the rest of the graph.
Rather than definining a notion of precoloring that captures this information and then working with this generalized precoloring,
it may be more convenient to find reducible configurations via a ``minimum cycle'' argument and then work out their reducibility
in the context of the whole graph.

Finally, it may be algorithmically easier and faster to just repeatedly reduce a configuration from a given list, rather
than to intersperse the reductions with splittings of the graph along short separating cycles.
As an example, Dvo\v{r}\'ak et al.~\cite{DvoKawTho} use this idea to obtain a linear-time algorithm to find
a $3$-coloring of a triangle-free planar graph.

\section{A Discharging Proof of Gr\"{o}tzsch' theorem}\label{sec:disch-grotzsch}

As a final example, we will present a proof of Gr\"{o}tzsch' theorem via discharging and reducible configurations.
In order to deal with separating cycles in reductions, we are going to prove a stronger precoloring extension
result.

\begin{theorem}\label{thm:grotzsch-gimbel}
Let $G$ be a plane triangle-free graph with the outer face bounded by a cycle $C$ of length at most $6$.
Suppose that there exists a $3$-coloring $\psi$ of $C$ that does not extend to a $3$-coloring of $G$.
Then $|C|=6$ and $G$ has a subgraph $H$ containing $C$ such that all non-outer faces of $H$ have length $4$.
\end{theorem}

Note an additional idea with respect to the trick described in Section~\ref{sec:precolface}: in the case that $|C|=6$,
we do not prove that a $3$-coloring of $C$ always extends to a $3$-coloring of $G$ (since this is not always the case).
Instead, we give a description of ``exceptional'' graphs for that the $3$-coloring does not necessarily extend.
This still enables us to eliminate separating $6$-cycles, unless their interiors contain such exceptional graphs.

In this section, a plane triangle-free graph $G$ with the outer face bounded by a cycle $C$ of length at most $6$
is \emph{safe} if either $|C|\le 5$, or $|C|=6$ and every subgraph of $G$ that includes $C$ has a non-outer face
of length greater than $4$.  A \emph{counterexample} is a triple $(G,C,\psi)$, where $G$ is a safe graph with
the outer face bounded by a cycle $C$ and $\psi$ is a $3$-coloring of $C$ that does not extend to a $3$-coloring of $G$.
A counterexample is \emph{minimum} if $|V(G)|$ is minimum over all counterexamples, and subject to that, $|E(G)|$ is \emph{maximum}.

Let us start by establishing some properties of a minimum counterexample.
\begin{lemma}\label{lemma:grgimprop}
If $(G,C,\psi)$ is a minimum counterexample, then
\begin{itemize}
\item[\textrm{(a)}] all vertices not in $C$ have degree at least three,
\item[\textrm{(b)}] $G$ is $2$-connected,
\item[\textrm{(c)}] every cycle of length at most $5$ in $G$ bounds a face, 
\item[\textrm{(d)}] for every non-facial $6$-cycle $K$ in $G$, all faces of
$G$ drawn in the open disk bounded by $K$ have length $4$, and
\item[\textrm{(e)}] $G$ contains no $4$-cycles other than $C$.
\end{itemize}
\end{lemma}
\begin{proof}
The claim (a) is obvious.  If $G$ is not $2$-connected, then $G=G_1\cup G_2$ for proper induced subgraphs $G_1$
and $G_2$, where $C\subseteq G_1$, $G_2$ is $2$-connected, and $G_1$ intersects $G_2$ in at most one vertex $w$.
By the minimality of $G$, the coloring $\psi$ extends to a $3$-coloring $\varphi_1$ of $G_1$.  Furthermore, since $G_2$ has
no vertex other than $w$ of degree at most two, Corollary~\ref{cor:mad} implies that $G_2$ has
a face bounded by a cycle $C_2$ of length at most $5$.  By the minimality of $G$, any $3$-coloring of $C_2$ extends
to a $3$-coloring of $G_2$, and by permuting the colors, we can assume that this coloring gives $w$ the color $\varphi_1(w)$
(if $w$ exists).  The combination of the colorings gives a $3$-coloring of $G$ that extends $\psi$, which is a contradiction.
Hence, (b) holds.

If $K$ is a cycle of length at most $5$ in $G$ that does not bound a face, then
let $G_2$ be the subgraph of $G$ drawn in the closed disk bounded by $K$,
and let $G_1=G-(V(G_1)\setminus V(K))$.  By the minimality of $G$, the coloring $\psi$ extends to a $3$-coloring $\varphi_1$ of $G_1$,
and the coloring of $K$ given by $\varphi$ extends to a $3$-coloring of $G_2$, which is a contradiction.  Hence, (c) holds.
The same argument proves (d). 

Finally, consider a $4$-cycle $K\neq C$ in $G_2$.  By (c), $K$ bounds a face.  Let $K=v_1v_2v_3v_4$, where say $v_1\not\in V(C)$.
If $G$ contained a path of length three between $v_1$ and $v_3$, then this path together with $v_1v_2v_3$ would give a $5$-cycle $K'\neq C$.
By (c), $K'$ bounds a face, and thus the path $v_1v_2v_3$ is contained in boundaries of two faces and $\deg(v_2)=2$.
By (a), this implies that $v_2\in V(C)$, but since $v_2$ has degree two, this would also imply $v_1\in V(C)$, which is a contradiction.
Hence, $G$ contains no such path of length three.

Let $G'$ be the graph obtained from $G$ by identifying $v_1$ with $v_3$ to a new vertex $v_{13}$ and suppressing
the arising parallel edges.  Note that $G'$ is a plane
triangle-free graph.  Clearly, $\psi$ does not extend to a $3$-coloring of $G'$,
since such a coloring could be extended to $G$ by giving $v_1$ and $v_3$ the color of $v_{13}$.  By the minimality of $G$,
we conclude that $G'$ is not safe, and in conjunction with (c) and (d), this implies that $|C|=6$ and
all non-outer faces of $G'$ have length $4$.  But that implies that all non-outer faces of $G$ have length $4$, contradicting
the assumption that $G$ is safe.  Hence, (e) holds.
\end{proof}

In fact, we can strengthen the constraints as follows.
\begin{lemma}\label{lemma:grgimprop1}
If $(G,C,\psi)$ is a minimum counterexample, then all non-outer faces of $G$ have length $5$ and $G$ contains no $6$-cycles distinct
from $C$.
\end{lemma}
\begin{proof}
The graph $G$ contains no non-facial $6$-cycles by Lemma~\ref{lemma:grgimprop}(c) and (d).
Hence, it suffices to show that $G$ has no non-outer faces of length other than $5$.
Suppose for a contradiction that $K=v_1\ldots v_k$ with $k\ge 6$ is a cycle of $G$ bounding a face and $K\neq C$,
where say $v_2\not\in V(C)$.  The vertex $v_2$ cannot have two neighbors in $C$ by Lemma~\ref{lemma:grgimprop}(e), (c), and (a).
Hence, we can assume that $v_1\not\in V(C)$.  By Lemma~\ref{lemma:grgimprop}(c) and (a), there exists no path of length two between
$v_1$ and $v_4$.  Let $G'=G+v_1v_4$.  Note that $G'$ is a plane triangle-free graph.  Also, recall that in the definition
of the minimality of a counterexample, we \emph{maximized} $|E(G)|$, and thus $(G',C,\psi)$ is not a counterexample.
Clearly, $\psi$ does not extend to a $3$-coloring of $G'$, and thus $G'$ is not safe and $|C|=6$.  However, $C$ has no chord
in $G$ (since $G$ is safe) and thus also no chord in $G'$ (since $v_1\not\in V(C)$, the edge $v_1v_4$ is not a chord).
Since $G'$ is not safe, it follows that it has a subgraph with at least three $4$-faces, and one of them is not incident with
the edge $v_1v_4$.  However, then $G$ contains a $4$-cycle, contradicting Lemma~\ref{lemma:grgimprop}(e).
\end{proof}

Finally, we will need one more reducible configuration.
\begin{lemma}\label{lemma:grgim-redu}
Let $(G,C,\psi)$ be a minimum counterexample and let $K=v_1v_2\ldots v_5$ be a cycle bounding a non-outer $5$-face of $G$.
If $v_1,\ldots,v_4\not\in V(C)$ and $\deg(v_1)=\ldots=\deg(v_4)=3$, then at least one of $v_1$, \ldots, $v_4$ has a neighbor
in $V(C)\setminus V(K)$.
\end{lemma}
\begin{proof}
For $i\in\{1,\ldots,4\}$, let $x_i$ be the neighbor of $v_i$ not in $K$.  Suppose for a contradiction that $x_1,\ldots, x_4\not\in V(C)$.
Let $G'$ be the graph obtained from $G-\{v_1,\ldots,v_4\}$ by identifying $x_2$ with $x_3$ to a new vertex $x$, suppressing
the arising parallel edges, and by adding the edge $x_1x_4$.  Clearly, $G'$ is a plane graph.

Firstly, we claim that every $3$-coloring $\varphi$ of $G'$ extends to a $3$-coloring of $G$.
Indeed, if $\varphi(x_1)=\varphi(v_5)$, then we can extend the coloring greedily by coloring $v_4$, $v_3$, $v_2$, and $v_1$
in order.  If $\varphi(x_4)=\varphi(v_5)$, then we can extend the coloring greedily by coloring $v_1$, $v_2$, $v_3$, and $v_4$
in order.   Otherwise, color $v_1$ with $\varphi(x_4)$ and $v_4$ with $\varphi(x_1)$, and note that because of the edge $x_1x_4$
of $G'$, these colors are distinct.  If $\varphi(x_4)=\varphi(x_2)$ or $\varphi(x_1)=\varphi(x_3)$, we can color $v_2$ and $v_3$
greedily in some order; otherwise, since $\varphi(x_2)=\varphi(x_3)=\varphi(x)$, we can color $v_2$ with $\varphi(x_1)$
and $v_3$ with $\varphi(x_4)$.

Hence, $\psi$ does not extend to a $3$-coloring of $G'$.  By the minimality of $G$, we conclude that $G'$ is not a counterexample,
and thus $G'$ cannot be safe.  Suppose that $G'$ contains a triangle $T$.  Such a triangle contains the edge $x_1x_4$ or the vertex
$x$.  If $T$ did not contain $x_1x_4$, then the path of $G$ corresponding to $T$ together with the path $x_2v_2v_3x_3$
would form a $6$-cycle contradicting Lemma~\ref{lemma:grgim-redu}.  If $T$ did not contain $x$, then replacing the edge
$x_1x_4$ by the path $x_1v_1v_5v_4x_4$ in $T$ gives a $5$-cycle in $G$, and by Lemma~\ref{lemma:grgimprop}(c), this $5$-cycle
bounds a face.  Hence, $\deg(v_5)=2$ and by Lemma~\ref{lemma:grgimprop}(a) we have $v_5\in V(C)$, which is a contradiction
since its neighbors $v_1$ and $v_4$ do not belong to $C$.  Finally, if $T$ contained both the edge $x_1x_4$ and the vertex $x$,
then $G$ contains an edge between $\{x_1,x_4\}$ and $\{x_2,x_3\}$, which contradicts Lemma~\ref{lemma:grgimprop}(c) or (e).

Hence, $G'$ is triangle-free.  Since $G'$ is not safe, we conclude that $|C|=6$ and $G'$ contains a subgraph $H'$ including $C$
such that the non-outer faces of $H'$ have length $4$.  Since $x_1,\ldots, x_4\not\in V(C)$ and $G$ is safe, the
cycle $C$ in $G'$ has no chord, and thus $V(H')\setminus V(C)\neq\emptyset$.  If $x_1x_4\not\in E(H')$, then
$x$ must be incident with all $4$-faces of $H'$ by Lemma~\ref{lemma:grgimprop}(e), and thus $V(H')\setminus V(C)=\{x\}$
and $x$ has three neighbors in $C$.  But then $x_2$ or $x_3$ has two neighbors in $C$, which contradicts
Lemma~\ref{lemma:grgimprop}(e), (c) or (a).  If $x_1x_4\in E(H')$, then $H'$ has at least four $4$-faces,
at least two of them are not incident with $x_1x_4$, and they cannot both be incident with $x$, implying that $G$ contains
a $4$-cycle contradicting Lemma~\ref{lemma:grgimprop}(e).
\end{proof}

We can now proceed with discharging.  Let us say that a vertex $v$ of a counterexample $(G,C,\psi)$ is \emph{light}
if $v\not\in V(C)$ and $\deg(v)=3$.

\begin{proof}[Proof of Theorem~\ref{thm:grotzsch-gimbel}]
Suppose for a contradiction that there exists a counterexample, and thus there exists a minimum counterexample
$(G,C,\psi)$.  Assign charge $\initch(v)=\deg(v)-4$ to each vertex $v\in V(G)$ and $\initch(f)=|f|-4$ to each
face $f$ of $G$; the sum of these charges is $-8$ by Lemma~\ref{lemma:initch}.

Let us redistribute the charge according to the following rules.
\begin{itemize}
\item[(R1)] If $f$ is a non-outer face and $v$ is an incident light vertex,
then $f$ sends $1/3$ to $v$.
\item[(R2)] If $f$ is a non-outer face and $v\in V(C)$ is an incident vertex of degree two,
then $f$ sends $1/3$ to $v$.
\item[(R3)] If $v\in V(C)$ has degree at least three, $uv\in E(G)\setminus E(C)$, $\deg(u)=3$,
and $u$ is incident with a $5$-face $f$ whose boundary does not contain the edge $uv$, then $u$ sends $1/3$ to $f$.
\end{itemize}
Let $\finch$ denote the resulting final charge.  Consider a non-outer face $f$; by Lemma~\ref{lemma:grgimprop1},
we have $|f|=5$, and thus $\initch(f)=1$.  Since $G$ is $2$-connected by Lemma~\ref{lemma:grgimprop}(b) and $G\neq C$,
if $f$ sends charge by (R2), then $f$ is incident with at least two vertices of degree at least three belonging to $C$
to that no charge is sent, giving $\finch(v)\ge \initch(v)-3\times 1/3=0$.  Hence, suppose that $f$ sends no charge by
(R2).  Let $t$ denote the number of light vertices incident with $f$.  If $t\le 3$, then $\finch(v)\ge \initch(v)-t\times 1/3=0$
By Lemma~\ref{lemma:grgim-redu}, if $t\ge 4$, then at least $t-3$ light vertices incident with $f$ have a neighbor in $C$ not
incident with $f$, and thus by (R1) and (R3), $\finch(v)\ge \initch(v)-t\times 1/3+(t-3)\times1/3=0$.

Hence, all non-outer faces of $G$ have non-negative final charge.  Consider now a vertex $v\in V(G)$.  When $v\not\in V(C)$, we have
$\finch(v)=\initch(v)\ge 0$ if $\deg(v)\ge 4$ and $\finch(v)=\initch(v)+3\times1/3=0$ by (R1) when $\deg(v)=3$.  When
$v\in V(C)$, we have $\finch(v)=\initch(v)+1/3=-5/3$ by (R2) if $\deg(v)=2$ and
$\finch(v)\ge \initch(v)-(\deg(v)-2)\times 1/3=d-4-d/3+2/3=\frac{2\deg(v)-10}{3}\ge -4/3$ by (R3) if $\deg(v)\ge 3$.

Also, for the outer face $f_0$, we have $\finch(f_0)=\initch(f_0)=|C|-4$.  Therefore, the sum of the charges
is at least
$$|C|-4-\frac{5}{3}|C|=4-\frac{2}{3}|C|\ge 0,$$
which is a contradiction with the fact that the sum of initial charges is $-8$ and the redistribution does not affect
the total amount of charge.
\end{proof}

In the context of Theorem~\ref{thm:grotzsch-gimbel}, it is natural to ask when a $3$-coloring of a $6$-cycle $C$
extends to a $3$-coloring of a plane graph $H$ with the outer face bounded by $C$ and all other faces of length $4$.
We will address this question in Chapter~\ref{chap:recolor}, Lemma~\ref{lemma:extend6}, and in Chapter~\ref{chap:flows}, Corollary~\ref{cor:flow-quadr}.
Let us remark that if $G$ has such a subgraph $H$ and a $3$-coloring of $C$ extends to $H$, then it also extends
to $G$, as can be seen by applying Theorem~\ref{thm:grotzsch-gimbel} to the subgraphs of $G$ drawn in the faces of $H$.

\subsection{Other discharging proofs of Gr\"otzsch' Theorem}.

There are a number of modifications that can be made to the discharging proof of Gr\"otzsch' Theorem.
One minor one concerns the reduction in Lemma~\ref{lemma:grgim-redu}. The way we reduce a 5-face incident with
four vertices of degree three comes from the original Gr\"otzsch' proof~\cite{grotzsch1959}, while
elsewhere~\cite{thom-torus} a reduction by identifying $v_5$ with $x_2$ and $x_3$ with $x_4$ is used
(we invite the reader to check that every $3$-coloring of the reduced graph extends to the coloring
of the original graph and to work out what assumptions need to be made to ensure that no triangles are created).
In some context one of the ways to reduce the configurations may be preferable; it does not matter much in our
proof.

It is not completely necessary to reduce faces of length at least 6; it is possible to
alter the discharging so that they end up with non-negative charge, which is not much of a pain due to the
fact that they start with quite large positive charge.  However, some extra care is required: the reduction
from Lemma~\ref{lemma:grgim-redu} fails when the edge $v_2v_3$ is incident with a $6$-face, and some transfer of
charge from $6$-faces to $5$-faces incident with at least four vertices of degree three is needed.
Again, reader is invited to work out the details as an exercise.

More importantly, there is another way to deal with faces of length other than 5.  In Lemma~\ref{lemma:grgimprop1}
we handled them by adding chords.  They can be also eliminated by vertex identifications analogously to the way
4-faces are collapsed in the proof of Lemma~\ref{lemma:grgimprop}(e).  In this context, the following
important tool was found by Klostermeyer and Zhang~\cite{KloZhang}.  Let us recall that the \emph{odd girth}
of a graph is the length of the shortest odd cycle (or $\infty$ if the graph is bipartite).  Observe that the odd girth
also gives a lower bound for the length of odd closed walks.
\begin{lemma}[The Folding Lemma]\label{lemma:folding}
Let $g$ be an odd integer.  Let $G$ be a plane graph of odd girth at least $g$ and let $K$ be a cycle in $G$ bounding a face.
If $|K|\neq g$, then there exists a subpath $xyz$ of $K$ such that $G$ contains no path of odd length less than $g$
between $x$ and $z$.  Consequently, the graph obtained from $G$ by identifying $x$ with $z$ has odd girth at least $g$.
\end{lemma}
\begin{proof}
The claim holds unless each two-edge subpath of $K$ is contained in a cycle of length exactly $g$;
for a contradiction, assume that is the case.

For a cycle $C$, a \emph{pace} of $C$ is a maximal subpath of $K\cap C$.
Let $C_1$ be a $g$-cycle in $G$ with the longest pace $P_1$ and let $v_1$ and $v_3$ be the endvertices of $P_1$
labelled so that $P_1$ is the clockwise arc of $C$ from $v_1$ to $v_3$.
There exists a $g$-cycle $C_2$ whose pace $P_2$ contains both edges of $K$ incident with $v_3$.  Let $v_2$ and $v_4$ be the endvertices
of $P_2$ labelled so that $P_2$ is the clockwise arc of $C$ from $v_2$ to $v_4$.
By the maximality of the pace $P_1$, we have $v_2\in V(P_1)\setminus \{v_1,v_3\}$.
For $i\in\{1,2\}$, let $Q_i$ be the subpath of $C_i$ edge-disjoint from $P_i$ such that $C_i=P_i\cup Q_i$,
and let $P'_i$ be the subpath of $K$ edge-disjoint from $P_i$ such that $K=P_i\cup P'_i$.
See Figure~\ref{fig:folding} for an illustration.

\begin{figure}
\begin{center}
\begin{asy}
unitsize(9mm);
v[1] = (0,0);
v[3] = (6,0);
v[2] = (4.5,0);
v[4] = (1.5,0);

draw(v[2]--v[3]{dir(-30)}.. (3,-3) .. {dir(30)} v[1] -- v[4], linewidth(1bp));
draw(v[2]--v[4]);

path q1 = (v[1]{dir(80)} .. {dir(-80)}v[3]);
path q2 = (v[2]{dir(80)} .. {dir(-80)}v[4]);

draw(q1);
draw(q2, linewidth(1bp));

label("$Q_1$", point(q1,1/3), NW);
label("$Q_2$", point(q2,1/2), S);
draw(brace(v[3],v[1], 0.9));
label("$P_1$", (3,-0.9), S);
label("$P'_1$", (3,-3), N);
label("$P'_2$", interp(v[2],v[4],1/2), N);

vertex(v[1], black);
vertex(v[2], black);
vertex(v[3], black);
vertex(v[4], black);
label("$v_1$", v[1], NW);
label("$v_2$", v[2], S);
label("$v_3$", v[3], NE);
label("$v_4$", v[4], S);

label("(a)", (2,-3.5));

v[1] = (8,0);
v[3] = v[1]+(4,0);
v[2] = v[1]+(2,0);
v[4] = v[1]+(6,0);

draw(v[1]--v[4]{dir(-30)}.. (v[1]+(3,-3)) .. {dir(30)} v[1] -- v[4]);
draw(v[2]--v[4]);

q1 = (v[1]{dir(80)} .. {dir(-80)}v[3]);
q2 = (v[2]{dir(80)} .. {dir(-80)}v[4]);
v[5] = intersectionpoint(q1,q2);

draw(q1);
draw(q2);

label("$A_1$", point(q1,1/3), NW);
label("$A_2$", point(q2,3/16), W);
label("$A_3$", point(q1,13/16), E);
label("$A_4$", point(q2,2/3), NE);

label("$W_1$", v[1] + (1,0.5));
label("$W_2$", v[1] + (3,0.5));
label("$W_3$", v[1] + (5,0.5));

label("$s_2$", v[1] + (3,0), S);
label("$s_3$", v[1] + (5,0), S);

vertex(v[1], black);
vertex(v[2], black);
vertex(v[3], black);
vertex(v[4], black);
vertex(v[5], black);
label("$v_1$", v[1], NW);
label("$v_2$", v[2], S);
label("$v_3$", v[3], S);
label("$v_4$", v[4], NE);
label("$w$", v[5], S);

label("(b)", v[1] + (3,-3.5));
\end{asy}
\end{center}
\caption{The cycles from the proof of Lemma~\ref{lemma:folding}.  Paths $Q_1$ and $Q_2$ may intersect
in vertices other than $w$ and may share edges.}\label{fig:folding}
\end{figure}

Suppose first that $P_1\cup P_2=K$, i.e., $v_4\in V(P_1)$, as in Figure~\ref{fig:folding}(a).  Then $|P_1|+|P_2|>|K|$ and $|P_1|>|K|/2$.
If $|K|$ is even, then the walk consisting of $Q_1$ and $P'_1$
has the same parity as $C_1$ and it is shorter, contradicting the assumption that $G$ has odd girth at least $g$.
If $|K|$ is odd, then since $|K|\neq g$ and $G$ has odd girth at least $g$, we have $|K|>g$.  Also,
$|P'_2|$ and $|Q_2|$ have the same parity, and since $|K|>g=|C_2|$, we have $|P'_2|>|Q_2|$.
But then the closed walk obtained from $C_1$ by replacing $P'_2$ with $Q_2$ has odd length smaller than $|C_1|=g$,
which is a contradiction.

Hence, $P_1\cup P_2\neq K$, and $v_4$ is an interior vertex of $P'_1$, as in Figure~\ref{fig:folding}(b).  By planarity, $C_1$ and $C_2$ intersect
in a vertex $w\not\in V(P_1\cap P_3)$.  For $i\in \{1,3\}$, let $A_i$ be the subpath of $C_1$ from $v_i$ to $w$
edge-disjoint from $P_1$, and let $A_{i+1}$ be the subpath of $C_2$ from $v_{i+1}$ to $w$
edge-disjoint from $P_2$.  Let $W_0$ be the closed walk consisting of $A_1$, $A_4$, and the clockwise
arc of $K$ from $v_1$ to $v_4$.  For $i\in\{1,2,3\}$, let $W_i$ be the closed walk consisting of $A_{i}$, $A_{i+1}$,
and the clockwise arc of $K$ from $v_i$ to $v_{i+1}$.  Note that for $i\in \{1,2\}$, the odd cycle $C_i$ is
the symmetric difference of $W_i$ and $W_{i+1}$, and thus $|W_2|$ has opposite parity from $|W_1|$ and $|W_3|$.

If $|W_2|$ is even, then $|W_1|$ and $|W_3|$ are odd and by the odd girth assumption, $|W_1|,|W_3|\ge g$.
Letting $s_2$ denote the length of the clockwise arc of $K$ from $v_2$ to $v_3$, observe that
$2g=|C_1|+|C_2|=|W_1|+|W_2|+2s_2\ge 2g+2s_2$, and thus $s_2=0$.  However, this implies that $v_2=v_3$, which contradicts the choice of $C_2$.

Hence, $|W_2|$ is odd.  Consequently, $|W_1|$ and $|W_3|$ are even and $|W_0|=|W_1|+|W_3|+2s_2-|W_2|$ is odd.
Letting $s_3$ denote the length of the clockwise arc of $K$ from $v_3$ to $v_4$, we have
$|A_2|+|A_3|+s_2=|W_2|\ge g=|C_2|=|A_2|+|A_4|+s_2+s_3$,
and thus $|A_3|\ge |A_4|+s_3$ and
$$g\le |W_0|=|C_1|+s_3+|A_4|-|A_3|\le |C_1|=g.$$
Therefore, $|W_0|=g$, and if the closed walk $W_0$ were not a cycle, it would contain a subwalk of odd length smaller than $g$,
contradicting the girth assumption.  Hence, $W_0$ is a $g$-cycle, and its pace contains $P_1\cup P_2$.  This contradicts the maximality
of the pace of $C_1$.
\end{proof}
The Folding Lemma is widely applicable not only for ordinary proper coloring, but
also whenever we consider any kind of coloring where identifying two vertices
(with a common neighbor) cannot decrease the number of colors needed, such as
circular or fractional coloring.  In these circumstances, it implies that when we color
plane graphs of odd girth at least $g$, we only need to consider graphs where all faces
have length exactly $g$.  For example, Gr\"otzsch' Theorem deals with graphs of odd girth at least $5$,
and thus the Folding Lemma implies that a hypothetical minimal counterexample has all faces of length $5$.

Let us remark that the Folding Lemma often makes it possible to improve girth bounds in coloring results
by one essentially for free: Supposing that by some discharging argument we can prove that a result
holds for planar graphs of girth $g$ for \emph{odd} $g$, we can consider instead graphs of odd girth $g$.
By the Folding Lemma, we can assume that their faces have length $g$, and thus the discharging argument
will go through unmodified (a care needs to be taken to check that all reductions also work in the odd girth
setting, though).  Since $g$ is odd, a graph of girth $g-1$ has odd girth at least $g$, and thus
in this way a result for planar graphs of girth $g$ can be cheaply transformed into a result
that holds for planar graphs of girth $g-1$.

We cannot eliminate non-facial cycles of length less than $g$ by the Folding Lemma,
and we need to deal with those using one of the methods of Section~\ref{sec:precolface}.  Of course,
when the Folding Lemma is applied in a graph with a precolored face, one needs to discuss the possibility
that the vertices being identified are precolored ones, which may make the identification impossible
when they have different colors.

Using the Folding Lemma and the reduction from Lemma~\ref{lemma:grgim-redu}, Gr\"otzsch' Theorem follows easily
from the following result proved using the idea of Subsection~\ref{ssec:shortestinter}.
\begin{lemma}\label{lemma:exredu}
Let $G$ be a $2$-connected plane triangle-free graph with all faces of length exactly $5$.
If the minimum degree of $G$ is at least three, then $G$ contains a $5$-face bounded by a cycle $K=v_1\ldots v_5$
such that $v_1$, \ldots, $v_4$ have degree three, the neighbors $x_1$ and $x_4$ of $v_1$ and $v_4$
not in $K$ have no common neighbor, and the neighbors $x_2$ and $x_3$ of $v_2$ and $v_3$ not in $K$
are not joined by a path of length three other than $x_2v_2v_3x_3$.
\end{lemma}
\begin{proof}
Let $C_1$ be a $(\le\!5)$-cycle in $G$ such that the open disk $\Lambda_1$ bounded by $C_1$ contains a vertex
of $G$ and subject to that $\Lambda_1$ is inclusionwise-minimal.  Let $G_1$ be the subgraph of $G$ drawn in
the closure of $\Lambda_1$.  Let $C$ be a $(\le\!6)$-cycle in $G_1$ such that the open disk $\Lambda$ bounded by $C$ contains a vertex
of $G$ and subject to that $\Lambda$ is inclusionwise-minimal.  Let $G'$ be the subgraph of $G$ drawn in the closure
of $C$.

We apply the discharging argument of Theorem~\ref{thm:grotzsch-gimbel} to $G'$ with the outer face bounded by the cycle $C$.
This gives a contradiction unless $G$ contains a $5$-face bounded by a cycle $K=v_1\ldots v_5$
such that $v_1$, \ldots, $v_4$ have degree three and neither these vertices nor their neighbors $x_1$, \ldots, $x_4$ outside of $K$
belong to $C$.  If $x_1$ and $x_4$ had a common neighbor $y$ in $G$, then note that $y\in V(G')$ and the $6$-cycle $x_4yx_1v_1v_5v_4$
would contradict the choice of $C$; hence, they do not have a common neighbor.

Suppose that $G$ contains a path $x_2y_2y_3x_3$ distinct from $x_2v_2v_3x_3$, and let $C'$ be the $6$-cycle $x_2y_2y_3x_3v_3v_2$.
If $C'\subseteq G'$, then $C'$ would contradict the choice of $C$.  Hence, $y_2,y_3\in V(C)$ and the edge $y_2y_3$ is drawn outside of $\Lambda$.
Since $G$ is triangle-free and $y_2y_3$ is a chord of $C$, we conclude that $|C|=6$ and $C=y_2a_1a_2y_3b_1b_2$, where say the open disk
bounded by $y_2y_3b_1b_2$ contains $\Lambda$.  Since $G$ is triangle-free and $|C_1|\le 5$, the edge $y_2y_3$ is not a chord of $C_1$,
and thus $y_2y_3\in E(G_1)$.  By the minimality of $\Lambda_1$, we conclude that $C_1=y_2y_3b_1b_2$.  But then the $4$-cycle $y_2a_1a_2y_3$
is contained in $G_1$ and contradicts the choice of $C_1$ (the open disk bounded by $y_2a_1a_2y_3$ must contain a vertex, since
$G$ is triangle-free and all faces of $G$ have length $5$).
\end{proof}

Another possible choice in the proof of Gr\"otzsch' Theorem is to first reduce it to the girth 5 case by the Folding Lemma and a precolored cycle
argument, and then execute the proof in girth at least 5 setting, by essentially the same reducible configurations and discharging rules,
but using a longer precolored cycle to eliminate further separating cycles and ensure that no $4$-cycles are created.
This way, Thomassen~\cite{thom-torus} proved the following precoloring extension result which is occasionally useful.
\begin{theorem}\label{thm:precol9}
Let $G$ be a plane graph of girth at least $5$ with the outer face bounded by an induced cycle $C$ of length at most $9$.
A $3$-coloring of $C$ extends to a $3$-coloring of $G$ unless $|C|=9$ and a vertex of $G$ has three neihbors in $C$
colored with three different colors.
\end{theorem}
As a final exercise, the reader should work out the details of the proof of Theorem~\ref{thm:precol9}.

\section{How to find reducible configurations}\label{sec:howto-redu}

Till now, we did not go into much details on how one can find suitable reducible configurations.
Mainly, this is because reducibility is highly problem-specific;
there are very few variations in the discharging part of the argument, but each problem
requires different set of reducible configurations and often different ideas to show their
reductions.  Hence, we will only be able to give some very general pointers on the topic.

Of course, there is interaction between discharging and reducibility.  Suppose that our chosen rules
do not completely discharge the graph, and we do not see how to fix this by changing the rules.
It is then natural to look for reducible configurations among the kinds of subgraphs that may end up having
negative charge; in Subsection~\ref{ssec:dischlp} we show how to narrow down the kinds of subgraphs
to only without whose reducibility it is not possible to decrease the amount of leftover charge.
What one should keep in mind is that only a part of such a subgraph may be necessarily for reducibility.
Reducing as small configurations as possible keeps the number of reducible configurations small.
Also, it is not always the case that it is as easy or easier to prove reducibility of a larger configuration.

If we cannot find reducible configuration among the subgraphs with negative charge,
it is commonly useful to consider the combinations of such subgraphs, or more precisely, to consider a combination
of a negatively charged subgraph with all possible adjacent non-positively charged subgraphs.
If all the configurations turn out to be reducible, this means that a subgraph with positive charge is adjacent,
giving us a natural candidate for a new discharging rule.

Conversely, sometimes we can spot common themes in the reducible configurations, such as specific subgraphs
that appear in many of them and are helpful in the reducibility arguments. It is then convenient to introduce
discharging rules that transfer charges from these subgraphs or their neighborhoods.  This then means that
when charge becomes negative in some configuration due to these transfers, we know the configuration contains
one of these useful subgraphs that make it more likely to be reducible.

Let us now go over some ideas that often appear in the proofs of reducibility.  We focus on the cases of
ordinary proper coloring and list coloring for concreteness.

Reducible configurations often consist of vertices of small degree.  When we are using $k$ colors, vertices
of degree less than $k$ are trivially reducible. By Corollary~\ref{cor:gallai1}, any $2$-connected subgraph
consisting of vertices of degree exactly $k$ is reducible unless it is an odd cycle or a clique; see
Subsection~\ref{ssec-gallai} for a more detailed analysis of reducibility of subgraphs whose vertices have degree exactly $k$.
As a rule of thumb, vertices in a reducible configuration have at most $k-2$ neighbors outside of the configuration---if
a vertex $v$ has $k-1$ neighbors outside the configuration, a precoloring of the neighbors can force uniquely the color
of $v$, and so we can as well not include $v$ in the configuration and consider it precolored directly (of course,
there are exceptions to this rule, especially in reductions that further modify the graph after removing the configuration, see
Lemmas~\ref{fig:tetrad} and \ref{lemma:grgim-redu} for examples).
When this rule of thumb is satisfied, we can often prove reducibility even if one or a few of the vertices have degree slightly larger than $k$,
but there is no simple overarching result generalizing Corollary~\ref{cor:gallai1}.  The following examples are commonly useful, see Figure~\ref{fig:diamredu}.
\begin{figure}
\begin{center}
\begin{asy}
v[0] = (0,0);
v[1] = v[0] + (0,-2);
path p1 = v[0]{dir(180)} .. {dir(0)} v[1];
path p2 = v[0]{dir(0)} .. {dir(180)} v[1];

draw(p1);
draw(p2);
draw(v[0]--v[1]);
vertex (v[0]);
vertex (v[1], black);
label("$v$", v[0], N);
label("$u$", v[1], S);
label("$P_1$", point (p1, 0.5), W);
label("$P_2$", point (p2, 0.5), E);

label ("(a)", v[0] + (0,-3));

v[0] = (4,0);
v[1] = v[0] + (-0.5,-2);
v[2] = v[0] + (0.5,-2);
p1 = v[0]{dir(180)} .. {dir(0)} v[1];
p2 = v[0]{dir(0)} .. {dir(180)} v[2];
v[3] = point(p1,0.2);
v[4] = point(p2,0.2);

draw(p1);
draw(p2);
draw(v[0]--v[1]--v[2]--cycle);
vertex (v[0]);
vertex (v[1], black);
vertex (v[2], black);
vertex (v[3]);
vertex (v[4]);
label("$v$", v[0], N);
label("$x$", v[1], S);
label("$y$", v[2], S);
label("$x'$", v[3], NW);
label("$y'$", v[4], NE);
label("$P_1$", point (p1, 0.5), W);
label("$P_2$", point (p2, 0.5), E);

label ("(b)", v[0] + (0,-3));
\end{asy}
\end{center}
\caption{Reducible configurations from Lemma~\ref{lemma:diamredu}.  Vertices drawn by full circles have degree $k+1$, while other vertices have degree $k$.}\label{fig:diamredu}
\end{figure}

\begin{lemma}\label{lemma:diamredu}
Let $L$ be an assignment of lists of size $k$ to vertices of a graph $G$.  Let $H$ be an induced subgraph of $G$ satisfying one of the following
conditions:
\begin{itemize}
\item[\textrm{(a)}] $H$ consists of adjacent vertices $u$ and $v$ and two paths $P_1$ and $P_2$ from $u$ to $v$ intersecting only in their
endpoints, such that all vertices of $H$ except for $u$ have degree $k$ in $G$ and $u$ has degree $k+1$ in $G$.
\item[\textrm{(b)}] $H$ consists of a triangle $vxy$ and paths $P_1$ from $v$ to $x$ and $P_2$ from $v$ to $y$ intersecting only in their
endpoints, such that all vertices of $H$ except for $x$ and $y$ have degree $k$ in $G$ and $x$ and $y$ have degree $k+1$ in $G$.
\end{itemize}
In the former case, let $G'=G-V(H)$; in the latter case, let $G'=G-xy$.  If $G'$ is $L$-colorable, then $G$ is $L$-colorable.
\end{lemma}
\begin{proof}
Let $\varphi$ be any $L$-coloring of $G-V(H)$.  For $z\in V(H)$, let
$$L'(z)=L(z)\setminus \{\varphi(w):w\in V(G)\setminus V(H), zw\in E(G)\}.$$
Clearly, it suffices to argue that if $\varphi$ extends to an $L$-coloring of $G'$, then $H$ is $L'$-colorable.

Let us first consider the case (a).  Let $P$ be the path $(P_1\cup P_2)-v$.  Note that $|L'(v)|\ge 3$ and $|L'(x)|\ge 2$ for all $x\in V(P)$.
Without loss of generality, we can assume that $|L'(v)|=3$ and $|L'(x)|=2$ for all $x\in V(P)$, as otherwise
we can remove extra colors from the lists of the vertices.  If all vertices of $P$ had the same list, then we can color $v$ by a color in $L'(v)$
not belonging to the list and independently color $P$ from its list.  Hence, by symmetry and connectedness of $P$, we can assume that there
exists $xy\in E(P)$ such that $L'(x)\neq L'(y)$ and $u$ is not contained in the component $P_0$ of $P-y$ containing $x$.  Then, we first
$L'$-color the path $P-V(P_0)$ so that the color of $y$ does not belong to $L'(x)$ and then greedily color $v$ and $P_0$.

Next, we consider the case (b).  Let $P$ be the path $(P_1\cup P_2)-v+xy$.  Without loss of generality, we can assume
that $|L'(v)|=4$ and $|L'(z)|=2$ for all $z\in V(P)$.  Let $x'$ and $y'$ be the endpoints of $P$
belonging to $P_1$ and $P_2$, respectively.  We say that an $L'$-coloring of $P$ is tough if $\{\psi(x'),\psi(x),\psi(y),\psi(y')\}=L(v)$,
and in particular the vertices $x'$, $x$, $y$, and $y'$ have distinct colors.
If not all vertices of $P_2-v$ have the same list, then there exist two $L'$-colorings of $P_2-v$ assigning the same color to $y$ and different colors to $y'$.
We can extend both of them to $L'$-colorings of $P$ that match on $P_1-v$; observe that at least one of the colorings is not tough, and thus it extends to an $L'$-coloring
of $H$.  Hence, we can assume that all vertices of $P_2-v$ have the same list $L_2$, and by symmetry, all the verticesin $P_1-v$ have the same list $L_1$.
If either $P_1-v$ or $P_2-v$ has even length or $L'(v)\neq L_1\cup L_2$, then an $L'$-coloring of $P$ is not tough and extends to an $L'$-coloring of $H$.
Otherwise, $H-xy$ has no $L'$-coloring, and thus $\varphi$ does not extend to an $L$-coloring of $G'$.
\end{proof}

The reductions so far only removed the reducible configuration or its part from the graph.  These kinds of reductions are the easiest
to use (they cannot create loops or other subgraphs that may be forbidden by assumptions), but of course they do not suffice in many cases.
After removing the configuration, it is often useful to add edges between edges in the neighborhood of the configuration, or to replace the
configuration by a suitable subgraph, the idea of course being that this subgraph forbids the colorings of the rest of the graph that do not
extend to the original configuration.  Again, let us point out common examples.
\begin{lemma}\label{lemma:oddclredu}
Let $H$ be either an odd cycle or a clique in a graph $G$.  Let $k=3$ in the former case and $k=|V(H)|$ in the latter case, so that $H$ is a $(k-1)$-regular graph.
Suppose that all vertices of $H$ have degree exactly $k$ in $G$.  Let $u$ and $v$ be distinct vertices of $G$ with neighbors in $H$.
If the graph $G'$ obtained from $G-V(H)$ by adding the edge $uv$ is $k$-colorable, then $G$ is $k$-colorable.
\end{lemma}
\begin{proof}
Consider any $k$-coloring $\varphi$ of $G'$.  For $x\in V(H)$, let $L(x)$ be the list of $k-1$ colors distinct from the color of the neighbor of $x$ in $V(G)\setminus V(H)$.
Because of the edge $uv$, not all these lists are the same, and since $H$ is connected, there exists $xy\in E(H)$ such that $L(x)\neq L(y)$.
Color $x$ by a color in $L(x)\setminus L(y)$, and then color the remaining vertices of $H$ greedily, in order along the cycle if $H$ is an odd cycle
and in an arbitrary order ending with $y$ if $H$ is a clique.
\end{proof}

\begin{lemma}\label{lemma:trian33}
Let $uvx$ be a triangle in a graph $G$, where $u$ and $v$ have degree three and $u'$ and $v'$ are their neighbors not in $\{x,u,v\}$.
If the graph $G'$ obtained from $G-\{u,v\}$ by adding the edge $u'v'$ is $3$-colorable, then $G$ is $3$-colorable.
\end{lemma}
\begin{proof}
Consider any $3$-coloring $\varphi$ of $G'$.  If $\varphi(u')=\varphi(x)$, we can color $v$ and $u$ greedily in order.
If $\varphi(v')=\varphi(x)$, we can color $u$ and $v$ greedily in order.  Otherwise, because of the edge $u'v'$,
the colors $\varphi(u')$, $\varphi(v')$, and $\varphi(x)$ are pairwise distinct, and we can color $u$ by $\varphi(v')$
and $v$ by $\varphi(u')$.
\end{proof}

Of course, when we add edges or other subgraphs, we may need to verify that we do not create loops or other forbidden subgraphs;
ideas from Section~\ref{sec:precolface} may be useful.

Further possiblity is to identify some vertices after the reduction in addition to the previously described transformations.
the Folding Lemma~\ref{lemma:folding} may simplify verification of the assumptions.  Vertex identification is a rather powerful
tool, especially when dealing with configurations containing vertices whose degree exceeds number of colors; e.g., identifying
neighbors of such vertices effectively reduces their degree.  A downside is that vertex identification is in general not
applicable for list coloring, since it is not possible to identify vertices with different lists (but see Chapter~\ref{chap:corresp}
for a partial workaround).

Finally, we need to mention the method of Kempe chains, which suitably modifies the coloring of the rest of the graph
before extending it to the reduced configuration (whose reduction may involve all other transformations described here).
Unlike the methods mentioned so far, Kempe chains are non-local and may affect the coloring of the whole graph, which may be
inconvenient when considering e.g. precoloring extension problems.  Furthermore, their applicability is restricted to ordinary
proper coloring and a few of its variants.  Nevertheless, when applicable, Kempe chains make it possible to show reducibility
of configurations widely beyond the reach of other methods.  We will discuss them in more detail in Chapter~\ref{chap:recolor}.

\chapter{List Coloring}

% LP

\section{Overview of the Method}
\begin{itemize}
\item definitions and why useful
\item Even cycles are $2$-choosable; antimatching (Erdos, Rubin, Taylor); Brooks' for list?
\end{itemize}

\subsection{Brooks' Theorem and Gallai trees}\label{ssec-gallai}

As we mentioned in the introduction, Brooks' Theorem generalizes to the list coloring setting;
in Lemma~\ref{lemma:gallai1}, we stated a quite useful variant for the list assignments where the
sizes of the lists match the degrees of the vertices.  Lemma~\ref{lemma:gallai1} is restricted
only to $2$-connected graphs; however, as we now show, this restriction is easy to lift.
In the process, we will also give a proof of Lemma~\ref{lemma:gallai1}.
A \emph{degree-sized assignment} to a graph $G$ is a list assignment such that $|L(v)|\ge \deg(v)$ for all $v\in V(G)$.
The greedy coloring argument is almost good enough to color a connected graph from a degree-sized assignment---we can only get stuck
at the last vertex.  This observation gives us the following result.

\begin{lemma}\label{lemma:gal-trive}
Let $G$ be a connected graph and let $L$ be a degree-sized assignment for $G$.  If $G$ is not $L$-colorable,
then $|L(v)|=\deg(v)$ for all $v\in V(G)$.
\end{lemma}
\begin{proof}
If $|L(v)|>\deg(v)$, then let $v_1$, \ldots, $v_n$ be a listing of vertices of $G$ in non-increasing order
according to their distance from $v$; hence, $v_n=v$ and for $1\le i\le n-1$, the vertex $v_i$ has a neighbor $v_j$
with $j>i$ (the neighbor of $v_i$ on a shortest path from $v_i$ to $v$).  Let us greedily $L$-color $v_1$, \ldots, $v_n$
in order.  For $1\le i\le n-1$, at least one neighbor of $v_i$ has not been colored yet, and thus at most $\deg(v_i)-1<|L(v_i)|$
colors need to be avoided.  At $v_n$, at most $\deg(v_n)<|L(v_n)|$ colors need to be avoided.  Hence, in both cases, we can
give $v_i$ a color from its list different from the colors of its neighbors.
\end{proof}

We now apply the preceding lemma to obtain a key property of graphs not colorable from a degree-sized assignment.

\begin{corollary}\label{cor:gal-adj}
Let $G$ be a connected graph and let $L$ be a degree-sized assignment for $G$.
If $G$ is not $L$-colorable, $uv\in E(G)$ and $u$ is not a cutvertex in $G$,
then $L(u)\subseteq L(v)$.
\end{corollary}
\begin{proof}
Suppose for a contradiction that $L(u)\not\subseteq L(v)$, and thus there exists a color $c\in L(u)\setminus L(v)$.
Let $G'=G-u$; since $u$ is not a cutvertex, $G'$ is connected.
Let $L'(x)=L(x)\setminus\{c\}$ for all neighbors $x$ of $u$ and $L'(x)=L(x)$ for all non-neighbors $x$.
Note that the list size decreases only for neighbors of $u$, and their degree decreases by the removal of $u$ as well,
and thus $L'$ is a degree-sized assignment for $G'$.  Furthermore, $|L'(v)|=|L(v)|\ge \deg_G(v)>\deg_{G'}(v)$,
and thus $G'$ is $L'$-colorable by Lemma~\ref{lemma:gal-trive}.  We can extend this coloring to an $L$-coloring of $G$ by giving $v$ color $c$,
which is a conradiction.
\end{proof}

Note that if neither $u$ nor $v$ is a cutvertex, then Corollary~\ref{cor:gal-adj} implies $L(u)\subseteq L(v)$ and $L(v)\subseteq L(u)$,
and thus $L(u)=L(v)$.  This is enough to prove Lemma~\ref{lemma:gallai1}, in the following slightly stronger form.

\begin{corollary}\label{cor:gal-2con}
Let $G$ be a $2$-connected graph and let $L$ be a degree-sized assignment for $G$.  Then $G$ is not $L$-colorable if and only if
$G$ is a clique or an odd cycle and all vertices of $G$ have the same list of length equal to the degree of vertices of $G$.
\end{corollary}
\begin{proof}
Clearly a clique $K_k$ is not colorable from the assigment of the same list of size $k-1$ to each vertex,
and an odd cycle is not colorable from the assignment of the same list of size $2$ to each vertex.
Hence, we only need to prove the ``only if'' part.  Suppose that a $2$-connected graph $G$ is not $L$-colorable
from a degree-sized assignment $L$.  Since $G$ is $2$-connected, Corollary~\ref{cor:gal-adj} implies that any two adjacent
vertices of $G$ have the same list, and consequently all the vertices of $G$ have the same list, say $\{1,\ldots,d\}$,
where $d\le \Delta(G)$.  It follows that $G$ is not $d$-colorable, and thus either $G=K_{d+1}$ or $d=2$ and $G$ is
an odd cycle by the Brooks' theorem (see Theorem~\ref{thm:brooks}).
\end{proof}

A \emph{Gallai forest} is a graph whose $2$-connected blocks are cliques and odd cycles,
and a \emph{Gallai tree} is a connected Gallai forest.
Suppose $B_1$, \ldots, $B_k$ are the blocks of a Gallai tree $T$, and let $S_1$, \ldots, $S_k$ be sets of colors
satisfying the following conditions:
\begin{itemize}
\item For $1\le i\le k$, if $B_i$ is a clique, then $|S_i|=|V(B_i)|-1$, and if $B_i$ is an odd cycle, then $|S_i|=2$.
\item For $1\le i<j\le k$, if $B_i\cap B_j\neq\emptyset$, then $S_i\cap S_j=\emptyset$.
\end{itemize}
For $v\in V(T)$, let $L(v)=\bigcup_{v\in B_i} S_i$.  If a list assignment $L$ can be expressed in this way, we say
that $L$ is a \emph{blockwise uniform} assignment for $T$.  We are now ready to give the full characterization of
graphs not colorable from a degree-sized assignment.

\begin{theorem}[Gallai~\cite{galfor}]\label{thm:gallai}
Let $G$ be a connected graph and let $L$ be a degree-sized assignment for $G$. Then $G$ is not $L$-colorable if and only if
$G$ is a Gallai tree and $L$ is blockwise uniform.
\end{theorem}
\begin{proof}
It is easy to see that a Gallai tree cannot be colored from a blockwise uniform assignment, and thus it suffices to prove
the ``only if'' part.  We do the proof by induction on the number of vertices of $G$, and thus we can assume that the
claim holds for all graphs with fewer than $|V(G)|$ vertices.

By Corollary~\ref{cor:gal-2con}, the claim holds when $G$ is $2$-connected.  Hence, suppose that $G$ is not $2$-connected.
First, we prove that $G$ is a Gallai tree.  Let $B$ be a block of $G$.  Since $G$ is not $2$-connected, there exists a leaf block $B'$ of $G$
distinct from $B$.  Let $v$ be a vertex of $B'$ which is not a cutvertex, and let $G'=G-v$.  Let $c$ be any color in $L(v)$
and let $L'(x)=L(x)\setminus\{c\}$ for all neighbors $x$ of $v$ and $L'(x)=L(x)$ for all other vertices $x$ of $G'$.  Note that $L'$
is a degree-sized assignment for $G'$ and that $G'$ is not $L'$-colorable, as otherwise we can extend the coloring to an $L$-coloring of $G$ by giving $v$ the color $c$.
By the induction hypothesis, $G'$ is a Gallai tree.  Note that $B$ is also a block of $G'$, and thus $B$ is a clique or an odd cycle.
As the choice of $B$ was arbitrary, all blocks of $G$ are cliques or odd cycles, and thus $G$ is a Gallai tree.

Let $B_1$, \ldots, $B_k$ be the blocks of $G$, where without loss of generality $B_k$ is a leaf block.
Let $z$ be the cutvertex of $B_k$ and let $v$ be any other vertex of $B_k$, and let $S_k=L(v)$; by Corollary~\ref{cor:gal-adj}, we conclude that
all non-cut vertices of $B_k$ have list $S_k$, and $S_k\subseteq L(z)$.  By Lemma~\ref{lemma:gal-trive}, if $B_k$ is a clique then $|S_k|=|B_k|-1$, and if $B_k$ is an odd cycle, then $|S_k|=2$.
Let $G'=B_1\cup\ldots\cup B_{k-1}$, let $L'(x)=L(x)$ for $x\in V(G')\setminus \{z\}$ and $L'(z)=L(z)\setminus S_k$.  Note that $L'$ is a degree-sized assignment
for $G'$ and that $G'$ is not $L'$-colorable, as otherwise the coloring would extend to an $L$-coloring of $G$ by using the colors in $S_k$ to color $B_k-z$.
By the induction hypothesis, $L'$ is blockwise uniform as shown by sets $S_1$, \ldots, $S_{k-1}$.  But then the sets $S_1$, \ldots, $S_{k-1}$, $S_k$ show
that $L$ is blockwise uniform.
\end{proof}

\section{Book Proof: $5$-choosability of planar graphs}

\begin{theorem}\label{thm:5choosbook}
Let $G$ be a plane graph, let $e$ be an edge incident with its outer face,
and let $L$ be a list assignment such that vertices incident with $e$ have distinct
lists of size $1$, all other vertices incident with the outer face have lists of size at least $3$
and all vertices not incident with the outer face have lists of size at least $5$.  Then $G$ is $L$-colorable.
\end{theorem}
\begin{proof}
We prove the claim by induction on $|V(G)|$, the basic case $|V(G)|=2$ being trivial.
We can assume that $G$ is connected; isolated vertices can be colored, and any other component
is $L$-colorable by induction hypothesis (selecting an edge incident with its outer face and decreasing
the sizes of the lists of incident vertices arbitrarily).

Furthermore, we can assume that $G$ is $2$-connected
and the cycle $K$ bounding its outer face is induced: otherwise, there exist proper induced subgraphs $G_1$ and $G_2$
of $G$ such that $G_1\cup G_2=G$, $e\in E(G_1)\setminus E(G_2)$, and $G_1\cap G_2$ is either a single vertex or a chord of $K$.
In the latter case, let $e_2$ be the edge of $G_1\cap G_2$; in the former case, let $e_2$ be an edge of $G_2$ incident with the
vertex of $G_1\cap G_2$ and the outer face of $G_2$.  Let $e_2=x_1x_2$.  By the induction hypothesis, there exists an $L$-coloring $\varphi_1$ of
$G_1$.  Let $L_2$ be the list assignment for $G_2$ obtained from $L$ by removing colors from the lists of $x_1$ and $x_2$
so that $L_2(x_1)$ and $L_2(x_2)$ are distinct lists of size $1$ and $L_2(x_i)=\{\varphi_1(x_i)\}$ for all $i\in\{1,2\}$
such that $x_i\in V(G_1\cap G_2)$.  By the induction hypothesis, $G_2$ has an $L_2$-coloring $\varphi_2$.  By the choice
of $L_2$, the colorings $\varphi_1$ and $\varphi_2$ match on $G_1\cap G_2$, and thus they give an $L_2$-coloring of $G$.

Let $v_1v_2v_3v_4$ be part of the boundary walk of the outer face of $G$, where $e=v_1v_2$; note that possibly $v_4=v_1$
if the outer face is bounded by a triangle.  Since $|L(v_3)|\ge 3$ and $|L(v_2)|=1$, there exists a set $S\subseteq L(v_3)\setminus L(v_2)$
of size two.  Let $L'$ be the list assignment obtained from $L$ by removing $S$ from the lists of neighbors of $v_3$, except
from the list of $v_4$ (and the list of $v_2$, which is disjoint from $S$).  Since the cycle bounding the outer
face has no chords, colors are being removed only at vertices whose list has size 5, and all these vertices are incident
with the outer face of $G-v$.  Hence, $G-v$ with the list assignment $L'$ satisfies the assumptions of the theorem, and
by the induction hypothesis, there exists an $L'$-coloring $\varphi$ of $G-v$.  Note that $\varphi(x)\not\in S$ for
each neighbor of $v$ except possibly for $x=v_4$.  Hence, we can extend the coloring to an $L$-coloring of $G$ by giving $v$
a color in $S\setminus\{\varphi(v_4)\}$.
\end{proof}

Let us remark that there is another, slighlty different way of finishing the proof.  Let the set $S$ of two colors
be again defined in the same way, and let $v_1v_2v_3\ldots v_k$ be the shortest subwalk of the boundary walk of the outer face
of $G$ such that $S\not\subseteq L(v_k)$ (which happens at latest when $v_k=v_1$).  Let $P$ be the path $v_3\ldots v_{k-1}$
and note that $S\subseteq L(x)$ for all $x\in V(P)$.  Let $\psi$ be a proper coloring of $P$ using the colors from $S$
such that $\psi(v_{k-1})\not\in\psi(v_k)$.  Let $L'$ be the list assignment obtained from $L$ by removing from the list
of each vertex the colors used by $\psi$ on its neighbors.  Since $\psi$ uses only two colors, the cycle bounding the outer
face has no chords, and lists of $v_2$ and $v_k$ are unaffected, it follows that $G-V(P)$ with list assignment $L'$
satisfies the assumptions of the theorem, and $G-V(P)$ can be $L'$-colored by the induction hypothesis.  Together with $\psi$,
this gives an $L$-coloring of $G$.

\subsection{A non-book proof}

Both the formulation of Theorem~\ref{thm:5choosbook} and its proof are exceptionally elegant.
However, they are something of an anomaly, not the most typical examples of the method.
Let us give another proof of $5$-choosability of planar graphs whose ideas translate directly to other
contexts, such as the proof of Grotzsch's theorem we give in the next section.

\begin{theorem}\label{thm:5choos-nonbook}
Let $G$ be a plane graph and let $P$ be a path of length at most two contained in the boundary of the
outer face of $G$.  Let $L$ be a list assignment satisfying the following conditions:
\begin{itemize}
\item[\textrm{(S)}] Vertices of $P$ have lists of size $1$, other vertices incident with the outer face have lists
of size at least three, and vertices not incident with the outer face have lists of size at least $5$.
\item[\textrm{(P)}] The lists of vertices of $P$ give a proper coloring of the subgraph of $G$ induced by $V(P)$,
and if a vertex $v$ with list of size three has three neighbors in $P$, then $L(v)$ contains a color not appearing
in the lists of vertices of $P$.
\item[\textrm{(I)}] The vertices with list of size exactly three form an independent set in $G$.
\end{itemize}
Then $G$ is $L$-colorable.
\end{theorem}
\begin{proof}
Suppose for a contradiction that $G$ with list assignment $L$ is a counterexample with $|V(G)|+|E(G)|$ minimum.
It is easy to check that the theorem holds for graphs with at most $4$ vertices, and thus $|V(G)|\ge 5$.

We claim that $G$ is $2$-connected: indeed, otherwise $G=G_1\cup G_2$ for proper induced subgraphs $G_1$ and $G_2$
intersecting in at most one vertex.  We can assume that either $P\subseteq G_1$, or $P$ has length two and each of $G_1$
and $G_2$ contains an edge of $P$.  By the minimality of $G$, there exists an $L$-coloring $\varphi_1$ of $G_1$.
Let $L_2$ be the list assignment obtained from $L$ by changing the list of the vertex $x$ in the intersection of $G_1$ and $G_2$
(if any) to $\{\varphi_1(x)\}$.  Again by the minimality of $G$, there exists an $L_2$-coloring $\varphi_2$ of $G_2$.
The colorings $\varphi_1$ and $\varphi_2$ match on $G_1\cap G_2$, and thus they give an $L$-coloring of $G$, which is a contradiction.

Let $K$ denote the cycle bounding the outer face of $G$.  The argument of the previous paragraph can also be used to show
that $K$ has no chords, except possibly if $|V(P)|=3$ and the chord is incident with the middle vertex of $P$.
Without loss of generality, we can assume that $|V(P)|=3$, since otherwise we can remove all but one color from the list of
a vertex $x$ adjacent to $P$ (so that the resulting list is distinct from the lists of the vertices of $P$) and add it to the path;
the condition (P) is satisfied by the choice of the list of $x$ and the restriction on the chords of $K$.
Let $P=p_1p_2p_3$.

We claim that for every $(\le\!4)$-cycle $C$ in $G$, the open disk $\Lambda$ bounded by $C$ contains no vertices of $G$.
Otherwise, let $G_1$ be obtained from $G$ by removing vertices drawn in $\Lambda$ and let $G_2$ be the subgraph of $G$ drawn
in the closure of $\Lambda$.  By the minimality of $G$, the graph $G_1$ has an $L$-coloring $\varphi_1$.
Let $v$ be an arbitrary vertex of $C$.  Let $L_2$ be the list assignment for $G_2-v$ defined as follows:
Each vertex $z\in V(C)\setminus \{v\}$ has list $L_2(z)=\{\varphi_1(z)\}$.  Each vertex $z\in V(G_2)\setminus V(C)$
has list $L_2(z)=L(z)\setminus \{\varphi_1(v)\}$ if $z$ is adjacent to $v$ and $L_2(z)=L(z)$ otherwise.
By the minimality of $G$, the graph $G_2-v$ is $L_2$-colorable, and combining its $L_2$-coloring with $\varphi_1$,
we obtain an $L$-coloring of $G$; this is a contradiction.

Suppose now that the cycle $K$ bounding the outer face of $G$ has a chord, necessarily incident with the middle vertex of $P$.
Let $p_2v$ be such a chord and let $G_1$ and $G_2$ be proper induced subgraphs of $G$ such that $G=G_1\cup G_2$ and $G_1\cap G_2=p_2v$,
with $p_1\in V(G_1)$ and $p_3\in V(G_2)$.  Choose the chord so that $G_2$ is minimal, and thus $p_2$ has no neihbors in $V(K\cap G_2)$
other than $v$ and $p_3$.  If $vp_3\not\in E(G_2)$, we can $L$-color $G_1$ and extend the coloring to an $L$-coloring of $G_2$
by the minimality of $G$, modifying the list of $v$ to a singleton matching the coloring of $G_1$ first---the assumption (P)
for $G_2$ is satisfied by the choice of $G_2$.  This is a contradiction, and thus $vp_3\in E(G_2)$.  Since all chords of $K$
are incident with $p_2$ and $3$-cycles in $G$ bound faces, we conclude that $G_2$ is equal to the triangle $p_2p_3v$.
Since $|V(G)|\ge 5$, the same argument implies $vp_1\not\in E(G_1)$.  If $p_1$, $p_2$, and $v$ have a common neighbor $z$ with $L(z)=3$,
then by (I) we have $|L(v)|\ge 4$, and thus we can choose a color $c\in L(v)\setminus (L(p_2)\cup L(p_3))$ such that $L(z)\neq L(p_2)\cup L(p_3)\cup \{c\}$.
Otherwise, let $c$ be an arbitrary color in $L(v)\setminus (L(p_2)\cup L(p_3))$.  Let $L_1$ be the list assignment obtained from
$L$ by setting $L_1(v)=\{c\}$.  By the minimality of $G$, we conclude that $G_1$ is $L_1$-colorable---the assumption (P) for $G_1$
is satisfied by the choice of $c$.  This gives an $L$-coloring of $G$, which is a contradiction.

Therefore, $K$ is an induced cycle.  Furthermore, an analogous argument shows the following.
\begin{itemize}
\item[(A)] Let $v_1v_2v_3$ be a path in $G$ such that $v_1,v_3\in V(K)\setminus\{p_2\}$ and $v_2\not\in V(K)$.
Let $G_1$ and $G_2$ be proper subgraphs of $G$ such that $G=G_1\cup G_2$, $G_1\cap G_2=v_1v_2v_3$, and $P\subseteq G_1$.
Then either $v_1v_3\in E(G)$ and $G_2$ is the triangle $v_1v_2v_3$, or $V(G_2)=\{v_1,v_2,v_3,z\}$ for a vertex $z$
with $|L(z)|=3$ adjacent to $v_1$, $v_2$, and $v_3$.
\end{itemize}
In particular, if $p_1$, $p_2$, and $p_3$ had a common neighbor, then by (A) we would conclude that $K$ is a $4$-cycle;
however, since the open disk bounded by a $4$-cycle in $G$ cannot contain any vertex, this would give a contradiction.
Hence, $p_1$, $p_2$, and $p_3$ do not have a common neighbor.

Consider the walk $p_1p_2p_3v_1v_2v_3v_4$ along the cycle $K$ (since the open disk bounded by a $(\le\!4)$-cycle contains no
vertices and $|V(G)|\ge 5$, we have $v_1,v_2\not\in V(P)$, but $v_3$ or $v_4$ can be vertices of $P$).
Note that $|L(v_1)|\le 4$ and either $|L(v_1)|=3$ or $|L(v_2)|=3$, as otherwise we can remove the color in $L(p_3)$ from the
list of $v_1$ and remove the edge $p_3v_1$ to obtain a counterexample smaller than $G$.
Let $X$ be a set of vertices of $G$ and let $\psi$ be an $L$-coloring of some vertices of $X$ defined as follows:
\begin{itemize}
\item If $|L(v_1)|=4$ (and thus $|L(v_2)|=3$ as we argued and $|L(v_3)|\neq 3$ by (I)):
\begin{itemize}
\item If $|L(v_3)|\neq 4$, or $|L(v_3)|=4$ and $|L(v_4)|\neq 3$, then $X=\{v_2\}$ and $\psi(v_2)$ is chosen
from $L(v_2)\setminus L(p_1)$ arbitrarily.
\item If $|L(v_3)|=4$ and $L(v_4)=3$:
\begin{itemize}
\item[($\star$)] If $v_1$, $v_2$, and $v_3$ do not have a common neighbor, then $X=\{v_2,v_3\}$, $\psi(v_3)$ is chosen from $L(v_3)\setminus L(v_4)$
arbitrarily, and $\psi(v_2)$ is chosen from $L(v_2)\setminus \{\psi(v_3)\}$ arbitrarily.
\item[($\star\star$)] If $v_1$, $v_2$, and $v_3$ have a common neighbor, then $X=\{v_1,v_2,v_3\}$, $\psi(v_3)$ is chosen from $L(v_3)\setminus L(v_4)$
arbitrarily, $\psi(v_1)$ is chosen from $L(v_1)\setminus L(p_3)$ so that $|L(v_2)\setminus \{\psi(v_1),\psi(v_3)\}|\ge 2$,
and $v_2$ is not colored by $\psi$.
\end{itemize}
\end{itemize}
\item If $|L(v_1)|=3$ (and thus $|L(v_2)|\ge 4$ by (I)):
\begin{itemize}
\item If $|L(v_2)|\ge 5$ or $|L(v_2)|=4$ and $|L(v_3)|\neq 3$, then $X=\{v_1\}$ and $\psi(v_1)$ is chosen from $L(v_1)\setminus L(p_3)$ arbitrarily.
\item If $|L(v_2)|=4$ and $|L(v_3)|=3$, then $X=\{v_1,v_2\}$, $\psi(v_2)$ is chosen from $L(v_2)\setminus L(v_3)$ arbitrarily,
and $\psi(v_1)$ is chosen from $L(v_1)\setminus (L(p_3)\cup \{\psi(v_2)\})$ arbitarily.
\end{itemize}
\end{itemize}
Let $L'$ be the list assigment for $G-X$ such that $$L'(z)=L(z)\setminus\{\psi(x):x\in\text{dom}(\psi), xz\in E(G)\}$$
for each $z\in V(G)\setminus X$.  Note that the choice of $\psi$ together with the fact that $K$ is an induced cycle and
that $|\text{dom}(\psi)|\le 2$ implies that $G-X$ with the list assignment $L'$ satisfies the condition (S).
Since $p_1$, $p_2$, and $p_3$ have no common neighbor, it also satisfies the condition (P).

Suppose that $G-X$ contains an edge $uv$ such that $|L'(u)|=|L'(v)|=3$.  Since $K$ is an induced cycle, the choice of $\psi$
implies that $u$ and $v$ cannot both be vertices of $K$, and thus say $v\in V(G)\setminus V(K)$.  Hence $|L(v)|\ge 5$,
and thus $|\text{dom}(\psi)|=2$ and $v$ is adjacent to both vertices of $\text{dom}(\psi)$.  If $u$ were also adjacent
to both vertices of $\text{dom}(\psi)$, then $G$ would contain a $(\le\!4)$-cycle bounding an open disk containing a vertex,
which is a contradiction.  Hence, $u$ has at most one neighbor in $\text{dom}(\psi)$, and since $|L'(u)|=3$,
we conclude that $u\in V(K)$.  It follows that $v$ has three neighbors in $K-V(P)$, and by (A),
these neighbors are consecutive in $K-V(P)$ and the middle one of them has list of size three.
However, this is not possible by the choice of $X$ and $\psi$---the only problematic case is ($\star$), but
there it is explicitly assumed that the three vertices do not have a common neighbor.

Therefore, $G-X$ with the list assignment $L'$ satisfies the condition (I), and by the minimality of $G$, it
follows that $G-X$ is $L'$-colorable.  However, an $L'$-coloring of $G-X$ can be extended to an $L$-coloring of $G$
by combining it with $\psi$ and in the case ($\star\star$) by extending the coloring to $v_2$ by giving
$v_2$ the color in $L(v_2)\setminus \{\psi(v_1),\psi(v_3)\}$ different from the color of the common neighbor
of $v_1$, $v_2$, and $v_3$ (note that $v_2$ has no other neighbors by (A)).  This is a contradiction.

Hence, there exists no counterexample to Theorem~\ref{thm:5choos-nonbook}.
\end{proof}

\section{The Short List-Coloring Proof of Grotzsch's theorem}

using $|P|\le 6$ and $|P|\le 4$ if allowing one adjacent pair of lists of size two

...

??? Comments on choice of the assumptions (if we can come up with something profound on the topic :-).

\section{Generalizations}

??? Distant precolored vertices
??? Distant cycles with reduced lists

\chapter{Recoloring}\label{chap:recolor}

Very often, we seek colorings of graphs satisfying some additional constraints.
This may be inherent to the considered question; e.g., in the precoloring extension problem,
a coloring of some vertices is fixed and we ask whether this coloring can be extended to the
whole graph, or quivalently, whether there exists a coloring that matches the colors of the fixed
vertices.  Or, it may be something needed to make another argument work; e.g., when showing that
a particular configuration is reducible (as in Chapter~\ref{chap:redu}, we seek a coloring of the rest
of the graph with the additional property that it extends to a coloring of the configuration in question.

In either case, rather than directly finding a coloring satisfying the additional constraints,
it may be easier to start with an arbitrary coloring and to modify it somehow to satisfy the constraints.
There are two major ways how to achieve that.
\begin{itemize}
\item We may be able to perform local recoloring---change colors of the vertices to satisfy the constraints
and then possibly alter the coloring of their bounded neighborhoods to fix any arising edges joining vertices of the same color.
Typically, this involves starting with a coloring that uses fewer colors than the coloring we look for
(e.g., to find a 4-coloring with additional properties, we start with a $3$-coloring which we modify to
satisfy the properties, introducing the 4th color in the process)---the extra available color or colors give us the flexibility
to absorb the changes within a bounded distance.
\item Or, we may need to do global recoloring, where coloring of arbitrarily distant parts of the graph may change.
The best known means of doing so are Kempe chain switches: a Kempe chain is a maximal bichromatic subgraph of the considered
graph, and we can alter the coloring by switching the colors in the Kempe chain.  Of course, this would be pointless if
the Kempe chain contained all the vertices of the two considered colors, as this would just rename the colors.  However,
in some situations, the extent of Kempe chains is restricted.  In plane graphs (or more generally, in graphs embedded
in a fixed surface), Kempe chains for disjoint pairs of colors are constrained by the embedding.  In the case of edge coloring,
Kempe chains form paths and even cycles.  In these situations, switching on Kempe chains can dramatically alter the properties
of the coloring, possibly making us able to satisfy the constraints.
\end{itemize}
It follows from the nature of the described transformations that if local recoloring is applied, many different constraints
may be satisfiable independently, assuming they are far apart.  Conversely, global recoloring methods are generally only applicable
to a single or a small number of localized constraints, since altering the coloring to satisfy one of the constraints may
affect validity of other previously satisfied constraints.

In addition to satisfying specific constraints, recoloring methods may also be used to show that a graph has many different
colorings.  This is clear for the local recoloring methods, at least in graphs with bounded maximum degree: if we can independently alter
the coloring at many disjoint locations,
we obtain a large number of different colorings.  Somewhat surprisingly, global recoloring and in particular Kempe chains
are also sometimes useful in this context, if we can show that the number of distinct Kempe chains for some pair of colors is large.

\section{Precoloring extension and local recoloring}

Perhaps the most natural way of giving additional constraints on colorings is to prescribe colors of some vertices,
leading to \emph{precoloring extension} problems.  In addition to being quite natural in itself, this concept is motivated
by many applications. We have already seen examples in Sections~\ref{sec:precolface} and \ref{sec:disch-grotzsch}, where
the fact that a precoloring of any short cycle in graphs from the considered class extends can be used to deal with short
separating cycles throughout the argument.  As another example, suppose we are trying to show an upper bound on chromatic number
of some class of graphs embedded on torus.  In such a graph, we can find a non-contractible cycle $C$ and cut the surface along this
cycle.  In this way, we obtain a graph drawn in the plane with two facial cycles $C_1$ and $C_2$ corresponding to the original cycle $C$,
and we need to color the graph in such a way that matching vertices of $C_1$ and $C_2$ have the same color. This we can try to do by
fixing a single coloring of $C_1$ and $C_2$, thus turning the original problem for toroidal graphs into a precoloring extension problem
in planar graphs.

If we allow an arbitrary set of vertices to be precolored, we essentially turn the original coloring problem into a list coloring one (consider
removing the precolored vertices and forbidding their colors at their neighbors).  Needless to say, this rarely if ever leads to a tractable
problem.  However, if the set of precolored vertices is suitably restricted (e.g., its size is bounded, or all precolored vertices are
required to be incident with a single face of the given embedded graph, or if a lower bound on the distance between the precolored vertices is given),
we may obtain interesting results.  Many of the techniques we studied earlier in the book can be used to prove precoloring extension
results, and indeed, we have already seen a number of theorems where some vertices were allowed to have their coloring prescribed for technical reasons.
In this section, we will show several examples of the ways how precoloring constraints can be satisfied via local recoloring.

Let us start with two precoloring extension results regarding plane graphs with vertices incident with one face precolored.
In Theorem~\ref{thm:grotzsch-gimbel}, we considered a plane triangle-free graph $G$ with outer face bounded by a $6$-cycle $C$,
and we showed that every precoloring of $C$ extends to a $3$-coloring of $G$, unless
$G$ has a subgraph $H$ containing $C$ such that all non-outer faces of $H$ have length $4$.
If $G$ contains such a subgraph, can we decide whether a precoloring of $C$ extends?
Using a recoloring argument, we will show that (excluding the trivial case that this is prevented by a chord of $C$),
such a precoloring extends unless it assigns vertices of $C$ colors $1,2,3,1,2,3$ in order.

\begin{lemma}\label{lemma:extend6}
Let $G$ be a plane triangle-free multigraph with the outer face bounded by a $6$-cycle $C=v_1\ldots v_6$ and all other
faces of length $4$.  Let $\psi$ be a $3$-coloring of the subgraph of $G$ induced by $V(C)$.
If $\psi(v_1)\neq\psi(v_4)$ or $\psi(v_2)\neq\psi(v_5)$ or $\psi(v_3)\neq\psi(v_6)$,
then $\psi$ extends to a $3$-coloring of $G$.
\end{lemma}
\begin{proof}
Since $\psi(v_1)\neq\psi(v_4)$ or $\psi(v_2)\neq\psi(v_5)$ or $\psi(v_3)\neq\psi(v_6)$, note that $C$ contains a $2$-colored subpath of
three vertices; by symmetry, we can assume that $\psi(v_1)=\psi(v_3)=1$ and $\psi(v_2)=2$.  Since $G$ is a plane graph with
all faces of even length, it is bipartite; let $\varphi_0$ be a $2$-coloring of $G$ such that $\varphi_0(v_1)=\varphi_0(v_3)=1$ and $\varphi_0(v_2)=2$.

If $\psi(v_5)=1$, then let $\varphi$ be obtained from $\varphi_0$ by changing colors of $v_4$ and $v_6$ to $\psi(v_4)$ and $\psi(v_6)$,
respectively.  Note that for $i\in \{4,6\}$, we have either $\varphi(v_i)=\varphi_0(v_i)=2$, or $\varphi(v_i)=3$.  Since $v_4$ and $v_6$
are non-adjacent, it follows that $\varphi$ is a proper $3$-coloring of $G$ that extends $\psi$.
If $\psi(v_5)=3$, then note that $\psi(v_4)=\psi(v_6)=\varphi_0(v_4)=\varphi_0(v_6)=2$.  We let $\varphi$ be obtained from $\varphi_0$ by changing the color of $v_5$ to $3$,
and again we conclude that $\varphi$ is a proper $3$-coloring of $G$ that extends $\psi$.

Hence, suppose that $\psi(v_5)=2$, and thus $\psi(v_4)=\psi(v_6)=3$.  Let $\varphi_1$ be a proper coloring of $G$ using colors $1$ and $3$
such that $\varphi_1(v_1)=\varphi_1(v_3)=1$ and $\varphi_1(v_4)=\varphi_1(v_6)=1$.  We let $\varphi$ be obtained from $\varphi_1$ by changing
the color of $v_1$ and $v_4$ to $2$.  Since $\psi$ is a $3$-coloring of the subgraph of $G$ induced by $V(C)$ and $\psi(v_1)=\psi(v_4)=2$,
it follows that $v_1$ is not adjacent to $v_4$, and thus $\varphi$ is a proper $3$-coloring of $G$ that extends $\psi$.
\end{proof}
Let us remark that the condition on $\psi$ in Lemma~\ref{lemma:extend6} is not only sufficient, but also necessary.
This is easy to see by induction. For any $3$-coloring of $G$ and a $4$-face $f$ of $G$, note that two non-adjacent vertices incident with $f$
have the same color.  Identifying the two vertices and suppresing the arising $2$-faces gives a smaller $3$-colored graph containing $C$
with all non-outer faces of length $4$.  The condition on the restriction of the $3$-coloring to $C$ then follows by the induction hypothesis,
with the base case (where $G$ consists of $C$ and a vertex adjacent to three non-consecutive vertices of $C$) forbidding exactly the
coloring $1,2,3,1,2,3$.  Of course, the proposed identification should not merge two vertices of $C$ or create a chord, but this is always
possible to ensure by the choice of $f$ if $|V(G)|>7$; we invite the reader to work out the details.

However, this proof of necessity is not the most instructive one; the reason why there is exactly one particular
precoloring that is bad for all quadrangulations is much easier to see in the dual setting of flows, as we will
discuss in much greater generality in Chapter~\ref{chap:flows}, Corollary~\ref{cor:flow-quadr}.

As another example, let us consider extendibility of $5$-coloring from a $4$-cycle in a planar graph.
\begin{lemma}\label{lemma:extend54}
Let $G$ be a plane graph with the outer face bounded by an induced cycle $C$ of length at most $4$.
Then every $5$-coloring $\psi$ of $C$ extends to a $5$-coloring of $G$.
\end{lemma}
\begin{proof}
Let $C=v_1v_2v_3v_4$.  If $\psi(v_1)=\psi(v_3)$ and $\psi(v_2)=\psi(v_4)$, then let $G'$ be the graph
obtained from $G$ by adding a new vertex $w$ adjacent to $v_1$, $v_2$, $v_3$, and $v_4$.  Otherwise,
we can by symmetry assume that $\psi(v_1)\neq\psi(v_3)$, and we let $G'$ be the graph obtained from $G$
by adding the edge $v_1v_3$.  Without loss of generality, we can assume that $\psi$ uses only colors
$\{1,\ldots,4\}$.  By the Four Color Theorem, $G'$ has a $4$-coloring; let us choose its $4$-coloring $\varphi$
so that $\varphi(v_i)=\psi(v_i)$ for as many vertices $v_i\in V(C)$ as possible.

We claim that the colorings $\varphi$ and $\psi$ differ on at most one vertex of $C$.  Indeed, if $\psi(v_1)=\psi(v_3)$ and $\psi(v_2)=\psi(v_4)$,
then the choice of $G'$ implies that $\varphi$ uses only three colors on $C$, and thus either $\varphi(v_1)=\varphi(v_3)$ or $\varphi(v_2)=\varphi(v_4)$.
By symmetry, we can assume the former, and permute the colors in $\varphi$ so that $\varphi(v_1)=\varphi(v_3)=\psi(v_1)$ and $\varphi(v_2)=\psi(v_2)$.
If $\psi(v_1)\neq\psi(v_3)$, then the choice of $G'$ implies that $\varphi(v_1)\neq \varphi(v_3)$, and thus we can permute the colors so that $\varphi$
matches $\psi$ on $v_1$, $v_2$, and $v_3$.

If $\psi$ matches $\varphi$ on $C$, we are done.  Hence, we can assume that $\psi$ and $\varphi$ assign different colors to $v_4$.  Let $\varphi'$ be
obtained from $\varphi$ by giving $v_4$ the color $\psi(v_4)$ and by giving each neigbor $x$ of $v_4$ such that $\varphi(x)=\psi(v_4)$ the color $5$.
Then $\varphi'$ is a proper $5$-coloring of $G$ that extends $\psi$.
\end{proof}
Of course, it is possible to prove Lemma~\ref{lemma:extend54} directly, without using the Four Color Theorem, either via a simple reducible configurations arguments,
or in the list coloring setting using Theorem~\ref{thm:5choosbook} or Theorem~\ref{thm:5choos-nonbook} (in fact, the argument is implicit in the proof of the
latter result).  Nevertheless, the same idea enables us to prove the following result, for which no direct proof is known.

\begin{theorem}[Albertson~\cite{Alb98}]\label{thm:extend-dist4}
Let $G$ be a planar graph and let $S$ be a set of vertices of $G$ such that the distance between any two
of them is at least $4$.  Then any $5$-coloring $\psi$ of $S$ extends to a $5$-coloring of $G$.
\end{theorem}
\begin{proof}
Let $\varphi_0$ be a $4$-coloring of $G$, obtained by the Four Color Theorem.  Let $\varphi$ be the coloring obtained from $\varphi_0$
by, for each $v\in S$, changing the color of $v$ to $\psi(v)$ and the color of each neighbor $x$ of $v$ with $\varphi_0(x)=\psi(v)$ to $5$.
Note that such neighbors form an independent set, since they have the same color in $\varphi_0$.  Furthermore, neigbors of distinct
vertices of $S$ are distinct and non-adjacent, since the distance between distinct vertices of $S$ is at least $4$.
Hence, $\varphi$ is a proper $5$-coloring of $G$ that extends$\psi$.
\end{proof}
Let us remark that the distance constraint in Theorem~\ref{thm:extend-dist4} cannot be decreased to $3$---otherwise, we could attach a precolored
leaf to each vertex of $G$, and thus effectively forbid one color at each vertex of $G$; and as Mirzakhani~\cite{mirzakhani1996small} showed,
there are planar graphs that are not properly colorable from lists given as $4$-element subsets of $[5]$.

\section{Locally planar graphs}

We say that an embedding of a graph in a given surface is locally planar if its representativity or edge-width is large enough---larger
than a specified constant, typically depending on the genus of the surface.  Many results for planar graphs extend to locally planar graphs (with notable
exceptions---despite the Four Color Theorem, in any surface of positive genus, there exist non-$4$-colorable graphs embedded with arbitrarily large representativity).
A commonly used technique to show such generalizations is to cut the graph along a non-contractible cycle $C$, color the resulting graph of smaller genus,
and alter the coloring near the cycles corresponding to $C$ to obtain a proper coloring of the original graph.  This is best explained on an example.
We will need the following fact about graphs embedded in the torus.

\begin{figure}
\begin{center}
\begin{asy}
pair w[][] = new pair[7][7];

void wallcoord (pair at)
{
  int i, j;

  for (i = 0; i < 7; ++i)
    for (j = 0; j < 7; ++j)
      w[i][j] = at + (0.5i,-0.5j);
}

void wall(pen p)
{
  int i, j;

  for (i = 0; i < 7; ++i)
    draw (w[0][i] -- w[6][i], p);
  draw (w[0][0] -- w[0][6], dotted + p);
  draw (w[6][0] -- w[6][6], dotted + p);
  for (i = 0; i < 6; ++i)
    for (j = i%2; j < 7; j += 2)
      draw(w[j][i]--w[j][i+1], p);
  for (i = 0; i < 7; ++i)
    for (j = 0; j < 7; ++j)
      vertex(w[i][j], p, 0.05);
}

void brick (int x, int y, pen col)
{
  if (x == 5)
    {
      fill(w[5][y]--w[6][y]--w[6][y+1]--w[5][y+1]--cycle, col);
      fill(w[0][y]--w[1][y]--w[1][y+1]--w[0][y+1]--cycle, col);
    }
  else
    fill(w[x][y]--w[x+2][y]--w[x+2][y+1]--w[x][y+1]--cycle, col);
}

wallcoord((0,0));
wall(black);
label("$6\times 6$ toroidal wall", (1.5,-3.5));

wallcoord((4,0));
brick(0,2,red);
brick(2,2,red);
brick(4,2,red);
brick(1,3,green);
brick(3,3,green);
brick(5,3,green);
wall(black);
draw(w[0][3]--w[6][3], linewidth(1.5bp));
label("cycle $C^1$", (5.5,-3.5));

wallcoord((8,0));
brick(0,0,red);
brick(1,1,red);
brick(0,2,red);
brick(1,3,red);
brick(0,4,red);
brick(1,5,red);
brick(2,0,green);
brick(3,1,green);
brick(2,2,green);
brick(3,3,green);
brick(2,4,green);
brick(3,5,green);
wall(black);
draw(w[3][0]--w[2][0]--w[2][1]--w[3][1]--w[3][2]--w[2][2]--w[2][3]--w[3][3]--w[3][4]--w[2][4]--w[2][5]--w[3][5]--w[3][6]--w[2][6], linewidth(1.5bp));
label("cycle $C^2$", (9.5,-3.5));

wallcoord((2,-4.5));
brick(4,0,red);
brick(5,1,red);
brick(0,2,red);
brick(1,3,red);
brick(2,4,red);
brick(3,5,red);
brick(0,0,green);
brick(1,1,green);
brick(2,2,green);
brick(3,3,green);
brick(4,4,green);
brick(5,5,green);
wall(black);
draw(w[0][0]--w[0][1]--w[1][1]--w[1][2]--w[2][2]--w[2][3]--w[3][3]--w[3][4]--w[4][4]--w[4][5]--w[5][5]--w[5][6]--w[6][6], linewidth(1.5bp));
draw(w[5][0]--w[6][0]--w[6][1], linewidth(1.5bp));
label("cycle $C^3$", (3.5,-8));

wallcoord((6,-4.5));
brick(2,0, interp(green,white,0.7));
brick(4,0, interp(green,white,0.7));
brick(3,1, interp(green,white,0.7));
brick(5,1, interp(green,white,0.7));
brick(0,2, interp(green,white,0.7));
brick(2,2, interp(green,white,0.7));
brick(4,2, interp(green,white,0.7));
brick(2,4, interp(green,white,0.7));
brick(3,5, interp(green,white,0.7));
wall(0.5white);
draw(w[0][3]--w[6][3], linewidth(1.5bp));
draw(w[3][0]--w[2][0]--w[2][1]--w[3][1]--w[3][2]--w[2][2]--w[2][3]--w[3][3]--w[3][4]--w[2][4]--w[2][5]--w[3][5]--w[3][6]--w[2][6], linewidth(1.5bp));
draw(w[0][0]--w[0][1]--w[1][1]--w[1][2]--w[2][2]--w[2][3]--w[3][3]--w[3][4]--w[4][4]--w[4][5]--w[5][5]--w[5][6]--w[6][6], linewidth(1.5bp));
draw(w[5][0]--w[6][0]--w[6][1], linewidth(1.5bp));
label(scale(0.5)*Label("$a$"), interp(w[2][2],w[2][3],0.4), 0.5W);
label(scale(0.5)*Label("$b$"), interp(w[3][3],w[3][4],0.6), 0.5E);
label(scale(0.5)*Label("$c$"), interp(w[2][3],w[3][3],0.5), 0.5N);
label("$A$", interp(w[4][1],w[5][2],0.5));
label("$H=C^1\cup C^2\cup C^3$", (7.5,-8));
\end{asy}
\end{center}
\caption{Cycles and subgraphs of $6\times 6$ toroidal wall.  Bottom of each figure is identified with its top, and the left side with the right side,
to obtain an embedding in the torus.}\label{fig:cylwall}
\end{figure}

\begin{lemma}\label{lemma:torus-cut-dist}
There exists a constant $\beta$ as follows.
Let $G$ be a quadrangulation of torus. If $G$ has edge-width at least $\beta$, then $G$ contains
an even-length non-contractible cycle $C$ with the following property.
Let $G'$ be obtained from $G$ by cutting the torus along the cycle $C$, and let $C_1$ and $C_2$ be the cycles
in $G'$ created from $C$. Then the distance between $C_1$ and $C_2$ in $G'$ is at least $3$.
\end{lemma}
\begin{proof}
Let $W$ be the $6\times 6$ toroidal wall depicted in Figure~\ref{fig:cylwall}.  Robertson and Seymour~\cite{rs12}
showed that there exists a constant $\beta_0$ such that every graph embedded in the torus with representativity
at least $\beta_0$ contains a subdivision of $W$.  Let $\beta=2\beta_0$.

Since $G$ is a quadrangulation with edge-width at least $\beta$, its representativity is at least $\beta/2=\beta_0$,
and thus $W$ contains a subdivision $W'$ of $W$.  Note that up to homeomorphism, $W$ (and thus also its subdivision $W'$)
has a unique embedding in the torus.  Let us call the facial cycles of $W'$ \emph{bricks}.
Let $C^1$, $C^2$, and $C^3$ be the cycles in $W'$ corresponding to the cycles in $W$
shown in  Figure~\ref{fig:cylwall}.  For $i\in\{1,2,3\}$, let $G^i$ be the graph obtained from $G$ by cutting along $C^i$,
with $C^i_1$ and $C^i_2$ denoting the cycles of $G^i$ corresponding to $C^i$.  Note that the distance between $C^i_1$ and $C^i_2$
in $G^i$ is at least three (indeed, all neighbors of $C^i_1$ are contained in red bricks and the neighbors of $C^i_2$
are contained in green bricks as seen in Figure~\ref{fig:cylwall}, and thus they are distinct).

Hence, it suffices to show that not all cycles $C^1$, $C^2$, and $C^3$ have odd length.  Let $H=C^1\cup C^2\cup C^3$.
Let $c$ denote the length of the path forming the intersection of $C^1$, $C^2$, and $C^3$.  Let $a$ and $b$ denote the lengths
of the paths forming $(C^2\cap C^3)-C^1$, as depicted in Figure~\ref{fig:cylwall}.
The graph $H$ has two faces, bounded by contractible closed walks.  Let $A$ denote the one bounding the face depicted in green in Figure~\ref{fig:cylwall}.
Since $H$ is a subgraph of the quadrangulation $G$, the contractible closed walk $A$ has even length.  Note furthermore
that $|A|=|C^1|+|C^2|+|C^3|-2b-2c$, and thus $|C^1|+|C^2|+|C^3|$ is even.  Consequently, either one or all three of
$C^1$, $C^2$, and $C^3$ have even length.
\end{proof}

Let us remark that Hutchinson~\cite{locplanq} proved using a different method that $\beta=25$ suffices
(but this is probably still far from the best possible).
We can now use recoloring argument to obtain the following result.

\begin{theorem}\label{thm:torquadr}
Let $\beta$ be the constant from Lemma~\ref{lemma:torus-cut-dist}.
If $G$ is a quadrangulation of torus with edge-width at least $\beta$, then $G$ is $3$-colorable.
\end{theorem}
\begin{proof}
Let $C=v_1v_2\ldots v_k$ be an even-length cycle in $G$ obtained using Lemma~\ref{lemma:torus-cut-dist}.
Let $G'$ be obtained from $G$ by cutting the torus along the cycle $C$, and let $C_1$ and $C_2$ be the cycles
in $G'$ created from $C$.  For $i\in\{1,2\}$, let $C_i=v_{1,i}v_{2,i}\ldots v_{k,i}$, where $v_{j,1}$ and $v_{j,2}$ are the
vertices created by cutting $v_j$ for $j=1,\ldots,k$.  Note that $G'$ be drawn in the plane so that $C_1$ and $C_2$ bound faces, with
all other faces coinciding with those of $G$.  Hence, all faces of $G'$ are even, and thus $G'$ is bipartite.
Let $\varphi$ be the $2$-coloring of $G'$ such that $\varphi(v_{1,1})=1$.  If $\varphi(v_{1,2})=1$, then the corresponding vertices
of $C_1$ and $C_2$ are assigned the same color, and merging these vertices gives a $2$-coloring of $G$.

Hence, assume that $\varphi(v_{1,2})=2$.
Let $X=\{v_{j,2}:\text{$j\in\{1,\ldots, k\}$ is odd}\}$, let $Z$ be the set of neigbors of vertices of $X$ in $G'$, and
let $Y=\{v_{j,1}:\text{$j\in\{1,\ldots, k\}$ is even}\}$.
Note that $\varphi$ assigns color $1$ to vertices of $Z$ and color $2$ to vertices of $X\cup Y$; and in particular, these
sets are independent.
Let $\varphi'$ be a $3$-coloring of $G'$ obtained from $\varphi$ by changing the color of vertices of $X$ to $1$ and
and the color of vertices of $Y\cup Z$ to $3$.  

The vertices of $V(G')\setminus (X\cup Y\cup Z)$ have no neighbors in $X$, and their color is different from the color $3$ of vertices of $Y\cup Z$.
Furthermore, vertuces of $Y$ have no neighbors in $Z$, as otherwise $G'$ would contain a path of length at most two between $C_1$ and $C_2$,
contradicting the choice of $C$.  Consequently, $\varphi'$ is indeed a proper $3$-coloring of $G'$.
Furthermore, $\varphi'(v_{j,1})=\varphi'(v_{j,2})$ for $j\in\{1,\ldots, k\}$.  Hence, merging the corresponding vertices of $C_1$ and $C_2$
transforms $\varphi'$ into a proper $3$-coloring of $G$.
\end{proof}

Analogous argument can be used to prove the same result for an arbitrary orientable surface~\cite{locplanq};
the situation for non-orientable surfaces is more complicated~\cite{MohSey,NakNegOta}.
Let us remark that Theorem~\ref{thm:torquadr} is far from best possible.  Indeed, Kr\'al' and Thomas~\cite{thomas2008coloring}
proved that a quadrangulation of torus is $3$-colorable unless it contains the Cayley graph $C(\mathbb{Z}_{13}; 1,5)$ as a subgraph.
The graph $C(\mathbb{Z}_{13}; 1,5)$ has a unique embedding in the torus whose edge-width is $5$, and thus in particular all quadrangulations
of torus with edge-width at least $6$ are $3$-colorable.

\section{Kempe Chains}

In the examples we have seen so far, we used local recoloring arguments, where the coloring is modified only in a small
part of the graph.  More radical changes may be achieved using \emph{Kempe chain} technique, first devised by Kempe
in his flawed attempt at proving the Four Color Theorem.

Given a proper coloring $\varphi$ of a graph $G$ and distinct colors $a$ and $b$, a \emph{Kempe chain} in colors $a$ and $b$
is a connected component $H$ of the subgraph $G[\varphi^{-1}(\{a,b\})]$ induced by vertices of color by $a$ or $b$
(let us remark that it is possible for $H$ to only use one of the colors $a$ and $b$, in case that $H$ consists of a single
vertex whose neighbors have colors distinct from $a$ and $b$).
By \emph{switching} on the Kempe chain $H$ we mean exchanging the colors $a$ and $b$ on the vertices of $V(H)$ in the coloring $\varphi$.
This clearly results in another proper coloring of $G$.

Of course, one trivial case is that all vertices colored by $a$ or $b$ happen to form a single connected component,
in which case switching on their unique Kempe chain simply renames the colors $a$ and $b$ and does not substantially
affect the properties of the coloring.  Thus, to be useful, we need some property of the graph $G$ that will ensure
that at least some of the Kempe chains are nontrivial.  Let us explore several examples of reasonings that lead to such a conclusion.

\subsection{Kempe chains in embedded graphs}

Let us start the exposition with an almost mandatory example, showing that all planar graphs are $5$-colorable
(which we already did using a different method in Theorem~\ref{thm:planar5col}).

\begin{theorem}\label{thm:planar5col-kempe}
Every planar graph $G$ is $5$-colorable.
\end{theorem}
\begin{proof}
We prove the claim by induction on the number of vertices of $G$.  If $|V(G)|\le 5$, then the claim is trivial,
hence assume that $|V(G)|\ge 6$.  By Corollary~\ref{cor:mad}, the average degree of $G$ is less than $6$, and
thus $G$ has a vertex $v$ of degree at most $5$.  By the induction hypothesis, $G-v$ has a proper $5$-coloring $\varphi$.
If $\deg(v)\le 4$ or if $\varphi$ assigns the same color to two neighbors of $v$, we can extend $\varphi$ to a proper $5$-coloring
of $G$ greedily.

Hence, suppose that $\deg(v)=5$ and $\varphi$ assigns different colors to the neighbors of $v$.  Let $v_1$, \ldots, $v_5$
be the neighbors of $v$ in the cyclic order according to their drawing around $v$.  Without loss of generality, $\varphi(v_i)=i$
for $i=1,\ldots, 5$.  Let $H_{1,3}$ be the Kempe chain in colors $1$ and $3$ containing the vertex $v_1$.
If $v_3\not\in V(H_{1,3})$, then let $\varphi_1$ be the coloring obtained from $\varphi$ by switching on $H_{1,3}$.
Then $\varphi_1(v_1)=\varphi_1(v_3)=3$ and $\varphi_1$ can be greedily extended to a proper $5$-coloring
of $G$.

Hence, suppose that $v_3\in V(H_{1,3})$, and thus $G-v$ contains a path $P\subseteq H_{1,3}$ between $v_1$ and $v_3$.
Consider now the Kempe chain $H_{2,4}$ for $\varphi$ in colors $2$ and $4$ containing the vertex $v_2$.  Note that by planarity,
the vertices $v_2$ and $v_4$ lie in different components of the graph $G-v-V(P)$, see Figure~\ref{fig:kempe5}.
Since vertices of $P$ have colors different from $2$ and $4$, it follows that the subgraph of $G$ consisting of vertices colored $2$ or $4$
does not contain a path from $v_2$ to $v_4$, and thus $v_4\not\in V(H_{2,4})$.  Hence, letting $\varphi_2$ denote the
$5$-coloring of $G-v$ obtained from $\varphi$ by switching on $H_{2,4}$, we have $\varphi_2(v_2)=\varphi_2(v_4)=4$,
and thus $\varphi_2$ can be greedily extended to a $5$-coloring of $G$.
\end{proof}

\begin{figure}
\begin{center}
\begin{asy}
v[0] = (0,0);
for (i = 0; i < 5; ++i)
  {
    v[i+1] = v[0] + dir(72i);
    draw(v[0]--v[i+1]);
  }

v[6] = v[1] + (0.5,1.5);
v[9] = v[3] + (0,1);
v[7] = v[6] + (-0.5,1);
v[8] = v[9] + (0.5,1);
v[10] = v[2] + (-0.5, 0.5);
v[11] = v[2] + (0.5, 0.5);
v[12] = v[2] + (0, 1);

draw(v[1]--v[6]--v[7]--v[8]--v[9]--v[3]);
draw(v[2]--v[11]--v[12]--v[10]--cycle);

vertex(v[0],white);
vertex(v[1], red);
vertex(v[2], green);
vertex(v[3], blue);
vertex(v[4], magenta);
vertex(v[5], black);
vertex(v[6], blue);
vertex(v[7], red);
vertex(v[8], blue);
vertex(v[9], red);
vertex(v[10], magenta);
vertex(v[11], magenta);
vertex(v[12], green);

label("$v$", v[0], W);
label("$1$", v[1], E);
label("$2$", v[2], E);
label("$3$", v[3], NW);
label("$4$", v[4], SW);
label("$5$", v[5], SE);

label("$3$", v[6], E);
label("$1$", v[7], N);
label("$3$", v[8], N);
label("$1$", v[9], NW);
label("$4$", v[10], E);
label("$4$", v[11], W);
label("$2$", v[12], N);
\end{asy}
\end{center}
\caption{Kempe chains at a $5$-vertex.}\label{fig:kempe5}
\end{figure}

Although very simple, the proof of Theorem~\ref{thm:planar5col-kempe} illustrates well the main features
of Kempe chain usage.  Namely, we used the fact that because of the planar embedding, the existence of a Kempe chain
in colors $1$ and $3$ between $v_1$ and $v_3$ prevents the existence of a Kempe chain in colors $2$ and $4$ between
$v_2$ and $v_4$.  The property that the sets of colors $\{1,3\}$ and $\{2,4\}$ are disjoint is crucial for this to go through;
and consequently, this type of argument is rarely helpful in $3$-coloring problems in embedded graphs.

We also see some limitations of the method.  The colors for which we take the Kempe chain must be interchangeable,
which prevents its application in the cases where not all colors can be used at all vertices (list coloring) or
where exchanging the values of two colors may lead to an invalid coloring (e.g., in circular coloring).
To take advantage of the embedding, it is also necessary that Kempe chains for disjoint pairs of colors
cannot intersect; this makes the Kempe chain method less useful for fractional coloring where
vertices are assigned sets of colors.

Note that the argument of the proof of Theorem~\ref{thm:planar5col-kempe} would fail for any surface of positive genus,
since in any such surface, it is possible to draw the two Kempe chains disjointly.  This does not necessarily mean that
Kempe chain arguments are not applicable in other surfaces; however, they could only be only useful for larger configurations
that admit so many Kempe chains that they cannot be disjointly drawn in the surface.

Compared with the proof of 5-colorability of planar graphs we presented in Theorem~\ref{thm:planar5col},
the reduction used to deal with degree 5 vertices is simpler---we just remove these vertices, without
identifying any of their neighbors.  These are not mutually exclusive; indeed, we will soon see examples
where more involved reductions are combined with Kempe chain arguments.  Nevertheless, it is often the case
that Kempe chain usage makes it possible to get away with just the trivial reductions, which is convenient
in the cases where more involved reductions could result in graph not belonging to the considered class.
In the following example, we could also reduce vertices of degree four by identifying some of their neighbors,
but it would require more ideas along the lines of those explored in Section~\ref{sec:precolface} to deal
with the possibility that this creates a $6$-cycle.

\begin{theorem}\label{thm:forb6}
Every planar graph without $6$-cycles is $4$-colorable.
\end{theorem}
\begin{proof}
Suppose for a contradiction that $G$ is a counterexample with the smallest number of vertices.
Clearly, $G$ has minimum degree at least four.

Suppose that $G$ has a vertex $v$ of degree $4$, and let $v_1$, \ldots, $v_4$ 
be the neighbors of $v$ in the cyclic order according to their drawing around $v$.
By the minimality of $G$, the graph $G-v$ has a $4$-coloring $\varphi$, which cannot be extended to $G$.
Without loss of generality, $\varphi(v_i)=i$
for $i=1,\ldots, 4$.  Let $H_{1,3}$ be the Kempe chain in colors $1$ and $3$ containing the vertex $v_1$,
and let $H_{2,4}$ be the Kempe chain in colors $2$ and $4$ containing the vertex $v_2$.
By planarity, either $v_3\not\in V(H_{1,3})$ or $v_2\not\in V(H_{2,4})$.
By symmetry, we can assume the former.  Hence, we can switch on $H_{1,3}$ and give $v$ the color $1$,
obtaining a $4$-coloring of $G$.  This is a contradiction, and thus $G$ has minimum degree at least $5$.

Note that each vertex of degree $5$ in $G$ is incident with at least two faces of length at least $4$;
otherwise, if $v_1$, \ldots, $v_5$ are the neighbors of $v$ in the cyclic order according to their drawing around $v$
and $v_iv_{i+1}v_5$ bounds a face of length three for $i=1, \ldots, 4$, then $v_1v_2v_3v_4v_5v$ is a $6$-cycle in $G$,
contradicting the assumptions.

We now obtain a contradiction by simple discharging: assign each vertex $v$ charge $\deg(v) - 6$ and each face $f$ charge $2|f|-6$.
By Lemma~\ref{lemma:initch}, the sum of the charges is negative.  We let each face of length at least $4$ send $1/2$ to each incident
vertex.  Then faces of length $3$ have zero charge, faces of length at least $4$ have charge $2|f|-6-|f|/2=(3|f|-12)/2\ge 0$,
vertices of degree at least $6$ have nonnegative charge, and vertices of degree $5$ have charge at least $-1+2\times1/2=0$.
Since the sum of the charges did not change, this is a contradiction.
\end{proof}

\subsection{Coloring graphs with forbidden minors}

Presence of Kempe chains can make certain graphs arise as minors (or topological minors) of currently
considered graph.  This is of importance in problems related to Hadwiger's conjecture.  For example, Hadwiger's conjecture
implies that every graph that does not contain $K_6$ as a minor is $5$-colorable.  This is known to be true, but the argument
is quite complicated and long~\cite{robertsonseymourthomas}.  Here, we present a much simpler argument showing $6$-colorability
of such graphs.

\begin{theorem}
Every graph not containing $K_6$ as a minor is $6$-colorable.
\end{theorem}
\begin{proof}
Suppose for a contradiction that $G$ is a counterexample with the smallest number of vertices.
Clearly, $G$ is connected and has minimum degree at least $6$.

Suppose that $G$ contains a vertex $v$ of degree $6$.  Since $G$ does not contain $K_6$ as a minor,
$v$ has neighbors $u_1$ and $u_2$ that are not adjacent.  The graph $G'$ obtained from $G$ by contracting
the edges $vu_1$ and $vu_2$ does not contain $K_6$ as a minor, and thus it has a $6$-coloring by the minimality of $G$.
Consequently, $G-v$ has a $6$-coloring in that $u_1$ and $u_2$ have the same color, and this $6$-coloring can be greedily extended to $v$.
This is a contradiction.  Hence, $G$ has minimum degree at least $7$.

On the other hand, Mader~\cite{mader1968homomorphiesatze} proved that every graph with $n\ge 6$
vertices and at least $4n-9$ edges contains $K_6$ as a minor.  Hence, $G$ has at most $4|V(G)|-10$
edges, and thus its average degree is less than $8$.  Consequently, $G$ contains a vertex $v$ of degree exactly $7$.
Let $H$ be the subgraph of $G$ induced by the neighbors of $v$.  Since $G$ is $K_6$-minor-free, $H$ is not a clique.
On the other hand, if $H$ contained an independent set of size three, then contracting the edges from $v$ to this independent
set, $6$-coloring the resulting graph, and extending the coloring to $v$ would give a contradiction similarly to the previous paragraph.
Hence, $\alpha(H)=2$.

Suppose that $H$ contains a clique $K$ of size at least $4$.  Note that $|K|=4$, as otherwise $G$ would contain $K_6$ as a subgraph.
Note that since $G$ has minimum degree at least $7$, each vertex of $\{v\}\cup K$ has a neighbor not in $\{v\}\cup K$.
If the subgraph $G-(\{v\}\cup K)$ is connected, then contracting this subgraph yields $K_6$ as a minor.
Otherwise, $G=G_1\cup G_2$ for two proper induced subgraphs $G_1$ and $G_2$ intersecting in the clique $\{v\}\cup K$,
both $G_1$ and $G_2$ are $6$-colorable by the minimality of $G$, and we can permute the colors to make the $6$-colorings
of $G_1$ and $G_2$ match on $\{v\}\cup K$, giving a $6$-coloring of $G$.  In either case, this is a contradiction.
Therefore, $\omega(H)\le 3$.  For any $u\in V(H)$, since $\alpha(H)=2$, the non-neighbors of $u$ in $H$ form a clique,
and thus $\deg_H(u)\ge 6-\omega(H)\ge 3$.

We claim that there exists a vertex $y$ of $H$ such that $H-y$ contains $K_4$ as a minor.
If $\delta(H)\ge 4$, then this is the case with $y$ chosen arbitrarily, since $H-y$ has minimum degree at least three and thus contains $K_4$ as a minor~\cite{dirac}.
Otherwise, $H$ contains a vertex $x$ of degree three.  Let $y_1$, $y_2$, and $y$ be neighbors of $x$ in $H$.  Since $\omega(H)\le 3$, we can assume
that $y_1y_2\not\in E(H)$, and since $\alpha(H)=2$, each vertex of $V(G)\setminus\{y_1,y_2\}$ is adjacent to $y_1$ or $y_2$.
Furthermore, since $\alpha(H)=2$, the set $V(H)\setminus\{x,y,y_1,y_2\}$ induces a clique of size three.  Hence, contracting the edges $y_1x$ and $y_2x$ in $H-y$ gives
a $K_4$ minor.  Let $G_{v,y}$ be the graph obtained from $G$ by removing all non-neighbors of $v$ and adding edges from $y$ to all other vertices of $V(H)$.
We conclude that $G_{v,y}$ contains $K_6$ as a minor, and thus $G$ does not contain $G_{v,y}$ as a minor.

Since $\delta(H)\ge 3$ and $\omega(H)\le 3$, the neighbors of $y$ in $H$ do not induce a clique.  Let $z_1$ and $z_2$ be non-adjacent neighbors of $y$ in $H$.
Let $G'$ be the graph obtained from $G$ by contracting the edges $vz_1$ and $vz_2$.  By the minimality of $G$, the graph $G'$ is $6$-colorable,
and thus there exists a $6$-coloring $\varphi$ of $G-v$ such that $\varphi(z_1)=\varphi(z_2)=6$ and $\varphi(y)=5$.  Let $V(H)\setminus\{y,z_1,z_2\}=\{u_1,\ldots,u_4\}$.
If the vertices $u_1$, \ldots, $u_4$ do not have pairwise distinct colors or if one of them has color $5$ or $6$, then we can extend $\varphi$ greedily to $v$.
Hence, we can without loss of generality assume that $\varphi(u_i)=i$ for $i=1, \ldots, 4$.  Let $H_{i5}$ be the Kempe chain in colors $i$ and $5$ containing $u_i$.
If $H_{i5}$ does not contain $y$, then we can switch on $H_{i5}$ and give $v$ the color $i$.  Hence, this is not the case.
The graph $H_5=H_{15}\cup\ldots\cup H_{45}$ is disjoint from $\{v,z_1,z_2\}$ and contains a path from $u_i$ to $y$ disjoint from $\{u_1,\ldots,u_4\}\setminus \{u_i\}$
for $i=1, \ldots, 4$.  Hence, by contracting all the edges of $H_5$ not incident with $u_1, \ldots, u_4$, we conclude that $G$ contains $G_{v,y}$ as a minor,
which is a contradiction.
\end{proof}

\subsection{Brooks' theorem}

Kempe chains are also extensively used in coloring problems in non-embedded graphs.
Of course, we still need some argument preventing one of the Kempe chains from containing
all the vertices of the two considered colors.  We now demonstate one based on the
degree considerations and local recoloring arguments, to prove the well-known Brooks' theorem.

\begin{theorem}[Brooks' theorem]\label{thm:brooks}
Let $\Delta\ge 3$ be an integer.
If $G$ is a connected graph of maximum degree at most $\Delta$ and $G\neq K_{\Delta+1}$,
then $G$ is $\Delta$-colorable.
\end{theorem}
\begin{proof}
We prove the claim by induction on the number of vertices of $G$.  Clearly, the claim holds in $|V(G)|\le \Delta$.
Hence, we can assume that $|V(G)|>\Delta$.  Let $v$ be a vertex such that $G-v$ is connected (we can choose $v$ as
a leaf in a spanning tree of $G$).  By the induction hypothesis, there exists a $\Delta$-coloring $\varphi$ of $G-v$.
If $\deg(v)<\Delta$, or if $\deg(v)=\Delta$ and two neighhbors of $v$ have the same color, then $\varphi$ extends to $v$ greedily.
Hence, we can assume that $\deg(v)=\Delta$, and letting $v_1$, \ldots, $v_\Delta$ denote the neighbors of $v$, that
$\varphi(v_i)=i$ for $i=1,\ldots,\Delta$.

For $1\le i<j\le \Delta$, let $H_{ij}$ denote the Kempe chain in colors $i$ and $j$ containing $v_i$.  If $v_j\not\in V(H_{ij})$,
then switching on $H_{ij}$ and giving $v$ color $i$ results in a $\Delta$-coloring of $G$.  Hence, we can assume that $H_{ij}$ contains
a path $P_{ij}$ between $v_i$ and $v_j$ for all $i<j$.  We claim that $H_{ij}$ is actually equal to this path.  Otherwise,
let $x$ be the first vertex of $P_{ij}$ as traversed from $v_i$ incident with an edge of $E(H_{ij})\setminus E(P_{ij})$, and let
$Q$ be the subpath of $P_{ij}$ between $v_i$ and $x$.  Note that $x$ has at least three neighbors either equal to $v$ or of color $i$ or $j$,
and since $\deg(x)\le\Delta$, there exists a color $k$ distinct from $i$ and $j$ that does not appear on any neighbor of $x$.
Let us recolor $x$ to $k$.  Now, $Q-x$ is the Kempe chain in colors $i$ and $j$ in the resulting coloring and $v_j\not\in V(Q-x)$,
and thus switching on $Q-x$ and giving $v$ color $i$ results in a $\Delta$-coloring of $G$.

Suppose that the paths $P_{12}$ and $P_{13}$ intersect in a vertex other than $v_1$.  Let $x\neq v_1$ be
the first vertex of $P_{12}$ as traversed from $v_i$ belonging to $P_{13}$.  Clearly $\varphi(x)=1$ and $x$ has two neighbors of color $2$
and two neighbors of color $3$.  Since $\deg(x)\le \Delta$, there exists a color $k\not\in\{1,2,3\}$ that does not appear on the neighbors of $x$.
Hence, we can recolor $x$ to $k$, switch the colors $1$ and $2$ on the part of $P_{12}$ between $v_1$ and $x$, and give $v$ the color $1$,
obtaining a $\Delta$-coloring of $G$.
Hence, we can assume that $P_{12}$ and $P_{13}$ intersect only in $v_1$.
More generally, we can assume the following: ($\star$) If $\varphi'$ is a $\Delta$-coloring of $G-v$, $i$, $j$, and $k$ are distinct colors,
and $Q_{ij}$ and $Q_{ik}$ are the Kempe chains in this coloring in colors $i$ and $j$, and $i$ and $k$, respectively, both containing
a neighbor $v'_i$ of $v$ such that $\varphi'(v'_i)=i$, then $Q_{ij}$ and $Q_{ik}$ only intersect in $v'_i$.

Since $G\neq K_{\Delta+1}$, the neighborhood of $v$ is not a clique, and we can by symmetry assume that $v_1$
is not adjacent to $v_2$.  Since $v_1v_2\not\in E(G)$, the neighbor $u$ of $v_1$ in $P_{12}$
is not adjacent to $v$.  Consider now the coloring $\varphi'$ obtained from $\varphi$ by
switching on $P_{13}$.  Let $P'_{23}$ and $P'_{12}$ be the Kempe chains of $\varphi'$ in colors $2$ and $3$, and in colors $1$ and $2$,
respectively, containing the vertex $v_1$.  Since $\varphi'(u)=\varphi(u)=2$ and $\varphi'(v_1)=3$, we have $u\in V(P'_{23})$.
Since $P_{12}$ and $P_{13}$ intersect only in $v_1$, we have $P_{12}-v_1\subseteq P'_{12}$, and thus $u\in V(P'_{12})$.
Consequently, $u$ is a common vertex of $P'_{12}$ and $P'_{23}$ distinct from their common endpoint $v_2$.  However, this contradicts ($\star$).
\end{proof}

Note that in addition to featuring a different way to restrict the Kempe chains, the presented proof of Brooks' theorem
also illustrates the need to sometimes perform consecutive Kempe chain switches in different colorings.  Indeed, in the last step of the
proof, we perform a Kempe chain swich to turn $\varphi$ into a coloring $\varphi'$ that violates the condition ($\star$).
We then perform one more Kempe switch to transform $\varphi'$ into a coloring that can be extended to $G$, as described in the
next to last paragraph of the proof.  We will use this possibility even more extensively in the following examples.

\subsection{Edge coloring and Vizing's Theorem}

A proper \emph{edge coloring} of a (multi)graph $G$ is an assignment of colors to edges of $G$ such that any
distinct edges incident with the same vertex have different colors.  The \emph{chromatic index} $\chi'(G)$
is the minimum number of colors in a proper edge coloring of $G$.  Equivalently, edge coloring is a proper vertex coloring
of the \emph{linegraph} $L(G)$ of $G$, i.e., the graph with the vertex set $E(G)$ and with distinct $e_1,e_2\in E(G)$
adjacent if and only if $e_1$ and $e_2$ have a common endpoint.  Consequently, we can apply Kempe chain switches
in this setting.

Kempe chains for edge coloring have a particularly simple structure.  Consider an edge $e=uv$ in color $a$.
By the definition of edge coloring, at most one edge of color $b\neq a$ is incident with each of $u$ and $v$.
Consequently, a Kempe chain in colors $a$ and $b$ has maximum degree at most $2$, and thus it is either a path or a cycle.
The simplicity of Kempe chains in edge coloring setting enables us to obtain comparatively strong results;
in constrast, much less is known about the variants of edge coloring for which Kempe chains are not usable,
such as for list edge coloring where edges are assigned possibly different lists of available colors.

Here, we show just an elementary application of the Kempe chain technique to prove the most basic result
on the topic, Vizing's bound in terms of maximum degree.  More in-depth treatment can be found in Chapter~\ref{chap:edgecol}.
Consider a graph $G$ of maximum degree at most $\Delta$, let $e_0=u_0v$ be an edge of $G$ and let $\varphi$ be a proper edge coloring
of $G-e_0$ by $c>\Delta$ colors.  We say that a color $a$ is \emph{$\varphi$-available} at a vertex $x\in V(G)$ if no edge incident
with $x$ has color $a$ in the coloring $\varphi$.  Since the number of colors is greater than the maximum degree of $G$,
there is at least one $\varphi$-available color at each vertex of $G$.  A \emph{Vizing fan} is a star in $G$ consisting of distinct edges
$e_0$, $e_1$, \ldots, $e_k$ incident with $v$ for some integer $k\ge 0$, such that, letting $e_i=u_iv$ for $i=1,\ldots, k$,
the color $\varphi(e_i)$ is $\varphi$-available at $u_{i-1}$.  The fan is \emph{reducible} if some color is
$\varphi$-available at both $u_k$ and $v$.  We need the following observation.
\begin{lemma}\label{lemma:redufan}
Let $\Delta\ge 0$ be an integer, let $G$ be a graph of maximum degree at most $\Delta$, and let $e_0$ be an edge of $G$.
Let $\varphi$ be a proper edge coloring of $G-e_0$ by $c>\Delta$ colors.  If there exists a reducible Vizing fan
starting with $e_0$, then $G$ has a proper edge coloring by $c$ colors.
\end{lemma}
\begin{proof}
Let $e_0$, \ldots, $e_k$ be a reducible Vizing fan in $G$, where $e_i=u_iv$ for $i=0,\ldots,k$.
Let $a$ be a color that is $\varphi$-available at both $u_k$ and $v$.
A proper edge coloring of $G$ using at most $c$ colors can be obtained from $\varphi$ by giving $e_{i-1}$
the color $\varphi(e_i)$ for $i=1,\ldots,k$ and giving $e_k$ the color $a$.
\end{proof}
A Vizing fan is \emph{maximal} if each color that is $\varphi$-available at $u_k$
appears on the edges of the fan.  Note that each Vizing fan can be extended to either a reducible or a closed one---if
the fan is neither reducible nor closed, then there exists a color $a$ that is $\varphi$-available at $u_k$ and $\varphi(e')=a$ for
some edge $e'$ incident with $v$ that does not yet belong to the fan, and we can add $e'$ to the fan as its last edge.
\begin{theorem}[Vizing's Theorem]
Let $\Delta\ge 0$ be an integer.  If $G$ is a graph of maximum degree at most $\Delta$, then $\chi'(G)\le\Delta+1$.
\end{theorem}
\begin{proof}
We prove the claim by induction on the number of edges of $G$.  When $E(G)=\emptyset$, then $G$ is trivially $(\Delta+1)$-edge-colorable,
hence assume that $E(G)\neq\emptyset$.  By the induction hypothesis, for every edge $e_0$ of $G$ there exists
a proper edge coloring $\varphi$ of $G-e_0$ using at most $\Delta+1$ colors.  If there is a reducible Vizing fan in any such
coloring starting with $e_0$, then $G$ has a proper edge coloring using at most $\Delta+1$ colors by Lemma~\ref{lemma:redufan}.
Hence, assume that there is no reducible Vizing fan starting with $e_0$ in any such coloring.

As we observed, this implies that for each such coloring, there exists a maximal Vizing fan starting with $e_0$.
Choose an edge $e_0=u_0v$, an edge coloring $\varphi$ of $G-e_0$, and a maximal Vizing fan $e_0$, \ldots, $e_k$
so that $k$ is minimized.  Let $e_i=u_iv$ for $i=1,\ldots,k$.  Since the fan is maximal, each color that is $\varphi$-available
at $u_k$ appears on an edge of the fan, and in particular $k\ge 2$.
If $\varphi(e_1)$ is not $\varphi$-available at $u_k$, then consider the coloring $\varphi'$ of $G-e_1$
obtained from $\varphi$ by uncoloring the edge $e_1$ and giving $e_0$ the color $\varphi(e_1)$; this is possible, since
$\varphi(e_1)$ is $\varphi$-available at $u_0$ by the definition of the Vizing fan.  Then $e_1$, \ldots, $e_k$
is a maximal Vizing fan in $G-e_1$ with the coloring $\varphi'$, contradicting the minimality of $k$.

Hence, $\varphi(e_1)$ is $\varphi$-available at $u_k$.  Let $a_1=\varphi(e_1)$ and let $a_2$ be a color that
is $\varphi$-available at $v$.  Since the fan is not reducible, the color $a_2$ is not $\varphi$-available at $u_k$,
i.e., there exists an edge $e$ incident with $v_k$ such that $\varphi(e)=a_2$.
Let $H$ be the Kempe chain in colors $a_1$ and $a_2$ containing $e$.  Since $a_1$ is $\varphi$-available at $u_k$,
the chain $H$ is a path.   Let $z$ be the endpoint of $H$ distinct from $u_k$.
Let $\varphi'$ be the edge coloring of $G-e_0$ by $\Delta+1$ colors obtained from $\varphi$
by switching on $H$.  Note that for each vertex $u\in V(G)\setminus\{u_k,z\}$ and a color $a$, the color $a$ is $\varphi'$-available
at $v$ if and only if it is $\varphi$-available at $v$.  Note that $z\neq u_1$, since the edge $e_1$ has color $a_1$
and the color $a_2$ is $\varphi$-available at $v$; i.e., if $u_1\in V(H)$, then $z=v$.

If $z\neq u_0$ and $z\neq v$, then $e_0$, \ldots, $e_k$ is a Vizing fan in $\varphi'$ and $a_2$ is $\varphi'$-available
both at $v$ and $u_k$, i.e., the fan is reducible, which is a contradiction.  If $z=u_0$, then $a_2$ is $\varphi'$-available
both at $v$ and $u_0$ and we can give $e_0$ the color $a_2$ to obtain a proper edge coloring of $G$ by $\Delta+1$ colors.
Finally, if $z=v$, then $a_1$ is $\varphi'$-available both at $v$ and $u_0$, and we can similarly
give $e_0$ the color $a_1$ to obtain a proper edge coloring of $G$ by $\Delta+1$ colors.
\end{proof}
There are several similar proofs of Vizing's Theorem, all of them based on some variant of growing a tree in a partial edge coloring
of the considered graph, and then using Kempe chain switches guided by this tree to extend the coloring to the original graph.
Let us remark that in Vizing's Theorem, it is assumed that the graph $G$ has no parallel edges.  Without this
assumption, the claim fails, as demonstrated by the triangle with each edge of multiplicity $\Delta/2$
(we leave it as an exercise for the reader to work out where the presented proof fails for multigraphs).
Chromatic index of multigraphs is the subject of Goldberg-Seymour Conjecture, which we explore in more detail
in Section~\ref{sec:goseycon}.

For any graph $G$, the edges incident with its vertex of maximum degree $\Delta$ form a clique in the linegraph of $G$,
and thus $\chi'(G)\ge \Delta$.  Vizing's Theorem thus shows that there are only two possible values for the chromatic index,
$\Delta$ or $\Delta+1$.  Somewhat surprisingly, it is NP-complete to decide which is the correct one, even for graphs of
maximum degree three~\cite{edgenpc}.

\subsection{Consistent sets of colorings and the Four Color Theorem}

The reader might wonder how to come up with reducibilty arguments that involve
multiple Kempe chain switches, other than trial-and-error or brute force enumeration
of all possibilities.  It turns out that there is a more systematic method, at least
for fixed configurations of bounded size---the consistent set method.
This method is still usually only practical
with computer assistance, but the time complexity is reasonable and the method
is applicable even for quite large configurations.

As a working example, we will use the best known application of the method: the proof
of the Four Color Theorem.  It turns out to be convenient to prove the following
claim, which was shown to be equivalent to the Four Color Theorem by Tait; we will
establish the equivalence later in Chapter~\ref{chap:flows}, see Lemma~\ref{lemma:4cec}.
\begin{theorem}\label{thm:planar3ec}
Every planar $3$-regular $2$-edge-connected graph is $3$-edge-colorable.
\end{theorem}
The proof consists of two parts: reducibility, demonstrating
hundreds of configurations that cannot appear in a hypothetical smallest counterexample
to Theorem~\ref{thm:planar3ec}, and discharging to show that every planar $3$-regular $2$-edge-connected
graph contains one of these configurations.  We will ignore the latter part, since
we have already discussed the discharging method in detail in Chapter~\ref{chap:redu}.
Instead, we focus on the former part, using the consistent set method to show reducibility of
one of the configurations (all the others can be handled in the same way).
More precisely, we show the following (a graph $G$ is \emph{cyclically $k$-edge-connected} if for every set $X\subseteq E(G)$ of size
less than $k$, at most one component of $G-X$ contains a cycle).
\begin{lemma}\label{lemma:birkhoffdiamond}
Let $G$ be a plane $3$-regular cyclically $5$-edge-connected graph such that every
planar $3$-regular $2$-edge-connected graph with fewer than $|V(G)|$ vertices is
$3$-edge-colorable.  If $G$ contains two adjacent vertices that are both incident only
with $5$-faces, then $G$ is $3$-edge-colorable.
\end{lemma}
Already Birkhoff~\cite{birkhof1913} determined that a hypothetical smallest counterexample
to Theorem~\ref{thm:planar3ec} is cyclically $5$-edge-connected (the argument to show this
again uses Kempe chains; we leave it to the reader as an exercise).  Hence, it is not a problem
that Lemma~\ref{lemma:birkhoffdiamond} has this stronger connectivity assumption.
Suppose for a contradiction that $G$ is not $3$-edge-colorable.

Let $x$ and $y$ be adjacent vertices of $G$ incident only with $5$-faces, whose boundary walks
are $xyv_3v_2v_1$, $yxv_8v_7v_6$, $v_8xv_1v_{10}v_9$, and $v_3yv_6v_5v_4$, see Figure~\ref{fig:birkhoffdiamond}.
Observe that the vertices $x$, $y$, and $v_1$, \ldots, $v_{10}$ are distinct and that there are no edges
among $\{v_2,v_4,v_5,v_7,v_9,v_{10}\}$ other than $v_4v_5$ and $v_9v_{10}$, as otherwise $G$ would not
be $5$-edge-connected.

\begin{figure}
\begin{center}
\begin{asy}
v[0] = (0,0);
v[11] = (1,0);
v[1] = v[0] + dir(120);
v[8] = v[0] + dir(-120);
v[3] = v[11] + dir(60);
v[6] = v[11] + dir(-60);
v[2] = (0.5,1.5);
v[7] = (0.5,-1.5);
v[10] = (-1.5,0.5);
v[9] = (-1.5,-0.5);
v[4] = (2.5,0.5);
v[5] = (2.5,-0.5);

for (i = 0; i <= 9; ++i)
  draw(v[i] -- v[i+1]);
draw(v[1]--v[10]);
draw(v[8]--v[0]--v[11]--v[3]);
draw(v[11]--v[6]);
path e[];
e[1] = v[2] -- (v[2] + 0.7dir(90));
e[2] = v[4] -- (v[4] + 0.7dir(30));
e[3] = v[5] -- (v[5] + 0.7dir(-30));
e[4] = v[7] -- (v[7] + 0.7dir(-90));
e[5] = v[9] -- (v[9] + 0.7dir(210));
e[6] = v[10] -- (v[10] + 0.7dir(150));
for (i = 1; i <= 6; ++i)
  draw(e[i]);

for (i = 0; i <= 11; ++i)
  vertex(v[i], white);

label("$x$", v[0], NE);
label("$v_1$", v[1], NW);
label("$v_2$", v[2], S);
label("$v_3$", v[3], NE);
label("$v_4$", v[4], SW);
label("$v_5$", v[5], NW);
label("$v_6$", v[6], SE);
label("$v_7$", v[7], N);
label("$v_8$", v[8], SW);
label("$v_9$", v[9], NE);
label("$v_{10}$", v[10], SE);
label("$y$", v[11], SW);

label("$e_1$", e[1], W);
label("$e_2$", e[2], N);
label("$e_3$", e[3], S);
label("$e_4$", e[4], E);
label("$e_5$", e[5], S);
label("$e_6$", e[6], N);
\end{asy}
\end{center}
\caption{Dual of Birkhoff diamond (configuration from Lemma~\ref{lemma:birkhoffdiamond}).}\label{fig:birkhoffdiamond}
\end{figure}

Let $G_1=G[\{x,y,v_1,\ldots,v_{10}]$ and $G_2=G-V(G_1)$, and let $e_1, \ldots, e_6$ be the edges of $G$
between $V(G_1)$ and $V(G_2)$ incident with $v_2$, $v_4$, $v_5$, $v_7$, $v_9$, and $v_{10}$ in order.
Let $B=\{e_1,\ldots, e_6\}$, and for $i\in\{1,2\}$, let $S_i$ be the set of colorings of edges of $B$
by colors $\{1,2,3\}$ that extend to $3$-edge-colorings of $G_i$.

Since we explicitly know the configuration $G_1$, we can determine $S_1$ exactly just by going over
all possible colorings of $B$ and checking which extend; up to permutation of colors, $S_1$ consists
exactly of colorings
\begin{align*}
&111212,111221,112112,112211,112222,112332,121121,121211,\\
&121222,121233,122122,122133,122212,122221,122313,123321
\end{align*}
where the colors of edges $e_1$, \ldots, $e_6$ are listed in order.

What can we say about $S_2$?
Since $G$ is not $3$-edge-colorable, no coloring of $B$ can extend both to $G_1$ and $G_2$, and thus $S_1\cap S_2=\emptyset$.
Furthermore, since $G$ is $3$-regular and exactly $6$ edges leave $G_2$, we conclude that $G_2$ has even number of vertices.
Since in any $3$-edge-coloring of $G_2+B$, each vertex of $G_2$ is incident with exactly one edge colored by any color $c\in\{1,2,3\}$,
it follows that $c$ appears on even number of edges of $B$.  Hence, $S_2$ may
(up to permutation of colors) contain only the following colorings.
\begin{align*}
&111111,111122,112121,112233,112323,121112,121323,121332\\
&122111,122331,123123,123132,123213,123231,123312
\end{align*}
Let $S'_2$ denote the above set of colorings; so, we have $S_2\subseteq S'_2$.

Now comes the key observation: the set $S_2$ is \emph{consistent} with respect to Kempe chains, in the following sense.
For each $\psi\in S_2$, there exists at least one $3$-edge-coloring $\varphi$ of the planar graph $G+B$
that matches $\psi$ on $B$.  For any pair of distinct colors $c_1,c_2\in \{1,2,3\}$, let $H$ be the union of Kempe chains
in colors $c_1$ and $c_2$ that intersect $B$.  Then $H$ is a union of pairwise vertex-disjoint paths ending with edges of $B$,
and by switching the colors on any subset of components of $H$, we obtain another $3$-edge-coloring of $G$, and its restriction to $B$ must belong to $S_2$.

Let us formulate the consistency condition more precisely.  Let $B_{\psi,c_1,c_2}$ be the set of edges of $B$ to that $\psi$ assigns colors $c_1$ or $c_2$.
A \emph{$(\psi,c_1,c_2)$-matching} is a partition of $B_{\psi,c_1,c_2}$ into pairs.  The $(\psi,c_1,c_2)$-matching $M$ is \emph{plane} if
the graph obtained from $G_2$ by, for each pair $e_ie_j\in M$, adding an edge between the ends of $e_i$ and $e_j$ in $G_2$, is plane.
For $M'\subseteq M$, let $\psi_{M'}$ denote the coloring obtained from $\psi$ by exchanging colors $c_1$ and $c_2$
on the edges of the pairs of $M'$.  Let
$$\psi\uparrow M=\{\psi_{M'}:M'\subseteq M\}.$$
We now have the following.
\begin{itemize}
\item[(A)] \emph{For every $\psi\in S_2$ and each pair of distinct colors $c_1,c_2\in \{1,2,3\}$,
there exists a plane $(\psi,c_1,c_2)$-matching $M$ such that $\psi\uparrow M\subseteq S_2$.}
\end{itemize}

We can use this property to exclude membership of some colorings from $S_2$.
For example, suppose that the coloring $\psi=111111$ belongs to $S_2$.  There are only five plane $(\psi,1,2)$-matchings;
for each of them, we list just the ending edges of the paths:
\begin{align*}
M_1&: e_1e_2, e_3e_4, e_5e_6\\
M_2&: e_1e_2, e_3e_6, e_4e_5\\
M_3&: e_1e_4, e_2e_3, e_5e_6\\
M_4&: e_1e_6, e_2e_3, e_4e_5\\
M_5&: e_1e_6, e_2e_5, e_3e_4\\
\end{align*}
Switching on all possible subsets of their components, we conclude that the sets $\psi\uparrow M_i$ for $i\in\{1,\ldots, 5\}$ contain the following colorings, up to permutation of colors
(let us remark that it suffices to try the switches involving at most half of the pairs, as switching on the complementary set of pairs is equivalent to switching on the current
set of pairs and afterwards echanging the colors $1$ and $2$):
\begin{align*}
\psi\uparrow M_1&: 111111,112222,112211,111122\\
\psi\uparrow M_2&: 111111,112222,111221,112112\\
\psi\uparrow M_3&: 111111,122122,122111,111122\\
\psi\uparrow M_4&: 111111,122221,122111,111221\\
\psi\uparrow M_5&: 111111,122221,121121,112211
\end{align*}
However, each of these sets contains a coloring not belonging to $S'_2$ and thus also not belonging to $S_2$, which contradicts the consistency condition (A).
Therefore, the coloring $111111$ does not belong to $S_2$.

Similarly, we can go over all colorings in $S'_2$, and exclude from membership
in $S_2$ all but the following ones; let their set be denoted by $S''_2$.
$$112233,112323,121323,121332,122331,123123,123132,123213,123231,123312$$
For example, the reason we could not show that $\psi=112233$ does not belong to $S_2$ is as follows.  There are two plane $(\psi,1,2)$-matchings.
\begin{align*}
M_1&: e_1e_2, e_3e_4\\
M_2&: e_1e_4, e_2e_3
\end{align*}
For these, we have
\begin{align*}
\psi\uparrow M_1&: 112233,111122\\
\psi\uparrow M_2&: 112233,121233\\
\end{align*}
And while $\psi\uparrow M_2$ contains a coloring not belonging to $S'_2$, both colorings in $\psi\uparrow M_1$ belong to $S'_2$, and this suffices to satisfy the consistency condition (A).
Similarly, Kempe chains in colors $1$ and $3$ and in colors $2$ and $3$ do not help, either.

However, both $\psi\uparrow M_1$ and $\psi\uparrow M_2$ contain colorings not belonging to $S''_2$! Hence, they both contain a coloring not belonging to $S_2$, and by (A)
we conclude that the coloring $112233$ cannot belong to $S_2$.  Going over all colorings in $S''_2$, we similarly concude that all colorings in $S_2$ are among the following ones,
up to permutation of colors.
$$112323,121323,121332,123123,123132,123213,123231,123312$$
Iterating the argument again reduces the set to
$$121323,123123,123132,123213,$$
the next iteration to just
$$123123,$$
and the final iteration shows that $S_2=\emptyset$.

This means that no coloring of $B$ extends to a $3$-edge-coloring of $G_2$, and thus $G_2$ itself is not $3$-edge-colorable.  However, consider now the
graph $G'$ obtained from $G_2$ by adding a $6$-cycle and adding in order edges between the vertices of this $6$-cycle
and the vertices of $G_2$ incident with $B$ in $G$.  It is easy to see that $G'$ is planar, $3$-regular, and $3$-edge-connected,
and by the assumptions of Lemma~\ref{lemma:birkhoffdiamond}, $G'$ is $3$-edge-colorable.  This is a contradiction, since $G_2$ is
a subgraph of $G'$; and thus we conclude that $G$ is $3$-edge-colorable, as required.

\subsubsection{Remarks}

There are several modifications that can be made to the basic scheme of the consistent set method
as outlined.  The configuration considered in Lemma~\ref{lemma:birkhoffdiamond} is symmetric along the horizontal and vertical axes,
and it is easy to see that all the sets considered in its proof must also have these symmetries.
For example, for every permutation $\pi\in\{(14)(23)(56),(26)(35),(14)(25)(36)\}$ (the two axial symmetries and their composition)
and for every coloring $\psi\in S'_2$, the coloring $\pi\circ\psi$ also belongs to $S'_2$.  Hence, instead of considering the whole set $S'_2$,
it suffices to only keep track of one representative of each such class of symmetric colorings.  So, instead of $S'_2$ as above, we only need to
consider the colorings
$$111111,111122,112121,112233,112323,121323,123123,123132,$$
keeping in mind that say $112323$ also represents the symmetric colorings $121332$, $123231$, and $123312$.  The further iterations become
\begin{align*}
&112323,121323,123123,123132\\
&121323,123123,123132\\
&123123
\end{align*}
Reducing the number of colorings that need to be considered is of course useful when proving reducibility by hand.
In computer-assisted proofs, eliminating symmetries can improve time complexity and potentially make it possible
to deal with larger configurations; however, the usefulness is limited since very large configurations are unlikely
to have non-trivial symmetries.

The consistency algorithm as outlined calls for going over all elements of $S_2$ to form the set $S'_2$, then
over all elements of $S'_2$ to form the set $S''_2$, and so on.  This can be sped up: when a coloring $c$
is removed from $S_2$ due to violation of the consistency condition (A), the consistency condition may only become violated
for the colorings that can be obtained from $c$ by Kempe chain switches, and thus we can maintain a queue of
the colorings that need to be re-checked.  Possibly even more efficient implementation will be discussed in Subsection~\ref{ssec:bcr}.

It of course may happen that the process of elimination ends up with a non-empty set $S^\star_2$ which satisfies
the consistency condition, and thus fails to directly obtain a contradiction.  In this case, the argument can still
succeed if there exists a configuration $G'_1$ smaller than $G_1$ with the property that no coloring in $S^\star_2$
extends to a coloring of $G'_1$.  In that case, the graph obtained from $G$ by replacing $G_1$ by $G'_1$ is not
$3$-edge-colorable, and assuming we can show it satisfies the connectivity and planarity assumptions, this again
gives the contradiction we seek.

We performed the argument in the dual setting of $3$-regular planar graphs and their $3$-edge-coloring mostly for convenience
of Kempe chains being just unions of paths and cycles. If preferred, essentially the same argument can be made directly
in the terms of $4$-colorings of planar triangulations---there, the configuration described in Lemma~\ref{lemma:birkhoffdiamond} corresponds to two triangles
sharing an edge and consisting only of vertices of degree $5$.  Let us note that in the proof of the Four Color Theorem, it is actually shown
this configuration is reducible even if the two vertices of the shared edge have degree $6$ (although this requires using a particular reducent
as discussed in the previous paragraph).  It is remarkable that these reductions are possible, especially compared to configurations
we considered in Section~\ref{sec:howto-redu} which were only possible when the degrees of almost all considered vertices were equal
to the number of colors.

\subsubsection{Block-count reducibility}\label{ssec:bcr}

Finally, let us describe a strengthening of the method of consistent sets based on counting the numbers of ways the precolorings
of $B$ extend rather than just whether they do, called \emph{block-count reducibility}.

Consider again the situation as discussed in the proof of Lemma~\ref{lemma:birkhoffdiamond}.  For a $3$-coloring $\psi$ of $B$
(satisfying the constraint that each color appears even number of times on $B$), let $n(\psi)$ denote the number of ways
$\psi$ extends to a $3$-edge-coloring of $G_2+B$.  Let $c_1,c_2\in \{1,2,3\}$ be distinct colors and let $M$ be a plane $(\psi,c_1,c_2)$-matching,
and let $\varphi$ be a $3$-edge-coloring of $G_2+B$ that extends $\psi$.  We say that $M$ is the \emph{trace} of $\varphi$ in colors $c_1$ and $c_2$
if the edges of $B_{\psi,c_1,c_2}$ are in the same Kempe chain of $\varphi$ in colors $c_1$ and $c_2$ if and only if they are matched in $M$.
Let $n(\psi,c_1,c_2,M)$ denote the number of $3$-edge-colorings of $G_2+B$ whose restriction to $B$ is equal to $\psi$ and whose trace in colors $c_1$ and $c_2$ is $M$.
Since each coloring has some trace, for each $\psi$, $c_1$, and $c_2$, we have the equality
$$n(\psi)=\sum_M n(\psi,c_1,c_2, M),$$
where the sum goes over all plane $(\psi,c_1,c_2)$-matchings $M$.  Suppose that $M'\subseteq M$ and recall that $\psi_{M'}$ is the coloring
obtained from $\psi$ by switching colors $c_1$ and $c_2$ on edges belonging to the pairs of $M'$.  Now, observe that if $\varphi$ is
a $3$-edge-coloring of $G_2+B$ extending $\psi$ with trace $M$ in colors $c_1$ and $c_2$, then by switching the colors on the Kempe chains joining the edges
matched by $M'$, we obtain a $3$-edge-coloring of $G_2+B$ extending $\psi_{M'}$ which also has trace $M$ in colors $c_1$ and $c_2$, since the Kempe chains in colors $c_1$ and $c_2$
are not affected by the switches.  This establishes a bijection showing that $n(\psi,c_1,c_2,M)=n(\psi_{M'},c_1,c_2,M)$.  I.e., this number is the same for all
colorings that can be obtained from $\psi$ by switching on subsets of $M$.  Which colorings can be obtained in this way?  If $e_ie_j$ is a pair of $M$,
switching on this pair cannot affect whether $e_i$ or $e_j$ have the same color or not, but this is the only constraint, motivating the following definition.

A \emph{signed matching} is a pair $(M,\sigma)$, where $M$ is a partition of a subset of $B$ into pairs and $\sigma$ assigns each pair in $M$ one of the signs $=$ or $\neq$.
If $M$ is a $(c_1,c_2,\psi)$-signed matching, we say that $\sigma$ is \emph{derived from $\psi$} if for $e_ie_j\in M$, $\sigma(e_ie_j)$ is $=$ if $\psi(e_i)=\psi(e_j)$
and $\neq$ if $\psi(e_i)\neq\psi(e_j)$.  We define $n(M,\sigma)$ to be equal to $n(\psi,c_1,c_2,M)$ for any $3$-coloring $\psi$ of $B$ and distinct colors $c_1,c_2\in \{1,2,3\}$ such that
$M$ is a $(c_1,c_2,\psi)$-matching and $\sigma$ is derived from $\psi$.  According to the previous paragraph, the value of $n(\sigma,c_1,c_2,M)$ does not depend on the choice of $\psi$
(the choice of colors $c_1$ and $c_2$ is implied by $M$ and also does not affect the value, as the colors can be freely permuted in any $3$-edge-coloring of $G_2+B$).
In particular, for each choice of distinct colors $c_1,c_2\in\{1,2,3\}$, we have
$$n(\psi)=\sum_{(M,\sigma)} n(M,\sigma),$$
where the sum goes over all plane $(c_1,c_2,\psi)$-matchings $M$, with $\sigma$ derived from $\psi$.
The corresponding equations for the case considered in Lemma~\ref{lemma:birkhoffdiamond} are listed in Figure~\ref{fig:bceqs}
(leaving out the $n(\cdot)$ around all the coloring and signed matching variables, denoting pairs $e_ie_j$ such that $\sigma(e_ie_j)$ is $=$ by $(ij)$ and those for that it is $\neq$ by $[ij]$,
and ignoring equations where there is only one variable on the right-hand side and this variable does not appear anywhere else).

\begin{figure}
\scriptsize
\begin{align*}
111111 &= (12)(34)(56) + (12)(36)(45) + (14)(23)(56) + (16)(23)(45) + (16)(25)(34)\\
111122 &= (12)(34) + (14)(23)\\
111122 &= (12)(34)(56) + (12)[36][45] + (14)(23)(56) + [16](23)[45] + [16][25](34)\\
111212 &= (12)(35) + (15)(23)\\
111212 &= (12)[34][56] + (12)[36][45] + [14](23)[56] + [16](23)[45] + [16](25)[34]\\
111221 &= (12)(36) + (16)(23)\\
111221 &= (12)[34][56] + (12)(36)(45) + [14](23)[56] + (16)(23)(45) + (16)[25][34]\\
112112 &= (12)(45) + (15)(24)\\
112112 &= (12)[34][56] + (12)(36)(45) + (14)[23][56] + [16][23](45) + [16](25)[34]\\
112121 &= (12)(46) + (16)(24)\\
112121 &= (12)[34][56] + (12)[36][45] + (14)[23][56] + (16)[23][45] + (16)[25][34]\\
112211 &= (12)(56) + (16)(25)\\
112211 &= (12)(34)(56) + (12)[36][45] + [14][23](56) + (16)[23][45] + (16)(25)(34)\\
112222 &= (34)(56) + (36)(45)\\
112222 &= (12)(34)(56) + (12)(36)(45) + [14][23](56) + [16][23](45) + [16][25](34)\\
112233 &= (34)(56) + [36][45] = (12)(56) + [16][25] = (12)(34) + [14][23]\\
112323 &= [34][56] + [36][45] = (12)(46) + [16][24] = (12)(35) + [15][23]\\
112332 &= [34][56] + (36)(45) = (12)(45) + [15][24] = (12)(36) + [16][23]\\
121112 &= (13)(45) + (15)(34)\\
121112 &= [12](34)[56] + [12][36](45) + (14)[23][56] + [16][23](45) + [16][25](34)\\
121121 &= (13)(46) + (16)(34)\\
121121 &= [12](34)[56] + [12](36)[45] + (14)[23][56] + (16)[23][45] + (16)(25)(34)\\
121211 &= (13)(56) + (16)(35)\\
121211 &= [12][34](56) + [12](36)[45] + [14][23](56) + (16)[23][45] + (16)[25][34]\\
121222 &= (24)(56) + (26)(45)\\
121222 &= [12][34](56) + [12][36](45) + [14][23](56) + [16][23](45) + [16](25)[34]\\
121233 &= (24)(56) + [26][45] = (13)(56) + [16][35] = [12][34] + [14][23]\\
121323 &= [24][56] + [26][45] = (13)(46) + [16][34] = [12][35] + [15][23]\\
121332 &= [24][56] + (26)(45) = (13)(45) + [15][34] = [12][36] + [16][23]\\
122111 &= (14)(56) + (16)(45)\\
122111 &= [12][34](56) + [12][36](45) + (14)(23)(56) + (16)(23)(45) + (16)[25][34]\\
122122 &= (23)(56) + (26)(35)\\
122122 &= [12][34](56) + [12](36)[45] + (14)(23)(56) + [16](23)[45] + [16](25)[34]\\
122133 &= (23)(56) + [26][35] = (14)(56) + [16][45] = [12][34] + (14)(23)\\
122212 &= (23)(46) + (26)(34)\\
122212 &= [12](34)[56] + [12](36)[45] + [14](23)[56] + [16](23)[45] + [16][25](34)\\
122221 &= (23)(45) + (25)(34)\\
122221 &= [12](34)[56] + [12][36](45) + [14](23)[56] + (16)(23)(45) + (16)(25)(34)\\
122313 &= (23)(46) + [26][34] = [14][56] + [16][45] = [12][35] + (15)(23)\\
122331 &= (23)(45) + [25][34] = [14][56] + (16)(45) = [12][36] + (16)(23)\\
123123 &= [23][56] + [26][35] = [13][46] + [16][34] = [12][45] + [15][24]\\
123132 &= [23][56] + (26)(35) = [13][45] + [15][34] = [12][46] + [16][24]\\
123213 &= [23][46] + [26][34] = [13][56] + [16][35] = [12][45] + (15)(24)\\
123231 &= [23][45] + [25][34] = [13][56] + (16)(35) = [12][46] + (16)(24)\\
123312 &= [23][46] + (26)(34) = [13][45] + (15)(34) = [12][56] + [16][25]\\
123321 &= [23][45] + (25)(34) = [13][46] + (16)(34) = [12][56] + (16)(25)
\end{align*}
\normalsize

\caption{Block-count equations for $3$-edge-colorings and $6$ boundary edges.}\label{fig:bceqs}
\end{figure}

Now, if $G$ is a couterexample to Lemma~\ref{lemma:birkhoffdiamond}, then
$n(\psi)=0$ for all $\psi\in S_1$.  E.g. $n(123321)=0$.  However, since all the counts
are non-negative, this implies that $n([23][45]) = n((25)(34)) = n([13][46]) = n((16)(34)) = n([12][56]) = n((16)(25)) = 0$.
We can propagate these zeros and eliminate the variables from the other equations.  For the colorings $\psi\in S'_2\setminus S''_2$,
this will result in an equation where the right hand side is empty, and thus $n(\psi)=0$.  This may force further
variables for signed matchings to be $0$, and thus we can repeat the argument.  Indeed, this is exactly what the
consistency method does.

Based on this observation, we can give even more efficient implementation of the consistency algorithm.
Form a bipartite graph with vertices of one part $Q$ representing the equations of the system
and the vertices of the other part $P$ representing the variables for signed matchings, joined
to the equations in which they appear.  We keep removing vertices for variables that are shown to be equal $0$:
when a vertex $v\in Q$ becomes isolated (or if the coloring in the left-hand side of the corresponding equation
belongs to $S_1$), we delete it together with other vertices for equations with the same left-hand side as well
as all their neighbors in $P$.  In the end, the left-hand sides of the equations for the remaining vertices of $Q$
form a set of colorings satisfying the consistency condition (A) and forming a superset of $S_2$.

More importantly, there may be variables that are forced to be $0$ even though this does not follow by the described
trivial propagation algorithm.  Consider for example the following set of colorings, which is consistent.
\begin{align*}
&111111,111221,112233,112323,121233,121323,122111,\\
&122221,122331,123123,123132,123213,123312,123321
\end{align*}
Indeed, setting all other variables for colorings to be $0$ and propagating, we obtain the system in Figure~\ref{fig:consnobc},
where all right-hand sides are non-trivial and no further propagation is possible.
However, we have (among others)
\begin{align*}
122221 &= (23)(45) + (25)(34) = (16)(23)(45)\\
122331 &= (23)(45) = (16)(45)\\
122111 &= (16)(45) = (16)(23)(45)
123321 &= (25)(34),
\end{align*}
implying $n(123321)=0$ and consequently $123321\not\in S_2$.  Hence, this enables us to further reduce the
set of possible colorings belonging to $S_2$.  Let us remark that the above set is to our knowledge smallest
one which is consistent, but not block-count consistent.

\begin{figure}
\begin{align*}
111111 &= (16)(23)(45)\\
111221 &= (16)(23) = (16)(23)(45)\\
112233 &= [36][45] = [16][25] = [14][23]\\
112323 &= [36][45] = [16][24] = [15][23]\\
121233 &= [26][45] = [16][35] = [14][23]\\
121323 &= [26][45] = [16][34] = [15][23]\\
122111 &= (16)(45) = (16)(23)(45) \\
122221 &= (23)(45) + (25)(34) = (16)(23)(45)\\
122331 &= (23)(45) = (16)(45) = (16)(23)\\
123123 &= [23][56] = [13][46] + [16][34] = [12][45]\\
123132 &= [23][56] = [13][45] = [16][24]\\
123213 &= [23][46] = [16][35] = [12][45]\\
123312 &= [23][46] = [13][45] = [12][56] + [16][25]\\
123321 &= (25)(34) = [13][46] = [12][56]\\
\end{align*}
\caption{Equations for a consistent set that is not block-count consistent.}\label{fig:consnobc}
\end{figure}

To prove reducibility via block-count consistency, one forms linear program as in Figure~\ref{fig:bceqs} and
adds equalities $n(\psi)=0$ for all colorings $\psi$ of $B$ that extend to the reduced configuration (expressing
the fact that we are for contradiction assuming that the graph we consider is not colorable).
Furthermore, one adds an inequality for the assumption that all smaller graphs are colorable, of form $\sum_{\psi} n(\psi)\ge 1$;
when we are replacing the configuration by a specific smaller graph $G'_1$, the sum goes over all colorings $\psi$ of $B$ that extend to $G'_1$,
otherwise the sum goes over all colorings of $B$.  If the polytope described by the resulting system is empty, this gives a contradiction,
showing that the considered graph is colorable.

One can even add constraints for several different graphs $G'_1$ by which the configuration can be replaced, if desired; this is useful
when trying to decide which reducent to use or whether there exists one, however it does not add to the strength of the method
(as an exercise, argue that if block-count consistency method succeeds using several reducents, it also succeeds using just one of them).

One might be concerned about the reliability of the result of the testing of the emptiness.  Unless an exact LP solver is used,
cannot the result be due to rounding errors?  This objection can be overcome via LP duality: the solver can also return the coefficients
from Farkas' lemma proving the emptiness of the polytope.  These coefficients can be rounded to rational numbers and then (in exact arithmetic)
used to verify that the inequalities are contradictory.

Since block-count reduciblity is stronger than the basic consistency method, why is it not universaly used?
One issue concerns its computational complexity.  LP solvers are of course much slower than the trivial propagation
method used by the consistency method, and thus block-count reducibility is not applicable to as large configurations.

A more principial problem arises when algorithmization is considered.  The consistency method gives a polynomial-time algorithm
to find a coloring of the graph. Going back to the proof of Lemma~\ref{lemma:birkhoffdiamond}, let us say we obtained recursively
a coloring of the reduced graph, and thus we have a $3$-edge-coloring of $G_2+B$.  Let $\psi$ be the restriction of this coloring to $B$,
and say that $\psi$ belongs to $S''_2$ but not to the next set $S'''_2$ constructed by the method.  By the construction of $S'''_2$,
we know that by switching on Kempe chains in some pair of colors, we can transform the coloring of $G_2+B$ to one whose restriction belongs to
$(S'_2\setminus S''_2)\cup S_1$.  If we obtain a coloring with restriction in $S'_2\setminus S''_2$, by construction of $S''_2$ we can switch
on Kempe chains in another pair of colors to obtain a coloring whose restriction to $B$ belongs to $S_1$.  This final coloring can be combined
with a $3$-edge-coloring of $G_1$ to give a $3$-edge-coloring of $G$.

For block-count consistency, similar efficient algorithm does not directly follow.  Firstly, in general it is not clear how the emptiness of the
polytope translates to an algorithm to translate a coloring of $G_2+B$ to one whose restriction to $B$ belongs to $G_1$.  However, let us consider
the simple example we discussed in this subsection, which at first gives us some hope.
Suppose we found a coloring of $G_2+B$ whose restriction to $B$ is $123321$, and thus its Kempe chains match $(25)(34)$ and we can switch
it to a coloring $\psi_1$ with restriction $122221$.  By the first equality, in another pair of colors the Kempe chains of $\psi_1$ match
$(16)(23)(45)$, and going through colorings with restriction $122111$ and $122331$, we obtain another coloring $\psi_2$ with restriction $122221$
(and Kempe chains matching $(23)(45)$).  We can repeat this process again to obtain from $\psi_2$ another coloring $\psi_3$ with restriction $122221$,
and so on.  This cannot continue indefinitely, since $G_2+B$ has only finitely many colorings, and thus eventually we obtain a coloring whose restriction to $B$
was eliminated in the consistency propagation part of the algorithm.  With this coloring, we can then proceed as in the previous paragraph.
However, $G_2+B$ can have exponentially many colorings, and thus it is in principle possible that we will have to go over exponentially many colorings $\psi_1$, $\psi_2$, $\psi_3$, $\dots$;
hence, the resulting algorithm might not be polynomial.

\section{Recoloring and the number of colorings}

The ability to transform a valid coloring into another one clearly has implications regarding the number of colorings
of the graph.  This is especially clear for local recolorings:  if we can change the coloring of a graph $G$ locally on $m$ places
that do not interfere with each other, then $G$ has at least $2^m$ different colorings.

\begin{theorem}\label{theorem:planar5many}
Every planar graph with $n$ vertices has at least $2^{n/4}$ different $5$-colorings.
\end{theorem}
\begin{proof}
Let $G$ be a planar graph with $n$ vertices.  By the Four Color Theorem, $G$ has a $4$-coloring $\varphi$.
A largest color class $C$ of this $4$-coloring has size at least $n/4$.  Now $C$ is an independent set, and
thus we can change colors of vertices of any subset of $C$ to $5$ to obtain a proper $5$-coloring of $G$.
Hence, $G$ has at least $2^{|C|}\ge 2^{n/4}$ different $5$-colorings.
\end{proof}

More complicated local recoloring arguments affect vertices at greater distances, and thus to use them to obtain
many colorings guaranteed to be different, one would need many vertices that are pairwise far apart.  However,
unless the maximum degree of the graph is bounded, there may not exist many distant vertices, somewhat limiting the potential
of this idea.

Perhaps a bit surprisingly, global recoloring arguments can be very useful in showing lower bounds on the numbers of
colorings.  As an example, consider a coloring of some graph $G$, and suppose that the subgraph of $G$ induced by
vertices of two colors $c_1$ and $c_2$ has $m$ components.  Then we can switch the colors $c_1$ and $c_2$ independently
on each of the components, obtaining $2^m$ different colorings.  Of course, we need an argument to show that $m$ is large;
one way to do so is demonstrated in the following example, giving an exponential bound on the number of $5$-colorings
of planar graphs without using the Four Color Theorem.

\begin{theorem}\label{thm:num5col}
Every planar graph with $n$ vertices has at least $2^{n/10}$ different $5$-colorings.
\end{theorem}
\begin{proof}
Let $G$ be a planar graph with $n$ vertices.  By Theorem~\ref{thm:planar5col}, $G$ has
a $5$-coloring $\varphi$.  For $1\le i<j\le 5$, let $G_{ij}$ denote the subgraph of $G$
induced by vertices of colors $i$ or $j$ in $\varphi$.  Let $n_{ij}$ and $m_{ij}$
denote the number of vertices and edges of $G_{ij}$, respectively.
Clearly, we have
$$\sum_{1\le i<j\le 5} n_{ij}=4n.$$
Furthermore, the graphs $G_{12}$, $G_{13}$, \ldots, $G_{45}$ are pairwise edge-disjoint
and by Euler's formula, $G$ has at most $3n$ edges, and thus
$$\sum_{1\le i<j\le 5} m_{ij}\le 3n.$$
Let $q$ denote the maximum number of components of the graphs $G_{ij}$ for $1\le i<j\le 5$;
we have $m_{ij}\ge n_{ij}-q$.  Hence, we have
$$3n\ge \sum_{1\le i<j\le 5} m_{ij}\ge \sum_{1\le i<j\le 5} (n_{ij}-q)=4n-10q,$$
and thus $q\ge n/10$.  Hence, there exist $i$ and $j$ such that the graph $G_{ij}$
has at least $n/10$ components, and by switching the colors $i$ and $j$ independently
in subsets of these components, we can transform $\varphi$ into $2^q\ge 2^{n/10}$ different $5$-colorings of $G$.
\end{proof}

Note that this argument can be generalized even to non-embedded graphs, since the only
properties taken from planarity are the density of the graph and the fact that it has a coloring.
Hence, we have the following stronger statement, whose proof we leave to the reader as an
exercise.

\begin{theorem}\label{thm:expmany}
For every integer $c\ge 2$ and real number $\beta<2c-2$, there exists a real number $\gamma>1$ as follows.
If $G$ is an $n$-vertex graph of average degree at most $\beta$ and $G$ is $c$-colorable,
then $G$ has at least $\gamma^n$ different $c$-colorings.
\end{theorem}

In particular, planar graphs of girth at least five have exponentially many $3$-colorings.
Furthermore, any sufficiently large graph embedded in a fixed surface has average degree at most $7$
by Corollary~\ref{cor:mad}, and thus each such graph has either $0$ or exponentially many $5$-colorings.

The situation is more interesting in cases where Theorem~\ref{thm:expmany} does not apply.
Thomassen~\cite{thom-many} conjectured that triangle-free planar graphs have exponentially many $3$-colorings; the best currently known
bound~\cite{submany} gives $\gamma^{\sqrt{n}}$ $3$-colorings for some $\gamma>0$.
Planar graphs do not need to have many different $4$-colorings: consider any planar triangulation
obtained from $K_3$ by repeatedly subdividing any face into three by adding a new vertex of degree three.
Any $4$-coloring of $K_3$ extends in a unique way to a $4$-coloring of such a graph, and thus it has
only one $4$-coloring up to permutation of colors.  As conjectured by Fiorini and Wilson, and independently by Fisk, and eventually
proved by Fowler~\cite{fowler2000unique}, these are the only uniquely $4$-colorable planar graphs with at least three vertices.

\chapter{Flows and Orientations}\label{chap:flows}

An important notion in the study of planar graphs is duality.  Recall the \emph{dual} $D$ of a plane graph $G$
is the plane graph whose vertices correspond to the faces of $G$, with adjacencies in $D$ corresponding to
the edges shared between the faces in $G$; see Figure~\ref{fig:dual} for an illustration.  A connection between
a concept in a plane graph and its counterpart in the dual often makes it possible to use tools from two in general
different areas---the basic example being the correspondence between edge cuts in the original graph and cycles in the dual.

\begin{figure}
\begin{center}
\begin{asy}
unitsize(15mm);

for (i = 0; i < 5; ++i)
  v[i] = dir(72i);

v[6] = (v[0]+v[1]+v[4])/3;
v[7] = (v[1]+v[2]+v[4])/3;
v[8] = (v[3]+v[2]+v[4])/3;
v[9] = 1.5dir(108);
v[10] = 1.8dir(-72);

for (i = 0; i < 5; ++i)
  draw(v[i] -- v[(i+1)%5]);
draw(v[1] -- v[4] -- v[2]);
draw(v[0]{dir(60)}..{dir(-30)}v[3]);
for (i = 0; i < 5; ++i)
  vertex (v[i], 0.05);

draw(v[7]--v[8], red);
draw(v[7]--v[6], red);
draw(v[7]--v[9], red);
draw(v[8]--v[10], red);
draw(v[6]--v[10], red);
draw(v[6]{dir(60)}..{dir(198)}v[9], red);
draw(v[8]{dir(170)}..{dir(18)}v[9], red);
draw(v[10]{dir(40)}..{dir(240)}v[9], red);
for (i = 6; i <= 10; ++i)
  vertex (v[i], red, 0.05);
\end{asy}
\end{center}
\caption{A graph $G$ (in black) and its dual $D$ (in red).}\label{fig:dual}
\end{figure}

In similar vein, $k$-colorings in the original graph correspond to \emph{nowhere-zero $k$-flows} in the dual,
where a nowhere-zero $k$-flow is a flow using only values $\pm 1$, $\pm 2$, \ldots, $\pm (k-1)$.
This connection (first noticed by Tutte~\cite{tutteflow}) gives hope of attacking coloring problems using
the well-developed theory of network flows.  An example arises in the theory of
$3$-colorability of triangle-free embedded graphs.  This problem can be reduced to study of $3$-colorings of
near-quadrangulations, and hence in the dual setting to nowhere-zero $3$-flows in near-Eulerian graphs, which have particularly nice
properties.

Furthermore, a natural idea is to consider the flows in a larger
class including planar graphs and thus obtain more flexibility in inductive arguments.  This hope
is supported by the fact that while chromatic number of a graph can be arbitrarily large,
any $2$-edge-connected graph has a nowhere-zero $6$-flow.  Thus, it seems that even in full generality,
studying nowhere-zero flows may be easier than studying graph coloring, and the results may still be relevant
in the initial setting of planar graphs.

Indeed, Tutte formulated several famous conjectures lifting 
coloring results and (at the time) open problems in planar graphs to such more general setting.
While none of these conjectures has been resolved yet, they motivated a number of partial results
and lead to a development of theory of nowhere-zero flows which is interesting for its own sake,
not just because of its connections to graph colorings.

\section{Nowhere-zero Flows and Flow-Coloring duality}\label{sec:flow-coloring-duality}

Let $\mathbb{A}$ be an abelian group, let $D$ be a multigraph and let $\vec{D}$ be its arbitrary orientation.  
For a vertex $v\in V(G)$, let $E^-(v)$ and $E^+(v)$ denote the sets of edges of $\vec{D}$ entering and leaving $v$, respectively.
An \emph{$\mathbb{A}$-flow}
is a function $f:E(\vec{D})\to\mathbb{A}$ satisfying the flow conservation law
\begin{equation}\label{eq:conserve}
\sum_{e\in E^-(v)} f(e)=\sum_{e\in E^+(v)} f(uv)
\end{equation}
for every vertex $v\in V(D)$.
The flow is \emph{nowhere-zero} if $f(e)\neq 0$ for every $e\in E(\vec{D})$.

We would like to view the flow as the property of the undirected multigraph $D$, rather than its arbitrary orientation.
Indeed, reversing the orientation of an edge of $\vec{D}$ and replacing the value assigned to it by its inverse in $\mathbb{A}$
clearly gives a valid $\mathbb{A}$-flow with basically the same properties.  Thus, consider the symmetric orientation $\ovlr{D}$
of $D$, where each edge $e$ is replaced by two oppositely directed edges $\ovl{e}$ and $\ovr{e}$.
We can define an \emph{$\mathbb{A}$-flow} on $D$ as a function $f:E(\ovlr{D})\to\mathbb{A}$
such that $f(\ovl{e})+f(\ovr{e})=0$ for every $e\in E(D)$,
and the variant version of (\ref{eq:conserve})
\begin{equation}\label{eq:conserve-alt}
\sum_{e\in E^-(v)} f(e)=\sum_{e\in E^+(v)} f(e)=0
\end{equation}
holds for every vertex $v\in V(D)$.

Suppose $G$ is a connected plane multigraph and $\varphi:V(G)\to \mathbb{A}$ is a proper coloring of $G$,
where elements of an abelian group $\mathbb{A}$ play the role of colors.  Let $D$ be the plane dual of $G$.
For an edge $e\in E(\ovlr{G})$ from a vertex $u$ to a vertex $v$, let $g_1$ and $g_2$ be the face of $G$ on the left and right of $e$
(as seen in the direction of $e$), and let $e^\star$ denote the edge of $\ovlr{D}$
corresponding to $e$ and directed from the vertex corresponding to $g_1$ to the vertex corresponding to $g_2$.
In this case, let us define $f:E(\ovlr{D})\to \mathbb{A}$ by setting
$f(e^\star)=\varphi(v)-\varphi(u)$.  See Figure~\ref{fig:dual-flow} for an illustration (showing just one edge of each pair of oppositely
directed edges of $G$ and $D$).
Let $g$ be a face of $G$ with the facial walk $v_1v_2\ldots v_m$, and for $i=1,\ldots, m$, let $g_i$ be the
other face incident with the edge $v_iv_{i+1}$ (where $v_{m+1}=v_1$).  We can now verify that $f$ satisfies the condition (\ref{eq:conserve-alt}) at the vertex
of $D$ corresponding to $G$:
$$\sum_{i=1}^m f(gg_i)=\sum_{i=1}^m (\varphi(v_{i+1})-\varphi(v_i))=0;$$
we conclude that $f$ is an $\mathbb{A}$-flow in $D$.

\begin{figure}
\begin{center}
\begin{asy}
unitsize(15mm);

for (i = 0; i < 5; ++i)
  v[i] = dir(72i);

v[6] = (v[0]+v[1]+v[4])/3;
v[7] = (v[1]+v[2]+v[4])/3;
v[8] = (v[3]+v[2]+v[4])/3;
v[9] = 1.5dir(108);
v[10] = 1.8dir(-72);

for (i = 0; i < 5; ++i)
  draw(v[i] -- v[(i+1)%5], MidArrow);
draw(v[1] -- v[4], MidArrow);
draw(v[4] -- v[2], MidArrow);
draw(v[0]{dir(60)}..{dir(-30)}v[3], MidArrow);
for (i = 0; i < 5; ++i)
  vertex (v[i], 0.05);

draw(v[8]--v[7], red, Arrow, L=scale(0.7)*Label("2"));
draw(v[6]--v[7], red, Arrow, L=scale(0.7)*Label("2"));
draw(v[7]--v[9], red, Arrow, L=scale(0.7)*Label("4"));
draw(v[8]--v[10], red, Arrow, L=scale(0.7)*Label("1"));
draw(v[6]--v[10], red, Arrow, L=scale(0.7)*Label("2"));
draw(v[6]{dir(60)}..{dir(198)}v[9], red, Arrow, L=scale(0.7)*Label("1"));
draw(v[8]{dir(170)}..{dir(18)}v[9], red, Arrow, L=scale(0.7)*Label("2"));
draw(v[9]{dir(60)}..{dir(220)}v[10], red, Arrow, L=scale(0.7)*Label("2"));
for (i = 6; i <= 10; ++i)
  vertex (v[i], red, 0.05);

label("$0$", v[0], E);
label("$1$", v[1], N);
label("$0$", v[2], NW);
label("$2$", v[3], SW);
label("$3$", v[4], SE);
\end{asy}
\end{center}
\caption{A coloring $V(G)\to\mathbb{Z}_4$ and a nowhere-zero $\mathbb{Z}_4$-flow in its dual.}\label{fig:dual-flow}
\end{figure}

Furthermore, since $\varphi$ is a proper coloring, $f$ does not assign value $0$ to any edge.  Thus, every proper coloring $\varphi$
of a connected plane multigraph using colors from $\mathbb{A}$ gives a nowhere-zero $\mathbb{A}$-flow in the dual;
we say that this flow is \emph{derived} from the coloring $\varphi$.  Conversely, nowhere-zero $\mathbb{A}$-flows give rise
to proper colorings.
\begin{lemma}\label{lemma:flowtocolor}
Let $G$ be a connected plane multigraph, let $D$ be the dual of $G$, and let $\mathbb{A}$ be a finite abelian group.
For every nowhere-zero $\mathbb{A}$-flow $f$ in $D$, there exist precisely $|\mathbb{A}|$ proper colorings of $G$
by elements of $\mathbb{A}$ whose derived $\mathbb{A}$-flow is $f$.
\end{lemma}
\begin{proof}
For an edge $e\in E(\ovlr{G})$, let us define $\delta(e)=f(e^\star)$.  For any walk $W=w_0w_1\ldots w_m$, let $\delta(W)=\sum_{i=1}^m \delta(w_{i-1}w_i)$.
By the flow conservation law (\ref{eq:conserve-alt}), if $W_g$ is the facial walk of a face $g$ of $G$, then $\delta(W_g)=0$.
If $C$ is a cycle in $G$, then denoting by $F_C$ the set of faces drawn inside $C$,
observe that
$$\delta(C)=\sum_{g\in F_C} \delta(W_g)=0.$$
Since each closed walk can be decomposed into cycles (and walks of length two over one edge), we conclude
that $\delta(W)=0$ for every closed walk $W$ in $G$.

Let $v$ be any vertex of $G$, and for each $x\in V(G)$, let us choose a path $P_x$ from $v$ to $x$ arbitrarily.
For any element $a$ of $\mathbb{A}$ and $x\in V(G)$, let $\varphi_a(x)=a+\delta(P_x)$.
For any edge $xy$, let $W_{xy}$ be the closed walk consisting of $P_x$, the edge $xy$, and the reverse of the walk $P_y$.
We have
$$0=\delta(W_{xy})=\varphi_a(x)+\delta(xy)-\varphi_a(y),$$
and thus $\delta(xy)=\varphi_a(y)-\varphi_a(x)$.  We conclude that $\varphi_a$ is a proper coloring of $G$ by elements
of $\mathbb{A}$ and $f$ is the nowhere-zero $\mathbb{A}$-flow derived from it.

Hence, there exist $|\mathbb{A}|$ proper colorings $\varphi_a$ of $G$ for $a\in |\mathbb{A}|$ whose derived $\mathbb{A}$-flow is $f$.
There are no other such colorings, since it is easy to see that a coloring whose whose derived $\mathbb{A}$-flow is $f$
is uniquely determined by the color it assigns to $v$.
\end{proof}

In particular, we obtain the following relationship between numbers of colorings and nowhere-zero flows.
\begin{corollary}\label{cor:numflowcol}
For any finite abelian group $\mathbb{A}$,
the number of proper $|\mathbb{A}|$-colorings of a connected plane multigraph $G$ is equal to $|\mathbb{A}|$ times the number
of nowhere-zero $\mathbb{A}$-flows in the dual $D$ of $G$.
\end{corollary}

Hence, in planar graphs, instead of studying their colorings, we can as well consider their nowhere-zero flows.
As a simple application, let us establish equivalence between the Four Color Theorem and $3$-edge-colorability of bridgeless
cubic planar graphs (Theorem~\ref{thm:planar3ec}).  Let us start with a quick observation.
\begin{lemma}\label{lemma:z223col}
A $3$-regular graph $G$ has a nowhere-zero $\mathbb{Z}_2^2$-flow if and only if $G$ is $3$-edge-colorable.
\end{lemma}
\begin{proof}
Let $a$, $b$, and $c$ be any non-zero elements of $\mathbb{Z}_2^2$.  Observe that $a+b+c=0$ if and only if these
elements are pairwise different, i.e., $\{a,b,c\}=\{(0,1),(1,0),(1,1)\}$.  Hence, a nowhere-zero $\mathbb{Z}_2^2$-flow
in a $3$-regular graph is exactly its $3$-edge-coloring using colors $\mathbb{Z}_2^2\setminus\{(0,0)\}$.
\end{proof}

\begin{lemma}\label{lemma:4cec}
The following claims are equivalent.
\begin{itemize}
\item Every planar graph is $4$-colorable.
\item Every planar $3$-regular $2$-edge-connected graph is $3$-edge-colorable.
\end{itemize}
\end{lemma}
\begin{proof}
Suppose first that every planar $3$-regular $2$-edge-connected graph is $3$-edge-colorable.  Let $G$ be any planar graph,
and let $G_1$ be a maximal planar supergraph of $G$ on the same vertex set; then $G_1$ is a plane triangulation.  Since $G_1$
has no loops, its dual $G_1^\star$ is $2$-edge-connected and $3$-regular, and thus $G_1^\star$ is $3$-edge-colorable.  By Lemma~\ref{lemma:z223col},
$G_1^\star$ has a nowhere-zero $\mathbb{Z}_2^2$-flow, and by Lemma~\ref{lemma:flowtocolor}, $G_1$ has a proper coloring by elements of $\mathbb{Z}_2^2$.
Consequently, $G_1$ as well as its subgraph $G$ are $4$-colorable.

Conversely, the dual of a planar $3$-regular $2$-edge-connected graph $H$ is a plane triangulation without loops, and a nowhere-zero
$\mathbb{Z}_2^2$-flow (and thus also a $3$-edge-coloring by Lemma~\ref{lemma:z223col}) can be derived from a proper $4$-coloring
of its dual $H^\star$ by elements of $\mathbb{Z}_2^2$ as described at the beginning of this section.
\end{proof}

\section{Flow and chromatic polynomials}

Consider two abelian groups of the same size, say $\mathbb{Z}_4$ and $\mathbb{Z}_2^2$.  Nowhere-zero flows over these two groups
are quite different. However, if $D$ is a connected plane multigraph, Corollary~\ref{cor:numflowcol} implies that the number of
nowhere-zero $\mathbb{Z}_4$-flows in $D$ is the same as the number of nowhere-zero $\mathbb{Z}_2^2$-flows in $D$; both are equal
to $\tfrac{1}{4}$ of the number of $4$-colorings of the dual of $D$.  This is not a coincidence; indeed, for a fixed
(not necessarily planar) multigraph, the number of nowhere-zero $\mathbb{A}$-flows depends only on the size of the (finite abelian) group $\mathbb{A}$.

For a multigraph $G$ and a finite abelian group $\mathbb{A}$, let $C^\star_G(\mathbb{A})$ denote the number of nowhere-zero $\mathbb{A}$-flows in $G$.
Note that when $G$ has no edges, we have $C^\star_G(\mathbb{A})=1$.
For a non-loop edge $e$ of $G$, let $G/e$ denote the graph obtained by contracting the edge $e$, destroying $e$ but keeping the parallel edges and loops
that may arise.

\begin{lemma}\label{lemma:count}
Let $\mathbb{A}$ be a finite abelian group, let $G$ be a multigraph and let $e$ be an edge of $G$.
\begin{itemize}
\item If $e$ is a loop, then $C^\star_G(\mathbb{A})=(|\mathbb{A}|-1)C^\star_{G-e}(\mathbb{A})$.
\item If $e$ is not a loop, then $C^\star_G(\mathbb{A})=C^\star_{G/e}(\mathbb{A})-C^\star_{G-e}(\mathbb{A})$.
\end{itemize}
Consequently, if $\mathbb{A}'$ is a finite abelian group and $|\mathbb{A}'|=|\mathbb{A}|$, then
$C^\star_G(\mathbb{A}')=C^\star_G(\mathbb{A})$.
\end{lemma}
\begin{proof}
If $e$ is a loop, then a nowhere-zero $\mathbb{A}$-flow in $G-e$ extends to a nowhere-zero $\mathbb{A}$-flow in $G$
by setting its value on $e$ to an arbitrary non-zero element of $\mathbb{A}$, and conversely the restriction of
a nowhere-zero $\mathbb{A}$-flow in $G$ to $E(G)\setminus\{e\}$ is a nowhere-zero $\mathbb{A}$-flow in $G-e$, justifying
the first claim.

If $e$ is not a loop, then note that any $\mathbb{A}$-flow $f'$ in $G/e$ extends to an $\mathbb{A}$-flow $f$ in $G$ in unique way
by setting the value on $e$ so that the flow conservation law holds on both ends of $e$; and conversely, the restriction of an $\mathbb{A}$-flow in $G$
to $E(G)\setminus\{e\}$ is an $\mathbb{A}$-flow in $G/e$.  Furthermore, if $f'$ is nowhere-zero, then $f$ is nowhere-zero everywhere except possibly
on $e$.  Finally, note that the $\mathbb{A}$-flows in $G$ whose value is $0$ exactly on $e$ are in 1-to-1 correspondence with nowhere-zero flows in $G-e$.
Consequently, $C^\star_G(\mathbb{A})=C^\star_{G/e}(\mathbb{A})-C^\star_{G-e}(\mathbb{A})$.

Since the formulas depend only on size of $\mathbb{A}$, the equality $C^\star_G(\mathbb{A}')=C^\star_G(\mathbb{A})$ whenever $|\mathbb{A}'|=|\mathbb{A}|$ follows
easily by induction on the number of edges of $G$.
\end{proof}

In view of Lemma~\ref{lemma:count}, let us for a multigraph $G$ and a positive integer $k$ define
$C^\star_G(k)$ as the number of nowhere-zero $\mathbb{A}$-flows in $G$ for any abelian group $\mathbb{A}$ of size $k$.
Note that if $G$ has no edges, then $C^\star_G(k)=1$, if $G$ has a loop $e$, then $C^\star_G(k)=(k-1)C^\star_{G-e}(k)$,
and if $e\in E(G)$ is not a loop, then $C^\star_G(k)=C^\star_{G/e}(k)-C^\star_{G-e}(k)$.  By induction, it is easy to
see that $C^\star_G$ is a polynomial in $k$, called the \emph{flow polynomial} of $G$.  The degree of $C^\star_G$
is at most $|E(G)|$; and in particular, numbers of nowhere-zero $\mathbb{Z}_k$-flows in $G$ for $1\le k\le |E(G)|$
determine the number of nowhere-zero $\mathbb{A}$-flows for any finite abelian group $\mathbb{A}$.

The dual concept corresponding to (and pre-dating) the flow polynomial is the \emph{chromatic polynomial} $C_G(k)$,
defined as the number of proper colorings of $G$ using colors $[k]$.  That $C_G$ is indeed a polynomial is clear by
induction from the following deletion-contraction formula to determine $C_G(k)$.
\begin{lemma}\label{lemma:delcon}
Let $k$ be a positive integer and let $G$ be a graph.  If $G$ has no edges, then $C_G(k)=k^{|V(G)}$.
If $e$ is a loop in $G$, then $C_G(k)=0$.  If $e$ is a non-loop edge of $G$, then
$C_G(k)=C_{G-e}(k)-C_{G/e}(k)$.
\end{lemma}
\begin{proof}
The first two claims are trivial.  For the last one, it suffices to note that proper $k$-colorings of $G$
are exactly those of the proper $k$-colorings of $G-e$ in which the ends of $e$ have different colors,
and that $C_{G/e}(k)$ counts the number of proper $k$-colorings of $G-e$ in which the ends of $e$ have the same color.
\end{proof}
Let us remark that since the polynomials $C_G$, $C_{G-e}$, and $C_{G/e}$ satisfy the deletion-contraction
equality from Lemma~\ref{lemma:delcon} for all positive integers $k$, we have $C_G=C_{G-e}-C_{G/e}$ as an identity for
the polynomials (and in particular, the identity also holds for all real numbers $k$).
Both the flow polynomial and the chromatic polynomial are specializations of
a more general Tutte polynomial~\cite{tutteflow}, which encompasses all graph parameters defined via deletion-contraction formulas
analogous to Lemmas~\ref{lemma:count} and \ref{lemma:flowtocolor}.

Note that by Lemma~\ref{lemma:flowtocolor}, we have the following.
\begin{corollary}
If $G$ is a plane connected graph, then
$$C_G(k)=kC^\star_{G^\star}(k).$$
\end{corollary}

Let us also note the following fact which often simplifies computation of the chromatic polynomial.
\begin{lemma}\label{lemma:chrmult}
If $G_1$ and $G_2$ are induced subgraphs of $G$ such that $G=G_1\cup G_2$
and $G_1\cap G_2$ is a clique with $m$ vertices, then
$$C_G(x)=\frac{C_{G_1}(x)C_{G_2}(x)}{x(x-1)\ldots (x-m+1)}.$$
In particular, if $G_1$ is a connected component of $G$ and $G_2=G-V(G_1)$ (so that $m=0$), then $C_G=C_{G_1}C_{G_2}$.
\end{lemma}
\begin{proof}
It suffices to prove the equality in the case $x$ is a positive integer; but then the equality just corresponds
to the fact that any pair of colorings of $G_1$ and $G_2$ by $x$ colors which match on $V(G_1\cap G_2)$ gives a coloring of $G$ by $x$ colors,
and vice versa.
\end{proof}

Chromatic polynomial was first suggested by Birkhoff as a means to prove the Four Color Theorem, conjecturing
that for any planar graph $G$, all real roots of $C_G$ are smaller than $4$.  While this approach appears promising
(it might enable one to use tools from the rich algebraic and analytic theory of polynomials),
this conjecture is still open.  Nevertheless, chromatic polynomial motivated further developments in algebraic
graph theory.  In particular, a number of intriguing results regarding the properties of the chromatic polynomial were found.  As a flavor,
let us show an identity for the chromatic polynomial at $\phi+1$, where $\phi=\frac{1+\sqrt{5}}{2}$
is the golden ratio.

\begin{lemma}\label{lemma:tutte}
Let $G$ be a plane multigraph and let $K=v_1v_2v_3v_4$ be a $4$-cycle in $G$ such that the open disk bounded by $K$
contains only the edge $v_1v_3$.  Let $G'=G-v_1v_3+v_2v_4$.  Then
$$C_G(\phi+1)+C_{G'}(\phi+1)=\phi^{-3}(C_{G/v_1v_3}(\phi+1)+C_{G'/v_2v_4}(\phi+1)).$$
\end{lemma}
\begin{proof}
We prove the claim by induction on $|V(G)|+|E(G)|$.  Clearly, we can assume that $G$ has no loops, as then
all the terms in the identity are $0$, and that $G$ has no isolated vertices, since removing them just multiplies all terms
in the identity by $(\phi+1)^{-1}$.
If $G$ has an edge $e$ with at most one end in $V(K)$, then the identity follows by the deletion-contraction formula, linearity,
and the induction hypothesis applied to $G-e$ and $G/e$.  Hence, it suffices to establish the base case when $V(G)=V(K)$.
Suppressing any parallel edges except for one edge parallel to $v_1v_3$ (if any) does not affect the values of the terms in the
identity.  Hence, we only need to consider three cases: in addition to $K+v_1v_3$, $G$ has no further edges, an edge $v_2v_4$, or an edge parallel to $v_1v_3$.

In the first case, $G$ and $G'$ are isomorphic and both $G/v_1v_3$ and $G'/v_2v_4$ are $3$-vertex paths with duplicated edges.
Hence, it suffices to verify that in this case $C_G(\phi+1)=\phi^{-3}C_{G/v_1v_3}(\phi+1)$.  Indeed, $C_G(x)=x(x-1)(x-2)^2$ and
$C_{G/v_1v_3}(x)=x(x-1)^2$, and thus
$$\frac{C_{G/v_1v_3}(\phi+1)}{C_G(\phi+1)}=\frac{\phi}{(\phi-1)^2}=\phi^3,$$
since $(\phi-1)^{-1}=\phi$.

In the latter two cases, one of $G$ and $G'$ is $K_4$ and the other one is the $4$-cycle $K$ tohether with a double edge joining vertices opposite on $K$,
and one of $G/v_1v_3$ and $G'/v_2v_4$ is a triangle with two double edges and the other one contains a loop.
The chromatic polynomials of these four graphs are $x(x-1)(x-2)(x-3)$, $x(x-1)(x-2)^2$, $x(x-1)(x-2)$, and $0$, respectively.  Hence, the identity holds, since
$$\frac{(C_{G/v_1v_3}(\phi+1)+C_{G'/v_2v_4}(\phi+1)}{C_G(\phi+1)+C_{G'}(\phi+1)}=\frac{1}{2\phi-3}=\phi^3.$$
\end{proof}

Note that the deletion-contraction formula in general implies
\begin{equation}\label{eq:delconcon}
C_G+C_{G/v_1v_3}=C_{G-v_1v_3}=C_{G'-v_2v_4}=C_{G'}+C_{G'/v_2v_4}.
\end{equation}
Combining these two identities
and using the facts that $\frac{1}{2}(\phi^{-3}+1)=\phi^{-1}$ and $\frac{1}{2}(\phi^{-3}-1)=-\phi^{-2}$,
we obtain a simpler formula for the value at $\phi+1$.

\begin{corollary}\label{cor:tutte}
Let $G$ be a plane multigraph and let $K=v_1v_2v_3v_4$ be a $4$-cycle in $G$ such that the open disk bounded by $K$
contains only the edge $v_1v_3$.  Let $G'=G-v_1v_3+v_2v_4$.  Then
$$C_G(\phi+1)=\phi^{-1}C_{G'/v_2v_4}(\phi+1)-\phi^{-2}C_{G/v_1v_3}(\phi+1).$$
\end{corollary}

Using this formula, we can inductively prove the amazing Golden Identity of Tutte.
\begin{theorem}\label{thm:golden}
Let $G$ be a multigraph triangulating the plane, with $n$ vertices.  Then
$$C_G(\phi+2)=(\phi+2)\phi^{3n-10}C^2_G(\phi+1).$$
\end{theorem}
\begin{proof}
Write $G_1\prec G_2$ if $G_1$ has fewer edges than $G_2$, or if both have the same number of edges and $G_1$ has larger
maximum degree.  We prove the claim by induction, assuming as the induction hypothesis that the claim holds for
all graphs $G_1$ such that $G_1\prec G$.

If $G$ contains a loop, then both sides of the identity are $0$.  Suppose $G$ contains a parallel edge forming a $2$-cycle $Q$.
Let $G_1$ and $G_2$ be obtained from the subgraphs drawn in the closed interior and exterior of $Q$ by suppressing their $2$-face bounded by $Q$.
By Lemma~\ref{lemma:chrmult}, the induction hypothesis, and the fact that $\phi+1=\phi^2$, we have
\begin{align*}
C_G(\phi+2)&=\frac{C_{G_1}(\phi+2)C_{G_2}(\phi+2}{(\phi+2)(\phi+1)}\\
&=\frac{(\phi+2)^2\phi^{3n-14}(C_{G_1}(\phi+1)C_{G_2}(\phi+1))^2}{(\phi+2)(\phi+1)}\\
&=\frac{(\phi+2)\phi^{3n-14}((\phi+1)\phi C_G(\phi+1))^2}{\phi+1}\\
&=(\phi+2)\phi^{3n-12}(\phi+1) C^2_G(\phi+1)\\
&=(\phi+2)\phi^{3n-10}C^2_G(\phi+1),
\end{align*}
as required.

Similarly, if $G$ contains a separating triangle $Q$, then letting $G_1$ and $G_2$ be the subgraphs
drawn in the closed interior and exterior of $Q$,
Lemma~\ref{lemma:chrmult} and the induction hypothesis, and the fact that $(\phi+1)(\phi-1)^2=1$ implies
\begin{align*}
C_G(\phi+2)&=\frac{C_{G_1}(\phi+2)C_{G_2}(\phi+2}{(\phi+2)(\phi+1)\phi}\\
&=\frac{(\phi+2)^2\phi^{3n-11}(C_{G_1}(\phi+1)C_{G_2}(\phi+1))^2}{(\phi+2)(\phi+1)\phi}\\
&=\frac{(\phi+2)\phi^{3n-12}((\phi+1)\phi(\phi-1) C_G(\phi+1))^2}{\phi+1}\\
&=(\phi+2)\phi^{3n-10}(\phi+1)(\phi-1)^2 C^2_G(\phi+1)\\
&=(\phi+2)\phi^{3n-10}C^2_G(\phi+1),
\end{align*}
as required.

Hence, we can assume that $G$ is simple and contains no separating triangles.  If $|V(G)|\le 4$, then since $G$ is a triangulation,
we have $G=K_3$ or $G=K_4$; it is easy to verify that the identity holds both for $K_3$ and $K_4$.  Hence, suppose that $V(G)\ge 5$.
Let $v_2$ be the vertex of $G$ of maximum degree.
By the absence of separating triangles, the neigbors of $v_2$ form an induced cycle $Q$.  Let $v_1v_3$ be an edge of this cycle.  Since $|V(G)|\ge 5$
and $Q$ is an induced cycle, $v_1v_3$ is incident with a face $v_1v_4v_3$ such that $v_4\not\in \{v_2\}\cup V(Q)$.  Let $G'=G-v_1v_3+v_2v_4$.
Note that $G'$ has greater maximum degree than $G$, and thus $G'\prec G$.  Hence, by (\ref{eq:delconcon}), the induction hypothesis,
Corollary~\ref{cor:tutte} applied to $G'$, and one more application of Corollary~\ref{cor:tutte}, we have
\begin{align*}
\frac{C_G(\phi+2)}{(\phi+2)\phi^{3n-10}}&=\frac{C_{G'}(\phi+2)+C_{G'/v_2v_4}(\phi+2)-C_{G/v_1v_3}(\phi+2)}{(\phi+2)\phi^{3n-10}}\\
&=C^2_{G'}(\phi+1)+\phi^{-3}C^2_{G'/v_2v_4}(\phi+1)-\phi^{-3}C^2_{G/v_1v_3}(\phi+1)\\
&=(\phi^{-3}+\phi^{-4})C^2_{G'/v_2v_4}(\phi+1)+(\phi^{-2}-\phi^{-3})C^2_{G/v_1v_3}(\phi+1)-2\phi^{-3}C_{G'/v_2v_4}(\phi+1)C_{G/v_1v_3}(\phi+1)\\
&=\phi^{-2}C^2_{G'/v_2v_4}(\phi+1)+\phi^{-4})C^2_{G/v_1v_3}(\phi+1)-2\phi^{-3}C_{G'/v_2v_4}(\phi+1)C_{G/v_1v_3}(\phi+1)\\
&=(\phi^{-1}C_{G'/v_2v_4}(\phi+1)-\phi^{-2}C_{G/v_1v_3}(\phi+1))^2\\
&=C^2_G(\phi+1),
\end{align*}
as required.
\end{proof}

In addition to being quite surprising by itself, an interesting fact can be obtained from Theorem~\ref{thm:golden} using the following
observation.
\begin{lemma}\label{lemma:noroot}
If $G$ is connected multigraph with $n$ vertices and no loops, then for any real number $x$ such that $0<x<1$
we have $(-1)^{n-1}C_G(x)>0$.
\end{lemma}
\begin{proof}
We prove the claim by induction on the number of edges of $G$.  Without loss of generality, $G$ does not contain parallel edges.
If $G$ is a tree, then $C_G(x)=x(x-1)^{n-1}$, and $(-1)^{n-1}C_G(x)=x(1-x)^{n-1}>0$.  Hence, we can assume that
$G$ has an edge $e$ whose removal does not disconnect $G$.  By the deletion-contraction formula and induction hypothesis,
we have
$$(-1)^{n-1}C_G(x)=(-1)^{n-1}(C_{G-e}(x)-C_{G/e}(x))=(-1)^{n-1}C_{G-e}(x)+(-1)^{n-2}C_{G/e}(x)>0,$$
as required.
\end{proof}
In particular, $(3-\sqrt{5})/2$ is not a root of any non-trivial chromatic polynomial.  Since chromatic polynomials have integer coefficients,
its Galois conjugate $(3+\sqrt{5})/2=\phi+1$ is not a root of any such polynomial, either.  Theorem~\ref{thm:golden} thus implies that
$\phi+2\approx 3.62$ is not a root of the chromatic polynomial of any plane triangulation.  If one could somehow ``push up'' this claim to $4$,
this would prove the Four Color Theorem!  Note however that there are plane triangulations whose chromatic polynomials have roots
arbitrarily close to four~\cite{royle2008planar}.

\subsection{Chromatic polynomial and the number of colorings}

The deletion-contraction formula from Lemma~\ref{lemma:delcon} involves subtraction of two terms; as such, it
is ill suited to give bounds on numbers of colorings.  Let us now give a formula that is more convenient from
this point of view.

\begin{lemma}\label{lemma:chrpos}
Let $v$ be a vertex of degree $d$ in a graph $G$, and let $N$ be the set of edges incident with $v$,
none of which is a loop.  For $X\subseteq N$,
let $G/X$ denote the graph obtained from $G$ by contracting all edges in $X$.  Then
$$C_G(k)=(k-d)C_{G-v}(k)+\sum_{\emptyset\neq X\subseteq N}^d (|X|-1)C_{G/X}(k).$$
\end{lemma}
\begin{proof}
It suffices to prove this formula when $k$ is a positive integer.  Consider any $k$-coloring $\varphi$ of $G-v$,
and let $A_1$, \ldots, $A_t$ be the partition of $N$ according to the colors of the endvertices of edges of $N$ in this coloring.
For non-empty $X\subseteq N$, we say that $\varphi$ contributes to colorings of $G/X$ if $X$ is one of $A_1$, \ldots, $A_t$.
Observe that $\varphi$ contributes to colorings of $G/X$ if and only if there exists a $k$-coloring $\psi$ $G/X$
such that $\varphi$ is obtained from $\psi$ by giving all vertices incident with $X$ the color of the vertex resulting
from the contraction of the edges of $X$.  Consequently, $C_{G/X}(k)$ is equal to the number of $k$-colorings of $G-v$
that contribute to colorings of $G/X$.

With the notation as in the previous paragraph, $\varphi$ contributes to colorings of $G/A_1$, \ldots, $G/A_t$,
and thus it contributes $(k-d)+(|A_1|-1)+\ldots+(|A_t|-1)=(k-d)+(d-t)=k-t$ to the right-hand side of the identity
from the statement of the lemma.  However, $\varphi$ also can be extended to a proper $k$-coloring of $G$ in exactly
$k-t$ ways, by giving $v$ a color different from the colors of vertices incident with $A_1$, \ldots, $A_t$.
Hence, $\varphi$ also contributes exactly $k-t$ to the left-hand side of the identity.
\end{proof}

The following consequence of Lemma~\ref{lemma:chrpos} can be easily proved by induction.
\begin{corollary}\label{cor:nonnegdeg}
If $G$ is a $d$-degenerate graph, then $C_G(k)\ge 0$ for all real numbers $k\ge d$.
\end{corollary}

Using the identity, we can also give the following lower bound on the chromatic polynomial of planar graphs,
due to Birkhoff and Lewis~\cite{birkhoff1946chromatic}.
\begin{theorem}\label{thm:birlew}
If $G$ is a planar graph with $n$ vertices, then
$$C_G(k)\ge k(k-1)(k-2)(k-3)^{n-3}$$
for all real numbers $k\ge 5$.
\end{theorem}
\begin{proof}
We prove the claim by induction on the number of vertices of $G$.  If $G$ contains a separating triangle,
then let $G_1$ and $G_2$ be proper induced subgraphs of $G$ such that $G=G_1\cup G_2$ and $G_1$ intersects
$G_2$ in a triangle.  By Lemma~\ref{lemma:chrmult} and the induction hypothesis, letting $n_1$ and $n_2$ denote
the numbers of vertices of $G_1$ and $G_2$, we have
\begin{align*}
C_G(k)&=\frac{C_{G_1}(k)C_{G_2}(k)}{k(k-1)(k-2)}\\
&\ge \frac{k(k-1)(k-2)(k-3)^{n_1-3}k(k-1)(k-2)(k-3)^{n_2-3}}{k(k-1)(k-2)}\\
&=k(k-1)(k-2)(k-3)^{n_1+n_2-6}=k(k-1)(k-2)(k-3)^{n-3},
\end{align*}
as required.  Hence, we can assume $G$ contains no separating triangles.

Since $G$ is planar, it contains a vertex $v$ of degree $d\in\{3,4,5\}$.  Let $e_1$, \ldots, $e_d$
be the edges incident with $v$ according to their cyclic ordering around $v$ in a plane drawing of $G$,
and let $v_1$, \ldots, $v_d$ be their endpoints different from $v$.
If $d=3$,
then by Lemma~\ref{lemma:chrpos} and the induction hypothesis, we have
$$C_G(k)\ge (k-3)C_{G-v}(k)\ge (k-3)k(k-1)(k-2)(k-3)^{n-4}=k(k-1)(k-2)(k-3)^{n-3}.$$
Suppose now that $d=4$, then since $G$ does not contain separating triangles, $v_i$ is not adjacent to $v_{i+2}$,
for $i\in\{1,2\}$.  Hence, letting $X_i=\{e_i,e_{i+2}\}$, the graph $G/X_i$ is loopless, and thus we can
apply induction hypothesis to it.  Also, by the deletion-contraction formula and the induction hypothesis,
$C_{G-v}(k)=C_{G-v+v_1v_3}(k)+C_{G-v+v_1v_3/v_1v_3}(k)\ge k(k-1)(k-2)[(k-3)^{n-4}+(k-3)^{n-5}]$.
By Lemma~\ref{lemma:chrpos}, we have
\begin{align*}
\frac{C_G(k)}{k(k-1)(k-2)}&\ge \frac{(k-4)C_{G-v}(k)+C_{G/X_1}(k)+C_{G/X_2}(k)}{k(k-1)(k-2)}\\
&\ge (k-4)[(k-3)^{n-4}+(k-3)^{n-5}]+2(k-3)^{n-5}\\
&=[(k-4)(k-3)+k-2](k-3)^{n-5}\\
&=\frac{k^2-6k+10}{k^2-6k+9}(k-3)^{n-3}>(k-3)^{n-3}.
\end{align*}
Finally, suppose that $d=5$.  By the absence of separating triangles, $v_i$ is not adjacent to $v_{i+2}$
for $i\in\{1,\ldots,5\}$, where $v_6=v_1$ and $v_7=v_2$.  Let $X_i=\{e_i,e_{i+2}$.
Applying twice the deletion-contraction formula and using the induction hypothesis,
we have
\begin{align*}
C_{G-v}(k)&=C_{G-v+v_1v_3}(k)+C_{G-v+v_1v_3/v_1v_3}(k)\\
&=C_{G-v+v_1v_3+v_1v_4}(k)+C_{G-v+v_1v_3+v_1v_4/v_1v_4}(k)+C_{G-v+v_1v_3/v_1v_3}(k)\\
&\ge k(k-1)(k-2)[(k-3)^{n-4}+2(k-3)^{n-5}].
\end{align*}
By Lemma~\ref{lemma:chrpos}, we have
\begin{align*}
\frac{C_G(k)}{k(k-1)(k-2)}&\ge \frac{(k-5)C_{G-v}(k)+\sum_{i=1}^5C_{G/X_i}(k)}{k(k-1)(k-2)}\\
&\ge (k-5)[(k-3)^{n-4}+2(k-3)^{n-5}]+5(k-3)^{n-5}\\
&=[(k-5)(k-3)+2k-5](k-3)^{n-5}\\
&=\frac{k^2-6k+10}{k^2-6k+9}(k-3)^{n-3}>(k-3)^{n-3}.
\end{align*}
\end{proof}
Birkhoff and Lewis conjectured that this inequality in fact holds for all $k\ge 4$, which would imply the Four Color Theorem.
The bound is tight for planar triangulations obtained from $K_3$ by repeatedly subdividing any face into three by adding a new vertex
of degree three.  For $k=5$, Theorem~\ref{thm:birlew} states that every planar graph has at least $60\cdot 2^{n-3}$ distinct $5$-colorings;
this significantly improves our previous bounds from Theorems~\ref{theorem:planar5many} and \ref{thm:num5col}.

\section{Integer flows}

So far, we mostly developed the theory of nowhere-zero flows over finite groups, and indeed, this is generally
the most convenient setting.  Nevertheless, in some cases it is worthwhile to consider an alternative approach
via integer flows with bounded range of values.  For a positive integer $k$, consider a proper $k$-coloring $\varphi:V(G)\to [k]$
of a plane connected multigraph $G$, and let $f$ be the derived nowhere-zero $\mathbb{Z}$-flow in the dual of $G$.
Then, all values of $f$ are $\pm 1$, \ldots, $\pm (k-1)$.

Motivated by this observation, let us say that a $\mathbb{Z}$-flow is a \emph{$k$-flow} if all its values are at most $k-1$ in absolute value.
If $f$ is a (nowhere-zero) $k$-flow, we can interpret its values as elements of $\mathbb{Z}_k$, and thus $f$ can also be viewed as a (nowhere-zero)
$\mathbb{Z}_k$-flow.  Together with Lemma~\ref{lemma:flowtocolor} and the argument from the previous paragraph,
we have the following.
\begin{observation}\label{obs:flowcol}
For any positive integer $k$, a connected plane multigraph has a proper $k$-coloring if and only if its dual has a nowhere-zero $k$-flow.
\end{observation}
As a consequence, a planar graph has a nowhere-zero $k$-flow if and only if it has a nowhere-zero $\mathbb{Z}_k$-flow.
A slightly more involved argument shows that this is true in general graphs as well.

\begin{lemma}
Let $G$ be a multigraph and let $k$ be a positive integer.  For every $\mathbb{Z}_k$-flow $f_0$ in $G$, there exists
a $k$-flow $f_1$ in $G$ such that $f_1(e)\bmod k=f_0(e)$ for every $e\in E(\ovlr{G})$.  In particular, if $f_0$ is nowhere-zero,
then $f_1$ is nowhere-zero as well.
\end{lemma}
\begin{proof}
Let $\vec{G}$ be an arbitrary orientation of $G$, and for each directed edge $e\in E(\vec{G})$, let
$f'_1(e)=f_0(e)$, where the values of $f_0$ are interpreted as integers from $\{0,1,\ldots, k-1\}$.
For $v\in V(G)$, let us define
$$r'(v)=\sum_{e\in E^+_{\vec{G}}(v)} f'_1(e)-\sum_{e\in E^-_{\vec{G}}(v)} f'_1(e),$$
denoting the excess of the amount leaving $v$ over the one entering $v$.
Note that $r'(v)$ is divisible by $k$, since $f_0$ is a $\mathbb{Z}_k$-flow.
Let $r(v)=r'(v)/k$.

Let $\vec{H}$ be the spanning subgraph of $\vec{G}$ with $E(\vec{H})=\{e\in E(\vec{G}): f_0(e)\neq 0\}$.
Consider any set $S\subseteq V(\vec{H})$, and let $E^-(S)$ and $E^+(S)$ be the sets of edges of $\vec{H}$ entering
and leaving $S$, respectively.  We have
\begin{align*}
\sum_{v\in S} r(S)&=\frac{1}{k}\sum_{v\in S}\left(\sum_{e\in E^+_{\vec{G}}(v)} f'_1(e)-\sum_{e\in E^-_{\vec{G}}(v)} f'_1(e)\right)
&=\frac{1}{k}\left(\sum_{e\in E^+(S)} f'_1(e)-\sum_{e\in E^-(S)} f'_1(e)\right),
\end{align*}
since the contributions of the edges between vertices of $S$ cancel out and the values on edges of $E(\vec{G})\setminus E(\vec{H})$
leaving or entering $S$ are $0$.  Since $0<f'_1(e)<k$ for all $e\in E(\vec{H})$,
we conclude that
\begin{equation}\label{eq:bigcut}
-|E^-(S)|\le \sum_{v\in S} r(S)\le |E^+(S)|.
\end{equation}
Let us give each edge of $\vec{H}$ capacity $1$ and each vertex $v$ of $\vec{H}$ demand $r(v)$.
Since (\ref{eq:bigcut}) holds for all sets $S\subseteq V(\vec{H})$, we conclude from the max-flow min-cut theorem
that there exists an integral flow in $\vec{H}$ satisfying all the demands: a function $f''_1:E(\vec{H})\to\{0,1\}$ such that
$$\sum_{e\in E^+_{\vec{H}}(v)} f''_1(e)-\sum_{e\in E^-_{\vec{H}}(v)} f''_1(e)=r(v)$$
for all $v\in V(\vec{H})$.  Let us extend $f''_1$ to $\vec{G}$ by setting $f''_1(e)=0$ for all $e\in E(\vec{G})\setminus E(\vec{H})$.

Now, we can define $f_1(e)=f'_1(e)-kf''_1(e)$ for all $e\in E(\vec{G})$.  By the choice of $f''_1$, we conclude that $f_1$ is a $\mathbb{Z}$-flow
in $G$, and clearly $f_1(e)\bmod k = f'_1(e)\bmod k=f_0(e)$ for all $e\in E(\vec{G})$.  Furthermore, since $f''_1(e)\in \{0,1\}$
and $f''_1(e)$ can be non-zero only when $f'_1(e)\ge 1$, we conclude that $f_1(e)\ge -(k-1)$, and thus $f_1$ is a $k$-flow.
\end{proof}

Note that if $k'\le k$, then a $k'$-flow is also a $k$-flow.  Hence, we get the following consequence, which is not easy to see
directly.
\begin{corollary}\label{cor:sizeflow}
If $\mathbb{A}'$ and $\mathbb{A}$ are two finite abelian groups, $|\mathbb{A}'|\le |\mathbb{A}|$, and
a multigraph $G$ has a nowhere-zero $\mathbb{A}'$-flow, then $G$ also has a nowhere-zero $\mathbb{A}$-flow.
\end{corollary}

\section{Basic results on existence of nowhere-zero flows}\label{sec:basicflow}

It is easy to decide whether a graph has a nowhere-zero $\mathbb{Z}_2$-flow, based on the following observation.
\begin{observation}\label{obs:euler}
If $G$ is an Eulerian graph and $a$ is any element of an abelian group $\mathbb{A}$, then $G$ has a $\mathbb{A}$-flow
using only values $a$ and $-a$.  Conversely, if $G$ has a nowhere-zero $\mathbb{Z}_2$-flow, then $G$ is Eulerian.
\end{observation}
\begin{proof}
If $G$ is Eulerian, then each component of $G$ contains a closed walk that passes through each edge exactly once.
Orienting the edges of $G$ along these walks and assigning to each of them the value $a$
gives a $\mathbb{A}$-flow in $G$.

A nowhere-zero $\mathbb{Z}_2$-flow necessarily assigns value $1$ to each edge of $G$, the flow conservation law
thus implies that all vertices of $G$ have even degree, and thus $G$ is Eulerian.
\end{proof}

In general, it is hard to decide whether a given graph has a nowhere-zero $\mathbb{A}$-flow for a fixed
non-trivial finite abelian group $\mathbb{A}\neq \mathbb{Z}_2$.  However, there are a number of results that are helpful in particular cases.
Let us start with a basic observation about edge-cuts.  If $f$ is a flow in a multigraph $G$ and $S\subseteq V(G)$,
let us define $$f(S)=\sum_{e=uv\in E(\ovlr{G}),u\in S,v\not\in S} f(e).$$

\begin{observation}\label{obs:flowoncut}
Let $\mathbb{A}$ be an abelian group, $G$ a multigraph, and $S\subseteq V(G)$ a set of its vertices.  For any function
$f:E(\ovlr{G})\to\mathbb{A}$ such that $f(\ovl{e})+f(\ovr{e})=0$ for all $e\in E(G)$,
if the conservation law (\ref{eq:conserve-alt}) is satisfied for all $v\in S$, then $f(S)=0$.
\end{observation}
\begin{proof}
Note that
$$f(S)=\sum_{u\in S}\sum_{e\in E^+(u)} f(e)=0,$$
where the first equality holds since if an edge $uv$ has both ends in $S$, then the sum contains
terms $f(uv)$ and $f(vu)=-f(uv)$ which cancel each other, leaving only the terms
from the sum in the definition of $f(S)$.
\end{proof}

\begin{corollary}\label{cor:smallcutflow}
Let $\mathbb{A}$ be an abelian group and let $G$ be a multigraph.  If $G$ has a nowhere-zero $\mathbb{A}$-flow $f$,
then $G$ is bridgeless.  Furthermore, if $C=\{e_1,e_2\}$ is a $2$-edge-cut in $G$, where $e_1=u_1v_1$ and $e_2=u_2v_2$
labelled so that $u_1$ and $u_2$ are in the same component of $G-C$, then $f(e_1)=-f(e_2)$.
\end{corollary}
\begin{proof}
If $G$ had a bridge $e$, then there would exist a set $S\subset V(G)$ such that $e$ is the only edge with one end in $S$ and
the other end outside of $S$, and $f(e)=f(S)=0$ by Observation\ref{obs:flowoncut}, contradicting the assumption
that $f$ is nowhere-zero.

In the case of a $2$-edge-cut, let $S$ be the vertex set of the component of $G-C$ containing $u_1$ and $u_2$.
We have $f(e_1)+f(e_2)=f(S)=0$ by Observation\ref{obs:flowoncut}, which implies $f(e_1)=-f(e_2)$.
\end{proof}

Another consequence of the cut condition is that flows are preserved by vertex identification.
\begin{corollary}\label{cor:contractflow}
Let $\mathbb{A}$ be an abelian group and let $G$ be a multigraph.  Let $\mathcal{P}=\{P_1,\ldots, P_k\}$ be a partition
of the vertex set of $G$, and let $G'$ be the multigraph obtained from $G$ by identifying the vertices in each part $P_i$ of $\mathcal{P}$
to a single vertex $p_i$.  If $G$ has a nowhere-zero $\mathbb{A}$-flow, then $G'$ has a nowhere-zero $\mathbb{A}$-flow as well.
\end{corollary}
\begin{proof}
Note that the edges of $G'$ are in one-to-one correspondence with the edges of $G$.  For a nowhere-zero flow $f$ in $G$
and every $e'\in E(G')$, let us define $f'(e)=f(e)$, where $e$ is the edge of $G$ corresponding to $e'$.  Then
$f'$ is a nowhere-zero $\mathbb{A}$-flow in $G'$, since Observation~\ref{obs:flowoncut} applied to $P_i$ for $i=1,\ldots, k$
implies the flow conservation law at the vertex $p_i$ of $G'$.
\end{proof}

Corollary~\ref{cor:contractflow} is often used to eliminate vertices of large degree: given a graph $G'$, a vertex $p$ of $G'$
can be replaced by an arbitrary subgraph with vertex set $P$, distributing the edges incident with $p$ among the vertices of $P$
arbitrarily.  Corollary~\ref{cor:contractflow} then implies that it suffices to find a nowhere-zero $\mathbb{A}$-flow in the resulting
graph.

Converse oparation (contracting a set of vertices $S$ and deriving a nowhere-zero $\mathbb{A}$-flow in the original graph $G$ from the one
in the contracted graph) is also sometimes used, but one needs to be more careful---if $G[S]$ is connected, then it is always possible
to extend the flow so that the conservation law holds at vertices of $S$, but it may not necessarily be possible to do so in such a way
that the resulting flow is nowhere-zero.  The following special case is often used to increase connectivity.
\begin{lemma}\label{lemma:contr2ecflow}
Let $\mathbb{A}$ be an abelian group and let $G$ be a multigraph.  Let $e$ be an edge of $G$ contained in a $2$-edge-cut.
Then $G$ has a nowhere-zero $\mathbb{A}$-flow if and only if $G/e$ does.
\end{lemma}
\begin{proof}
By Corollary~\ref{cor:contractflow}, if $G$ has a nowhere-zero $\mathbb{A}$-flow, then so does $G/e$.

Conversely, suppose $f$ is a nowhere-zero $\mathbb{A}$-flow in $G/e$.  Let $e=uv$ and let $e'=u'v'$ be the other edge of a $2$-edge-cut
containing $e$, labelled so that $u$ and $u'$ are in the same component $S$ of $G-\{e,e'\}$.  Let us extend $f$ to $G$
by setting $f(e)=-f(e')$, so that $f(V(S))=0$.
Note that the flow conservation law holds at all vertices except possibly for $u$ and $v$.
Furthermore, since $f(V(S))=0$ and the flow conservation law holds at all vertices of $V(S)$ except possibly for $u$,
we conclude analogously to Observation~\ref{obs:flowoncut} that the flow conservation law holds also at $u$.  A symmetrical
argument shows that the flow conservation law holds at $v$.  Hence, $f$ is a nowhere-zero $\mathbb{A}$-flow in $G$.
\end{proof}

Another operation which is often useful is \emph{lifting} edges incident with a vertex.  If $e_1=uv$ and $e_2=vw$ are distinct edges
in a multigraph $G$ and $G'$ is obtained from $G-\{e_1,e_2\}$ by adding an edge joining $u$ and $w$, we say that $G'$ is obtained
from $G$ by \emph{lifting the edges $e_1$ and $e_2$ at $v$}.  Clearly, if $G'$ contains a nowhere-zero $\mathbb{A}$-flow,
then $G$ contains one as well, obtained by sending the flow of $e$ over edges $e_1$ and $e_2$ instead.
The following result of Mader~\cite{mader} is of particular importance in this context.
\begin{lemma}[Mader~\cite{mader}]\label{lemma:mader}
Let $k\ge 3$ be an integer.  If $G$ is $k$-edge-connected multigraph and a vertex $v\in V(G)$ has
degree at least $k+2$, then there exist edges incident with $v$ whose lifting results in a $k$-edge-connected graph.
\end{lemma}

For a flow $f$, the \emph{support} of $f$ is the set of edges on that it is non-zero.
The following fact is very useful when constructing nowhere-zero flows over products of groups (which often can be assumed due to Corollary~\ref{cor:sizeflow}).
\begin{observation}\label{obs:prodflow}
Let $\mathbb{A}=\mathbb{A}_1\times \cdots\times \mathbb{A}_k$ be an abelian group.
For $i=1,\ldots, k$, let $f_i$ be an $\mathbb{A}_i$-flow in a multigraph $G$.
Let $f(e)=(f_1(e),\ldots,f_k(e))$ for each edge $e\in E(G)$.  Then $f$ is an $\mathbb{A}$-flow in $G$,
and if the union of supports of $f_1$, \ldots, $f_k$ is $E(G)$, then $f$ is nowhere-zero.
\end{observation}

This observation is often used in conjuction with the following construction of flows with large support.

\begin{lemma}\label{lemma:treecomplflow}
Let $G$ be a connected multigraph and let $T$ be a spanning tree of $G$.  Let $\mathbb{A}$ be a non-trivial abelian group
and let $f$ be an arbitrary function assigning elements of $\mathbb{A}$ to directed edges of $E(G)\setminus E(T)$.
Then $f$ can be extended to an $\mathbb{A}$-flow in $G$.  In particular, $G$ has an $\mathbb{A}$-flow whose support
contains all edges of $G$ not belonging to $T$.
\end{lemma}
\begin{proof}
We prove the following stronger claim:  Let $T\subseteq G$ be a tree, and let $f$ be an arbitrary function assigning elements of
$\mathbb{A}$ to directed edges of $E(G)\setminus E(T)$, such that the flow conservation law holds at all vertices of $V(G)\setminus V(T)$.
Then $f$ can be extended to an $\mathbb{A}$-flow in $G$.

The claim is proved by induction on the number of vertices of $T$.  If $T$ has only one vertex $v$, then $f$ is already defined
on all edges of $G$ and satisfies the flow conservation law at all vertices of $G$ other than $v$ by the assumptions.
However, then $f$ also satisfies the flow conservation law at $v$ (by Observation~\ref{obs:flowoncut} applied to $S=V(G)\setminus\{v\}$,
noting that $f(\{v\})$ is equal to $-f(S)$).

If $|V(T)|\ge 2$, then $T$ has a leaf $u$ incident with a unique edge $e_0=uw\in E(T)$.  Let us set
$$f(e_0)=-\sum_{e\in E^+_{\ovlr{G}}(u), e\neq e_0} f(e),$$
so that the flow conservation law is satisfied at $u$.  The claim then follows by the induction hypothesis applied to $T-u$.
\end{proof}

In particular, Observation~\ref{obs:prodflow} can be applied to construct a nowhere-zero flow from two flows obtained using
Lemma~\ref{lemma:treecomplflow} for edge-disjoint spanning trees.  Existence of such trees is guaranteed by the following
well-known connectivity condition, which is a corollary of a stronger theorem of Nash-Williams~\cite{nashwil}.

\begin{theorem}\label{thm:disjspanning}
For every integer $k\ge 1$, each $2k$-edge-connected graph has $k$ pairwise edge-disjoint spanning trees.
\end{theorem}

\section{Tutte's Flow Conjectures}

The basic idea behing introduction of nowhere-zero flows is as follows: to prove that planar graphs
satisfying certain properties are $k$-colorable, show that graphs from some superclass of their duals
have a nowhere-zero $k$-flow.  One might hope the latter problem is easier to approach.
Along these lines, Tutte formulated several conjectures lifting coloring results and (at the time) open problems
in planar graphs to this more general setting.  While none of these conjectures has been resolved yet, there
has been a number of interesting partial results and they are nowadays recognized as some of the most influential
questions in graph theory.

Let us start with the most general one of these conjectures.
\begin{conjecture}[5-Flow Conjecture]
Every bridgeless multigraph has a nowhere-zero $5$-flow.
\end{conjecture}
By Observation~\ref{obs:flowcol}, the 5-Flow Conjecture would strenthen the well-known fact that all planar graphs
are $5$-colorable.  The assumption that $G$ is bridgeless is of course necessary by Corollary~\ref{cor:smallcutflow}.
Furthermore, by Lemma~\ref{lemma:z223col}, a cubic graph has a nowhere-zero $4$-flow only if it is $3$-edge-colorable.
In particular, the Petersen graph does not have a nowhere-zero $4$-flow, even though it is $3$-edge-connected,
and thus the bound in the 5-Flow Conjecture cannot be strengthened to $4$.

Nevertheless, Tutte also conjectured that increasing the edge connectivity to $4$ is sufficient to improve the bound.
\begin{conjecture}[3-Flow Conjecture]
Every $4$-edge-connected multigraph has a nowhere-zero $3$-flow.
\end{conjecture}
As argued above, the connectivity bound is tight.  Also, a plane connected graph is $4$-edge-connected if and only if
its dual does not contain any cycles of length at most three.  Hence, by Observation~\ref{obs:flowcol} the 3-Flow Conjecture
is a strengthening of Gr\"{o}tzsch' Theorem.  Note that by Lemma~\ref{lemma:mader}, it would suffice to prove the conjecture
for graphs of maximum degree at most $5$.

Finally, a condition for existence of a nowhere-zero $4$-flow would obviously be of interest with respect to the Four Color Theorem.
Tutte proposed the following conjecture.
\begin{conjecture}[4-Flow Conjecture]
Every bridgeless multigraph that does not contain the Petersen graph as a minor has a nowhere-zero $4$-flow.
\end{conjecture}
Since the Petersen graph is not planar, (duals of) plane graphs do not contain Petersen minors, and thus
the 4-Flow Conjecture strengthens the 4-color theorem.  Using Corollary~\ref{cor:contractflow}, it is easy to see that it would suffice
to prove the 5-Flow Conjecture for cubic graphs (see the proof of Theorem~\ref{thm:6flow} below for a more
detailed argument).  This is not the case for the 4-Flow Conjecture: replacing or splitting off vertices of large degree can create
a Petersen minor.  Nevertheless, the special case of cubic graphs is still interesting and strengthens the Four Color Theorem;
a rather involved proof has been obtained recently~\cite{flow431,flow432,flow433}.

To illustrate the difficulties in a possible full proof of the 4-Flow Conjecture, let us mention another special case,
where the graph contains a vertex $v$ such that $G-v$ is planar.  
It is easy to see that such a graph $G$ cannot contain the Petersen graph as a minor, since the Petersen graph minus one vertex is still non-planar.
Furthermore, vertices of $V(G)\setminus \{v\}$ of degree greater than three can be replaced by cycles of vertices of degree three while preserving the fact that $G-v$ is planar.
Hence, we can without loss of generality assume that all vertices of $G$ other than $v$ have degree three.
Analogously to Lemma~\ref{lemma:z223col}, one can show that $G$ has a nowhere-zero $\mathbb{Z}_2^2$-flow if and only if $G-v$ is $3$-edge-colorable.
Hence, this special case is equivalent to an old conjecture of Gr\"{o}tzsch which is also open.
\begin{conjecture}[Gr\"{o}tzsch' Conjecture]
A planar bridgeless graph $G$ of maximum degree at most three is $3$-edge-colorable if and only if no component of $G$ contains
exactly one vertex of degree two.
\end{conjecture}

All of the Tutte's flow conjectures are open, but we can at least prove some interesting weakenings of these
claims.  Let us start with some easy consequences of the tools introduced in Section~\ref{sec:basicflow}.

\begin{theorem}
Every $4$-edge-connected multigraph has a nowhere-zero $4$-flow.
\end{theorem}
\begin{proof}
Let $G$ be a $4$-edge-connected multigraph.  By Theorem~\ref{thm:disjspanning}, $G$ has two edge-disjoint spanning trees $T_1$ and $T_2$.
By Lemma~\ref{lemma:treecomplflow}, for $i\in\{1,2\}$ there exists a $\mathbb{Z}_2$-flow $f_i$ in $G_i$ whose support includes the complement of $T_i$.
Since $T_1$ and $T_2$ are edge-disjoint, the union of the supports of $f_1$ and $f_2$ is $E(G)$, and thus
$G$ has a nowhere-zero $\mathbb{Z}_2^2$-flow by Observation~\ref{obs:prodflow}.
\end{proof}

A similar argument shows existence of nowhere-zero $8$-flows in general bridgeless graphs.
\begin{theorem}\label{thm:8flow}
Every bridgeless multigraph $G$ has a nowhere-zero $8$-flow.
\end{theorem}
\begin{proof}
We prove by induction on the number of vertices of $G$ that $G$ has a nowhere-zero $\mathbb{Z}_2^3$-flow, the case $|V(G)|=1$ being trivial.
Clearly we can assume that $G$ is connected, and since it is bridgeless, it is $2$-edge-connected.
If $G$ is not $3$-edge-connected, then an edge $e$ of $G$ is contained in a $2$-edge-cut.
By the induction hypothesis, $G/e$ has a nowhere-zero $\mathbb{Z}_2^3$-flow, and thus $G$ has a nowhere-zero $\mathbb{Z}_2^3$-flow by
Lemma~\ref{lemma:contr2ecflow}.

Hence, we can assume that $G$ is $3$-edge-connected.  Let $G'$ be the multigraph obtained from $G$ by doubling each edge;
then $G'$ is $6$-edge-connected.  By Theorem~\ref{thm:disjspanning}, $G'$ has three pairwise edge-disjoint spanning trees,
and thus $G$ contains spanning trees $T_1$, $T_2$, and $T_3$ such that each edge of $G$ belongs to at most two of the trees.
By Lemma~\ref{lemma:treecomplflow}, for $i\in\{1,2,3\}$ there exists a $\mathbb{Z}_2$-flow $f_i$ in $G_i$ whose support includes the complement of $T_i$.
Since no edge of $G$ belongs to all of the trees $T_1$, $T_2$, and $T_3$, the union of the supports of $f_1$, $f_2$, and $f_3$ is $E(G)$.
Consequently, $G$ has a nowhere-zero $\mathbb{Z}_2^3$-flow by Observation~\ref{obs:prodflow}.
\end{proof}

Thomassen improved Theorem~\ref{thm:8flow}, showing that all bridgeless graphs have nowhere-zero $6$-flows.   To this end, he used
the following decomposition of $3$-connected graphs.
\begin{lemma}\label{lemma:descent}
Let $G$ be a $3$-connected graph.  Then there
exists a partition $V_1$, \ldots, $V_k$ of vertices of $G$ such that for $i=1, \ldots, k$,
\begin{itemize}
\item either $|V_i|=1$ or $G[V_i]$ has a Hamiltonian cycle, and
\item if $i\ge 2$, then there exist at least two edges with one end in $V_i$ and the other end in $V_1\cup\ldots\cup V_{i-1}$.
\end{itemize}
\end{lemma}
\begin{proof}
Choose a set $V_1$ consisting of an arbitrary vertex of $G$.  For $i\ge 2$, let $B$ be a leaf $2$-connected block of $G_i=G-(V_1\cup \ldots\cup V_{i-1})$.
Since $G$ is $3$-connected and at most one vertex separates $B$ from the rest of $G_i$, there exist at least two edges $e_1$ and $e_2$ from $B$ to
$V_1\cup \ldots\cup V_{i-1}$.  If $e_1$ and $e_2$ are incident with the same vertex $v$ of $B$, we set $V_i=\{v\}$.
Otherwise, since $B$ is $2$-connected, there exists a cycle $C$ in $B$ containing the endpoints of these two edges,
and we set $V_i=V(C)$.
\end{proof}

We can now prove a bound on existence of flows that is only by one worse than the one given by the 5-Flow Conjecture.

\begin{theorem}\label{thm:6flow}
Every bridgeless graph $G$ has a nowhere-zero $6$-flow.
\end{theorem}
\begin{proof}
We will prove that $G$ has a nowhere-zero $\mathbb{Z}_2\times\mathbb{Z}_3$-flow.
As in the proof of Theorem~\ref{thm:8flow}, we can assume that $G$ is $3$-edge-connected.  Furthermore, we can assume that $G$ has maximum degree at most
three: a vertex $v$ with neighbors $v_1$, \ldots, $v_k$ can be replaced by a cycle $w_1w_2\ldots w_k$ and edges $w_iv_i$ for $1\le i\le k$,
and a flow in the resulting graph can be transformed into a flow in $G$ by Corollary~\ref{cor:contractflow}.  Hence,
$G$ is $3$-connected.  Let $V_1$, \ldots, $V_k$ be a partition of the vertex set of $G$ as in Lemma~\ref{lemma:descent}.
For $m=1, \ldots, k$, let $K_m$ be the union of Hamiltonian cycles of graphs $G[V_i]$ such that $1\le i\le m$ and $|V_i|>1$.
For $m=2, \ldots, k$, let $H_m$ be a subgraph of $G$ with vertex set $V_1\cup \ldots\cup V_m$ which for $2\le i\le m$ contains exactly two edges
with one end in $V_i$ and the other end in $V_1\cup \ldots\cup V_{i-1}$.  Observe that $K_m\cup H_m$ is connected and there exists a cycle $C_m\subseteq H_m$
containing both edges from $V_m$ to $V_1\cup\ldots\cup V_{m-1}$.

Let $T$ be a spanning tree of $K_k\cup H_k$; note that $T$ is also a spanning tree of $G$.  By Lemma~\ref{lemma:treecomplflow}, $G$ has a $\mathbb{Z}_3$-flow $f_k$
whose support contains $E(G)\setminus E(T)$, and thus $f_k$ can be $0$ only on edges of $K_k\cup H_k$.  Let us now transform $f_k$ into a $\mathbb{Z}_3$-flow $f_1$
which can be zero only on $K_k$.  We define $Z_3$-flows $f_{k-1}$, \ldots, $f_1$, such that $f_i$ can only be zero
on edges of $H_i\cup K_k$.  Assuming $f_{i+1}$ was already constructed, we consider the three flows obtained from $f_{i+1}$ by increasing the flow values
along the cycle $C_{i+1}\subseteq H_{i+1}\cup K_k$ by $0$, $1$, and $2$.  Note that one of these three flows is non-zero on both edges of $H_{i+1}$ between $V_{i+1}$ and $V_1\cup\ldots\cup V_i$;
we select this flow as $f_i$.  Since all the edges whose values differ in $f_{i+1}$ and $f_i$ belong to $H_{i+1}\cup K_k$, we conclude inductively that $f_i$ can only have zeros
on edges of $H_i\cup K_k$.

Consequently, the $\mathbb{Z}_3$-flow $f_1$ can only be zero on the edges of $K_k$.
Let $f_0$ be the $\mathbb{Z}_2$-flow in $G$ whose value is $1$ on edges of $K_k$ and zero everywhere else.
The union of the supports of $f_0$ and $f_1$ is $E(G)$, and thus $G$ has a nowhere-zero $\mathbb{Z}_2\times \mathbb{Z}_3$-flow by Observation~\ref{obs:prodflow}.
\end{proof}

\subsection{Weak $3$-flow conjecture}\label{ssec:weak3flow}

It is much more difficult to prove existence of a $3$-flow subject to some edge-connectivity assumption, partially because
$\mathbb{Z}_3$ is not a product of non-trivial groups, which makes it impossible to use Observation~\ref{obs:prodflow}.
Indeed, for quite a long time is has been open whether any edge-connectivity is sufficient to ensure the existence of a $3$-flow.
We now aim to show that 6-edge-connected multigraphs have nowhere-zero $3$-flows, based on an argument of Mikl\'os Lov\'asz et al.~\cite{weak63}
(improving an older argument of Thomassen~\cite{weak83} for $8$-edge-connected graphs).
Let us remark that to prove the $3$-Flow Conjecture, it would be enough to show that 5-edge-connected multigraphs have nowhere-zero 3-flows~\cite{weak53eq}.

Consider a nowhere-zero $\mathbb{Z}_3$ flow $f$ in a multigraph $G$. Clearly, we can select an orientation $\vec{G}$ of $G$
so that $f(uv)=1$ for all $uv\in E(\vec{G})$.  Hence, $G$ has a nowhere-zero $3$-flow if and only if $G$ has an orientation
such that each vertex of $G$ has the same in- and out-degree modulo $3$.  For the purposes of induction, we will consider
a more general problem.  For a function $\beta:V(G)\to \{0,1,2\}$ and a set $X\subseteq V(G)$, let us define $\beta(X)=(\sum_{x\in X} \beta(x))\bmod 3$.
The function $\beta$ is a \emph{boundary} if $\beta(V(G))=0$. An orientation of edges incident with a vertex $v$ of $G$ is \emph{consistent with $\beta$}
if $\deg^+(v)-\deg^-(v)\equiv \beta(v)\pmod 3$.
An orientation of $G$ is a \emph{$\beta$-orientation} if it is consistent with $\beta$ at all vertices of $G$.  Hence, $G$ has a nowhere-zero $3$-flow if and only if it has a $\beta$-orientation
for the identically zero function $\beta$.  For $X\subseteq V(G)$, let $\deg_G(X)$ (or just $\deg(X)$ when the multigraph $G$ is clear from the context)
denote the number of edges of $G$ with exactly one end in $X$.  Let us define
$$\beta'(X)=\begin{cases}
\beta(X)&\text{if $\deg(X)$ and $\beta(X)$ have the same parity}\\
3-\beta(X)&\text{if $\deg(X)$ and $\beta(X)$ have the opposite parity}
\end{cases}.$$
For a vertex $x\in V(G)$, let us write $\beta'(x)$ instead of $\beta'(\{x\})$.
Note that $\beta'(X)$ and $\deg(X)$ have the same parity, and that
\begin{equation}
\text{if $\deg(X)\ge 6$, then $\deg(X)\ge \beta'(X)+4$.}\label{eq:lbbeta}
\end{equation}
Indeed, $\beta'(X)\le 3$, and if $\beta'(X)=3$, then $\deg(X)$ must be odd, implying $\deg(X)\ge 7=\beta'(X)+4$.
Note also that
\begin{equation}
\beta'(X)=\beta'(V(G)\setminus X).\label{eq:compl}
\end{equation}
Indeed, $\deg(X)=\deg(V(G)\setminus X)$, and since $\beta$ is a boundary, we have either $\beta(X)=\beta(V(G)\setminus X)=0$,
or $\{\beta(V(G)\setminus X),\beta(X)\}=\{1,2\}$.  In the former case, the claim is obvious. In the latter case,
we can by symmetry assume that $\beta(X)=1$ and $\beta(V(G)\setminus X)=2$.  Hence, if $\deg(X)$ is even, then
$\beta'(X)=\beta'(V(G)\setminus X)=2$, and if $\deg(X)$ is odd, then $\beta'(X)=\beta'(V(G)\setminus X)=1$.

We now aim to prove the following.
\begin{theorem}\label{thm:6flowgen}
Let $G$ be a multigraph with boundary $\beta$. Let $z_0$ be a vertex of $G$
and let $\vec{D}$ be an orientation of edges incident with $z_0$ consistent with $\beta$.
Let $V_0=\{v\in V(G)\setminus \{z_0\}: \beta'(v)=0\}$, and if $V_0$ is non-empty, then
let $v_0$ be a vertex of $V_0$ of minimum degree.  If $\deg(z_0)\le \beta'(z_0)+4$ and $\deg(A)\ge \beta'(A)+4$ for every non-empty $A\subsetneq V(G)\setminus \{z_0\}$
other than $\{v_0\}$, then $G$ has a $\beta$-orientation extending $\vec{D}$.
\end{theorem}

To summarize, the bounds on the sizes of edge-cuts around sets $A$ with given boundary required by Theorem~\ref{thm:6flowgen} can be found in Table~\ref{tab:6flowgen}.
Before we prove Theorem~\ref{thm:6flowgen}, let us observe that it indeed implies that $6$-edge-connected graphs have nowhere-zero $3$-flows.
Indeed, they have the following stronger property (called \emph{$\mathbb{Z}_3$-connectivity}).
\begin{table}
\begin{center}
\begin{tabular}{c|cc}
$\beta(A)$&$\deg(A)$ even&$\deg(A)$ odd\\
\hline
$0$&4&7\\
$1$&6&5\\
$2$&6&5
\end{tabular}
\end{center}
\caption{Lower bounds on cut sizes from Theorem~\ref{thm:6flowgen}.}\label{tab:6flowgen}
\end{table}

\begin{corollary}\label{cor:z3conn}
A $6$-edge-connected multigraph $G$ has a $\beta$-orientation for any boundary $\beta$.
\end{corollary}
\begin{proof}
Let $G'$ be the multigraph obtained from $G$ by adding an isolated vertex $z_0$ and setting $\beta(z_0)=0$.
Note that if $A\subsetneq V(G)$ is non-empty, then $\deg(A)\ge 6$, since $G$ is $6$-edge-connected, and thus
$\deg(A)\ge \beta'(A)+4$ by (\ref{eq:lbbeta}).  Hence, Theorem~\ref{thm:6flowgen} implies that $G'$ (and thus also $G$)
has a $\beta$-orientation.
\end{proof}
This has a nice consequence observed by Thomassen~\cite{weak83}: Consider a $6$-edge-connected graph $G$ such that $|E(G)|$ is
divisible by $3$.  Then the function $\beta(v)=(-\deg v)\bmod 3$ for $v\in V(G)$ is a boundary for $G$, and a $\beta$-orientation $\vec{G}$
which exist by Corollary~\ref{cor:z3conn} has the property that the outdegree of every vertex is divisible by $3$.
Consequently, $G$ can be expressed as a union of edge-disjoint claws (copies of $K_{1,3}$).

Let us now proceed with the proof of Theorem~\ref{thm:6flowgen}.  A \emph{counterexample} (to Theorem~\ref{thm:6flowgen}) is a quadruple $(G,\beta,z_0,\vec{D})$
satisfying the assumptions of Theorem~\ref{thm:6flowgen} (for some choice of $v_0$) such that $G$ does not have a $\beta$-orientation extending $\vec{D}$.
A counterexample is \emph{almost minimal} if $|V(G)|+|E(G-z_0)|$ is minimum among all counterexamples.
A counterexample is \emph{minimal} if it is almost minimal and subject to that, $|E(G)|$ is minimum.
Note that an almost minimal counterexample has no loops not incident with $z_0$, since if $e$ is a loop, then $(G-e,\beta,z_0, \vec{D})$ would be a counterexample
contradicting almost minimality of $(G,\beta,z_0,\vec{D})$.
Similarly, a minimal counterexample has no loops, as in that case removing the loops at $z_0$ would contradict the minimality.

Let us now prove some properties of such (hypothetical) minimum counterexample.  Firstly, let us prove that the condition $\deg(A)\ge \beta'(A)+4$
is not tight for any nontrivial subset $A$ of vertices of $G$.
\begin{lemma}\label{lemma:6fl-nontight}
Let $(G,\beta,z_0,\vec{D})$ be an almost minimal counterexample and let $X\subsetneq V(G)\setminus\{z_0\}$.  If $|X|\ge 2$,
then $\deg(X)\ge \beta'(X)+6$.
\end{lemma}
\begin{proof}
Suppose for a contradiction that $\deg(X)<\beta'(X)+6$.  Since $\deg(X)$ and $\beta'(X)$ have the same parity,
we have $\deg(X)=\beta'(X)+4$. Let $G_1$ be the multigraph obtained from $G$ by contracting $X$ into a new vertex $x$,
let $G_2$ be the multigraph obtained from $G$ by contracting $V(G)\setminus Z$ into a new vertex $y_0$, and let
$\beta(x)=\beta(X)$ and $\beta(y_0)=\beta(V(G)\setminus X)$.

Note that $(G_1,\beta,z_0,\vec{D})$ and $(G_2,\beta,y_0,\vec{D}_2)$ for any orientation $\vec{D}_2$ of edges incident with
$y_0$ consistent with $\beta$ satisfy the assumptions of Theorem~\ref{thm:6flowgen}. For the former, one needs to consider the situation that $\beta'(x)=0$
and $\deg(x)<\deg(v_0)$, in which case $x$ will play the role of $v_0$ in $(G_1,\beta,z_0,\vec{D})$, and thus we need to verify that
$\deg(v_0)\ge \beta'(v_0)+4$; however, since $\beta'(v_0)=0$, the degree of $v_0$ is even, and since $\deg(v_0)>\deg(x)\ge 4$,
we have $\deg(v_0)\ge 6$ and $\deg(v_0)\ge \beta'(v_0)+4$ by (\ref{eq:lbbeta}).  For the latter, we have
$\deg(y_0)=\beta'(X)+4=\beta'(V(G)\setminus X)+4=\beta'(y_0)+4$ by (\ref{eq:compl}).

By the almost minimality of $(G,\beta,z_0,\vec{D})$, we conclude that $G_1$ has a $\beta$-orientation exteding the given orientation $\vec{D}$
of edges incident with $z_0$.  Let $\vec{D}_2$ be the induced orientation of edges incident with $x$, which we interpret
as an orientation of the corresponding edges of $G_2$ incident with $y_0$.  Using again the almost minimality of $(G,\beta,z_0,\vec{D})$,
there exists a $\beta$-orientation of $G_2$ exteding $\vec{D}_2$.  Combining these orientations gives a $\beta$-orientation of $G$ which extends $\vec{D}$,
contradicting the assumption that $(G,\beta,z_0,\vec{D})$ is a counterexample.
\end{proof}

Thanks to the slack provided by Lemma~\ref{lemma:6fl-nontight}, we can lift pairs of edges at vertices of $G$.  This has the
following consequence.

\begin{lemma}\label{lemma:6fl-no0}
If $(G,\beta,z_0,\vec{D})$ is an almost minimal counterexample, then $\beta'(v)\neq 0$ for all $v\in V(G)\setminus \{z_0\}$.
\end{lemma}
\begin{proof}
Otherwise, there exists a vertex $v_0\in V(G)\setminus \{z_0\}$ with $\beta'(v_0)=0$ of minimum degree.
Note that $\beta(v_0)=0$ and $v_0$ has an even degree.
If $v_0$ is an isolated vertex, then $(G-v_0,\beta,z_0,\vec{D})$ is counterexample contradicting the almost minimality of $G$.
Hence, we can assume that $\deg(v_0)\ge 2$.

Suppose now that $z_0$ is the only neighbor of $v_0$.  If $|V(G)|=2$, then $\beta(z_0)=0$ since $\beta$ is a boundary; since $\vec{D}$ is consistent with $\beta$
at $z_0$, it is also consistent with $\beta$ at $v_0$, and thus $\vec{D}$ is a $\beta$-orientation of $G$.  If $|V(G)|\ge 3$,
then consider the set $A=V(G)\setminus\{v_0,z_0\}$.  We have
$\deg(z_0)=\deg(A)+\deg(v_0)\ge \beta'(A)+6=\beta'(\{z_0,v_0\})+6=\beta'(z_0)+6$, where the last equality holds since $\beta(v_0)=0$ and $v_0$ has even degree,
implying that $\deg(z_0)$ and $\deg(\{z_0,v_0\})$ have the same parity.  This contradicts the assumptions of Theorem~\ref{thm:6flowgen}.

Let us now consider the case that $V(G)=\{z_0,v_0,x\}$ and $v_0$ is only adjacent to $x$.
Then $\vec{D}$ together with an orientation of half of the edges at $v_0$ towards $v_0$ and half away from $v_0$ gives
a $\beta$-orientation of $G$ (it is consistent at $x$ since $\beta$ is a boundary).

Hence, we can assume that there exist edges $e_1$ and $e_2$ incident with $v_0$ with different ends such that $e_2$ is not incident with $z_0$,
and thus it is not directed by $\vec{D}$.  We let $G'$ be obtained from $G$ by lifting $e_1$ and $e_2$ at $v_0$,
treating the created edge as $e_1$ (in case $e_1$ belongs to $\vec{D}$).  We claim that $(G',\beta,z_0,\vec{D}$ satisfies the assumptions of
Theorem~\ref{thm:6flowgen}.  Indeed, consider any set $A\subsetneq V(G')\setminus \{z_0\}$.  If $|A|\ge 2$, then
$\deg_{G'}(A)\ge \deg_G(A)-2\ge \beta'(A)+4$ by Lemma~\ref{lemma:6fl-nontight}.  If $A=\{x\}$ for a vertex $x\neq v_0$,
then $\deg_{G'}(A)=\deg_G(A)\ge \beta'(A)+4$ by the assumptions.  Hence, there exists a $\beta$-orientation of $G'$ extending $\vec{D}$
by the almost minimality of $(G,\beta,z_0,\vec{D})$.  However, orienting $e_2$ at $v_0$ in the opposite direction from $e_1$ results
in a $\beta$-orientation of $G$ extending $\vec{D}$, contradicting the assumption that $(G,\beta,z_0,\vec{D})$ is a counterexample.
\end{proof}

In particular, the set $V_0$ from the statement of Theorem~\ref{thm:6flowgen} is empty, and thus there exists no vertex $v_0$.
Hence, if $(G,\beta,z_0,\vec{D})$ is a minimal counterexample, then $\deg(A)\ge \beta'(A)+4$ for every non-empty $A\subsetneq V(G)\setminus \{z_0\}$.
If $G-z_0$ were disconnected, then let $V(G)\setminus \{z_0\}=A_1\cup A_2$ for non-empty sets $A_1$ and $A_2$ with no edges between them;
hence, $\deg(z_0)=\deg(A_1)+\deg(A_2)\ge 8>4+\beta'(z_0)$, contradicting the assumptions.  We conclude that $G-z_0$ is connected.

We now come to a key point in the proof.  We say that distinct vertices $x,y\in V(G)\setminus\{z_0\}$ are \emph{conflicting} if $\beta'(x)=3$ or $\beta'(y)=3$ or
$\beta(x)+\deg(x)+\beta(y)+\deg(y)$ is odd.
\begin{lemma}\label{lemma:6fl-noconfl}
If $(G,\beta,z_0,\vec{D})$ is an almost minimal counterexample, then $V(G)\setminus\{z_0\}$ does not contain conflicting vertices.
\end{lemma}
\begin{proof}
Suppose for a contradiction that distinct vertices $x,y\in V(G)\setminus\{z_0\}$ conflict.  Since $G-z_0$ is connected, we can
assume that $x$ and $y$ are joined by an edge $e$ (otherwise, observe that any path between $x$ and $y$ in $G-z_0$ contains
adjacent conflicting vertices, and consider these vertices, instead).  Note that if $\beta'(v)=3$, then $\beta(v)=0$ and $v$ has odd degree; hence, we can by symmetry assume
that $\beta(y)+\deg(y)$ is odd, and either $\beta(x)+\deg(x)$ is even or $\beta'(x)=\beta'(y)=3$.
Let $\beta_1(x)=(\beta(x)-1)\bmod 3$, $\beta_1(y)=(\beta(y)+1)\bmod 3$, and $\beta_1(v)=\beta(v)$ for all $v\in V(G)\setminus \{x,y\}$.
Clearly, $\beta_1$ is a boundary.  If $(G-e,\beta_1,z_0,\vec{D})$ satisfied the assumptions of Theorem~\ref{thm:6flowgen}, then by the almost minimality of $(G,\beta,z_0,\vec{D})$,
$\vec{D}$ would extend to a $\beta_1$-orienation of $G-e$, and directing $e$ towards $y$ would give a $\beta$-orientation of $G$ extending $\vec{D}$,
which contradicts the assumption that $(G,\beta,z_0,\vec{D})$ is a counterexample.

Hence, there exists a nonempty set $A\subsetneq V(G)\setminus \{z_0\}$ such that $\deg_{G-e}(A)<\beta_1'(A)+4$.  Since $\deg_G(A)\ge\beta'(A)+4$,
this is only possible if $|\{x,y\}\cap A|=1$.  Note that $\deg_{G-e}(A)=\deg_G(A)-1$, and thus $\beta_1'(A)\ge\beta'(A)$.
A straightforward case analysis shows that this is only the case if $\beta'(A)\le 2$ and $\beta_1'(A)=\beta'(A)+1$.
If $|A|\ge 2$, then $\deg_{G-e}(A)=\deg_G(A)-1\ge \beta'(A)+5=\beta_1'(A)+4$ by Lemma~\ref{lemma:6fl-nontight}.
Observe also that $\beta'_1(y)=\beta'(y)-1$ since $\beta(y)+\deg(y)$ is odd.
For $A=\{x\}$, since $\beta'(A)\le 2$, we conclude that $\beta'(x)\neq 3$, and thus $\beta(x)+\deg(x)$ is even.
But then $\beta'_1(x)=\beta'(x)-1$, unless $\beta'(x)=0$; however, this contradicts Lemma~\ref{lemma:6fl-no0}.
\end{proof}

\begin{corollary}\label{cor:nobound}
If $(G,\beta,z_0,\vec{D})$ is an almost minimal counterexample, then $\beta(v)\in\{1,2\}$ and $\beta'(v)\in \{1,2\}$ for all $v\in V(G)\setminus \{z_0\}$.
Furthermore, $\deg(v)+\beta(v)$ has the same parity for all $v\in V(G)\setminus \{z_0\}$.
\end{corollary}

If $\deg(z_0)\le 2$, then consider any edge $e=uv$ of $G-z_0$, and let $G_1=G-e+\{uz_0,vz_0\}$, and let $\vec{D}_1$ be obtained from $\vec{D}$
by orienting $uz_0$ towards $z_0$ and $vz_0$ away from $z_0$.  Observe that $(G_1,\beta,z_0,\vec{D}_1)$ satisfies the assumptions of
Theorem~\ref{thm:6flowgen}, and by the almost minimality of $(G,\beta,z_0,\vec{D})$, it follows that $\vec{D}_1$ extends to a $\beta$-orientation of $G_1$.
However, orienting $e$ from $u$ to $v$ then results in a $\beta$-orientation of $G$ which extends $\vec{D}$, contradicting the assumption that $(G,\beta,z_0,\vec{D})$ is
a counterexample.  We conclude that $z_0$ has degree at least $3$.

We now show that in minimal counterexamples, all edges of $\vec{D}$ are oriented in the same direction.

\begin{lemma}\label{lemma:fl6all}
Let $(G,\beta,z_0,\vec{D})$ be a minimal counterexample such that $\deg(v)+\beta(v)$ is even for all $v\in V(G)\setminus \{z_0\}$.
Then $\deg(z_0)=\beta(z_0)+3$ and all edges of $\vec{D}$ are directed away from $z_0$.
\end{lemma}
\begin{proof}
Suppose first that there exists an edge $e=xz_0$ directed towards $z_0$.  Note that $\beta(x)=\beta'(x)\neq 0$ by Lemma~\ref{lemma:6fl-no0}.
Let $\beta_1(x)=\beta(x)-1$, $\beta_1(z_0)=(\beta(z_0)+1)\bmod 3$, and $\beta_1(v)=\beta(v)$ for all $v\in V(G)\setminus \{x,z_0\}$.
Clearly, $\beta_1$ is a boundary.  If $(G-e,\beta_1,z_0,\vec{D}-e)$ satisfied the assumptions of Theorem~\ref{thm:6flowgen}, then by the minimality of $(G,\beta,z_0,\vec{D})$,
$\vec{D}-e$ would extend to a $\beta_1$-orienation of $G-e$, and directing $e$ towards $z_0$ would give a $\beta$-orientation of $G$ extending $\vec{D}$,
which contradicts the assumption that $(G,\beta,z_0,\vec{D})$ is a counterexample.

Hence, there exists a nonempty set $A\subsetneq V(G)\setminus \{z_0\}$ such that $\deg_{G-e}(A)<\beta_1'(A)+4$.  Since $\deg_G(A)\ge\beta'(A)+4$,
this is only possible if $x\in A$.  As in the proof of Lemma~\ref{lemma:6fl-noconfl}, we must have $\beta_1'(A)=\beta'(A)+1$, and
if $|A|\ge 2$, then $\deg_{G-e}(A)=\deg_G(A)-1\ge \beta'(A)+5=\beta_1'(A)+4$ by Lemma~\ref{lemma:6fl-nontight}.
Furthermore, $\beta(x)+\deg_G(x)$ is even and $\beta(x)\neq 0$, and thus $\beta_1'(x)=\beta'(x)-1$.
This is a contradiction, showing that all edges of $\vec{D}$ are directed away from $z_0$.

In particular, $\beta(z_0)=\deg(z_0)\bmod 3$, and thus $\deg(z_0)=\beta(z_0)+3m$ for some integer $m$.
Since $\deg(z_0)\ge 3$, we have $m\ge 1$.  On the other hand, $\deg(z_0)\le \beta'(z_0)+4\le 7$, and thus $m\le 2$.
If $m=2$, then $\deg(z_0)=\beta(z_0)+6$, $\deg(z_0)$ and $\beta(z_0)$ have the same parity, and $\beta'(z_0)=\beta(z)$,
and thus $\deg(z_0)\le \beta'(z_0)+4=\beta(z_0)+4$, which is a contradiction.  Consequently, $m=1$
and $\deg(z_0)=\beta(z_0)+3$.
\end{proof}

We are now ready to prove the main result on $3$-flows.

\begin{proof}[Proof of Theorem~\ref{thm:6flowgen}]
Suppose for a contradiction that there exists a minimal counterexample $(G,\beta,z_0,\vec{D})$ to Theorem~\ref{thm:6flowgen}.
Clearly, $G$ has at least three vertices, as otherwise $\vec{D}$ is a $\beta$-orientation of $G$.
By Corollary~\ref{cor:nobound}, $\deg(v)+\beta(v)$ has the same parity for all $v\in V(G)\setminus \{z_0\}$.
We can without loss of generality assume that $\deg(v)+\beta(v)$ is even for all $v\in V(G)\setminus \{z_0\}$:
otherwise, we instead consider a counterexample $(G,\beta_1,z_0,\vec{D}_1)$, where $\beta_1(v)=(-\beta(v))\bmod 3$ for $v\in V(G)$
and $\vec{D}_1$ is obtained from $\vec{D}$ by reversing orientations of all edges (note that a $\beta$-orientation extending $\vec{D}$
can be obtained from a $\beta_1$-orientation extending $\vec{D}_1$ by reversing orientations).

Let $e=z_0x$ be an edge of $G$, oriented away from $z_0$ by $\vec{D}$ due to Lemma~\ref{lemma:fl6all}.
Let $G_2$ be the multigraph obtained from $G$ by replacing $e$ by $2$ parallel edges,
and let $\vec{D_2}$ be obtained from $\vec{D}-e$ by directing the two new edges towards $z_0$.

By Lemma~\ref{lemma:fl6all}, we have $\deg_{G_2}(z_0)=\deg_G(z_0)+1=\beta(z_0)+4$, and thus
$\deg_{G_2}(z_0)$ and $\beta(z_0)$ have the same parity.  Consequently, $\beta'_{G_2}(z_0)=\beta(z_0)$,
and $\deg_{G_2}(z_0)=\beta'_{G_2}(z_0)+4$.  Consider now a non-empty set $A\subsetneq V(G)\setminus\{z_0\}$.
If $x\not\in A$, then $\deg_{G_2}(A)=\deg_G(A)\ge \beta'_G(A)+4=\beta'_{G_2}(A)+4$ by the assumptions.
If $x\in A$ and $|A|\ge 2$, then $\deg_{G_2}(A)=\deg_G(A)+1\ge \beta'_G(A)+7\ge \beta'_{G_2}(A)+4$
by Lemma~\ref{lemma:6fl-nontight}, since $\beta'_{G_2}(A)\le 3$.  By Corollary~\ref{cor:nobound} and
the fact that $\deg_G(x)+\beta(x)$ is even, we have $\beta'_G(x)=\beta(x)\in \{1,2\}$.
Note that $\deg_{G_2}(x)+\beta(x)$ is odd and $\beta'_{G_2}(x)=3-\beta(x)\le \beta'_G(x)+1$.
Hence, $\deg_{G_2}(x)=\deg_G+1\ge \beta'_G(x)+5\ge \beta'_{G_2}(x)+4$.

It follows that $(G_2,\beta,z_0,\vec{D}_2)$ satisfies the assumptions of Theorem~\ref{thm:6flowgen}.
If $(G_2,\beta,z_0,\vec{D}_2)$ were a counterexample, then it would be almost minimal, since
$|V(G_2)|+|E(G_2-z_0)|=|V(G)|+|E(G-z_0)|$.  But $\deg_{G_2}(x)+\beta(x)$ is odd and $\deg_{G_2}(y)+\beta(y)$ is even
for any $y\in V(G)\setminus \{z_0,x\}$, contradicting Lemma~\ref{lemma:6fl-noconfl}.
Hence, $(G_2,\beta,z_0,\vec{D}_2)$ is not a counterexample, and thus $G_2$ has a $\beta$-orientation which
extends $\vec{D}_2$.  However, this corresponds to a $\beta$-orientation of $G$ which extends $\vec{D}$,
contradicting the assumption that $(G,\beta,z_0,\vec{D})$ is a counterexample.
\end{proof}

The reader is now perhaps left wondering how exactly one could come up with such an argument.
The idea of splitting off even degree vertices (with $\beta(v_0)=0$) as in Lemma~\ref{lemma:6fl-no0} is natural
and often appears in flow arguments.  Of course, after splitting off some of the edges incident with $v_0$,
its degree becomes smaller than $6$, and thus we cannot enforce that the graph is $6$-edge-connected at that
point---hence, we need the technical exception from the connectivity condition for $\deg(\{v_0\})$ in
the statement of Theorem~\ref{thm:6flowgen}.

More importantly, we need to ensure that splitting off the edges at $v_0$
does not create non-trivial small edge-cuts---so, we need to be able to deal with the situation that the connectivity
condition is tight for some set $X$.  To this end, we apply the argument of Lemma~\ref{lemma:6fl-nontight},
which exploits the fact that we allow edges incident with the vertex $z_0$ to be pre-oriented.  Hence, we can
use induction hypothesis for the graph obtained by contracting $X$, and then extend the orientation of edges
leaving $X$ to the subgraph induced by $X$.  This pre-orientation argument is analogous to the usage
of a precoloring extension argument to eliminate short separating cycles, which we studied in Section~\ref{sec:precolface}.
In conclusion, both $v_0$ and $z_0$ in the statement of Theorem~\ref{thm:6flowgen} are just standard technicalities.

On the other hand, the idea of considering $\beta$-orientations instead of just flows (with zero boundary) is crucial.
This enables us to fix orientation of an edge $e$ and remove this edge, by adjusting the boundary values on its edge appropriately,
which gives us Lemmas~\ref{lemma:6fl-noconfl} and \ref{lemma:fl6all} and enables us to finish the argument
(assuming of course that this does not violate the connectivity assumptions---since non-trivial cuts are not tight due
to Lemma~\ref{lemma:6fl-nontight}, this just needs to be verified for the ends of $e$).

Of course, it is not at all obvious that these ideas need to succeed in any given case.  In particular,
the success depends on a proper choice of the connectivity assumptions (Table~\ref{tab:6flowgen}),
requiring a lot of careful trial-and-error; and we can say very little regarding this aspect of the method beyond that.

\subsection{A Flow Proof of Gr\"{o}tzsch' Theorem}

???

\section{$3$-colorability of near-quadrangulations}\label{sec:quadran}

The connection between coloring and nowhere-zero flows turns out to be especially useful in the case of $3$-coloring of
plane graphs with almost all faces of length exactly $4$; the reason being that nowhere-zero $\mathbb{Z}_3$-flows
in $4$-regular graphs (their duals) degenerate into ordinary integer flows (bounded by $1$ on each edge).
Let us state this observation in a more general form in the language of boundaries and consistent orientations we
introduced in Subsection~\ref{ssec:weak3flow}.

For an undirected multigraph $G$, a \emph{demand function} is any function $d:V(G)\to\mathbb{Z}$
such that
\begin{itemize}
\item $d(V(G))=0$, where $d(X)=\sum_{x\in X} d(x)$ for any set $X\subseteq V(G)$, and
\item for every $v\in V(G)$, $|d(v)|\le \deg(v)$ and $d(v)$ has the same parity as $\deg(v)$.
\end{itemize}
The demand function \emph{refines} a boundary $\beta$ if $\beta(v)\equiv d(v)\bmod 3$ for each $v\in V(G)$.
Note that when $\beta(v)=0$ and $\deg(v)=4$, if a demand function $d$ refines $\beta$, then $d(v)=0$
(while in other cases, there are up to $\lceil (2\deg(v)+1)/6\rceil$ possible values of $d(v)$).

A \emph{$\mathbb{Z}$-flow (with unit capacities) satisfying demands $d$}
is a function $f:E(\ovlr{G})\to \{-1,0,1\}$ such that $f(\ovl{e})+f(\ovr{e})=0$ for the opposite orientations
$\ovl{e}$ and $\ovr{e}$ of each edge $e\in E(G)$, and such that
$$\sum_{e\in E^+(v)} f(e)=d(v)$$
for all $v\in V(G)$.  If $\vec{D}$ is an orientation of a subgraph $G$ of $G$, we say that the $\mathbb{Z}$-flow $f$
\emph{extends} $\vec{D}$ if $f(e)=1$ for each $e\in E(\vec{D})$.  A set $S\subseteq V(G)$ is a \emph{$(d,\vec{D})$-blocking cut}
if $d(S)>|E_{\ovlr{G}}^+(S)|-2|E_{\vec{D}}^-(S)|$.  Let us remark that in a $\mathbb{Z}$-flow satisfying demands $d$,
$d(S)$ is the amount of flow leaving $S$, while $|E_{\ovlr{G}}^+(S)|-2|E_{\vec{D}}^-(S)|$ is an upper bound on the amount
of flow that can leave $S$ in any $\mathbb{Z}$-flow extending $\vec{D}$.

\begin{lemma}\label{lemma:z3ord}
Let $G$ be a multigraph with boundary $\beta$, and let $\vec{D}$ be an orientation of a subgraph of $G$.  The following
claims are equivalent:
\begin{itemize}
\item[(a)] $G$ has a $\beta$-orientation extending $\vec{D}$.
\item[(b)] There exists a demand function $d$ refining $\beta$ and a $\mathbb{Z}$-flow satisfying demands $d$
and extending $\vec{D}$.
\item[(c)] There exists a demand function $d$ refining $\beta$ with no $(d,\vec{D})$-blocking cuts.
\end{itemize}
\end{lemma}
\begin{proof}
If $\vec{G}$ is a $\beta$-orientation extending $\vec{D}$, we can define $f(e)=1$ for every $e\in E(\vec{G})$,
$f(\ovl{e})=-f(\ovr{e})$ for every $e\in E(\ovlr{G})$ such that $\ovr{e}\in E(\vec{G})$,
and $d(v)=\sum_{e\in E_{\ovlr{G}}^+(v)} f(e)$ for each vertex $v\in V(G)$.  This gives a demand function $d$ refining $\beta$,
and $f$ is a $\mathbb{Z}$-flow satisfying demands $d$ and extending $\vec{D}$.  Hence, (a) implies (b).

Suppose $d$ is a demand function refining $\beta$ and $f$ is a $\mathbb{Z}$-flow satisfying demands $d$
and extending $\vec{D}$.  Let $G'$ be the spanning subgraph of $G$ consisting of edges to which $f$ assigns zero flow.
Since $d(v)$ has the same parity as $\deg(v)$ and $f$ satisfies the demands $d$, we conclude that every vertex of $G'$
has even degree.  By Observation~\ref{obs:euler}, $G'$ has a $\mathbb{Z}$-flow $f'$ using only values $-1$ and $1$.
Then $f+f'$ is a $\mathbb{Z}$-flow satisfying demands $d$ and extending $\vec{D}$ using only values $-1$ and $1$.
The orientation $\vec{G}$ of $G$ consisting of the edges $e\in E(\ovlr{G})$ such that $f(e)=1$ extends $\vec{D}$,
and since $d$ refines $\beta$, $\vec{G}$ is a $\beta$-orientation.  Hence, (b) implies (a).

Furthermore, for any set $S\subseteq V(G)$, we have
\begin{align*}
d(S)&=\sum_{v\in S}\sum_{e\in E^+(v)} f(e)=f(S)=|E^+(S)|-2|\{e\in E^+(S): f(e)=-1\}|\\
&\le |E^+(S)|-2|E_{\vec{D}}^-(S)|,
\end{align*}
implying that $S$ is not a $(d,\vec{D})$-blocking cut.  Hence, (b) also implies (c).
The converse follows from the max-flow min-cut theorem.
\end{proof}

Using the duality between colorings and flows in plane graphs, we obtain a characterization
for precoloring extension in plane near-quadrangulations.
Let $\psi$ be a $3$-coloring of a cycle $C$ in a plane graph $G$.  We define $\vec{C}^\star_\psi$
as the orientation of the corresponding edges in the dual $G^\star$ of $G$, containing the edges $e^\star$
for each edge $e=uv\in\ovlr{C}$ such that $\psi(v)-\psi(u)\equiv 1\pmod 3$.
A demand function $d$ is \emph{normal} if it refines the zero boundary, that is, $d(v)$ is divisible by $3$
for every vertex $v$.

\begin{lemma}\label{lemma:flow-quadr}
Let $G$ be a connected plane graph with the outer face bounded by a cycle $C$, and let $\psi$ be a $3$-coloring of $C$.
The following claims are equivalent:
\begin{itemize}
\item[(a)] $G$ has a proper $3$-coloring extending $\psi$.
\item[(b)] In the dual $G^\star$ of $G$, there exists a normal demand function $d$ and a $\mathbb{Z}$-flow satisfying demands $d$
and extending $\vec{C}^\star_\psi$.
\item[(c)] In the dual $G^\star$ of $G$, there exists a normal demand function $d$ with no $(d,\vec{C}^\star_\psi)$-blocking cuts.
\end{itemize}
\end{lemma}
\begin{proof}
Suppose first $G$ has a proper $3$-coloring $\varphi$ extending $\psi$.  Let $f$ be the nowhere-zero $\mathbb{Z}_3$-flow
in the dual $G^\star$ derived from $\varphi$.  Since $\varphi$ extends $\psi$, for each edge $e=uv\in\ovlr{C}$ we have
$$f(e^\star)=\varphi(v)-\varphi(u)=\psi(v)-\psi(u),$$
and thus $f(e')=1$ for every $e'\in E(\vec{C}^\star_\psi)$.  Hence, the orientation $\vec{G}^\star$ of $G^\star$ consisting of edges $e'\in E(\ovlr{G}^\star)$
such that $f(e')=1$ extends $\vec{C}^\star_\psi$.  Since $f$ is a $\mathbb{Z}_3$-flow, $\vec{G}^\star$ is a $\beta$-orientation for the zero boundary $\beta$.
By Lemma~\ref{lemma:z3ord}, it follows that there exists a normal demand function $d$ in $G^\star$ and a $\mathbb{Z}$-flow satisfying demands $d$
and extending $\vec{C}^\star_\psi$.  Hence, (a) implies (b).

Conversely, suppose that $d$ is a normal demand function $d$ and $f$ is a $\mathbb{Z}$-flow satisfying demands $d$
and extending $\vec{C}^\star_\psi$.  By Lemma~\ref{lemma:z3ord}, there exists a $\beta$-orientation $\vec{G}^\star$ of $G^\star$ extending
$\vec{C}^\star_\psi$ for the zero demand function $\beta$.  Consequently, there exists a nowhere-zero $\mathbb{Z}_3$-flow $f$ in
$G^\star$ such that $f(e')=1$ for every $e'\in E(\vec{C}^\star_\psi)$.  Let $v$ be a vertex of $C$.
Proceeding as in the proof of Lemma~\ref{lemma:flowtocolor}, we construct a $\mathbb{Z}_3$-coloring $\varphi$ of $G$ whose derived
$\mathbb{Z}_3$-flow is $f$ such that $\varphi(v)=\psi(v)$.  Since $f(e')=1$ for every $e'\in E(\vec{C}^\star_\psi)$ and
$f$ is derived from $\varphi$, we conclude that $\varphi(u)=\psi(u)$ for every $u\in V(C)$.  Hence, $\varphi$ extends $\psi$.
Therefore, (b) implies (a).

The equivalence of (b) and (c) follows from Lemma~\ref{lemma:z3ord}.
\end{proof}

Note that in the situation of Lemma~\ref{lemma:flow-quadr}, the precoloring $\psi$ determines uniquely the value of
the demand function $d$ on the vertex $v^\star$ corresponding to the outer face of $G$:
$$d(v^\star)=\deg^+_{\vec{C}^\star_\psi}(v^\star)-\deg^-_{\vec{C}^\star_\psi}(v^\star).$$
If $G$ has only a bounded number of faces distinct from the outer one of length other than $4$ and the lengths of these faces
are bounded, then there is only a bounded number of normal demand functions to be inspected in (b), and for each possible demand
function, we can verify whether there exists a $\mathbb{Z}$-flow satisfying demands $d$ and extending $\vec{C}^\star_\psi$
in polynomial time using any efficient maximum flow algorithm.  Hence, in this situation, we can in polynomial time determine
whether $\psi$ extends to a proper $3$-coloring of $G$.

In theoretical applications, it is more convenient to work directly in the graph rather than in its dual.
Let $\psi$ be a $3$-coloring of vertices of a walk $W=v_1v_2\ldots v_k$.
We define $$\omega_\psi(W)=\sum_{i=1}^{k-1}((\psi(v_{i+1})-\psi(v_i))\bmod 3),$$
where $-1\bmod 3=2$ and $-2\bmod 3=1$.  For a cycle $C$, note that $\omega_\psi(C)$ is divisible by $3$;
the \emph{winding number} of $\psi$ on $C$ is defined as $\omega_\psi(C)/3$, and if we see $\psi$ as
a homomorphism of $C$ to a triangle, we can interpret it as the number of times the image of $C$ goes around the triangle.

Let $G$ be a plane graph with the outer face bounded by a cycle $C$, and let $F^{(i)}$ be the set of non-outer faces of $G$.
A \emph{primal demand function} with respect to $\psi$ is a function $d:F^{(i)}\to\mathbb{Z}$ such that
\begin{itemize}
\item $d(F^{(i)})=-\omega_\psi(C)$, 
\item for every non-outer face $f$, we have $|d(f)|\le |f|$ and $d(f)$ has the same parity as $|f|$.
\end{itemize}
For a cycle $K$ in $G$, let $d(K)$ denote the sum of $d(f)$ over the faces $f$ drawn inside $K$.
For distinct vertices $u$ and $v$ of $C$, let $uCv$ denote the subpath of $C$ starting in $u$ and ending in $v$
such that the outer face of $G$ is to the left from this subpath.

\begin{lemma}\label{lemma:flow-quadr-better}
Let $G$ be a connected plane graph with the outer face bounded by a cycle $C$, and let $\psi$ be a $3$-coloring of $C$.
The precoloring $\psi$ extends to a proper $3$-coloring of $G$ if and only if there exists a primal demand function $d$
with respect to $\psi$ such that
\begin{itemize}
\item[(i)] every cycle $K$ intersecting $C$ in at most one vertex satisfies $|d(K)|\le |K|$, and
\item[(ii)] every path $P$ starting in a vertex $v_1\in V(C)$, ending in a vertex $v_2\in V(C)$,
and otherwise disjoint from $C$, satisfies $|\omega_\psi(v_2Cv_1)+d(P\cup v_2Cv_1)|\le |E(P)|$.
\end{itemize}
\end{lemma}
\begin{proof}
By Lemma~\ref{lemma:flow-quadr}, if $\psi$ extends to a $3$-coloring of $G$, then
there exists a normal demand function $d$ with no $(d,\vec{C}^\star_\psi)$-blocking cuts in the dual $G^\star$ of $G$.
We can naturally interpret $d$ as a primal demand function with respect to $\psi$.

Consider a cycle $K$ which is edge-disjoint from $C$ and let $S_K$ denote the set of vertices of $G^\star$
corresponding to the faces of $G$ drawn inside $K$.  We have $E_{\vec{C}^\star_\psi}^-(S_K)=\emptyset$ and $|E_{\ovlr{G^\star}}^+(S_K)|=|K|$.
Since $S_K$ is not a $(d,\vec{C}^\star_\psi)$-blocking cut in $G^\star$, this gives $d(K)=d(S_K)\le |K|$;
and since $V(G^\star)\setminus S_K$ is not a $(d,\vec{C}^\star_\psi)$-blocking cut in $G^\star$, we have $-d(K)=d(V(G^\star)\setminus S_K)\le |K|$.
Hence, $|d(K)|\le |K|$ for every cycle $K$ in $G$ edge-disjoint from $C$, and in particular for any cycle $K$ intersecting $C$ in at most one vertex.

Consider now a path $P$ starting in a vertex $v_1\in V(C)$, ending in a vertex $v_2\in V(C)$, and otherwise disjoint from $C$;
let $Q=v_2Cv_1$ and let $S_P$ denote the set of vertices of $G^\star$ corresponding to the faces of $G$ drawn inside the cycle $K_P=P\cup Q$.
We have $|E_{\vec{C}^\star_\psi}^-(S_P)|=(\omega_\psi(Q)+|E(Q)|)/2$, $|E_{\vec{C}^\star_\psi}^+(S_P)|=(-\omega_\psi(Q)+|E(Q)|)/2$, and
$|E_{\ovlr{G^\star}}^+(S_P)|=|E(P)|+|E(Q)|$.
Since $S_P$ is not a $(d,\vec{C}^\star_\psi)$-blocking cut in $G^\star$, this gives
$d(P\cup Q)=d(S_P)\le |E_{\ovlr{G^\star}}^+(S_P)|-2|E_{\vec{C}^\star_\psi}^-(S_P)|=|E(P)|-\omega_\psi(Q)$.
Furthermore, since $V(G^\star)\setminus S_P$ is not a $(d,\vec{C}^\star_\psi)$-blocking cut in $G^\star$, we have
$d(P\cup Q)=-d(V(G^\star)\setminus S_P)\ge 2|E_{\vec{C}^\star_\psi}^+(S_P)|-|E_{\ovlr{G^\star}}^+(S_P)|=-|E(P)|-\omega_\psi(Q)$.
Hence, (i) and (ii) holds.

Conversely, suppose that there exists a primal demand function $d$ with respect to $\psi$ such that
(i) and (ii) hold. We naturally interpret $d$ as a normal demand function in $G^\star$, and claim
that as such it has no $(d,\vec{C}^\star_\psi)$-blocking cuts; this implies that $\psi$ extends to a $3$-coloring of $G$
by Lemma~\ref{lemma:flow-quadr}.  Let $f^\star$ denote the vertex of $G^\star$ corresponding to the outer face of $G$.
For $S\subseteq V(G^\star)$, let us define $\delta(S)=d(S)+2|E_{\vec{C}^\star_\psi}^-(S)|-|E_{\ovlr{G^\star}}^+(S)|$.
Suppose for a contradiction that $S$ is a $(d,\vec{C}^\star_\psi)$-blocking cut in $G^\star$, i.e., that $\delta(S)>0$.
Without loss of generality, we can assume that $f^\star\not\in S$ (otherwise, flip the drawing of $G$, replace $d$ by $-d$, and
consider $V(G^\star)\setminus S$ instead of $S$).  Choose a set $S$ with $f^\star\not\in S$ and $\delta(S)>0$ such that $|E_{\ovlr{G^\star}}^+(S)|$ is minimum.
If $G^\star[S]$ were not connected, then there would exist non-empty disjoint sets $S_1,S_2\subset S$
such that $G^\star[S]=G^\star[S_1]\cup G^\star[S_2]$.  Note that $\delta(S)=\delta(S_1)+\delta(S_2)$, and by symmetry we could assume $\delta(S_1)>0$.
Furthermore, $|E_{\ovlr{G^\star}}^+(S_1)|=|E_{\ovlr{G^\star}}^+(S)|-|E_{\ovlr{G^\star}}^+(S_2)|<|E_{\ovlr{G^\star}}^+(S)|$, which would contradict
the choice of $S$.  Hence, $G^\star[S]$ is connected.

If $G^\star-S$ were not connected, and there would exist disjoint non-empty sets $A_1,A_2\subset V(G^\star-S)$
such that $G^\star-S=G^\star[A_1]\cup G^\star[A_2]$.  Note that
\begin{align*}
\delta(S\cup A_1)&= \delta(S)+d(A_1)-2|E_{\vec{C}^\star_\psi}^+(A_1)|+|E_{\ovlr{G^\star}}^+(A_1)|\\
&=\delta(S)-d(S\cup A_2)-2|E_{\vec{C}^\star_\psi}^-(S_\cup A_2)|+|E_{\ovlr{G^\star}}^+(S\cup A_2)|\\
&=\delta(S)-\delta(S\cup A_2);
\end{align*}
hence, by symmetry, we could assume $\delta(S\cup A_1)>0$, which contradicts the choice of $S$ since $|E_{\ovlr{G^\star}}^+(S\cup A_1)|<|E_{\ovlr{G^\star}}^+(S)|$.
Therefore, $G^\star-S$ is connected.

Let $K$ be the subgraph of $G$ formed by edges $e$ such that $e^\star$ has exactly one end in $S$, and by the incident vertices.  Clearly, $K$
has no bridges.  Since both $G^\star[S]$ and $G^\star-S$ are connected, $K$ has exactly two faces, and thus $K$ is a cycle in $G$ (with $S$
corresponding to the faces drawn inside $K$).  Since $\delta(S)>0$, (i) implies that $K$ shares at least two vertices with $C$.
Let $P_1$, \ldots, $P_m$ be maximal subpaths of $K$ starting and ending in different vertices of $C$ and otherwise disjoint from $C$.
For $i=1,\ldots,m$, let $Q_i$ be the subpath of $C$ with the same endpoints as $P_i$ such that the interior of the cycle
$P_i\cup Q_i$ is disjoint from the interior of $K$; by (ii), we have $-(\omega_\psi(Q_i)+d(P_i\cup Q_i))\le |E(P_i)|$.
Note that
\begin{align*}
|E_{\ovlr{G^\star}}^+(S)|&=|E_{\vec{C}^\star_\psi}^-(S)|+|E_{\vec{C}^\star_\psi}^+(S)|+\sum_{i=1}^m |E(P_m)|\\
&\ge |E_{\vec{C}^\star_\psi}^-(S)|+|E_{\vec{C}^\star_\psi}^+(S)|-\sum_{i=1}^m (\omega_\psi(Q_i)+d(P_i\cup Q_i))\\
&=-\omega_\psi(C)+2|E_{\vec{C}^\star_\psi}^-(S)|-d(V(G^\star)\setminus S)+d(f^\star)=2|E_{\vec{C}^\star_\psi}^-(S)|+d(S),
\end{align*}
and thus $\delta(S)\le 0$, which is a contradiction.  Hence, there is no $(d,\vec{C}^\star_\psi)$-blocking cut.
\end{proof}

As the first application, let us consider the particularly nice case of near-quadrangulations,
where all faces except for the outer one have length four.  Here, the primal demand function must be
identically $0$, making the condition (i) trivial and simplifying the condition (ii).  Hence, we obtain the following characterization,
which is a far-reaching generalization of Lemma~\ref{lemma:extend6}.

\begin{corollary}\label{cor:flow-quadr}
Let $G$ be a connected plane graph with the outer face bounded by a cycle $C$ and all other faces having length four,
and let $\psi$ be a $3$-coloring of $C$.
The precoloring $\psi$ extends to a proper $3$-coloring of $G$ if and only if $\omega_\psi(C)=0$
and every path $P$ starting in a vertex $v_1\in V(C)$, ending in a vertex $v_2\in V(C)$,
and otherwise disjoint from $C$, satisfies $|\omega_\psi(v_2Cv_1)|\le |E(P)|$.
\end{corollary}

In particular, if the outer face of $G$ has no shortcuts (paths $P$ as in the statement of Corollary~\ref{cor:flow-quadr}
with $|E(P)|<|E(v_2Cv_1)|$, then $\psi$ extends to a $3$-coloring of $G$ if and only if $\omega_\psi(C)=0$.
The situation remains almost as simple in the case where $G$ has exactly one non-outer face $f$ of length other than four.
Here, the value of the primal demand function on $f$ is forced to be $-\omega_\psi(C)$.
Furthermore, note that in the condition (ii), we can restrict our attention only to the paths $P$ such that
$f$ is not contained in the interior of the cycle $P\cup v_2Cv_1$, since
\begin{align*}
\omega_\psi(v_2Cv_1)+d(P\cup v_2Cv_1)&=(\omega_\psi(C)-\omega_\psi(v_1Cv_2))+(-\omega_\psi(C)-d(P\cup v_1Cv_2))\\
&=-(\omega_\psi(v_1Cv_2)+d(P\cup v_1Cv_2)).
\end{align*}
Hence, in this case we can simplify Lemma~\ref{lemma:flow-quadr-better} as follows.
\begin{corollary}\label{cor:flow-oneface}
Let $G$ be a connected plane graph with the outer face bounded by a cycle $C$ and with exactly one non-outer face $f$ of length other than four,
and let $\psi$ be a $3$-coloring of $C$.
The precoloring $\psi$ extends to a proper $3$-coloring of $G$ if and only if
\begin{itemize}
\item[(i)] every cycle $K$ whose interior contains $f$ satisfies $|\omega_\psi(C)|\le |K|$, and
\item[(ii)] every path $P$ starting in a vertex $v_1\in V(C)$, ending in a vertex $v_2\in V(C)$,
otherwise disjoint from $C$, and such that $f$ is not contained in the interior of the cycle $P\cup v_2Cv_1$,
satisfies $|\omega_\psi(v_2Cv_1)|\le |E(P)|$.
\end{itemize}
\end{corollary}

In case that more than one non-outer face has length other than four, there are typically several primal demand functions
to consider.  The interaction of the paths arising from the condition (ii) for different primal demand functions then become
somewhat more complicated, but can still be analyzed in some special cases.  This was used to exactly describe when a precoloring
of a cycle of length at most nine extends to a $3$-coloring of a planar triangle-free graph~\cite{col8cyc,col9cyc} (see Theorem~\ref{thm:grotzsch-gimbel}
for the case the length is at most six).

\part{Coloring Graphs on Surfaces}

\chapter{The history and the modern view}

Under the influence of the Four Color Problem, planar graphs played a prominent role in the beginnings of the graph coloring theory.
It is therefore not surprising that graphs drawn in other surfaces were also considered quite early; Heawood's upper bound
on the chromatic number of graphs drawn in any surface dates to 1890.  For a long time, most of the research was focused
on the behavior with the number of colors close to the one given by Heawood's formula, on the order of the square root of the genus
of the surface.  Most prominently, a series of results culminating in the paper of Ringel and Youngs~\cite{ringel} established the tightness of Heawood's
upper bound and Dirac~\cite{dirac1952} has shown that this bound is essentially only achieved by cliques.

Since 1990's, the focus shifts towards coloring by a small number of colors.  Corollary~\ref{cor:mad} shows that for any $\varepsilon>0$ and any fixed surface,
all but finitely many graphs drawn in the surface have average degree less than $6+\varepsilon$.  This makes it easy to decide the $k$-colorability
of these graphs for any $k\ge 7$, by testing for one of a finitely many obstructions.  Using very simple arguments on the density of critical graphs
(which we explore in the next chapter) this idea applies to $6$-colorability as well.  As it turns out, 5-colorability in any fixed surface is also described
by only finitely many obstructions, but this is a much more challenging proposition.  It was established by Thomassen~\cite{Thomassen97} in 1997,
and the argument highlights the importance of precoloring extension arguments.  In particular, this result implies that locally planar graphs
(graphs drawn in a fixed surface without short non-contractible cycles) are 5-colorable, generalizing the 5-color theorem for planar graphs.

Similarly, motivated by Gr\"{o}tzsch' Theorem, one can ask whether locally planar triangle-free graphs are 3-colorable.  This is quite difficult to establish
even for graphs of girth at least five~\cite{thomassen-surf}, and the triangle-free case brings further challenges, since 3-colorability of triangle-free
graphs on surfaces is not characterized by a finite number of obstructions.  The 3-coloring theory of quadrangulations we have seen in Section~\ref{sec:quadran}
plays an important role in this context, and combining it with a number of other ideas, 3-colorability of locally planar triangle-free graphs has been established
by Dvo\v{r}\'ak, Kr\'al' and Thomas~\cite{trfree6}.

The reader probably noticed a glaring omission in our discussion.  What about 4-colorability, arguably the most interesting case given the Four Color Theorem?
Unfortunately, we cannot say much on this topic.  Very little is known about 4-colorability of graphs in any surface other than the sphere.  Not only that,
even seemingly simple questions such as how hard is it to decide the 4-colorability for graphs drawn in the plane with just one crossing are wide open.
This new incarnation of the Four Color Problem is one of the main challenges for the current graph coloring theory.

\section{The Heawood bound and beyond}\label{sec:heawood}

One of the earliest results on graph coloring is Heawood's upper bound~\cite{heawood} on the chromatic number
of graphs that can be drawn in a fixed surface.  This bound is a simple consequence of the sparsity of embedded graphs.
Indeed, since the proof is entirely in terms of degeneracy, it applies to the list coloring as well.
For a non-negative integer $g$,
let $$H(g)=\Bigl\lfloor\frac{7+\sqrt{24g+1}}{2}\Bigl\rfloor.$$
\begin{theorem}[Heawood's formula, list coloring setting]\label{thm:listheawood}
Every graph drawn in a surface of genus $g\neq 0$ is $H(g)$-choosable.
\end{theorem}
\begin{proof}
For projective planar graphs (the case $g=1$), we have $H(1)=6$; Corollary~\ref{cor:mad} implies these graphs have maximum
average degree less than $6$, and thus they are $5$-degenerate and $6$-choosable by Lemma~\ref{lemma:degen}.
Hence, we can assume $g\ge 2$.

Suppose for some integer $k$, $G$ is a non-$k$-choosable graph drawn in a surface of genus $g$ with the smallest number of vertices.
Then $G$ has minimum degree at least $k$, as if $G$ contained a vertex $v$ of degree less than $k$, then $G-v$ would be $k$-choosable
by the minimality of $G$ and we could color $v$ greedily, showing that $G$ is $k$-choosable as well.  In particular, $|V(G)|\ge k+1$.
Since $G$ is drawn in a surface of genus $g$, Corollary~\ref{cor:mad} gives
$$k\le 6\Bigl(1+\frac{g-2}{|V(G)|}\Bigr)\le 6\Bigl(1+\frac{g-2}{k+1},$$
and thus $k^2-5k-6(g-1)\le 0$.  This implies $$k\le \frac{5+\sqrt{24g+1}}{2}<H(g).$$
Consequently, every graph drawn in a surface of genus $g$ is $H(g)$-choosable.
\end{proof}
Let us remark that by a sheer coincidence, $H(g)=4$, and thus for ordinary proper coloring, Heawood's bound holds for planar graphs (the case $g=0$)
as well due to the Four Color Theorem.

How tight is Heawood's bound?  If $\Sigma$ is a surface of genus $g$ other than the Klein bottle, then the complete graph
$K_{H(g)}$ can be drawn in $\Sigma$; this is an extremely non-trivial result from graph embedding theory
which has been proven in a series of papers~\cite{ringel54,ringel61,twyoungs,youngs67} and unpublished results by Gustin, Mayer, Ringel, Terry, Welch, and Youngs,
completed by the announcement of the solution to the last few sporadic cases by Ringel and Youngs~\cite{ringel}.  The complete
treatment can be found in~\cite{ringelbook}.

On the other hand, Franklin~\cite{franklin} observed that while $H(g)=7$, $K_7$ cannot be drawn in the Klein bottle.
As we will see in the next chapter, a graph drawn in a surface of genus 2 is 6-colorable
if and only if its clique number is at most 6. Hence, all graphs drawn in the Klein bottle are 6-colorable,
giving the only exception to tightness of Heawood's formula.
In fact, cliques are the only obstruction preventing us from strengthening Heawood's bound in much more general circumstances,
as was first shown by Dirac for genus at least four and later exteneded to all surfaces other than the sphere.
\begin{theorem}[Dirac~\cite{dirac1952,dirac1957short},  Albertson and Hutchinson~\cite{albertson1979three}]\label{thm:dirac}
Suppose $G$ is a a graph drawn in a surface of genus $g\neq 0$.  If $\omega(G)<H(g)$, then $G$ is $(H(g)-1)$-colorable.
\end{theorem}

It is not very hard to improve upon this theorem by adding further forbidden subgraphs, as is
easily seen using the theory of critical graphs we present in the next chapter.  Indeed,
we invite the reader to combine the idea of the proof of Theorem~\ref{thm:aldirac} with
Lemma~\ref{lemma:gallaidecomp} to prove the following theorem.
\begin{theorem}
For every integer $c\ge 0$, there exist integers $p$ and $g_0$ and a finite set $\FF_c$ of graphs of chromatic number $p$
such that for every $g\ge g_0$, a graph $G$ drawn in a surface of genus $g$ is $(H(g)-c)$-colorable if and only if
$G$ does not contain a subgraph consisting of a graph from $\FF_c$ together with $H(g)+1-c-p$ universal vertices.
\end{theorem}

Indeed, from a more modern perspective, coloring by a number of colors close to $H(g)=\Theta(\sqrt{g})$ is simple.
In fact, suppose we color by $c\ge 7$ colors.  If the graph has more than $6(g-2)$ vertices, Corollary~\ref{cor:mad} implies
it contains a vertex of degree at most $6$, which we can delete without affecting the $c$-colorability of the graph.
Thus, $c$-colorability is only interesting for graphs with at most $6(g-2)$ vertices, of which there are only finitely
many in any given surface!  This immediately gives us an algorithm with time complexity $O(|V(G)|+\exp(g))$ for $c$-colorability
of a graph $G$ of genus $g$, and a way to describe the $c$-colorability by finitely many forbidden subgraphs for any fixed genus.

The challenge thus becomes to bring the number of colors needed below $7$. As we will see in the next chapter, the case $c=6$ is not
much harder.  The case of $5$-colorability is much more intriguing and was only resolved in the 90's by Thomassen~\cite{Thomassen97},
who has shown that it also can be characterized by finitely many forbidden subgraphs for any fixed genus.
Since $3$-colorability is NP-hard even in planar graphs~\cite{garey1979computers}, and thus unlikely to admit any nice characterization,
this leaves the case of $4$-colorability (arguably the most interesting one, in connection with the Four Color Theorem).
Here, we know a characterization by a finite number of forbidden subgraphs is not possible.  However, we can neither confirm nor
exclude the existence of a polynomial-time algorithm to decide $4$-colorability of a graph embedded in a fixed surface.

Considering Gr\"{o}tzsch' Theorem, what happens if we forbid triangles?  Analogously to the Heawood's bound,
Gimbel and Thomassen~\cite{gimbel} have a lower bound of $\Omega(g^{1/3}/\log g)$ and an upper
bound of $O((g/\log g)^{1/3})$ for the maximum chromatic number of a triangle-free graph
of genus $g$.  However, as we indicated, we are more interested in the case of a small number of colors.
Here, it is not hard to see that $c$-colorability of embedded triangle-free graphs is characterized by a finite number
of forbidden subgraphs for every $c\ge 4$.  The case $c=3$ is significantly more interesting, though:
while the number of forbidden subgraphs is not finite, polynomial-time algorithm does exist~\cite{trfree7}.
As these results are most naturally described in terms of critical graphs, we postpone a detailed discussion till Section~\ref{sec:survsurf}.

Finally, let us mention how the situation changes when instead of ordinary proper coloring, we consider list coloring.
This case is also well developed, though the results in this setting were only obtained recently and we still have
less knowledge of some aspects (especially concerning the particulars of the coloring properties of graphs drawn in the projective plane,
the torus, and the Klein bottle).  As we have seen, the Heawood's bound follows solely from degeneracy, and thus it applies to the list
coloring case without any changes.  The original proof of Dirac's improved bound uses some ideas specific to ordinary proper coloring,
but later the result was extended to the list coloring case as well~\cite{bohmelc,listdir2}.  The arguments we discussed above for coloring with $c\ge 6$
colors, or with $c\ge 4$ colors in the triangle-free case, also directly apply to the list coloring.  The 5-list-coloring case turns out to be
substantially more challenging, but it also is characterized by a finite number of forbidden subgraphs~\cite{lukethe}.
On the other hand, planar graphs are not all 4-list-colorable~\cite{voigt1993}, and this fact can be used to show that deciding colorability of
a planar graph from lists of size four is NP-complete.  Similarly, there are triangle-free planar graphs that are not 3-list-colorable~\cite{voigt1995},
and this implies that deciding colorability of a triangle=free planar graph from lists of size three is NP-complete.
Hence, 3-list-colorability is only interesting for graphs of girth at least five.  This is again a very challenging case; only very recently,
Postle~\cite{postle3crit} proved it is characterized by finitely many forbidden subgraphs.

\section{Further aspects}

In the previous section, we discussed the basic questions of exact characterization and efficient algorithms for colorability
of embedded graphs.  Of course, there are many further viewpoints, which we discuss in this section.

\subsection{Locally planar graphs}
The basic (and sometimes even correct) intuition is that if graphs are drawn in a surface in a sufficiently generic way and cannot be locally distinguished
from planar graphs, then they should behave similarly to planar graphs.  More precisely, we say that some result holds for \emph{locally planar graphs}
if there exists a function $f:\mathbb{N}\to\mathbb{N}$ such that for every $g\ge 0$, the result holds for all graphs drawn in a surface of genus $g$
with edge-width at least $f(g)$.  The reader might wonder why we chose to constrain the edge-width rather than the representativity; the reason
is that in this way, the subgraphs of locally planar graphs are also locally planar (while subgraphs of a graph $G$ can have larger representativity than $G$,
they have at least as large edge-width).

Starting by contradicting our intuition, let us note that the Four Color Theorem does not extend to the locally planar setting.
Indeed, in Section~\ref{sec:survsurf}, we will give examples of non-4-colorable graphs drawn in any fixed surface other than the sphere
with arbitrarily large edge-width.  On the other hand, in most other cases our intuition works.  Indeed, if all planar graphs (possibly subject
to girth restrictions) are $c$-colorable and the $c$-colorability in any fixed surface is characterized by a finite number of forbidden subgraphs, then clearly
locally planar graphs (subject to these girth restrictions) are $c$-colorable, since any graph drawn with edge-width larger than the number of vertices in
the forbidden subgraphs is $c$-colorable.  As we have argued in the previous section, this covers essentially all combinations of the number of colors
and girth, except for the case of $3$-colorability of triangle-free graphs.  For those, the situation is more complicated---locally planar triangle-free
graphs in orientable surfaces are 3-colorable, while in non-orientable surfaces, there are non-3-colorable triangle-free graphs of arbitrarily large edge-width~\cite{trfree6}.
Let us remark that these non-3-colorable graphs have a simple structure (they are supergraps of quadrangulations satisfying a certain parity condition).

Let us also note that it is possible to prove colorability of locally planar graphs without establishing the colorability is characterized
by a finite number of forbidden subgraphs, and indeed, this is sometimes substantially easier.
For example, the result that locally planar graphs are 5-colorable~\cite{Th2} predates the result on forbidden subgraphs~\cite{Thomassen97},
and similar situation occurred for 5-choosability~\cite{DKM,lukethe}.  The basic idea of such a direct argument is as follows.
Let $G$ be a locally planar graph embedded in a surface of genus $g$; without loss of generality, the embedding of $G$ is $2$-cell.
Then $G$ has a subgraph $H$ such that $H$ has only one face and this face is $2$-cell.
If $H$ were bipartite, we could proceed as follows: Give vertices of $G-V(H)$ the list $\{1,\ldots,5\}$ if they have no
neighbor in $H$ and the list $\{1,2,3\}$ if they have a neighbor in $H$. All vertices with list of size three are
incident with one face of the plane graph $G-V(H)$, and thus $G-V(H)$ can be colored from these lists by Theorem~\ref{thm:5choosbook}.
We can then use colors $3$ and $4$ to color $H$.

However, $H$ is not in general bipartite.  Note that all but $O(g)$ vertices of $H$ have degree two, and since $G$ is locally planar, $H$ can be split into a forest $H'$
with $O(g)$ vertices and $O(g)$ long paths of vertices of degree two between vertices of $H'$.  We can $2$-color $H'$ and most of these long
paths, only transitioning between different colorings at most once on each of the paths.  Moreover, $H$ can be chosen with the minimimum number
of edges, which implies the paths are geodesic, and thus each vertex of $G-V(H)$ attaches to the paths ``locally'',
to at most three consecutive vertices of such a path.  A more detailed analysis of this locality shows that we can transition between the
colorings at a carefully chosen point (and possibly color a few more vertices outside of $H$) so that this does not create a list of size
less than three in $G-V(H)$.  The idea for 5-choosability is similar but more involved, due to the fact that we cannot choose the coloring
in this ``almost bipartite'' fashion.

\subsection{Precoloring extension}

As we have just seen, precoloring extension arguments play an important role in coloring graphs on surfaces.
They are also commonly used to deal with the case that the considered graph $G$ is not locally planar, and thus it contains a short
non-contractible cycle $C$.  We can cut the surface along $C$, obtaining a graph $G'$ drawn in a simpler surface with
boundary components bounded by two cycles $C_1$ and $C_2$ corresponding to $C$ (or by one cycle of twice the length,
in case $C$ is $1$-sided).  If a precoloring of $C_1$ and $C_2$ in which the matching vertices have the same color
can be extended to a coloring of $G'$, this also gives a proper coloring of $G$.
Similarly, if we already deal with a graph with several precolored boundary cycles and two of the cycles
are close to each other, we can cut the surface along a path between the two cycles and precolor the two resulting paths.

This leads us to consider the case of locally planar (or even planar) graphs with several precolored cycles far apart from
one another.  Before we discuss this case, let us consider an even simpler setting: we precolor single vertices,
which are required to be far apart from one another.  We have already seen an example in Chapter~\ref{chap:recolor},
Theorem~\ref{thm:extend-dist4}: In a planar graph, any precoloring of vertices at distance four from one another extends to a $5$-coloring
(let us remark that as we will see in Corollary~\ref{cor:oddsame}, this is not the case for $4$-coloring).
The idea of the proof of Theorem~\ref{thm:extend-dist4} crucially depends on the fact that we use more colors than is the chromatic number
of the graph.  Hence, it does not extend to precoloring extension of $5$-colorings in locally planar graphs.
It also does not apply to list coloring.

The nibbling approach of the proof of 5-choosability in Theorem~\ref{thm:5choos-nonbook} can be (with substantial additional effort)
extended to prove that there exists $d_0$ such that in a planar graph with an assignment $L$ of lists of size 5, any $L$-coloring
of vertices at distance at least $d_0$ from one another extends to an $L$-coloring of the whole graph~\cite{LidDvoMohPos}.
The key idea is that all coloring steps are performed near to the special path $P$ contained in the boundary of the outer face
of the graph, and thus they can only be affected by one of the precolored vertices.  This essentially reduces the problem
to the case that exactly one vertex is precolored, for which the minimal counterexamples (in the generalized setting analogous
to Theorem~\ref{thm:5choos-nonbook}) can be characterized.

For locally planar graphs, the cutting technique we described in the previous subsection is in principle aplicable
(choosing $H$ as a minimal subgraph with one $2$-cell face and containing all precolored vertices), though we are
not aware of anyone actually carrying it out.  The progess on this topic was obtained in the more general setting
where larger subgraphs (e.g., boundaries of faces of bounded length) can be precolored.

Hence, let us consider this more general case: Let $G$ be a graph drawn in a surface of genus $g$ and let $H$
be a subgraph of $G$ such that each connected component of $H$ has at most $p$ vertices.  Let $\varphi$ be a $5$-coloring
of $H$ and suppose that the edge-width of $G$ as well as the distance between distinct components of $H$ is at least $d_0$,
for some $d_0$ sufficiently large compared to $g$ and $p$.  Can $\varphi$ be extended to a $5$-coloring of $G$?
There of course arises the issue that this does not need to be the case even if $H$ has only one component.
To avoid having to deal with this local issue and be able to focus on the global phenomenon, let us add
an assumption that for every component $C$ of $H$, the restriction of $\varphi$ to $C$ extends to a $5$-coloring of $G$.

This question was resolved as a side effect of the developments on the forbidden subgraphs for $5$-coloring of embedded graphs.
The main result of~\cite{pothom} can be stated as follows.  For some absolute constant $\kappa$, if $G$ is drawn in a surface of genus $g$ and $H$ is a subgraph of $G$,
then there exists $F\subseteq G$ such that $H\subseteq F$, $|V(F)|\le \kappa(|V(H)|+g)$, and every 5-coloring of $H$ that extends to $F$ also
extends to $G$.  In particular, in the situation of the previous paragraph, we can assume $G=F$.  We can also assume that $G$ is
connected, as otherwise we can consider each component separately.  If $H$ had $c\ge 2$ components, then since the distance between
distinct components is at least $d_0$, we would have $|V(G)|\ge \tfrac{cd_0}{2}\ge {d_0}{2p}|V(H)|>\kappa(|V(H)|+g)$
for sufficiently large $d_0$, which is a contradiction.  Hence, $H$ has only one component, and $\varphi$ extends to a $5$-coloring of $G$
by assumptions.

The same idea applies in the $5$-list-coloring setting~\cite{lukethe}, as well as for 3-coloring~\cite{trfree3} and 3-list-coloring~\cite{postle3crit}
of graphs of girth at least five.  For 3-coloring of triangle-free graphs, the situation is more complicated, and indeed, the analogous statement
is false.  Indeed, while a precoloring of a 5-cycle in a triangle-free planar graph always extends to a 3-coloring of the whole
graph, this does not have to be the case for two 5-cycles, regardless of how far they are from each other---the reader should
use the theory explained in Section~\ref{sec:quadran} to check this is the case when all other faces have length four.
Nevertheless, building upon the idea from the previous paragraph, Dvo\v{r}\'ak and Lidick{\'y}~\cite{cylgen-part2} proved that
in a planar triangle-free graph, a precoloring of sufficiently distant vertices can be extended to a $3$-coloring.

\subsection{Crossings and other anomalies}

So far, we considered the possibility to generalize the drawing of graphs from the plane to more general surfaces.
Another natural option is to stay in the plane, but allow edges in the drawing to cross in a restricted way.

The \emph{crossing number} $\crs(G)$ is defined as the minimum number of crossings with which $G$ can be drawn in the plane
(no edge can pass through a vertex, and at most two edges can cross at each point).  Of course, the genus of $G$ is
at most $\crs(G)$, as each crossing can be replaced by a crosscap, and thus $\chi(G)\le H(\crs(G))=O(\sqrt{\crs(G)})$
by Heawood's formula.  However, this is not the correct order of magnitude.
\begin{lemma}
Every graph $G$ is $k$-choosable, where $k=\max(15,\sqrt[4]{232\crs(G)})$.
\end{lemma}
\begin{proof}
Let $n=|V(G)|$ and $m=|E(G)|$.  Suppose $G$ is not $k$-choosable, and in particular, $n>k$.
Without loss of generality, we can assume all proper subgraphs of $G$ are $k$-choosable,
as otherwise we can consider such a subgraph instead of $G$.  It follows that $G$ has minimum degree at least $k$,
as otherwise we could delete a vertex $v$ of degree less than $k$, color $G-v$ from the lists, and extend the coloring to $v$ greedily.
In particular, $m\ge kn/2>7n$, and thus by the crossing number lemma~\cite{ackerman2019topological},
$$\crs(G)\ge \frac{m^3}{29n^2}\ge\frac{k^3n}{232}>\frac{k^4}{232}.$$
Therefore, $k<\sqrt[4]{232\crs(G)}$, which is a contradiction.
\end{proof}
Moreover, the crossing number of the clique $K_k$ is less than $k^4/64$, showing that this bound is asymptotically tight.
Indeed, by analogy to Hadwiger's conjecture, Albertson conjectured that if $\chi(G)\ge k$, then $\crs(G)\ge \crs(K_k)$.
Ackerman~\cite{ackerman2019topological} proved this conjecture holds for $k\le 18$.

In particular, since $\crs(K_6)=3$, every graph drawn in the plane with at most two crossings is $5$-colorable.
The precoloring extension results we discussed before thus imply that a graph drawn in the plane
with any number of crossings sufficiently far apart is 5-colorable.
Indeed, replace each crossing $c$ by a vertex $v_c$ of degree four, obtaining a planar graph $G'$; thus, each crossing $c$
corresponds to a copy $H_c$ of $K_{1,4}$ in $G'$.  For each crossing $c$ one by one, turn $v_c$ back into a crossing;
as we observed, the resulting graph has a $5$-coloring $\varphi_c$.  For each $c$, color $H_c-v_c$ according to $\varphi_c$
and give $v_c$ a color different from the colors of its neighbors.  As we observed in the previous subsection,
since the components of the precolored subgraph are far apart and the coloring of each of them individually extends to a $5$-coloring,
the precoloring of the whole precolored subgraph also extends to a 5-coloring of the whole graph.
By the choice of the precoloring, this gives a 5-coloring of the original graph with the crossings.

Let us remark that we can extend this idea to list coloring, to 3-coloring of graphs of girth at least five, and to graphs
drawn on surfaces with crossings in a natural way; we invite the reader to work out the details.  Let us also note that
it is possible to prove results for graphs with distant crossings directly, without resorting to the precoloring extension arguments
but using similar ideas, see~\cite{5choosfar} for an example.  In fact, for 5-coloring, the situation is much easier than the previous
paragraph might suggest.  Indeed, if the distance between any two crossings is at least two, we can exploit the fact that
planar graphs are 4-colorable analogously to the proof of Theorem~\ref{thm:extend-dist4}: Delete an edge from each crossing,
4-color the resulting planar graph, and recolor one of the vertices incident with the other edge of each crossing by color 5.
Actually, it suffices to require that the distance between crossings is at least one, as Kr\'al' and Stacho~\cite{krst}
proved by a variation on a reducible configuration proof of 5-colorability of planar graphs.

One can view distant crossings or precolored vertices in a planar graph as ``anomalies'' in its regular structure.
Another kind of anomaly that has been studied is the presence of distant short cycles in graphs of otherwise
larger girth.  The prototypical example concerns the problem of colorability of planar graphs where any two triangles
are far apart.  By analogy with Gr\"{o}tzsch' Theorem and considering the fact that planar graphs with one triangle
(in fact, even with at most three triangles~\cite{aksenov}) are 3-colorable, one would expect such graphs are 3-colorable
as well.  This question has been known as Havel's problem (Havel~\cite{conj-havel} disproved an earlier
conjecture that it is enough the triangles are at distance at least one from one another, and asked whether
any distance $d\ge 2$ suffices).  It is known that $d\ge 4$ by a construction of Aksionov and Mel'nikov~\cite{aksmel}.
The question was resolved in positive by Dvo\v{r}\'ak, Kr\'al' and Thomas~\cite{trfree5}, but with a rather
high bound on $d$ (they claim $d=10^{100}$ suffices; this bound likely can be improved using the stronger results
regarding the obstructions to 3-colorability that have been obtained since then).  We will discuss their
argument in more detail in Chapter~\ref{chap:trfree}.

...

%AMHERE
Number of colorings

\chapter{Critical Graphs}\label{chap:critical}

% ZD
A useful technique to prove that graphs from certain class are $k$-colorable,
which we have already seen used a number of times throughout the book,
is to consider the properties of a hypothetical minimal counterexample,
eventually showing no such counterexample can exist.  What the minimality
exactly entails depends on the particulars of the considered claim, but
in virtually all cases it includes the property that while the whole graph
cannot be $k$-colored, all proper induced subgraphs (or even all proper
subgraphs) are $k$-colorable.

Given the ubiquity of the approach, it is natural to ask whether something 
useful can be told about such ``critical'' graphs in general, without any further
constraints imposed by a particular situation.  While there are some issues
with this idea (since $k$-colorability is NP-hard for $k\ge 3$, it is not surprising
critical graphs lack easily describable structure), it turns out there is a number
of interesting results about the critical graphs in terms of density and forbidden subgraphs.
This is especially important in the study of graphs on surfaces, which as we have
seen are quite sparse.  Indeed, it can be argued that in the last few decades,
most of the progess on the fundamental questions concerning the chromatic properties
of graphs on surfaces has been achieved through the study of critical graphs.

Much of this progess turns out to be due to improved bounds
on the size and density of these graphs.  For example, knowing that in any
fixed surface, there are only finitely many obstructions to $5$-colorability
is already quite useful, as it enables us to test $5$-colorability by verifying the
presence of the these obstructions.  Knowing that the size of these obstructions
is bounded by a linear function of the genus may at first look just as a quantitative improvement,
but actually this has many qualitative implications regarding for example precoloring extension
properties or the dependence of the number of colorings on the size of the graph.
We will discuss these consequences in detail later in the following chapter;
here, we focus on the ways how one can prove such linear bounds for embedded graphs.

\section{Definitions and Basic Properties}\label{sec:defbas}

Let us start our treatment of critical graphs by introducing a bit of terminological
deviation.  A graph is commonly called \emph{$k$-critical} if its chromatic number is $k$, but every
proper subgraph has chromatic number less than $k$.  Consequently, a graph is $k$-colorable
if and only if it contains no $(k+1)$-critical subgraph.  This is notationally a bit unfortunate,
as it necessitates adding or subtracting one at a lot of places.  Even worse, in contexts
of other kinds of coloring this notation becomes confusing.  For example, in the setting
of the fractional chromatic number (which may have non-integral values), to prove results
about $2.5$-colorability, it makes sense to consider minimal graphs that are not $2.5$-colorable.
Calling such graphs $2.5$-critical would be missleading, as by analogy with the ordinary
proper coloring case, this would one lead to believe these graphs actually are $2.5$-colorable.

To avoid this issue, we opt for the following (somewhat non-standard) terminology.
We say that a graph $G$ is \emph{critical for $k$-coloring} if it is not $k$-colorable,
but all proper subgraphs of $G$ are $k$-colorable.  Thus, graphs critical for $k$-coloring
are minimal obstructions to $k$-colorability with respect to the subgraph inclusion.

\begin{observation}\label{obs:critsg}
For every integer $k\ge 1$, a graph $G$ is $k$-colorable if and only if no subgraph of $G$
is critical for $k$-coloring.
\end{observation}

\begin{figure}
\begin{center}
\begin{asy}
unitsize(15mm);

v[0] = (0,0);
for (i = 1; i < 5; ++i)
  v[i] = dir(15 + 30i);
v[5] = v[2] + (0,1);
v[6] = v[3] + (0,1);

for (i = 1; i < 5; ++i)
  draw(v[0] -- v[i]);
draw(v[1]--v[2]--v[3]--v[4]--v[6]--v[3]);
draw(v[1]--v[5]--v[2]);
draw(v[5]--v[6]);

for (i = 0; i <= 6; ++i)
  vertex (v[i], white, 0.05);

label("$u$", v[3], NW);
label("$v$", v[2], NW);
\end{asy}
\end{center}
\caption{A graph vertex-critical but not critical for $3$-coloring.}\label{fig:veedcrit}
\end{figure}

In the theory of graph classes closed under induced subgraphs (but not necessarily all subgraphs),
it is natural to consider the variation on this notion that only takes the induced subgraphs
into account. We say that a graph $G$ is \emph{vertex-critical for $k$-coloring} if it is not $k$-colorable,
but all proper \emph{induced} subgraphs of $G$ are $k$-colorable, and we have the following observation.
\begin{observation}\label{obs:critinsg}
For every integer $k\ge 1$, a graph $G$ is $k$-colorable if and only if no induced subgraph of $G$
is vertex-critical for $k$-coloring.
\end{observation}
Clearly, each critical graph is also vertex-critical,
but the converse is not true---see for example the graph in Figure~\ref{fig:veedcrit}, which becomes $3$-colorable
after removal of any vertex, but not by removal of the edge $uv$.  Correspondingly, any claim that holds for vertex-critical
graphs also holds for critical graphs.  Observe furthermore that a vertex-critical graph contains a critical spanning subgraph,
and thus each vertex-critical graph is at least as dense as some critical graph.
Due to this fact, it is actually quite rare for the distinction between vertex-criticality and criticality to make difference.

A graph is $1$-colorable if and only if it has no edges, and thus $K_2$ is the only critical graph for $1$-coloring.
A graph is $2$-colorable if and only if it does not contain an odd cycle, and the shortest odd cycle in any graph is induced;
hence, odd cycles are the only critical and vertex-critical graphs for $2$-coloring.  However, since $k$-colorability
is NP-hard for every $k\ge 3$, we cannot expect a simple explicit description of graphs critical for $k$-coloring.  Nevertheless,
it is at least clear these graphs cannot be too sparse.
\begin{lemma}\label{lemma:crmindeg}
If $G$ is vertex-critical for $k$-coloring, then $G$ has minimum degree at least $k$.
\end{lemma}
\begin{proof}
If $G$ contained a vertex $v$ of degree less than $k$, then a $k$-coloring of $G-v$ (which exists
by vertex-criticality of $G$) would greedily extend to a $k$-coloring of $G$, which is a contradiction.
\end{proof}
While very simple, Lemma~\ref{lemma:crmindeg} is quite interesting in the context of graphs on surfaces,
which are sparse by Corollary~\ref{cor:mad}.

\begin{corollary}\label{cor:small-simple}
Let $\ell,k\ge 3$ and $g\ge 0$ be integers.  If $k>\tfrac{2\ell}{\ell-2}$, then every graph of genus at most $g$ and girth at least $\ell$
which is vertex-critical for $k$-coloring has at most $$\frac{2\ell}{k\ell-2k-2\ell}(g-2)$$ vertices.
\end{corollary}
\begin{proof}
Since $G$ is not $k$-colorable, it is not a forest, and thus combining Corollary~\ref{cor:mad} and Lemma~\ref{lemma:crmindeg},
we obtain
\begin{align*}
\frac{2\ell}{\ell-2}\Bigl(1+\frac{g-2}{|V(G)|}\Bigr)&\ge k\\
\frac{g-2}{|V(G)|}&\ge \frac{k(\ell-2)}{2\ell}-1.
\end{align*}
By assumptions, the right-hand side is positive.  Hence, we conclude that 
the required inequality holds.
\end{proof}
In particular, Corollary~\ref{cor:small-simple} implies that no graph vertex-critical for $k$-coloring that satisfies
the conditions exists for $g\le 2$; in other words, all graphs drawn in the plane, the projective plane, the torus
or the Klein bottle are $7$-colorable (case $\ell=3$), $5$-colorable if they are triangle-free (case $\ell=4$),
$4$-colorable if they have girth at least $5$ and $3$-colorable if they have girth at least $7$.

Let $\FF_{k,\ell,g}$ denote the set of all pairwise non-isomorphic graphs of genus at most $g$ and girth at least $\ell$
that are vertex-critical for $k$-coloring.  By Corollary~\ref{cor:small-simple}, when $k>\tfrac{2\ell}{\ell-2}$,
the set $\FF_{k,\ell,g}$ is finite for any $g$.  Consider any graph $G$ of girth at least $\ell$ and genus at most $g$.  If $G$ is not
$k$-colorable, then by Observation~\ref{obs:critinsg} $G$ contains an induced subgraph $F$ vertex-critical for $k$-coloring.
Clearly $F$ also has girth at least $\ell$ and genus at most $g$, and thus $F\in\FF_{k,\ell,g}$.  Conversely, if $G$ is $k$-colorable,
it clearly does not contain a subgraph belonging to $\FF_{k,\ell,g}$.  Therefore, when $k>\tfrac{2\ell}{\ell-2}$,
we can for any fixed surface $\Sigma$ test $k$-colorability of a graph of girth at least $k$ drawn in $\Sigma$ in polynomial
time, by checking whether it contains one of the finitely many graphs from $\FF_{k,\ell,g}$ as an induced subgraph.
Eppstein~\cite{eppstein00} proved that one can test the presence of a fixed induced subgraph $F$ in a graph $G$ embedded in a fixed surface $\Sigma$
in time $O(|V(G)|)$, where only the multiplicative constant hidden in the $O$-notation depends on $F$ and $\Sigma$.
Combining these observations, we obtain the following result, highlighting the importance of obtaining bounds on the sizes of critical graphs.
\begin{theorem}\label{thm:crittoalg}
Let $\ell,k\ge 3$ and $g\ge 0$ be integers.  If $\FF_{k,\ell,g}$ is finite, then there exists an algorithm that,
for an input graph $G$ of genus at most $g$ and girth at least $\ell$, decides in time $O(|V(G)|)$ whether $G$ is $k$-colorable.
\end{theorem}
Of course, by Corollary~\ref{cor:small-simple}, Theorem~\ref{thm:crittoalg} applies whenever $k>\tfrac{2\ell}{\ell-2}$.
Let us remark that when $\FF_{k,\ell,g}$ is finite, even though we do not necessarily have an explicit listing of the graphs in $\FF_{k,\ell,g}$,
we can imagine the list to be hard-coded into the algorithm from the theorem; thus, the algorithm is non-uniform (as described, it cannot
take $\ell$, $k$ and $g$ as a part of the input).  Of course, to show $\FF_{k,\ell,g}$ is finite, we generally prove an
upper bound on the size of the graphs in the set (analogously to Corollary~\ref{cor:small-simple}).  In this case, we can
instead have the algorithm first test all graphs smaller than this bound for criticality, turning the algorithm into a uniform one.

Furthermore, let us note that the algorithm from Theorem~\ref{thm:crittoalg} only shows a graph is $k$-colorable, but does not return
a $k$-coloring.  If a $k$-coloring is required, one either has to go back to the proof of finiteness of $\FF_{k,\ell,g}$ and turn
the argument into an algorithm (which is usually possible, but often quite complicated and possibly resulting in a worse time complexity),
or to find a separate argument (possibly exploiting the possibility to call the existence-only algorithm from Theorem~\ref{thm:crittoalg}
repeatedly for various subgraphs or contractions of the input graph).  We will show a partial remedy for this flaw in the following chapter.

Let us return back to the study of critical graphs.  Clearly, any vertex-critical graph must be connected.  Actually, even cuts of size one are easy to exclude.
\begin{observation}\label{obs:crit-2conn}
For any integer $k\ge 1$, every graph $G$ vertex-critical for $k$-coloring is $2$-connected.
\end{observation}
\begin{proof}
Suppose for a contradiction $G=G_1\cup G_2$ for proper induced subgraphs $G_1$ and $G_2$ intersecting in exactly one vertex $v$.
Since $G$ is vertex-critical for $k$-coloring, both $G_1$ and $G_2$ are $k$-colorable.  We can permute the colors in a $k$-coloring of $G_2$
so that $v$ has the same color as in a $k$-coloring of $G_1$.  Then, the two colorings combine to a $k$-coloring of $G$, which is a contradiction.
\end{proof}
More generally, the argument used to prove Observation~\ref{obs:crit-2conn} shows that if a graph $G$ is vertex-critical and $K$ is a clique
in $G$, then $G-K$ is connected.
On the other hand, vertex-critical graphs do not have be $3$-connected, even for $k$ large.  Examples of non-$3$-connected graphs critical for $k$-coloring can
be obtained using the following construction tracing back to Dirac~\cite{dircrit}, Haj\'os~\cite{hajos}, and Ore~\cite{ore}.  Let $G$ and $H$ be graphs,
let $u$ and $v$ be adjacent vertices of $G$ and let $(A,B)$ be a partition of edges incident with a vertex $w$ of $H$ to two non-empty sets $A$ and $B$.
Let $H_{w\to(A,B)}$ denote the graph obtained from $H$ by splitting $w$ into two vertices $w_A$ and $w_B$ and redirecting the edges of $A$ to $w_A$
and the edges of $B$ to $w_B$.  Let the \emph{Ore sum} of $G$ and $H$ on $(u,v,w,A,B)$ be the graph obtained from the disjoint union
of $G-uv$ and $H_{w\to(A,B)}$ by identifying $u$ with $w_A$ and $v$ with $w_B$.
\begin{lemma}\label{lemma:orecrit}
Let $k$ be a non-negative integer, let $G$ and $H$ be graphs critical for $k$-coloring, and let $F$ be the Ore sum of $G$ and $H$ on $(u,v,w,A,B)$.
Then $F$ is not $k$-colorable, and if $H_{w\to(A,B)}$ is $k$-colorable, then $F$ is critical for $k$-coloring.
\end{lemma}
\begin{proof}
Suppose for a contradiction that $F$ has a proper $k$-coloring $\varphi$.  Since the restriction of $\varphi$ to $V(G)$ cannot give a proper $k$-coloring of $G$,
we have $\varphi(u)=\varphi(v)$.  However, then restricting $\varphi$ to $V(H)\setminus\{w\}$ and giving $w$ the color $\varphi(v)$ results in a proper $k$-coloring of $H$,
which is a contradiction.  Hence, $F$ is not $k$-colorable.

Suppose now that $H_{w\to(A,B)}$ has a proper $k$-coloring $\psi$; since $H$ is not $k$-colorable, we have $\psi(w_A)\neq\psi(w_B)$.
Clearly $F$ does not contain isolated vertices, and thus to show that $F$ is critical for $k$-coloring, it suffices to show that for every edge $e\in E(F)$, the graph $F-e$ is $k$-colorable.
If $e\in E(G)\setminus\{uv\}$, then $G-e$ has a $k$-coloring $\theta$, and this coloring assigns distinct colors to the ends of the edge $uv$.
By permuting the colors, we can assume $\theta(u)=\psi(w_A)$ and $\theta(v)=\psi(w_B)$;
combining the colorings $\theta$ and $\psi$ gives a $k$-coloring of $F-e$.  If $e\in E(H)$, then $H-e$ has a $k$-coloring; let $\psi'$ be a $k$-coloring of $H_{w\to(A,B)}-e$ obtained from this
$k$-coloring of $H-e$ by giving both $w_A$ and $w_B$ the color of $w$.  Since $G$ is critical for $k$-coloring, $G-uv$ has a $k$-coloring $\theta'$, and since $G$ is not $k$-colorable,
we have $\theta'(u)=\theta'(v)$; by permuting the colors, we can ensure that $\theta'(u)=\psi'(w_A)$.  Hence, the combination of $\theta'$ and $\psi'$ gives a proper $k$-coloring
of $F-e$.
\end{proof}
In particular, Lemma~\ref{lemma:orecrit} applies whenever $|A|<k$, since then $H_{w\to(A,B)}$ is $k$-colorable due to $H-A$ being $k$-colorable.
There are two important special cases.  First one concerns the situation that $|A|=1$ (and $k\ge 2$); such an Ore sum is called the \emph{Haj\'os sum},
and can be restated as removing the edge $uv$ and the single edge $a\in A$, identifying $u$ with one end of $a$, and adding an edge between $v$ and the other end of $a$.
The second one concerns the case that $H$ is a clique on $k+1$ vertices; graphs obtained from repeated application of the Ore sum with copies of $K_{k+1}$ are called \emph{$(k+1)$-Ore graphs}.
Figure~\ref{fig:tw} depicts a $4$-Ore graph.

Note that all $(k+1)$-Ore graphs are critical for $k$-coloring and (with the exception of the graph $K_{k+1}$ itself), they have vertex-cuts of size two; thus, indeed,
there are infinitely many non-$3$-connected critical graphs for $k$-coloring with arbitrarily large $k$.  Nevertheless, we can at least say something about their edge-connectivity,
strengthening Lemma~\ref{lemma:crmindeg}.

\begin{lemma}\label{lemma:cr-econ}
For any positive integer $k$, every graph $G$ vertex-critical for $k$-coloring is $k$-edge-connected.
\end{lemma}
\begin{proof}
Suppose for a contradiction that we can partition the vertices of $G$ into non-empty parts $A$ and $B$ such that less than $k$ edges have one end in $A$ and the other end in $B$.
Let $u_1v_1$, \ldots, $u_tv_t$ with $t<k$ be the edges of $G$ with $u_i\in A$ and $v_i\in B$ for $i\in\{1,\ldots,t\}$.  Since $G$ is vertex-critical for $k$-coloring,
$G[A]$ has a proper $k$-coloring $\varphi$ and $G[B]$ has a proper $k$-coloring $\psi$.  We now show that we can permute the colors in $\varphi$ so that the two colorings combine to
a proper coloring of $G$.

Let $H$ be the auxiliary bipartite graph with parts $\{a_1,\ldots, a_k\}$ and $\{b_1,\ldots,b_k\}$,
where for $i\in\{1,\ldots,t\}$, $a_{\varphi(u_i)}b_{\psi(v_i)}$ is a \emph{non-edge} of $H$ and all other pairs of vertices from the two parts form edges.
Consider any non-empty set $I\subseteq \{a_1,\ldots, a_k\}$ and let $N(I)$ denote the set of vertices in $\{b_1,\ldots,b_k\}$ that have a neighbor in $I$.
Since $H$ has at most $t$ non-edges between the parts, there are at most $t/|I|$ vertices among $\{b_1,\ldots,b_k\}$ that have no neighbor in $I$, and thus 
$$|N(I)|\ge k-t/|I|\ge k-(k-1)/|I|=|I|+\frac{(|I|-1)(k-1-|I|)}{|I|}\ge |I|-\frac{|I|-1}{|I|}.$$
Since $|N(I)|$ is an integer and $\tfrac{|I|-1}{|I|}<1$, this implies $|N(I)|\ge |I|$ for every $I\subseteq \{a_1,\ldots, a_k\}$,
and thus $H$ has a perfect matching $M$ by Hall's theorem.

For every color $c\in\{1,\ldots,k\}$, let us define $f(c)$ so that $M$ contains the edge $a_cb_{f(c)}$.  Then $f$ is a permutation of the colors.
Let $\varphi'$ be the $k$-coloring of $G[A]$ given by $\varphi'(u)=f(\varphi(u))$ for each $u\in A$.  We claim that $\varphi'$ and $\psi$ combine to a proper $k$-coloring of $G$, which is a contradiction.
Indeed, for $i\in\{1,\ldots,t\}$, we have $\varphi'(u_i)=f(\varphi(u_i))$, and thus $M\subseteq H$ contains the edge $a_{\varphi(u_i)}b_{\varphi'(u_i)}$, and thus
$\psi(v_i)\neq \varphi'(u_i)$ by the definition of the edge set of $H$.
\end{proof}

How many vertices can graph vertex-critical for $k$-coloring have?  Certainly the smallest such graph is the clique $K_{k+1}$.
The Haj\'os sum of two such cliques has $2k+1$ vertices, and in a sense, it is the next smallest non-trivial vertex-critical graph:
There are ways to obtain smaller ones, for example the graph obtained from the $5$-cycle by adding $k-2$ universal vertices has $k+3$
vertices, but as we will see momentarily, all such graphs have disconnected complement, and thus they are complete joins of two smaller
vertex-critical graphs (a \emph{complete join} of two graphs $G_1$ and $G_2$ is obtained from their dijoint union by adding all edges between $V(G_1)$ and $V(G_2)$).

We say that a graph $G$ vertex-critical for $k$-coloring is \emph{tight} if for every $v\in V(G)$, $G$ has a $(k+1)$-coloring
such that the color class containing $v$ has size one and all other color classes have size two; and in particular, $|V(G)|=2k+1$.
A graph $G$ is \emph{hypo-matchable} if for every $v\in V(G)$, $G-v$ has a perfect matching; note that the complement of a tight graph is hypo-matchable.
We say that $G$ is \emph{loose} if $G$ has a $(k+1)$-coloring with all color classes of size at least two; and in particular, $|V(G)|\ge 2k+2$.
The following lemma is a mild strengthening of results of Gallai~\cite{gallai2} and Stehl{\'\i}k~\cite{stehlik}.

\begin{lemma}\label{lemma:gallaidecomp}
Every vertex-critical graph is a complete join of at most one loose vertex-critical graph with tight vertex-critical graphs.
\end{lemma}
\begin{proof}
Suppose $G$ is a graph vertex-critical for $k$-coloring, and let $\varphi$ be a $(k+1)$-coloring of $G$ that minimizes the size
of the set $B$ of vertices contained in color classes of size at least three.  Let $G_1$ be the complement of $G-B$
be the matching in $G_1$ formed by color classes of size two.  Let $k_1$ be the number of colors $\varphi$ uses on $V(G)\setminus B$.
Since $G$ is vertex-critical, $G-B$ cannot be colored by fewer than $k_1$ colors, and thus $M$ is a maximum matching in $G_1$.

We now apply a well-known Gallai-Edmonds decomposition to $G_1$: There exists a set $T\subseteq V(G_1)$ such that each component of $G_1-T$
is hypo-matchable.  Moreover, let $\CC$ be the set of components of $G_1-T$ and let $H$ be an auxiliary bipartite graph with parts $T$ and $\CC$
where $t\in T$ and $C\in\CC$ are adjacent if and only if $t$ has a neighbor in $C$; then $H$ has a matching that covers $T$.

Let $\CC_1$ consist of the components $C\in \CC$ such that $C$ is covered by every matching in $H$ that covers $T$.
Let $T_1$ be a maximal subset of $T$ such that the neighborhood $N(T_1)$ of $T_1$ in $H$ has size $|T_1|$.
We claim that $\CC_1=N(T_1)$.  Indeed, since $|N(T_1)|=|T_1|$, for every $C\in N(T_1)$, no matching in $H-C$ can cover $T_1$.
Conversely, if $C\in\CC_1$, then Hall's theorem implies there exists $T_2\subseteq T$ such that $C\in N(T_2)$ and $|N(T_2)|=|T_2|$.
We have $|N(T_1\cup T_2)|=|N(T_1)\cup N(T_2)|=|N(T_1)|+|N(T_2)|-|N(T_1)\cap N(T_2)|\le |T_1|+|T_2|-|N(T_1\cap T_2)|\le |T_1|+|T_2|-|T_1\cap T_2|=|T_1\cup T_2|$,
and thus $|N(T_1\cup T_2)|=|T_1\cup T_2|$ since $H$ has a matching that covers $T$.  The maximality of $T_1$ implies $T_2\subseteq T_1$ and $C\in N(T_1)$.
Let $G_0=G\Bigl[B\cup T_1\cup\bigcup_{C\in\CC_1} V(C)]$.  

Consider $C\in \CC\setminus \CC_1$ and a vertex $v\in V(C)$.  Since $C\not\in \CC_1$, $H$ has a matching $M_C$ covering $T$ but not $C$.
We can extend this matching to a maximum matching $M'$ in $G_1$ that does not cover $v$, using the fact that the components of $\CC$ are hypo-matchable.
This corresponds to a coloring of $G-B$ by $k_1$ colors such that the color class containing $v$ has color one and all vertices of $\overline{C}-v$ are in color
classes of size exactly two contained in $C$.  Note that $\overline{C}$ cannot be colored by fewer than $k_C=(|V(C)|+1)/2$ colors, since $G-B$ cannot be colored by fewer than $k_1$ colors.
On the other hand, $\overline{C}-v$ is colored by one less color, and since the choice of $v\in C$ is arbitrary, we conclude $\overline{C}$ is vertex-critical and tight.
Note that in $G$, $v$ is adjacent to all vertices of $T_1$ since $N(T_1)=\CC_1$ and $G_1$ is the complement of $G-B$.  Furthermore, $v$ is adjacent all vertices in $B$,
as otherwise we could recolor a non-neighbor of $v$ in $B$ to the color of $v$, contradicting the minimality of $|B|$.  Again, since the choice of $v\in C$ is arbitrary,
it follows that $G$ contains all edges between $G_0$ and $\overline{C}$.

Similarly, considering a $k_1$-coloring of $G-B$ arising from an arbitrary matching in $H$ that covers $T$, we conclude that $G$ has a $(k+1)$-coloring
in which $V(G_0)$ is a union of $k+1-\sum_{C\in \CC\setminus \CC_1} k_C$ color classes, each of size at least two, and thus $G_0$ cannot be colored by fewer colors.
Let $G'=G-(T\setminus T_1)$.  The graph $G'$ is a complete join of $G_0$ and the graphs $\overline{C}$ for $C\in\CC\setminus \CC_1$, and thus it cannot be colored
by fewer than $k+1$ colors.  Since $G$ is vertex-critical for $k$-coloring, it follows that $G=G'$.  Since $G$ is vertex-critical, deleting any vertex of $G_0$ decreases
the chromatic number of $G$, and thus also the chromatic number of $G_0$.  Hence, $G_0$ is a loose vertex-critical graph, and the claim of this lemma follows.
\end{proof}

Note that $K_1$ is tight and the next smallest vertex-critical graph that is tight is $C_5$ (and this is the only tight graph with $5$-vertices), and the smallest loose vertex-critical graph is $C_7$.
This has the following consequence.
\begin{corollary}\label{cor:smallestcrit}
Suppose $G\neq K_{k+1}$ is a graph vertex-critical for $k$-coloring.  Then $G$ has at least $k+3$ vertices, and if $|V(G)|=k+3$, then $G$ is the complete join of $C_5$ with $k-2$ copies of $K_1$.
\end{corollary}

\section{Density of critical graphs}

Using Corollary~\ref{cor:small-simple}, we have shown that certain combinations of chromatic number and girth admit only
finitely many vertex-critical graphs embeddable in any fixed surface.  Table~\ref{table:knowncrit} summarizes our current state of knowledge
concerning vertex-critical graphs of various girths and bounded genus,  with the entries resolved in the previous section highlighted in green.
We can push this approach a bit further, to resolve the entries highlighed in blue in the table.

\begin{table}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|}
\hline
\backslashbox{$\ell$}{k}& 1 & 2 & 3   & 4                 & 5                 & 6                 & $\ge\!7$\\
\hline
3         & FC & P & NPC~\cite{garey1979computers}            & ?                 & FC~\cite{Thomassen97}                & {\color{blue}FC}  & {\color{green}FC}\\
4         & FC & P & P~\cite{trfree7}              & {\color{blue}FC}  & {\color{green}FC} & {\color{green}FC} & {\color{green}FC}\\
5         & FC & P & FC~\cite{thomassen-surf}             & {\color{green}FC} & {\color{green}FC} & {\color{green}FC} & {\color{green}FC}\\
$6$       & FC & P &{\color{blue}FC}& {\color{green}FC} & {\color{green}FC} & {\color{green}FC} & {\color{green}FC}\\
$\ge\!7$  & FC & P &{\color{green}FC}& {\color{green}FC} & {\color{green}FC} & {\color{green}FC} & {\color{green}FC}\\
\hline
\end{tabular}
\end{center}

Legend:
\begin{description}
\item[FC]: $\FF_{k,\ell,g}$ is finite for each genus $g$.
\item[P]: $\FF_{k,\ell,g}$ is infinite for each $g>0$, but $k$-colorability of graphs of girth at least $\ell$ and genus at most $g$
is polynomial-time solvable for each $g$.
\item[NPC]: $k$-colorability is NP-complete even for planar graphs.
\end{description}

\caption{Complexity of $k$-coloring a graph of girth at least $\ell$ and bounded genus.}\label{table:knowncrit}
\end{table}

Since $K_{k+1}$ is critical for $k$-coloring, the bound from Lemma~\ref{lemma:crmindeg} cannot be improved without
further assumptions, even if we consider the average degree instead of the minimum degree.
However, as it turns out, $K_{k+1}$ is significantly sparser than other vertex-critical graphs for $k$-coloring.
For graphs with a small number of vertices, the following bound by Dirac~\cite{diracdens} is quite good
(the proof we give for this result comes from~\cite{weinstein}).
\begin{lemma}\label{lemma:diracdens}
Let $k\ge 2$ be an integer.  If $G$ is an $n$-vertex graph vertex-critical for $k$-coloring and $G\neq K_{k+1}$, then $G$ has average degree
at least $k+\tfrac{k-2}{n}.$
\end{lemma}
\begin{proof}
For $v\in V(G)$, let the \emph{excess} of $v$ be $\exc_{G,k}(v)=\deg(v)-k$, and let $\exc_k(G)=\sum_{v\in V(G)} \exc_{G,k}(v)$.
Hence, we want to prove that if $G$ is vertex-critical for $k$-coloring and $G\neq K_{k+1}$, then $\exc_k(G)\ge k-2$.  We prove this claim by induction on $k$.
The basic case $k=2$ is trivial, and thus we can assume $k\ge 3$.

The claim is trivial if $G$ has minimum degree at least $k+1$, and thus suppose $w$ is a vertex of $G$ of degree $k$.  Since $G$ is vertex-critical for $k$-coloring and $G\neq K_{k+1}$,
the neighborhood of $w$ is not a clique; let $v_1$, \ldots, $v_k$ be the neighbors of $w$, where $v_1v_2\not\in E(G)$.  Since $G$ is vertex-critical, $G-v$ has a $k$-coloring $\varphi$ that cannot
be extended to $v$; we can assume $\varphi(v_i)=i$ for $i\in\{1,\ldots,k\}$.

Suppose $G[N(w)\setminus\{v_i\}]$ is not a clique (which is always the case when $i\not\in\{1,2\}$).  Let $Y$ be a maximal independent set in $G$ containing all vertices of color $i$.
Since $G$ is not $k$-colorable, the graph $G-Y$ is not $(k-1)$-colorable, and thus it contains an induced subgraph $H$ vertex-critical for $(k-1)$-coloring.
Since $G-w$ is $k$-colorable, $G-Y-w$ is $(k-1)$-colorable, and thus $w\in V(H)$.  Furthermore, $H$ has minimum degree at least $k-1$, and thus $N(w)\setminus\{v_i\}\subseteq V(H)$.
Consequently, $H$ is not a clique, and thus by the induction hypothesis, we have $\exc_{k-1}(H)\ge k-3$.  Note that
$$\exc_k(G)=\exc_{k-1}(H)+\sum_{v\in V(G)\setminus V(H)} \exc_{G,k}(v)+\sum_{v\in V(H)} (\deg_G(v)-\deg_H(v)-1).$$
Since $Y$ is a maximal independent set, every vertex of $H$ has a neighbor in $Y$, and thus each term of the last sum is non-negative.
We conclude that $\exc_k(G)\ge k-2$ unless all vertices of $V(G)\setminus V(H)$ have zero excess and each vertex of $H$ has exactly one neighbor in $Y$.
Therefore, for every $i\in \{1,\ldots,k\}$ such that $G[N(w)\setminus v_i]$ is not a clique, every vertex of color $i$ has zero excess and every vertex of non-zero excess has at most one neighbor
of color $i$.

In particular, this applies to vertices of color $3$, \ldots, $k$.  By Brooks' theorem, since $G$ is not a clique, $G$ cannot have maximum degree $k$, and thus
$G$ contains a vertex $z$ of positive excess, without loss of generality of color $1$.  Since $z$ has at most one neighbor of each of the colors $3$, \ldots, $k$,
$z$ has at least three neighbors of color $1$.  Consequently, both $G[N(w)\setminus\{v_1\}]$ and $G[N(w)\setminus\{v_2\}]$ are cliques.  Since $w$, $v_3$, \ldots, $v_k$
have zero excess, we conclude that all neighbors of these vertices are contained in $\{w, v_1,\ldots, v_k\}$.  If for some $j\in\{3,\ldots,k\}$, the vertices
$v_1$ and $v_2$ had no neighbor of color $j$ other than $v_j$, we could recolor $v_1$ and $v_2$ to $j$, $v_j$ to $1$, and $w$ to $2$, obtaining a $k$-coloring of $G$.
This is a contradiction, and thus each of the colors appears on the neighborhood of $v_1$ or $v_2$ outside of $\{v_3,\ldots,v_k\}$.
Similarly, $v_1$ has a neighbor of color $2$ and $v_2$ has a neighbor of color $1$.
Consequently,
$$\exc_k(G)\ge \exc_{G,k}(v_1)+\exc_{G,k}(v_2)=\deg(v_1)+\deg(v_2)-2k\ge k-2,$$
as required.
\end{proof}
The Haj\'os sum of two copies of $K_{k+1}$ has $n=2k+1$ vertices and $2\binom{k+1}{2}-1=\tfrac{1}{2}(kn+k-2)$ edges, showing that the lemma
is tight in this special case. 

Corollary~\ref{cor:smallestcrit} and Lemma~\ref{lemma:diracdens} together give just about enough information about critical graphs to prove
Theorem~\ref{thm:dirac} up to a few exceptional genera.
\begin{theorem}\label{thm:aldirac}
Suppose $G$ is a a graph drawn in a surface of genus $g\not\in\{0,1,3\}$.  If $\omega(G)<H(g)$, then $G$ is $(H(g)-1)$-colorable.
\end{theorem}
\begin{proof}
We proceed similarly to the proof of Heawood's formula, employing the stronger bounds we obtained in the meantime.
Let $k=H(g)-1$ and $n=|V(G)|$; suppose for a contradiction that $G$ is critical for $k$-coloring and $G\neq K_{k+1}$.
By Corollary~\ref{cor:smallestcrit}, we have $n\ge k+3$.  Combining Corollary~\ref{cor:mad} with Lemma~\ref{lemma:diracdens},
we have
\begin{align*}
k+\frac{k-2}{n}&\le 6+\frac{6(g-2)}{n}\\
k-6&\le\frac{6g-k-10}{n}\le \frac{6g-k-10}{k+3}\\
k^2-2k-(6g+8)&\le 0\\
\frac{3+\sqrt{24g+1}}{2}<H(g)-1=k&\le \Bigl\lfloor\frac{2+\sqrt{24g+36}}{2}\Bigr\rfloor.
\end{align*}
Note that $\sqrt{24g+36}-\sqrt{24g+1}-1$ is decreasing in $g$ and equal to $0$ for $g=12$, hence we have $g\le 11$.
Furthermore, numerical calculations show that
\begin{itemize}
\item for $g\in\{10,11\}$, $H(g)-1=10$ while the right-hand side is $9$,
\item for $g\in\{7,8,9\}$, $H(g)-1=9$ while the right-hand side is $8$,
\item for $g\in\{5,6\}$, $H(g)-1=8$ while the right-hand side is $7$,
\item for $g=4$, $H(g)-1=7$ while the right-hand side is $6$, and
\item for $g=2$, $H(g)-1=6$ while the right-hand side is $5$.
\end{itemize}
This is a contradiction.
\end{proof}
Let us remark that as we already mentioned, $K_7$ cannot be drawn in the Klein bottle, and thus Theorem~\ref{thm:aldirac} implies
graphs drawn in the Klein bottle are $6$-colorable.
As for the genera excluded in the statement of Theorem~\ref{thm:aldirac}, the case $g=0$ obviously fails---it is not true that
all planar graphs of clique number at most three are $3$-colorable.  On the other hand, the conclusion holds for $g\in\{1,3\}$;
all projective planar graphs not containing $K_6$ are 5-colorable, and all graphs drawn in the non-orientable surface of genus $3$
not containing $K_7$ are $6$-colorable~\cite{albertson1979three}.  We encourage the reader to work out these last two cases as an
exercise (hint: a vertex $v$ of minimum degree has two non-adjacent neighbors; we can delete $v$, identify these two neighbors,
and proceed by induction, unless the identification creates the forbidden clique).

Let us also remark that while the proof of the Heawood bound is purely in the terms of degeneracy and thus it directly
applies to the list coloring setting, the presented proofs of Lemmas~\ref{lemma:gallaidecomp} and \ref{lemma:diracdens}
employ ideas that are specific just to the ordinary proper coloring.  Nevertheless, Theorem~\ref{thm:dirac} can be generalized
to the list coloring setting, using somewhat more involved arguments~\cite{bohmelc,listdir2}.

For graphs with many vertices, the bound from Lemma~\ref{lemma:diracdens} is not much better than the trivial lower bound of $k$.
To obtain an asymptotically better bound, let us first make a simple observation on the subgraphs of vertex-critical graphs for $k$-coloring induced by vertices
of degree exactly $k$; we refer the reader to Subsection~\ref{ssec-gallai} for definition and motivation for Gallai forests.

\begin{lemma}\label{lemma:degkgal}
If $G$ is vertex-critical for $k$-coloring, then the subgraph of $G$ induced by vertices of degree exactly $k$
is a Gallai forest.
\end{lemma}
\begin{proof}
Let $S$ be the vertex set of a component of the subgraph of $G$ induced by vertices of degree exactly $k$.
Since $G$ is vertex-critical for $k$-coloring, $G-S$ has a $k$-coloring $\varphi$.  For every vertex $v\in S$,
let $L(v)=\{1,\ldots,k\}\setminus\{\varphi(u):u\in V(G)\setminus S, uv\in E(G)\}$ be the set of colors that do
not appear on the neighbors of $v$; clearly, $|L(v)|\ge k-(\deg_G(v)-\deg_{G[S]}(v))=\deg_{G[S]}(v)$,
and thus $L$ is a degree-sized assignment for $G[S]$.  Note that an $L$-coloring of $G[S]$ would combine
with $\varphi$ to a $k$-coloring of $G$.  Since $G$ is not $k$-colorable, it follows $G[S]$ is not $L$-colorable,
and by Theorem~\ref{thm:gallai}, $G[S]$ is a Gallai tree.
\end{proof}

A straightforward inductive argument shows that Gallai forests of bounded maximum degree are relatively sparse.

\begin{lemma}\label{lemma:galdens}
Let $k\ge 3$ be an integer.  Suppose $T$ is a Gallai forest of maximum degree at most $k$.
If no component of $T$ is a clique with $k+1$ vertices, then $T$ has average degree at most
$k-1+\tfrac{2}{k}$.
\end{lemma}
\begin{proof}
We prove the claim by induction on the number of vertices of $T$.  Clearly, we can assume that $T$ is connected.
If $T$ is $2$-connected, then $T$ is either an odd cycle or a clique of size at most $k$, and thus its average
degree is at most $k-1$, implying the inequality.

Hence, suppose that $T$ is not $2$-connected.  Let $B$ be a leaf block of $T$.  If $k\ge 4$ and $B$ is an odd cycle,
or if $B$ is a clique of size at most $k-1$, then let $H=B$.  Otherwise, $B$ is $(k-1)$-regular, and since the maximum degree of $T$ is at most $k$
and $B$ is a leaf block, there exists exactly one other block $B'$ intersecting $B$ and $B'$ is isomorphic to $K_2$; in this case we let $H=B\cup B'$.
In either case,
\begin{equation}\label{eq:galdens-1}
|E(H)|\le \Bigl(\frac{k-1}{2}+\frac{1}{k}\Bigr)(|V(H)|-1).
\end{equation}
Let $H'$ be the subgraph of $T$ such that
$T=H\cup H'$ and $H'$ intersects $H$ in exactly one vertex.  Then $H'$ is a Gallai forest and by the induction hypothesis, we have
\begin{equation}\label{eq:galdens-2}
|E(H')|\le \Bigl(\frac{k-1}{2}+\frac{1}{k}\Bigr)|V(H')|.
\end{equation}
Since $|V(T)|=(|V(H)|-1)+|V(H')|$ and $|E(T)|=|E(H)|+|E(H')|$, the desired bound on the average degree of $T$ 
follows by summing (\ref{eq:galdens-1}) and (\ref{eq:galdens-2}).
\end{proof}

Lemmas~\ref{lemma:degkgal} and \ref{lemma:galdens} imply that in a graph vertex-critical for $k$-coloring other than $K_{k+1}$,
relatively many edges leave the subgraph induced by vertices of degree exactly $k$, which implies that its average degree
must be substantially larger than $k$.

\begin{theorem}[Gallai~\cite{galfor}]\label{thm:critdens}
Let $k\ge 3$ be an integer.  If $G$ is vertex-critical for $k$-coloring and $G\neq K_{k+1}$, then $G$ has average degree
at least
$$k+\frac{k-2}{k^2+2k-2}.$$
\end{theorem}
\begin{proof}
Let $S$ be the set of vertices of $G$ of degree $k$.  By Lemmas~\ref{lemma:degkgal} and \ref{lemma:galdens},
$G[S]$ has at most $$\Bigl(\frac{k-1}{2}+\frac{1}{k}\Bigr)|S|$$ edges.  Note that $k|S|$ is the number of edges of $G$ incident with vertices of $S$,
counting those in $G[S]$ twice.  Hence,
\begin{equation}\label{eq:critdens-b1}
|E(G)|\ge k|S|-|E(G[S])|\ge \Bigl(\frac{k+1}{2}-\frac{1}{k}\Bigr)|S|.
\end{equation}
All vertices of $G$ not in $S$ have degree at least $k+1$, and thus
\begin{equation}\label{eq:critdens-b2}
2|E(G)|\ge (k+1)|V(G)|-|S|.
\end{equation}
Multiplying (\ref{eq:critdens-b2}) by $\bigl(\tfrac{k+1}{2}-\tfrac{1}{k}\bigr)$ and adding it to (\ref{eq:critdens-b1}) gives
$$\Bigl(k+2-\frac{2}{k}\Bigr)|E(G)|\ge\Bigl(\frac{k+1}{2}-\frac{1}{k}\Bigr)(k+1)|V(G)|,$$
and thus
$$\frac{k^2+2k-2}{k}|E(G)|\ge\frac{k^3+2k^2-k-2}{2k}|G|,$$
and the average degree of $G$ is
$$\frac{2|E(G)|}{|V(G)|}\ge \frac{k^3+2k^2-k-2}{k^2+2k-2}=k+\frac{k-2}{k^2+2k-2}.$$
\end{proof}
In combination with Corollary~\ref{cor:mad}, Theorem~\ref{thm:critdens} gives the following extension to Corollary~\ref{cor:small-simple}, covering the blue entries in Table~\ref{table:knowncrit}.
\begin{corollary}\label{cor:small-medium}
Let $\ell\in\{3,4,6\}$ and $g\ge 0$ be integers, and let $k=\tfrac{2\ell}{\ell-2}$.  Every graph of genus at most $g$ and girth at least $\ell$
other than $K_{k+1}$ which is vertex-critical for $k$-coloring has at most $$\frac{k^3+2k^2-2k}{k-2}(g-2)$$ vertices.
\end{corollary}

How good is the bound from Theorem~\ref{thm:critdens}?  The average degree given by the Theorem is about $k+1/k$.
The $(k+1)$-Ore graphs defined in the previous section, a best construction available to us at the moment,
have in limit (as their number of vertices goes to infinity, for a fixed $k$) average degree $k+1-2/k$, which for large $k$ leaves a gap of almost $1$.
The bound from Theorem~\ref{thm:critdens} was later mildly improved by Krivelevich~\cite{krivelevich1997minimal}
and by Kostochka and Stiebitz~\cite{kostochka1996excess} to a bound of about $k+2/k$.  However, a breakthrough came in the work of Kostochka and Yancey~\cite{koyanore},
who proved a bound that asymptotically matches the density of $(k+1)$-Ore graphs using a newly developed potential method; we give more details in Chapter~\ref{chap:potential}.

\section{Survey of critical graphs on surfaces}\label{sec:survsurf}

In the previous sections, we have already seen several results concerning critical graphs in particular surfaces.
Let us now summarize these results and expand on them.

We start with a very well understood case of planar graphs.  By the Four Color Theorem,
every planar graph is 4-colorable, and thus there are no planar graphs vertex-critical for $4$-coloring.
On the other hand, deciding whether a planar graph is $3$-colorable is NP-hard~\cite{garey1979computers},
and thus there is little hope of obtaining useful results on planar graphs critical for $3$-coloring.
However, by Gr\"{o}tzsch' Theorem, there are no planar graphs critical for $3$-coloring of girth at least four.

\subsubsection*{Four colors}
The ideas of the proof of the Four Color Theorem do not generalize to other surfaces.
Despite much attention, questions regarding the $4$-colorability of graphs on surfaces of positive genus remain wide open.
In particular, we do not know whether one can decide $4$-colorability of a projective planar or a toroidal
graph in polynomial time; but we also do not know any hardness result preventing this from being the case.
What we can tell is that for the projective plane and the torus (and thus also any other surface of non-zero genus),
there exist infinitely many graphs critical for $4$-coloring that can be drawn in the surface.
To see this, let us start with an interesting observation about quadrangulations of the projective plane,
shown by Youngs~\cite{youngs}.
\begin{lemma}\label{lemma:projall}
Let $G$ be a quadrangulation of the projective plane and let $\varphi$ be any proper coloring of $G$ (using any number of colors).
If $G$ is not bipartite, then there exists a face $f$ of $G$ such that $\varphi$ assigns four different colors to vertices
incident with $f$.
\end{lemma}
\begin{proof}
Since $G$ is a quadrangulation, all contractible cycles in $G$ have even length.  Since $G$ is not bipartite,
it contains an odd cycle $C$, necessarily a non-contractible one.  We cut the projective plane along $C$,
turning $G$ into a quadrangulation $G'$ of a disk.  For each $4$-cycle $K$ bounding a face of $G$,
let $\vec{K}$ be the orientation of $K$ such that the corresponding cycle in $G'$ is directed in the clockwise
direction around the face it bounds.  Consider any edge $e$ of $G$ and let $K_1$ and $K_2$ be the cycles bounding
the two faces incident with $e$; observe that if $e\in E(C)$, then $e$ is directed in $\vec{K}_1$ and $\vec{K}_2$
in the same way, while if $e\not\in E(C)$, then $e$ is directed in opposite ways.  Let $\vec{C}$ be the orientation
of $C$ that matches the orientations of incident faces.

For each face $f$ bounded by a cycle $K$, let $s_f=\sum_{(u,v)\in E(\vec{K})} \sgn(\varphi(v)-\varphi(u))$.
We have
$$\sum_{f\in F(G)} s_f=2\sum_{(u,v)\in E(\vec{C})} \sgn(\varphi(v)-\varphi(u)),$$ since the contributions of the edges not in $C$
cancel out.  Since $|C|$ is odd, the right-hand side is twice an odd number, and thus non-zero.  Hence, there exists a face $f$ of $G$
such that $s_f\neq 0$.  Observe this implies $\varphi$ assigns four different colors to vertices incident with $f$.
\end{proof}
For a graph $G$ drawn in a surface, let $G^\dagger$ denote the triangulation of the surface obtained by adding
into each face of $G$ a vertex adjacent to all vertices incident with the face.  If $G$ is a non-bipartite quadrangulation
of the projective plane, Lemma~\ref{lemma:projall} implies that $G^\dagger$ is not $4$-colorable.  Note $G^\dagger$ is not
necessarily critical for $4$-coloring; however, since we can choose the quadrangulation $G$ of arbitrarily large edge-width,
Observation~\ref{obs:critsg} implies there exist graphs critical for $4$-coloring drawn in the projective plane with arbitrarily
large edge-width.

For orientable surfaces, we can use another intriquing observation by Fisk~\cite{Fisk78}.

\begin{lemma}\label{lemma:oddsame}
Suppose $G$ is a triangulation of a surface and let $\varphi:V(G)\to[4]$ be a proper coloring of $G$.
For $i\in[4]$, let $d_i=\sum_{v\in \varphi^{-1}(i)} \deg v$ be the sum of the degrees of vertices of color $i$.  Then $d_1$, \ldots, $d_4$ all have the same parity.
\end{lemma}
\begin{proof}
For $j\in[4]$, let $t_j$ denote the number of faces of $G$ not incident with a vertex of color $j$ (e.g., $t_4$
is the number of faces incident with vertices of colors $1$, $2$, and $3$).
We claim that $t_1$, \ldots, $t_4$ have the same parity.  By symmetry, it suffices to show this is the case for $t_3$ and $t_4$.
To see that, it suffices to note that each face that contributes to $t_3$ or $t_4$ is incident with a unique edge
whose ends are colored $1$ and $2$, and that for each such edge $e$, the two faces incident with $uv$ contribute either
$1$ to both $t_3$ and $t_4$, or $2$ to one of $t_3$ and $t_4$ and $0$ to the other one.

Consider now a vertex $v$ of color $1$, and for $j\in \{2,3,4\}$, let $t_j(v)$ denote the number of faces of
$G$ incident with $v$ and not incident with a vertex of color $j$.  We have
$$t_2+t_3+t_4=\sum_{v\in \varphi^{-1}(1)} (t_2(v)+t_3(v)+t_4(v))=\sum_{v\in \varphi^{-1}(1)} \deg(v)=d_1.$$
Since $t_2$, $t_3$, and $t_4$ have the same parity, it follows that they also have the same parity as $d_1$.
A symmetric argument shows that $d_2$, \ldots, $d_4$ also have the same parity, as required.
\end{proof}
This lemma gives us the most information when $G$ has only a few vertices of odd degree.
In particular, we have the following surprising consequence, showing that in 4-colorings of triangulations,
the colors of arbitrarily distant vertices are not independent.

\begin{corollary}\label{cor:oddsame}
If $G$ is a triangulation of a surface and $G$ has exactly two vertices $u$ and $v$ of odd degree,
then in any $4$-coloring of $G$, the vertices $u$ and $v$ have the same color.
\end{corollary}
\begin{proof}
If $u$ and $v$ had different colors (say $1$ and $2$) in a $4$-coloring of $G$, we would have $d_1$ odd
and $d_3$ even, contradicting Lemma~\ref{lemma:oddsame}.
\end{proof}
In particular, if we take plane triangulation $G$ with exactly two vertices of odd degree (and it is easy to
construct such triangulations with vertices of odd degree arbitrarily far apart) and add an edge $e$ between
the two vertices, we obtain a graph that can be drawn in the torus and is not $4$-colorable.
A subgraph $G'$ of this graph that is critical for $4$-coloring clearly must contain $e$ and $G'-e$ must be connected
by Observation~\ref{obs:crit-2conn}, and thus $|V(G')|$ is at least as large as the distance between the endpoints
of $e$ in $G$.  Thus, indeed there are infinitely many graphs critical for $4$-coloring that can be drawn
in the torus (or any other surface of genus at least two).  Finally, let us remark on another way how to use
Corollary~\ref{cor:oddsame} to obtain graphs critical for $4$-coloring: any triangulation of a surface
with exactly two vertices of odd degree where the two vertices are adjacent has chromatic number at least five,
and for surfaces of non-zero genus, one can construct such triangulations with arbitrarily large edge-width.

Given the Four Color Theorem, it is tempting to conjecture that graphs critical for $4$-coloring in other surfaces
should at least have a simple structure.  If that is the case, such structure is still beyond our grasp,
and the problem of 4-coloring graphs on surfaces is wide open.

\subsubsection*{Five and more colors}
The above constructions illustrate that graphs critical for $4$-coloring in any surface of non-zero genus
can have quite intricate structure, which indicates the question of $4$-colorability of graphs on surfaces
is rather difficult one.  With greater number of colors, the situation is somewhat easier.
As we argued in the previous section, the set $\FF_{k,3,g}$ is finite for every $k\ge 6$,
implying that $k$-colorability is decidable in polynomial time.  By a much more involved argument,
Thomassen~\cite{Thomassen97} proved that $\FF_{5,3,g}$ is finite as well (the full treatment of
this case is beyond the scope of this book, but we will discuss at least some of the ideas later).

The explicit lists of critical graphs are known for the simplest surfaces.  Heawood's formula shows
that all projective-planar graphs are 6-colorable, and by Theorem~\ref{thm:dirac}, the only
projective-planar graph critical for 5-coloring is $K_6$.  Similarly, these results show that
graphs drawn in the torus are $7$-colorable and the only graph critical for $6$-coloring is $K_7$.
Thomassen~\cite{Tho5torus} proved there are exactly four graphs critical for $5$-coloring in the torus~\cite{Tho5torus}.
As we already noted, all graphs in the Klein bottle are 6-colorable.  The explicit list of nine
graphs critical for $5$-coloring in the Klein bottle was given by Chenette et al.~\cite{ChePosStrThoYer}
and Kawarabayashi et al.~\cite{KawKraKynLid}.

\subsubsection*{Triangle-free graphs}

As we have seen in Corollary~\ref{cor:small-medium}, for $k\ge 4$, the set $\FF_{k,4,g}$ is finite,
and furthermore, every triangle-free graph drawn in a surface of genus at most two is $4$-colorable.

The situation is much more interesting for the 3-coloring case.  Gr\"{o}tzsch' theorem shows all planar triangle-free
graphs are 3-colorable, but this is not true for any other surface.  Indeed, in any surface other than the sphere,
there are infinitely many triangle-free graphs critical for $3$-coloring.  
One way how to obtain such graphs is via \emph{Mycielski construction}.
For a graph $G$, let $M(G)$ denote the graph obtained from $G$ by, for each $v\in V(G)$, adding a vertex $v^\star$
adjacent exactly to the neighbors of $v$ in $G$, and then adding a \emph{central} vertex $u$ adjacent exactly to the vertices $v^\star$ for $v\in V(G)$.
Figure~\ref{fig:myc} shows the graph $M_{C_7}$ with its drawing in the projective plane and in the torus;
it is easy to see that $M(C)$ is triangle-free and can be drawn in these surfaces for any odd cycle $C$.
Furthermore, $M(C)$ is critical for $3$-coloring, due to the following more general observation.
\begin{lemma}\label{lemma:myccrit}
If a graph $G$ is critical for $k$-coloring, then $M(G)$ is critical for $(k+1)$-coloring.
\end{lemma}
\begin{proof}
Let $u$ be the central vertex of $M(G)$ and let $Z=V(M(G))\setminus (V(G)\cup \{u\})$.
If $M(G)$ had a $(k+1)$-coloring, then $M(G)-u$ would have a $(k+1)$-coloring $\varphi$ in which
the color $k+1$ would not appear on $Z$.  The vertices of $G$ colored by $k+1$ form an independent
set, and thus we could recolor each such vertex $v$ to the color $\varphi(v^\star)\in\{1,\ldots,k\}$,
obtaining a $k$-coloring of $G$.  This is a contradiction, implying $\chi(M(G))>k+1$.

Consider now an edge $e\in E(M(G))$.  If $e\in E(G)$, then $G-e$ has a $k$-coloring $\psi_1$.
For each $v\in V(G)$, give $v^\star$ the color $\psi_1(v)$, and color $u$ by the color $k+1$,
obtaining a $(k+1)$-coloring of $M(G)-e$.  Otherwise, $e=v^\star x$ for some $v\in V(G)$
and $x\in N_G(v)\cup\{u\}$.  If $x=u$, then let $\psi_2$ be a $k$-coloring of $G-v$.
For $y\in V(G)\setminus \{v\}$, color $y^\star$ by $\psi_2(y)$ and give $v$, $v^\star$, and $u$ the color $k+1$.
Finally, consider the case that $x\neq u$.  Let $\psi_3$ be a $k$-coloring of $G-uv$.
For $y\in V(G)$, color $y^\star$ by $\psi_3(y)$, change the color of $v$ to $k+1$, and give $u$ the color $k+1$.
We conclude that $M(G)-e$ is $(k+1)$-colorable for every $e\in E(M(G))$, and thus $M(G)$ is critical for $(k+1)$-coloring.
\end{proof}

\begin{figure}
\begin{center}
\begin{asy}
for (i = 0; i < 14; ++i)
  v[i] = 2 * dir(360i/14);
for (i = 0; i < 7; ++i)
  v[14+i] = dir(360*(2i+1)/14);
v[21] = (0,0);
draw(circle (v[21], 2));
for (i = 0; i < 7; ++i)
  {
    draw (v[2i] -- v[14+i] -- v[(2i+2) % 14]);
    draw (v[21] -- v[14+i]);
  }
for (i = 0; i <= 21; ++i)
  vertex(v[i]);
label ("A", v[0], E);
label ("B", v[1], NE);
label ("C", v[2], NE);
label ("D", v[3], N);
label ("E", v[4], N);
label ("F", v[5], NW);
label ("G", v[6], NW);
label ("A", v[7], W);
label ("B", v[8], SW);
label ("C", v[9], SW);
label ("D", v[10], S);
label ("E", v[11], S);
label ("F", v[12], SE);
label ("G", v[13], SE);

pair p = (4,3);
for (i = 0; i < 7; ++i)
  {
    v[i] = p + (0,-i);
    v[7 + i] = p + (4,-i);
    v[14 + i] = p + (i % 2 == 0 ? 1 : 3, -1 - i);
  };
v[20] = p + (2,0);
v[21] = p + (2,-3);
v[22] = p + (0,-7);
v[23] = p + (2,-7);
v[24] = p + (4,-7);

draw(v[0] -- v[22]);
draw(v[7] -- v[24]);
draw(v[0] -- v[7], dashed);
draw(v[22] -- v[24], dashed);
for (i = 0; i < 3; ++i)
  draw (v[2i] -- v[14+2i] -- v[2i+2]);
for (i = 0; i < 2; ++i)
  draw (v[7+2i+1] -- v[14+2i+1] -- v[7+2i+3]);
draw (v[20] -- v[8]);
draw (v[12] -- v[19] -- v[24]);
draw (v[6] -- v[23]);
for (i = 0; i < 7; ++i)
  draw (v[21] -- v[14+i]);
for (i = 0; i <= 24; ++i)
  vertex(v[i]);
label ("A", v[0], W);
label ("B", v[1], W);
label ("C", v[2], W);
label ("D", v[3], W);
label ("E", v[4], W);
label ("F", v[5], W);
label ("G", v[6], W);
label ("A", v[7], E);
label ("B", v[8], E);
label ("C", v[9], E);
label ("D", v[10], E);
label ("E", v[11], E);
label ("F", v[12], E);
label ("G", v[13], E);
label ("A", v[22], W);
label ("A", v[24], E);
label ("H", v[20], N);
label ("H", v[23], S);

\end{asy}
\end{center}

\caption{The Mycielski graph of a $7$-cycle.}\label{fig:myc}
\end{figure}

Another construction applicable to non-orientable surfaces is given in Lemma~\ref{lemma:projall}.
Indeed, there is a nice generalization of this construction.  Consider a quadrangulation of
a non-orientable surface where a closed walk that passes through each crosscap exactly once has odd length.  If this quadrangulation
has no separating 4-cycles and has large enough edge-width, then it is critical for $3$-coloring.

The latter construction is actually very instructive.  Indeed, the only graphs critical for $3$-coloring of large edge-width turn out
to be such quadrangulations~\cite{trfree6}.  More generally, all graphs critical for $3$-coloring drawn in any fixed surface
are ``almost quadrangulations''; we will discuss their theory in more detail in Chapter~\ref{chap:trfree}.
For now, let us just note that although the set $\FF_{3,4,g}$ is infinite for any $g\ge 1$, we know enough about the
structure of these critical graphs to determine whether a triangle-free graph drawn in a fixed surface is $3$-colorable
in linear time~\cite{trfree7}.

As for explicit lists, Gimbel and Thomassen~\cite{gimbel} proved that projective-planar graphs critical for $3$-coloring
are exactly the non-bipartite quadrangulations without separating 4-cycles.  In the torus, the situation is much more complicated---the
critical graphs fall into 186 infinite families~\cite{dpfuture}.  For Klein bottle, the explicit list is not known.

\subsubsection*{Girth at least five}

Corollary~\ref{cor:small-medium} shows that for $k\ge 3$ and any $g\ge 0$, the set $\FF_{k,6,g}$ is finite, and
furthermore, every graph of girth at least six drawn in a surface of genus at most two is $3$-colorable.
This leaves girth five as the last interesting case.  Another deep result of Thomassen~\cite{thomassen-surf}
shows that $\FF_{3,5,g}$ is finite for any $g\ge 0$.  Furthermore, all graphs of girth at least five drawn in the
projective plane, the torus~\cite{thom-torus}, or the Klein bottle~\cite{tw-klein} are $3$-colorable.

Let us comment a bit on the proof method in the last two results.  The argument is a generalization of a reducible
configurations proof of Gr\"{o}tzsch' theorem.  The main complication is the need to avoid creating cycles of length
at most four in the reductions.   The contractible ones can be dealt with using the precolored cycle trick, see
Section~\ref{sec:precolface}.  To deal with the non-contractible ones, they actually show a stronger result, allowing
non-contractible triangles and 4-cycles: Every graph drawn in the projective plane or the torus without contractible
cycles of length at most four is $3$-colorable.  For the Klein bottle, the situation is a bit more complicated,
as there exist graphs critical for 3-coloring drawn in the Klein bottle without contractible $(\le\!4)$-cycles.
However, they turn out to form a simple infinite family (a subclass of $4$-Ore graphs we introduced in Section~\ref{sec:defbas}),
whose first few graphs are depicted in Figure~\ref{fig:tw}.
These graphs play an important role in the coloring theory of embedded triangle-free graphs and we will encounter
them or their variations several more times.  As the drawing shows, they are planar and contain exactly four triangles,
and in the drawing in the Klein bottle, these triangles are one-sided.  In this context, let us remark that planar graphs
with at most three triangles are 3-colorable~\cite{aksenov}, and the graphs depicted in Figure~\ref{fig:tw} play a key role
in the characterization of non-3-colorable planar graphs with four triangles~\cite{4c4t}.

\begin{figure}
\begin{center}
\begin{asy}
for (j = 0; j < 3; ++j)
  for (i = 0; i < 4; ++i)
    v[4j+i] = (j+1) * dir(90i);

for (j = 0; j < 2; ++j)
  {
    v[12+2j] = v[4j] + (0.5,0);
    v[12+2j+1] = v[4j+3] + (0,-0.5);
  }

for (j = 0; j < 3; ++j)
  for (i = 0; i < 4; ++i)
    draw(v[4j+i] -- v[4j+(i+1)%4]);
for (j = 0; j < 2; ++j)
  {
    draw(v[4j] -- v[12+2j] -- v[12+2j+1] -- v[4j+2] -- v[4j+5] -- v[12+2j]);
    draw(v[12+2j+1] -- v[4j+7]);
  }

draw (v[1] -- v[3]);
draw (v[8]{N} .. (v[9] + (0,0.5)) .. {S}v[10]);

crosscap (interp (v[1],v[3],0.5));
crosscap (v[9] + (0,0.5));

for (i = 0; i <= 15; ++i)
  vertex(v[i]);
  
\end{asy}
\end{center}

\caption{Graphs critical for 3-coloring drawn in the Klein bottle without contractible $(\le\!4)$-cycles.}\label{fig:tw}
\end{figure}

\section{Bounding the Size of a Critical Graph}
Key Idea: Criticality with respect to a subgraph.

Overview Methods to bound size of a critical graph:
\begin{itemize}
\item Reductions increasing a properly defined weight (example: linear bound on the size of graphs in disk
critical for $5$-coloring?).
\item Specific subgraphs at the precolored face coming from the nibbling method (example: quadratic (or linear?) bound
on the size of graphs in disk critical for $5$-list-coloring)?
\end{itemize}

\section{Increasing Weight via Discharging}

\section{Increasing Weight via Nibbling}

\chapter{Hyperbolicity}

% LP

\section{Weak hyperbolicity and its consequences.}

\subsection{Edgewidth of critical graphs. }
\subsection{Logarithmic radius and coloring algorithm.}
\subsection{Precoloring extension?}
\subsection{Number of colorings? }

\section{Proof of the Weak Hyperbolic Structure Theorem?}

\section{Strong hyperbolicity and the size of embedded critical graphs.}

\section{Locally Free}

Application to far apart (at least in plane). Prove the plane version via Steiner Trees.

\section{Overview of the known hyperbolic families and bounds.}


\chapter{Triangle-free Graphs and Quadrangulations}\label{chap:trfree}

% ZD

\section{Bounding the sum of lengths of $(\ge\!5)$-faces in $4$-critical triangle-free graphs (outline only).}
\section{Coloring quadrangulations and near-quadrangulations.}

\subsection{ Winding number.}
\begin{itemize}
\item The disk case, analysis of critical graphs via flows. (already done in the flows section ?)
\end{itemize}

\subsection{The general case (statement + proof outline).}

\section{Applications of the theory:}
\subsection{Algorithmic (outline).}
\subsection{Graphs with high edge-width.}
\subsection{Coloring with few uncolored vertices.}
\subsection{Distant anomalies, Havel's problem (outline).}

\part{Advanced Methods}

\chapter{Density of Critical Graphs and the Potential Method}\label{chap:potential}

% LP

\section{Maximum average degree, degeneracy, embedded graphs.}
\section{Potential instead of mad.}
\section{Short Potential Proof of Brooks' Theorem}
\section{The Short Potential Proof of Grotzsch's Theorem}
\section{Outline of general $k$?}
\section{Survey of other results.}

\chapter{Probabilistic Methods}
\section{Probabilistic Tools: Local Lemma and Concentration Inequalities}
\section{Nibble Method: Short Proof of Kim's result}
\section{Outline of Johansson?}
\section{Reed's Conjecture}
\subsection{Density Lemma}
\subsection{Outline of Sparsity Lemma}

\part{Variants of Colorings}

\chapter{More on List Coloring?}

\section{Polynomial method}

\section{Orientations? Paintability?}
\section{Ohba's?}

\chapter{Edge Coloring}\label{chap:edgecol}

Maybe?

Do we want to have this chapter?  Or possibly we could refocus it on the
sparse setting (cubic graphs, planar graphs -- Seymour's conjecture)?

\section{Vizing Fans, Kierstead Paths}
\section{Tashkinov Trees and the Goldberg-Seymour Conjecture}\label{sec:goseycon}
\section{List Coloring Conjecture for Bipartite Graphs (Galvin's Proof)}
\section{List Coloring Conjecture: Outline of Kahn's Proof?}

\chapter{Correspondence Coloring}\label{chap:corresp}

% LP

\section{Definitions and Motivation}

Definition and properties of correspondence coloring.

\section{Results on list coloring via correspondence coloring}

\begin{itemize}
\item More reducible configurations: $3$-list-coloring graphs without $4$-, \ldots, $8$-cycles.
\item Restoring uniformity in probabilistic arguments: Sparse graphs of bounded maximum degree.
\end{itemize}

\section{Old Results through the lens of Corr. Coloring}

Corr. coloring tied to average degree (Berhnetsyn's Proof)

\section{Open Questions}

Lift matching number? (i.e. special case of correspondence edge coloring)

\chapter{Circular Coloring, Fractional Coloring}

Maybe?

\part{Coloring and Structure}

\chapter{Excluding Minors}

Maybe?

Results on graphs avoiding a minor:


\section{Decomposition to two low tree-width graphs, $2$-approximation algorithm.}
\section{Hadwiger's conjecture and its relaxations}
(colors induce subgraphs of bounded maximum degree, maximum component size).
\section{Hajos' conjecture and counterexamples}

\chapter{Forbidding Subgraphs}

Maybe?

\section{Strong Perfect Graph Theorem}
\section{Gyarfas Conj + $\chi$-boundedness}
\section{Erdos-Hajnal}

\part{Open Problems}

\begin{itemize}
\item 4-colorability (surfaces, planar + edge, one crossing, \ldots).
\item Characterization of planar graphs with $\alpha(G)=n/4$, Eulerian triangulations with $\alpha(G)=n/3$.
\item $4$-colorability of Eulerian triangulations of surfaces.
\item $3$-colorability without $4$-, $5$-, $6$-cycles.
\item Improving the distance in Havel's conjecture, constants in the bounds on critical graphs.
\item Algorithmic: extending a precoloring of an arbitrarily long face in triangle-free planar graphs.
\item Vertex minors and $\chi$-boundedness.
\end{itemize}

\newpage
\pagestyle{plain}
\addcontentsline{toc}{chapter}{Index}
\printindex

\addcontentsline{toc}{chapter}{Bibliography}
\bibliographystyle{acm}
\bibliography{cb}

\end{document}
